This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.log, tmp/, .js, .html, .blade.php, .css, public/, vendor/, node_modules, venv/, logs/, electorn-sentinerl/
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  ISSUE_TEMPLATE/
    bug.yml
    config.yml
  workflows/
    dependabot-auto-merge.yml
    fix-php-code-styling.yml
    publish.yml
    tests.yml
  CONTRIBUTING.md
  dependabot.yml
  FUNDING.yml
  SECURITY.md
config/
  laravilt-panel.php
docs/
  index.md
  mcp-server.md
lang/
  ar/
    panel.php
  en/
    panel.php
resources/
  css/
    app.css
  js/
    components/
      AppLogoIcon.vue
      LanguageSwitcher.vue
      LaraviltPage.vue
      ManageRecords.vue
      PanelPageLayout.vue
      PanelSidebar.vue
      RelationManager.vue
      RelationManagers.vue
      SettingsPageSkeleton.vue
    layouts/
      AppLayout.vue
      CardLayout.vue
      PanelLayout.vue
      SettingsLayout.vue
    pages/
      laravilt/
        Dashboard.vue
        ManageRecords.vue
        Page.vue
    app.js
    index.js
routes/
  web.php
src/
  Commands/
    InstallCommand.php
    InstallPanelCommand.php
    MakeClusterCommand.php
    MakePageCommand.php
    MakePanelCommand.php
    MakeRelationManagerCommand.php
    MakeResourceCommand.php
  Concerns/
    HasAI.php
    HasAuth.php
    HasBranding.php
    HasBreadcrumbs.php
    HasClusters.php
    HasColors.php
    HasId.php
    HasMiddleware.php
    HasNavigation.php
    HasNotifications.php
    HasPages.php
    HasPath.php
    HasResources.php
    HasTenancy.php
    HasTheme.php
    HasWidgets.php
  Contracts/
    HasPanel.php
  Discovery/
    PanelDiscovery.php
  Enums/
    PageLayout.php
  Facades/
    Panel.php
  FontProviders/
    FontProvider.php
    GoogleFontProvider.php
  Http/
    Controllers/
      LocaleController.php
    Middleware/
      Authenticate.php
      HandleLocalization.php
      SharePanelData.php
  Mcp/
    Tools/
      GetResourceInfoTool.php
      ListPanelFeaturesTool.php
      SearchDocsTool.php
    LaraviltPanelServer.php
  Middleware/
    IdentifyPanel.php
  Navigation/
    NavigationBuilder.php
    NavigationGroup.php
    NavigationItem.php
    UserMenu.php
  Pages/
    CreateRecord.php
    Dashboard.php
    EditRecord.php
    ListRecords.php
    ManageRecords.php
    Page.php
    ViewRecord.php
  Resources/
    RelationManagers/
      RelationManager.php
    Resource.php
  Theme/
    ThemeManager.php
  Cluster.php
  Panel.php
  PanelProvider.php
  PanelRegistry.php
  PanelServiceProvider.php
stubs/
  bootstrap/
    app.stub
    providers.stub
  layouts/
    app/
      AppHeaderLayout.vue.stub
      AppSidebarLayout.vue.stub
    auth/
      AuthCardLayout.vue.stub
      AuthSimpleLayout.vue.stub
      AuthSplitLayout.vue.stub
    settings/
      Layout.vue.stub
    AppLayout.vue.stub
    AuthLayout.vue.stub
  Middleware/
    HandleAppearance.stub
    HandleInertiaRequests.stub
  routes/
    settings.stub
    web.stub
  cluster.stub
  dashboard-page.stub
  dashboard.stub
  page-view.stub
  page.stub
  panel-provider.stub
  resource-Api.stub
  resource-Create.stub
  resource-Edit.stub
  resource-List.stub
  resource-View.stub
tests/
  Feature/
    DebugTest.php
  Unit/
    NavigationItemTest.php
    PageTest.php
    PanelRegistryTest.php
    PanelTest.php
  Pest.php
  TestCase.php
.gitignore
CHANGELOG.md
CODE_OF_CONDUCT.md
composer.json
LICENSE.md
mcp-server.json
package.json
phpstan.neon
phpunit.xml
pint.json
README.md
testbench.yaml
vite.plugin.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="resources/js/components/LanguageSwitcher.vue">
<script setup lang="ts">
import { computed } from 'vue';
import { usePage, router } from '@inertiajs/vue3';
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { Globe, Check } from 'lucide-vue-next';
import { useLocalization } from '@/composables/useLocalization';

interface Locale {
    value: string;
    label: string;
    dir: 'ltr' | 'rtl';
    flag: string;
}

const { trans } = useLocalization();

const page = usePage<{
    panel?: {
        id: string;
        path: string;
        availableLocales: Locale[];
        currentLocale: string;
    };
}>();

const availableLocales = computed(() => page.props.panel?.availableLocales || []);
const currentLocale = computed(() => page.props.panel?.currentLocale || 'en');
const panelPath = computed(() => page.props.panel?.path || '');
const panelId = computed(() => page.props.panel?.id || 'admin');

const currentLocaleData = computed(() => {
    return availableLocales.value.find(l => l.value === currentLocale.value) || {
        value: 'en',
        label: 'English',
        dir: 'ltr',
        flag: 'us'
    };
});

const getFlagUrl = (flag: string) => {
    return `https://flagcdn.com/w20/${flag}.png`;
};

const switchLocale = (locale: string) => {
    if (locale === currentLocale.value) return;

    // Build the URL using panel path
    const url = `/${panelPath.value}/locale`;

    router.post(url, {
        locale,
    }, {
        preserveScroll: true,
        preserveState: false,
        onSuccess: () => {
            // Use Inertia's reload instead of window.location.reload()
            // This provides a smoother transition
            router.reload({ only: [] });
        },
    });
};
</script>

<template>
    <DropdownMenu>
        <DropdownMenuTrigger as-child>
            <Button variant="ghost" size="icon" class="relative">
                <img
                    :src="getFlagUrl(currentLocaleData.flag)"
                    :alt="currentLocaleData.label"
                    class="h-5 w-5 rounded-sm object-cover"
                />
                <span class="sr-only">{{ trans('laravilt-panel::panel.language.switch') }}</span>
            </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end" class="w-48">
            <DropdownMenuItem
                v-for="locale in availableLocales"
                :key="locale.value"
                class="flex items-center gap-3 cursor-pointer"
                @click="switchLocale(locale.value)"
            >
                <img
                    :src="getFlagUrl(locale.flag)"
                    :alt="locale.label"
                    class="h-4 w-4 rounded-sm object-cover"
                />
                <span :class="{ 'flex-1': currentLocaleData.dir === 'ltr' }" class="text-start">{{ locale.label }}</span>
                <Check
                    v-if="locale.value === currentLocale"
                    class="h-4 w-4 text-primary rtl:me-auto"
                />
            </DropdownMenuItem>
        </DropdownMenuContent>
    </DropdownMenu>
</template>
</file>

<file path="src/Concerns/HasAI.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Concerns;

use Closure;
use Laravilt\AI\AIManager;
use Laravilt\AI\Builders\AIProviderBuilder;
use Laravilt\AI\Builders\GlobalSearchBuilder;
use Laravilt\AI\GlobalSearch;
use Laravilt\Panel\Navigation\NavigationItem;

trait HasAI
{
    protected ?GlobalSearchBuilder $globalSearchBuilder = null;

    protected ?AIProviderBuilder $aiProviderBuilder = null;

    /**
     * Configure global search for this panel.
     */
    public function globalSearch(?Closure $callback = null): static
    {
        $this->globalSearchBuilder = new GlobalSearchBuilder;

        if ($callback) {
            $callback($this->globalSearchBuilder);
        }

        return $this;
    }

    /**
     * Configure AI providers for this panel.
     */
    public function aiProviders(?Closure $callback = null): static
    {
        $this->aiProviderBuilder = new AIProviderBuilder;

        if ($callback) {
            $callback($this->aiProviderBuilder);
        }

        return $this;
    }

    /**
     * Check if global search is enabled.
     */
    public function hasGlobalSearch(): bool
    {
        return $this->globalSearchBuilder !== null && $this->globalSearchBuilder->isEnabled();
    }

    /**
     * Get the global search builder.
     */
    public function getGlobalSearchBuilder(): ?GlobalSearchBuilder
    {
        return $this->globalSearchBuilder;
    }

    /**
     * Check if AI providers are configured.
     */
    public function hasAIProviders(): bool
    {
        return $this->aiProviderBuilder !== null && $this->aiProviderBuilder->hasConfiguredProviders();
    }

    /**
     * Get the AI provider builder.
     */
    public function getAIProviderBuilder(): ?AIProviderBuilder
    {
        return $this->aiProviderBuilder;
    }

    /**
     * Get global search configuration for frontend.
     *
     * @return array<string, mixed>|null
     */
    public function getGlobalSearchConfig(): ?array
    {
        if (! $this->hasGlobalSearch()) {
            return null;
        }

        $config = $this->globalSearchBuilder->toArray();

        // Add endpoint if not set
        if (! $config['endpoint']) {
            $config['endpoint'] = $this->url('/global-search');
        }

        return $config;
    }

    /**
     * Get AI configuration for frontend.
     *
     * @return array<string, mixed>|null
     */
    public function getAIConfig(): ?array
    {
        if (! $this->hasAIProviders()) {
            return null;
        }

        return $this->aiProviderBuilder->toArray();
    }

    /**
     * Get global search endpoint URL.
     */
    public function getGlobalSearchEndpoint(): string
    {
        if ($this->globalSearchBuilder && $endpoint = $this->globalSearchBuilder->getEndpoint()) {
            return $endpoint;
        }

        return $this->url('/global-search');
    }

    /**
     * Register AI and global search routes for this panel.
     */
    protected function registerAIRoutes(): void
    {
        if (! $this->hasGlobalSearch()) {
            return;
        }

        $panelPath = $this->getPath();
        $panelId = $this->getId();
        $middleware = $this->getMiddleware();

        // Register global search route
        \Illuminate\Support\Facades\Route::middleware($middleware)
            ->prefix($panelPath)
            ->name($panelId.'.')
            ->group(function () {
                $controller = \Laravilt\AI\Http\Controllers\GlobalSearchController::class;

                \Illuminate\Support\Facades\Route::get('/global-search', [$controller, 'search'])->name('global-search');
                \Illuminate\Support\Facades\Route::get('/global-search/resources', [$controller, 'resources'])->name('global-search.resources');
            });

        // Register AI routes if providers are configured
        if ($this->hasAIProviders()) {
            $panel = $this;

            // Register AI Chat page route
            \Illuminate\Support\Facades\Route::middleware($middleware)
                ->prefix($panelPath)
                ->name($panelId.'.')
                ->group(function () use ($panel) {
                    $pageClass = \Laravilt\AI\Pages\AIChat::class;

                    \Illuminate\Support\Facades\Route::get('/ai', function () use ($pageClass, $panel) {
                        $page = new $pageClass;
                        $page->panel($panel);

                        return $page->render();
                    })->name('ai');
                });

            // Register AI API routes
            \Illuminate\Support\Facades\Route::middleware($middleware)
                ->prefix($panelPath.'/ai')
                ->name($panelId.'.ai.')
                ->group(function () {
                    $controller = \Laravilt\AI\Http\Controllers\AIController::class;

                    \Illuminate\Support\Facades\Route::get('/config', [$controller, 'config'])->name('config');
                    \Illuminate\Support\Facades\Route::post('/chat', [$controller, 'chat'])->name('chat');
                    \Illuminate\Support\Facades\Route::post('/stream', [$controller, 'stream'])->name('stream');

                    // Session routes (methods in AIController)
                    \Illuminate\Support\Facades\Route::get('/sessions', [$controller, 'sessions'])->name('sessions.index');
                    \Illuminate\Support\Facades\Route::post('/sessions', [$controller, 'createSession'])->name('sessions.store');
                    \Illuminate\Support\Facades\Route::get('/sessions/{session}', [$controller, 'session'])->name('sessions.show');
                    \Illuminate\Support\Facades\Route::patch('/sessions/{session}', [$controller, 'updateSession'])->name('sessions.update');
                    \Illuminate\Support\Facades\Route::delete('/sessions/{session}', [$controller, 'deleteSession'])->name('sessions.destroy');
                });
        }
    }

    /**
     * Register resources for global search.
     */
    protected function registerResourcesForGlobalSearch(): void
    {
        if (! $this->hasGlobalSearch()) {
            return;
        }

        $globalSearch = app(GlobalSearch::class);
        $builder = $this->globalSearchBuilder;
        $excludedResources = $builder->getExcludedResources();

        // Configure global search from builder
        $globalSearch->limit($builder->getLimit());

        if ($builder->usesAI()) {
            $globalSearch->useAI(true);
        }

        // Register AI manager from panel's providers
        if ($this->hasAIProviders()) {
            $aiManager = app(AIManager::class);

            foreach ($this->aiProviderBuilder->getProviders() as $provider) {
                $aiManager->addProvider($provider);
            }

            if ($defaultProvider = $this->aiProviderBuilder->getDefaultProviderName()) {
                $aiManager->setDefaultProvider($defaultProvider);
            }
        }

        // Auto-register resources that have AI enabled
        foreach ($this->getResources() as $resourceClass) {
            // Skip excluded resources
            if (in_array($resourceClass, $excludedResources)) {
                continue;
            }

            /** @var \Laravilt\Panel\Resources\Resource $resourceClass */
            if ($resourceClass::hasAI()) {
                $agent = $resourceClass::getAIAgent();

                if ($agent && $searchable = $agent->getSearchable()) {
                    // Build URL pattern manually to avoid route generation during boot
                    $panelPath = $this->getPath();
                    $resourceSlug = $resourceClass::getSlug();
                    $urlPattern = "/{$panelPath}/{$resourceSlug}/{id}";

                    $globalSearch->registerResource(
                        resource: $resourceSlug,
                        model: $resourceClass::getModel(),
                        searchable: $searchable,
                        label: $resourceClass::getPluralLabel(),
                        icon: $resourceClass::getNavigationIcon(),
                        url: $urlPattern
                    );
                }
            }
        }
    }

    /**
     * Get AI-related menu items for user menu.
     *
     * @return array<NavigationItem>
     */
    public function getAIMenuItems(): array
    {
        if (! $this->hasAIProviders()) {
            return [];
        }

        return [
            NavigationItem::make(__('laravilt-ai::ai.chat.title'))
                ->translationKey('laravilt-ai::ai.chat.title')
                ->icon('Sparkles')
                ->url($this->url('/ai')),
        ];
    }
}
</file>

<file path="tests/Unit/NavigationItemTest.php">
<?php

use Laravilt\Panel\Navigation\NavigationItem;

describe('NavigationItem', function () {
    it('can be created with a label', function () {
        $item = NavigationItem::make('Dashboard');

        expect($item->getLabel())->toBe('Dashboard');
    });

    it('can set url', function () {
        $item = NavigationItem::make('Dashboard')->url('/admin');

        expect($item->getUrl())->toBe('/admin');
    });

    it('can set icon', function () {
        $item = NavigationItem::make('Dashboard')->icon('LayoutDashboard');

        expect($item->getIcon())->toBe('LayoutDashboard');
    });

    it('can set sort order', function () {
        $item = NavigationItem::make('Dashboard')->sort(10);

        expect($item->getSort())->toBe(10);
    });

    it('can set badge', function () {
        $item = NavigationItem::make('Notifications')->badge(5);

        expect($item->getBadge())->toBe('5');
    });

    it('can set badge color', function () {
        $item = NavigationItem::make('Notifications')->badge(5, 'danger');

        expect($item->getBadgeColor())->toBe('danger');
    });

    it('has default badge color', function () {
        $item = NavigationItem::make('Notifications')->badge(5);

        expect($item->getBadgeColor())->toBe('primary');
    });

    it('can convert to array', function () {
        $item = NavigationItem::make('Dashboard')
            ->url('/admin')
            ->icon('LayoutDashboard')
            ->sort(1);

        $array = $item->toArray();

        expect($array)->toHaveKeys(['title', 'url', 'icon', 'sort']);
        expect($array['title'])->toBe('Dashboard');
        expect($array['url'])->toBe('/admin');
        expect($array['icon'])->toBe('LayoutDashboard');
    });

    it('can set active condition', function () {
        $item = NavigationItem::make('Dashboard')
            ->url('/admin')
            ->active(true);

        expect($item->isActive())->toBeTrue();
    });

    it('defaults active to false', function () {
        $item = NavigationItem::make('Dashboard')->url('/admin');

        expect($item->isActive())->toBeFalse();
    });

    it('can set translation key', function () {
        $item = NavigationItem::make('Dashboard')
            ->translationKey('navigation.dashboard');

        expect($item->getTranslationKey())->toBe('navigation.dashboard');
    });

    it('can set method', function () {
        $item = NavigationItem::make('Logout')
            ->method('POST');

        expect($item->getMethod())->toBe('POST');
    });
});
</file>

<file path="tests/Unit/PageTest.php">
<?php

use Laravilt\Panel\Pages\Page;

class TestPage extends Page
{
    protected static ?string $title = 'Test Page';

    protected static ?string $navigationIcon = 'TestIcon';

    protected static ?string $slug = 'test-page';

    protected static string $view = 'test';
}

class HiddenPage extends Page
{
    protected static ?string $slug = 'hidden';

    protected static bool $shouldRegisterNavigation = false;

    protected static string $view = 'hidden';
}

describe('Page', function () {
    it('can get title', function () {
        expect(TestPage::getTitle())->toBe('Test Page');
    });

    it('can get navigation icon', function () {
        expect(TestPage::getNavigationIcon())->toBe('TestIcon');
    });

    it('can get slug', function () {
        expect(TestPage::getSlug())->toBe('test-page');
    });

    it('can check navigation registration', function () {
        expect(TestPage::shouldRegisterNavigation())->toBeTrue();
        expect(HiddenPage::shouldRegisterNavigation())->toBeFalse();
    });
});
</file>

<file path="tests/Unit/PanelRegistryTest.php">
<?php

use Laravilt\Panel\Panel;
use Laravilt\Panel\PanelRegistry;

describe('PanelRegistry', function () {
    beforeEach(function () {
        $this->registry = new PanelRegistry;
    });

    it('can register a panel', function () {
        $panel = Panel::make('admin');
        $this->registry->register($panel);

        expect($this->registry->get('admin'))->toBe($panel);
    });

    it('can get all panels', function () {
        $panel1 = Panel::make('admin');
        $panel2 = Panel::make('user');

        $this->registry->register($panel1);
        $this->registry->register($panel2);

        expect($this->registry->all())->toHaveCount(2);
        expect($this->registry->all())->toContain($panel1, $panel2);
    });

    it('can get default panel', function () {
        $panel1 = Panel::make('admin');
        $panel2 = Panel::make('user')->default();

        $this->registry->register($panel1);
        $this->registry->register($panel2);

        expect($this->registry->getDefault())->toBe($panel2);
    });

    it('returns first panel when no explicit default', function () {
        $panel = Panel::make('admin');
        $this->registry->register($panel);

        // getDefault() returns first panel if no explicit default is set
        expect($this->registry->getDefault())->toBe($panel);
    });

    it('returns null for non-existent panel', function () {
        expect($this->registry->get('nonexistent'))->toBeNull();
    });

    it('can check if panel exists', function () {
        $panel = Panel::make('admin');
        $this->registry->register($panel);

        expect($this->registry->has('admin'))->toBeTrue();
        expect($this->registry->has('nonexistent'))->toBeFalse();
    });
});
</file>

<file path="tests/Unit/PanelTest.php">
<?php

use Laravilt\Panel\Panel;

describe('Panel', function () {
    it('can be instantiated with an id', function () {
        $panel = Panel::make('admin');

        expect($panel)->toBeInstanceOf(Panel::class);
        expect($panel->getId())->toBe('admin');
    });

    it('can set and get path', function () {
        $panel = Panel::make('admin')->path('dashboard');

        expect($panel->getPath())->toBe('dashboard');
    });

    it('defaults path to id', function () {
        $panel = Panel::make('admin');

        expect($panel->getPath())->toBe('admin');
    });

    it('can be set as default', function () {
        $panel = Panel::make('admin')->default();

        expect($panel->isDefault())->toBeTrue();
    });

    it('can set brand name', function () {
        $panel = Panel::make('admin')->brandName('My App');

        expect($panel->getBrandName())->toBe('My App');
    });

    it('can set brand logo', function () {
        $panel = Panel::make('admin')->brandLogo('/images/logo.svg');

        expect($panel->getBrandLogo())->toBe('/images/logo.svg');
    });

    it('can set middleware', function () {
        $panel = Panel::make('admin')->middleware(['web', 'auth']);

        expect($panel->getMiddleware())->toBe(['web', 'auth']);
    });

    it('can set middleware (replaces previous)', function () {
        $panel = Panel::make('admin')
            ->middleware(['web'])
            ->middleware(['auth']);

        expect($panel->getMiddleware())->toBe(['auth']);
    });

    it('can set auth middleware', function () {
        $panel = Panel::make('admin')->authMiddleware(['auth:sanctum']);

        expect($panel->getAuthMiddleware())->toBe(['auth:sanctum']);
    });

    it('can generate url', function () {
        $panel = Panel::make('admin')->path('admin');

        expect($panel->url('/'))->toBe('/admin/');
        expect($panel->url('/users'))->toBe('/admin/users');
    });
});

describe('Panel Pages', function () {
    it('can register pages', function () {
        $panel = Panel::make('admin')->pages([
            \Laravilt\Panel\Pages\Dashboard::class,
        ]);

        expect($panel->getPages())->toContain(\Laravilt\Panel\Pages\Dashboard::class);
    });

    it('starts with empty pages', function () {
        $panel = Panel::make('admin');

        expect($panel->getPages())->toBeArray();
    });
});

describe('Panel Resources', function () {
    it('starts with empty resources', function () {
        $panel = Panel::make('admin');

        expect($panel->getResources())->toBeArray();
    });
});

describe('Panel Widgets', function () {
    it('starts with empty widgets', function () {
        $panel = Panel::make('admin');

        expect($panel->getWidgets())->toBeArray();
    });
});
</file>

<file path=".github/ISSUE_TEMPLATE/bug.yml">
name: Bug Report
description: Report a bug
title: "[Bug]: "
labels: ["bug"]
body:
  - type: markdown
    attributes:
      value: |
        Thanks for taking the time to fill out this bug report!
  - type: textarea
    id: description
    attributes:
      label: Description
      description: A clear and concise description of the bug
    validations:
      required: true
  - type: textarea
    id: steps
    attributes:
      label: Steps to Reproduce
      description: Steps to reproduce the behavior
      placeholder: |
        1. Go to '...'
        2. Click on '....'
        3. See error
    validations:
      required: true
  - type: textarea
    id: expected
    attributes:
      label: Expected Behavior
      description: What you expected to happen
    validations:
      required: true
  - type: textarea
    id: actual
    attributes:
      label: Actual Behavior
      description: What actually happened
    validations:
      required: true
  - type: input
    id: version
    attributes:
      label: Package Version
      description: What version of the package are you using?
    validations:
      required: true
  - type: input
    id: php-version
    attributes:
      label: PHP Version
      description: What version of PHP are you using?
    validations:
      required: true
  - type: input
    id: laravel-version
    attributes:
      label: Laravel Version
      description: What version of Laravel are you using?
    validations:
      required: true
</file>

<file path=".github/ISSUE_TEMPLATE/config.yml">
blank_issues_enabled: false
contact_links:
  - name: Ask a question
    url: https://github.com/laravilt/panel/discussions/new?category=q-a
    about: Ask the community for help
  - name: Request a feature
    url: https://github.com/laravilt/panel/discussions/new?category=ideas
    about: Share ideas for new features
</file>

<file path=".github/workflows/dependabot-auto-merge.yml">
name: Dependabot Auto-Merge

on: [push, pull_request]

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-merge Dependabot PRs for semver-minor updates
        if: ${{steps.metadata.outputs.update-type == 'version-update:semver-minor'}}
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Auto-merge Dependabot PRs for semver-patch updates
        if: ${{steps.metadata.outputs.update-type == 'version-update:semver-patch'}}
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
</file>

<file path=".github/CONTRIBUTING.md">
# Contributing to Panel

Thank you for considering contributing to Panel!

## Pull Requests

1. Fork the repository
2. Create a new branch for your feature
3. Write tests for your changes
4. Ensure all tests pass
5. Submit a pull request

## Coding Standards

- Follow PSR-12 coding standards
- Run `composer format` before committing
- Write tests for new features
- Ensure PHPStan passes with level 5

## Running Tests

```bash
composer test
```

## Code Style

```bash
composer format
```

## Static Analysis

```bash
composer analyse
```
</file>

<file path=".github/dependabot.yml">
version: 2
updates:
  - package-ecosystem: "composer"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
</file>

<file path=".github/FUNDING.yml">
github: fadymondy
</file>

<file path=".github/SECURITY.md">
# Security Policy

## Reporting a Vulnerability

If you discover a security vulnerability within Panel, please send an email to info@3x1.io. All security vulnerabilities will be promptly addressed.

Please do not publicly disclose the issue until it has been addressed by the team.
</file>

<file path="docs/index.md">
# Laravilt Panel Package

The Laravilt Panel package provides a powerful, flexible foundation for building admin panels, dashboards, and multi-tenant applications with Laravel and Inertia.js.

## Table of Contents

1. [Installation](#installation)
2. [Core Concepts](#core-concepts)
3. [Creating Panels](#creating-panels)
4. [Pages](#pages)
5. [Navigation](#navigation)
6. [Layouts](#layouts)
7. [Middleware](#middleware)
8. [Multi-Tenancy](#multi-tenancy)
9. [Customization](#customization)
10. [API Reference](#api-reference)

## Installation

```bash
composer require laravilt/panel
```

### Publish Configuration

```bash
php artisan vendor:publish --tag="laravilt-panel-config"
```

### Publish Assets

```bash
php artisan vendor:publish --tag="laravilt-panel-assets"
```

## Core Concepts

### What is a Panel?

A Panel is an isolated section of your application with its own:
- **URL Path**: `/admin`, `/app`, `/tenant/{tenant}`
- **Authentication Guard**: `web`, `admin`, `tenant`
- **Navigation**: Sidebar, topbar, custom menus
- **Pages**: Dashboard, resources, settings
- **Layouts**: Different UI layouts per panel
- **Middleware**: Custom authentication and authorization

### Use Cases

- **Admin Panel**: Backend administration interface
- **User Dashboard**: Customer-facing dashboard
- **Multi-Tenant Apps**: Separate panels per tenant
- **API Dashboard**: API management interface

## Creating Panels

### Basic Panel

Register a panel in your `AppServiceProvider` or dedicated `PanelServiceProvider`:

```php
use Laravilt\Panel\Panel;

public function boot(): void
{
    Panel::make('admin')
        ->path('/admin')
        ->register();
}
```

### Panel with Authentication

```php
Panel::make('admin')
    ->path('/admin')
    ->authGuard('admin')
    ->login()                    // Enable login page
    ->registration()             // Enable registration
    ->emailVerification()        // Require email verification
    ->middleware(['web', 'auth:admin'])
    ->register();
```

### Multi-Panel Application

```php
// Admin Panel
Panel::make('admin')
    ->path('/admin')
    ->authGuard('admin')
    ->login()
    ->register();

// User Dashboard
Panel::make('app')
    ->path('/app')
    ->authGuard('web')
    ->login()
    ->register();

// Tenant Panel
Panel::make('tenant')
    ->path('/tenant/{tenant}')
    ->authGuard('tenant')
    ->login()
    ->register();
```

## Pages

### Creating a Page

Create a page class:

```php
namespace App\Pages;

use Laravilt\Panel\Pages\Page;

class Dashboard extends Page
{
    protected static ?string $title = 'Dashboard';

    protected static ?string $slug = 'dashboard';

    protected static ?string $navigationIcon = 'heroicon-o-home';

    public function getHeading(): string
    {
        return 'Welcome to Dashboard';
    }

    public function getSubheading(): ?string
    {
        return 'Overview of your application';
    }

    protected function getInertiaProps(): array
    {
        return [
            'stats' => $this->getStats(),
            'recentActivity' => $this->getRecentActivity(),
        ];
    }

    protected function getStats(): array
    {
        return [
            'users' => \App\Models\User::count(),
            'revenue' => '$12,345',
            'orders' => 156,
        ];
    }
}
```

### Registering Pages

```php
Panel::make('admin')
    ->pages([
        Dashboard::class,
        UsersPage::class,
        SettingsPage::class,
    ])
    ->register();
```

### Page Layouts

Available layouts:

```php
use Laravilt\Panel\Enums\PageLayout;

class MyPage extends Page
{
    public function getLayout(): string
    {
        return PageLayout::Default->value;    // Full width layout
        // or
        return PageLayout::Centered->value;   // Centered content
        // or
        return PageLayout::Card->value;       // Card-based layout
        // or
        return PageLayout::Settings->value;   // Settings sidebar layout
    }
}
```

### Page with Actions

```php
use Laravilt\Actions\Action;
use Laravilt\Forms\Components\TextInput;

class EditProfile extends Page
{
    protected function getSchema(): array
    {
        return [
            TextInput::make('name')
                ->label('Name')
                ->required(),

            TextInput::make('email')
                ->label('Email')
                ->email()
                ->required(),
        ];
    }

    protected function getActions(): array
    {
        return [
            Action::make('save')
                ->label('Save Changes')
                ->action(function (array $data) {
                    auth()->user()->update($data);

                    session()->flash('notifications', [[
                        'type' => 'success',
                        'message' => 'Profile updated successfully!',
                    ]]);
                })
                ->requiresConfirmation()
                ->modalHeading('Save Changes')
                ->modalDescription('Are you sure you want to save these changes?'),
        ];
    }
}
```

### Page Clusters

Group related pages together:

```php
namespace App\Clusters;

use Laravilt\Panel\Clusters\Cluster;

class Settings extends Cluster
{
    protected static ?string $title = 'Settings';

    protected static ?string $navigationIcon = 'heroicon-o-cog';

    protected static ?int $navigationSort = 100;
}
```

Register pages in cluster:

```php
namespace App\Pages\Settings;

use App\Clusters\Settings;
use Laravilt\Panel\Pages\Page;

class GeneralSettings extends Page
{
    protected static ?string $cluster = Settings::class;

    protected static ?string $title = 'General';
}
```

## Navigation

### Navigation Configuration

```php
Panel::make('admin')
    ->navigation([
        'dashboard' => [
            'label' => 'Dashboard',
            'icon' => 'heroicon-o-home',
            'url' => '/admin/dashboard',
            'sort' => 1,
        ],
        'users' => [
            'label' => 'Users',
            'icon' => 'heroicon-o-users',
            'url' => '/admin/users',
            'sort' => 2,
            'badge' => fn () => \App\Models\User::count(),
        ],
    ])
    ->register();
```

### Navigation Groups

```php
protected static ?string $navigationGroup = 'Management';

protected static ?int $navigationSort = 10;
```

### Custom Navigation

```php
Panel::make('admin')
    ->navigationBuilder(function (NavigationBuilder $builder) {
        return $builder
            ->items([
                NavigationItem::make('Dashboard')
                    ->icon('heroicon-o-home')
                    ->url('/admin'),

                NavigationItem::make('Users')
                    ->icon('heroicon-o-users')
                    ->url('/admin/users')
                    ->badge(fn () => User::count()),

                NavigationGroup::make('Settings')
                    ->items([
                        NavigationItem::make('General')
                            ->url('/admin/settings/general'),
                        NavigationItem::make('Security')
                            ->url('/admin/settings/security'),
                    ]),
            ]);
    })
    ->register();
```

## Layouts

### Default Layout

The default layout includes:
- Sidebar navigation
- Top bar with user menu
- Main content area
- Notifications

### Custom Layout Components

```php
Panel::make('admin')
    ->sidebarComponent('CustomSidebar')
    ->topbarComponent('CustomTopbar')
    ->register();
```

### Layout Props

Pass custom props to layout:

```php
protected function getLayoutProps(): array
{
    return [
        'showSidebar' => true,
        'sidebarCollapsible' => true,
        'theme' => 'dark',
    ];
}
```

## Middleware

### Global Middleware

```php
Panel::make('admin')
    ->middleware(['web', 'auth:admin', 'verified'])
    ->register();
```

### Page-Specific Middleware

```php
class SecurePage extends Page
{
    protected static array $middleware = ['two-factor'];
}
```

### Custom Panel Middleware

```php
namespace App\Http\Middleware;

class CheckPanelAccess
{
    public function handle($request, Closure $next, $panel)
    {
        $panelInstance = Panel::get($panel);

        if (!$panelInstance->canAccess(auth()->user())) {
            abort(403);
        }

        return $next($request);
    }
}
```

## Multi-Tenancy

### Tenant-Scoped Panels

```php
Panel::make('tenant')
    ->path('/tenant/{tenant}')
    ->middleware(['web', 'auth', 'tenant'])
    ->tenantMiddleware(function ($request, $next, $tenantId) {
        $tenant = Tenant::findOrFail($tenantId);

        // Set current tenant
        app()->instance('current_tenant', $tenant);

        // Scope queries
        Tenant::setCurrent($tenant);

        return $next($request);
    })
    ->register();
```

### Tenant-Aware Pages

```php
class TenantDashboard extends Page
{
    protected function getInertiaProps(): array
    {
        $tenant = app('current_tenant');

        return [
            'tenant' => $tenant,
            'users' => $tenant->users()->count(),
            'subscription' => $tenant->subscription,
        ];
    }
}
```

## Customization

### Custom Page Override

Replace any built-in page:

```php
Panel::make('admin')
    ->login(page: CustomLoginPage::class)
    ->register(page: CustomRegisterPage::class)
    ->register();
```

Custom page class:

```php
namespace App\Pages;

use Laravilt\Auth\Pages\Login as BaseLogin;

class CustomLoginPage extends BaseLogin
{
    protected ?string $component = 'CustomLoginPage';

    public function getHeading(): string
    {
        return 'Welcome Back!';
    }

    protected function getInertiaProps(): array
    {
        return array_merge(parent::getInertiaProps(), [
            'companyLogo' => asset('images/logo.png'),
            'features' => [
                'Secure login',
                'Two-factor authentication',
                'Password reset',
            ],
        ]);
    }
}
```

### Custom Theme

```php
Panel::make('admin')
    ->theme([
        'primary' => '#3b82f6',
        'secondary' => '#10b981',
        'danger' => '#ef4444',
    ])
    ->register();
```

### Custom Branding

```php
Panel::make('admin')
    ->brandName('My Admin Panel')
    ->brandLogo(asset('images/admin-logo.png'))
    ->brandUrl('/admin')
    ->favicon(asset('images/favicon.ico'))
    ->register();
```

## API Reference

### Panel Methods

```php
// Basic Configuration
Panel::make(string $id)                  // Create panel with ID
    ->path(string $path)                  // Set URL path
    ->authGuard(string $guard)            // Set auth guard
    ->middleware(array $middleware)       // Add middleware
    ->domain(string $domain)              // Set domain

// Authentication Features
    ->login(bool|string $page = true)     // Enable login
    ->registration(bool|string $page)     // Enable registration
    ->emailVerification()                 // Require email verification
    ->otp()                               // Enable OTP
    ->twoFactor(array $config)            // Enable 2FA
    ->passwordReset()                     // Enable password reset
    ->socialLogin(array $providers)       // Enable social auth
    ->passkeys()                          // Enable passkeys
    ->magicLinks()                        // Enable magic links

// Pages & Navigation
    ->pages(array $pages)                 // Register pages
    ->navigation(array $items)            // Set navigation
    ->navigationGroups(array $groups)     // Set navigation groups

// Branding
    ->brandName(string $name)             // Set brand name
    ->brandLogo(string $url)              // Set logo URL
    ->brandUrl(string $url)               // Set brand link
    ->favicon(string $url)                // Set favicon

// Advanced
    ->tenantMiddleware(Closure $callback) // Add tenant middleware
    ->beforeRegister(Closure $callback)   // Run before registration
    ->afterRegister(Closure $callback)    // Run after registration

// Registration
    ->register()                          // Register the panel
```

### Panel Facade

```php
use Laravilt\Panel\Facades\Panel;

// Get panel instance
$panel = Panel::get('admin');

// Get current panel
$current = Panel::getCurrent();

// Check if panel exists
Panel::has('admin'); // returns boolean

// Get all panels
$panels = Panel::all();

// Panel properties
$panel->getId();                    // Get panel ID
$panel->getPath();                  // Get URL path
$panel->getAuthGuard();             // Get auth guard
$panel->url($path = '');            // Generate panel URL
$panel->canAccess($user);           // Check if user can access
$panel->hasLogin();                 // Check if login enabled
$panel->hasRegistration();          // Check if registration enabled
```

### Page Methods

```php
// Override in your page class
protected static ?string $title;              // Page title
protected static ?string $slug;               // URL slug
protected static ?string $navigationIcon;     // Navigation icon
protected static ?string $navigationGroup;    // Navigation group
protected static ?int $navigationSort;        // Navigation sort order
protected static bool $shouldRegisterNavigation = true;

// Methods to override
public function getHeading(): string;         // Page heading
public function getSubheading(): ?string;     // Page subheading
public function getLayout(): string;          // Page layout
protected function getSchema(): array;        // Form schema
protected function getActions(): array;       // Page actions
protected function getInertiaProps(): array;  // Props for frontend
```

## Best Practices

### 1. Panel Organization

```php
// Group related panels in a PanelServiceProvider
namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Laravilt\Panel\Panel;

class PanelServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        $this->registerAdminPanel();
        $this->registerUserPanel();
    }

    protected function registerAdminPanel(): void
    {
        Panel::make('admin')
            ->path('/admin')
            ->authGuard('admin')
            ->login()
            ->pages([...])
            ->register();
    }

    protected function registerUserPanel(): void
    {
        Panel::make('app')
            ->path('/app')
            ->authGuard('web')
            ->login()
            ->pages([...])
            ->register();
    }
}
```

### 2. Page Organization

```
app/
  Pages/
    Admin/
      Dashboard.php
      Users/
        ListUsers.php
        EditUser.php
      Settings/
        GeneralSettings.php
    App/
      Dashboard.php
      Profile.php
```

### 3. Custom Pages

Always extend base pages when customizing:

```php
use Laravilt\Auth\Pages\Login as BaseLogin;

class CustomLogin extends BaseLogin
{
    // Only override what you need
}
```

### 4. Event Listeners

Listen to auth events for custom behavior:

```php
Event::listen(LoginSuccessful::class, function ($event) {
    // Track login
    // Send notification
    // Update last login
});
```

## Troubleshooting

### Panel Not Found

Ensure panel is registered in a service provider that's loaded:

```php
// config/app.php
'providers' => [
    App\Providers\PanelServiceProvider::class,
],
```

### Routes Not Working

Clear route cache:

```bash
php artisan route:clear
php artisan route:cache
```

### Middleware Issues

Check middleware priority and order:

```php
Panel::make('admin')
    ->middleware(['web', 'auth:admin']) // 'web' must come first
    ->register();
```

## Support

For issues, questions, or contributions:
- GitHub: https://github.com/laravilt/panel
- Documentation: https://laravilt.com/docs/panel
- Discord: https://discord.gg/laravilt
</file>

<file path="docs/mcp-server.md">
# MCP Server Integration

The Laravilt Panel package can be integrated with MCP (Model Context Protocol) server for AI agent interaction.

## Available Generator Commands

### laravilt:panel
Create a new panel with all necessary scaffolding.

**Usage:**
```bash
php artisan laravilt:panel admin
php artisan laravilt:panel tenant --path=/tenant/{tenant}
```

**Arguments:**
- `id` (string, required): Panel identifier (kebab-case recommended)

**Options:**
- `--path`: Custom URL path for the panel (defaults to `/{id}`)

**What It Generates:**
- Panel provider: `app/Providers/{StudlyId}PanelProvider.php`
- Pages directory: `app/Laravilt/{StudlyId}/Pages/`
- Resources directory: `app/Laravilt/{StudlyId}/Resources/`
- Widgets directory: `app/Laravilt/{StudlyId}/Widgets/`
- Dashboard page: `app/Laravilt/{StudlyId}/Pages/Dashboard.php`
- Vue dashboard: `resources/js/pages/{StudlyId}/Dashboard.vue`
- Auto-registers provider in `bootstrap/providers.php`

**Generated Provider Structure:**

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;use Laravilt\Panel\Panel;

class AdminPanelProvider extends ServiceProvider
{
    public function boot(): void
    {
        Panel::make('admin')
            ->path('/admin')
            ->login()
            ->registration()
            ->passwordReset()
            ->emailVerification()
            ->pages([
                \Admin\Pages\Dashboard::class,
            ])
            ->resources([
                // Register resources here
            ])
            ->register();
    }
}
```

### laravilt:page
Create a new page for a panel.

**Usage:**
```bash
php artisan laravilt:page admin Settings
php artisan laravilt:page admin Users/Profile
```

**Arguments:**
- `panel` (string, required): Panel name (StudlyCase)
- `name` (string, required): Page name (can include subdirectories)

**What It Generates:**
- PHP Page: `app/Laravilt/{Panel}/Pages/{Name}.php`
- Vue View: `resources/js/pages/{Panel}/{Name}.vue`

**Generated Page Structure:**
```php
<?php

namespace App\Laravilt\Admin\Pages;

use Laravilt\Panel\Pages\Page;

class Settings extends Page
{
    protected static ?string $title = 'Settings';

    protected static ?string $slug = 'settings';

    protected static ?string $navigationIcon = 'Settings';

    protected function getInertiaProps(): array
    {
        return [
            // Return page props here
        ];
    }
}
```

### laravilt:resource
Create a complete resource with CRUD pages from a database table.

**Usage:**
```bash
php artisan laravilt:resource
php artisan laravilt:resource admin --table=products
php artisan laravilt:resource admin --table=products --model=Product
```

**Arguments:**
- `panel` (string, optional): Panel name (interactive if not provided)

**Options:**
- `--table`: Database table to generate from
- `--model`: Custom model name (defaults to singular StudlyCase of table)

**Interactive Prompts:**
1. Select a panel (from available panels)
2. Search and select a database table
3. Review detected columns and relations
4. Choose to generate Grid view (optional)
5. Choose to generate API endpoints (optional)
6. Select API methods to generate

**What It Generates:**
- Model: `app/Models/{ModelName}.php` (if not exists)
- Resource: `app/Laravilt/{Panel}/Resources/{ModelName}/{ModelName}Resource.php`
- Form: `app/Laravilt/{Panel}/Resources/{ModelName}/Form/{ModelName}Form.php`
- Table: `app/Laravilt/{Panel}/Resources/{ModelName}/Table/{ModelName}Table.php`
- InfoList: `app/Laravilt/{Panel}/Resources/{ModelName}/InfoList/{ModelName}InfoList.php`
- Pages: List, Create, Edit, View
- Grid (optional): `app/Laravilt/{Panel}/Resources/{ModelName}/Grid/{ModelName}Grid.php`
- API (optional): `app/Laravilt/{Panel}/Resources/{ModelName}/Api/{ModelName}Api.php`

**Smart Features:**
- Auto-detects column types and generates appropriate form fields
- Detects foreign key relations (e.g., `user_id` -> `users` table)
- Generates BelongsTo relationships in models
- Maps table/model names to appropriate icons (100+ icon mappings)
- Handles JSON columns with KeyValue or Repeater components
- Recognizes special fields (email, url, phone, password, color, file)
- Generates proper validation rules
- Creates appropriate table columns with sorting/searching

## Integration Example

MCP server tools should provide:

1. **list-panels** - List all available panels
2. **panel-info** - Get details about a specific panel
3. **generate-panel** - Generate a new panel with configuration
4. **list-resources** - List all resources in a panel
5. **generate-resource** - Generate a resource from a table
6. **list-pages** - List all pages in a panel
7. **generate-page** - Generate a new page

## Panel Methods Reference

### Basic Configuration
```php
Panel::make(string $id)                  // Create panel with ID
    ->path(string $path)                  // Set URL path
    ->authGuard(string $guard)            // Set auth guard
    ->middleware(array $middleware)       // Add middleware
    ->domain(string $domain)              // Set domain
```

### Authentication Features
```php
    ->login(bool|string $page = true)     // Enable login
    ->registration(bool|string $page)     // Enable registration
    ->emailVerification()                 // Require email verification
    ->otp()                               // Enable OTP
    ->twoFactor(array $config)            // Enable 2FA
    ->passwordReset()                     // Enable password reset
    ->socialLogin(array $providers)       // Enable social auth
    ->passkeys()                          // Enable passkeys
    ->magicLinks()                        // Enable magic links
```

### Pages & Navigation
```php
    ->pages(array $pages)                 // Register pages
    ->resources(array $resources)         // Register resources
    ->navigation(array $items)            // Set navigation
    ->navigationGroups(array $groups)     // Set navigation groups
```

### Branding
```php
    ->brandName(string $name)             // Set brand name
    ->brandLogo(string $url)              // Set logo URL
    ->brandUrl(string $url)               // Set brand link
    ->favicon(string $url)                // Set favicon
```

## Resource Class Reference

### Properties
```php
protected static string $model;           // Model class
protected static ?string $table;          // Database table name
protected static ?string $navigationIcon; // Lucide icon name
protected static ?string $navigationGroup;// Navigation group
protected static int $navigationSort;     // Sort order
protected static bool $hasApi = false;    // Enable API endpoints
protected static bool $hasGrid = false;   // Enable grid view
```

### Methods
```php
public static function form(Schema $schema): Schema;
public static function table(Table $table): Table;
public static function infolist(Schema $schema): Schema;
public static function grid(Grid $grid): Grid;      // If hasGrid
public static function api(ApiResource $api): ApiResource; // If hasApi
public static function getPages(): array;
public static function getRelations(): array;
```

## Page Class Reference

### Properties
```php
protected static ?string $title;              // Page title
protected static ?string $slug;               // URL slug
protected static ?string $navigationIcon;     // Navigation icon
protected static ?string $navigationGroup;    // Navigation group
protected static ?int $navigationSort;        // Navigation sort order
protected static bool $shouldRegisterNavigation = true;
```

### Methods
```php
public function getHeading(): string;         // Page heading
public function getSubheading(): ?string;     // Page subheading
public function getLayout(): string;          // Page layout
protected function getSchema(): array;        // Form schema
protected function getActions(): array;       // Page actions
protected function getInertiaProps(): array;  // Props for frontend
public function getHeaderActions(): array;    // Header actions
```

## Icon Mapping

The resource generator includes smart icon mapping based on table/model names. Here are some examples:

| Keyword | Icon |
|---------|------|
| user, users | Users |
| customer | UserCircle |
| product | Package |
| order | ShoppingCart |
| payment | CreditCard |
| post, article | FileText |
| category | FolderTree |
| setting | Settings |
| notification | Bell |
| message | MessageSquare |
| project | FolderKanban |
| task | CheckSquare |
| event | Calendar |
| company | Building2 |
| report | FileBarChart |

## Security

The MCP server runs with the same permissions as your Laravel application. Ensure:
- Proper file permissions on the app/Laravilt directory
- Secure configuration of the MCP server
- Limited access to the MCP configuration file
- Validation of user inputs before passing to generators
</file>

<file path="resources/js/components/AppLogoIcon.vue">
<script setup lang="ts">
import type { HTMLAttributes } from 'vue';

defineOptions({
    inheritAttrs: false,
});

interface Props {
    className?: HTMLAttributes['class'];
}

defineProps<Props>();
</script>

<template>
    <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 40 42"
        :class="className"
        v-bind="$attrs"
    >
        <path
            fill="currentColor"
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M17.2 5.633 8.6.855 0 5.633v26.51l16.2 9 16.2-9v-8.442l7.6-4.223V9.856l-8.6-4.777-8.6 4.777V18.3l-5.6 3.111V5.633ZM38 18.301l-5.6 3.11v-6.157l5.6-3.11V18.3Zm-1.06-7.856-5.54 3.078-5.54-3.079 5.54-3.078 5.54 3.079ZM24.8 18.3v-6.157l5.6 3.111v6.158L24.8 18.3Zm-1 1.732 5.54 3.078-13.14 7.302-5.54-3.078 13.14-7.3v-.002Zm-16.2 7.89 7.6 4.222V38.3L2 30.966V7.92l5.6 3.111v16.892ZM8.6 9.3 3.06 6.222 8.6 3.143l5.54 3.08L8.6 9.3Zm21.8 15.51-13.2 7.334V38.3l13.2-7.334v-6.156ZM9.6 11.034l5.6-3.11v14.6l-5.6 3.11v-14.6Z"
        />
    </svg>
</template>
</file>

<file path="resources/js/components/LaraviltPage.vue">
<script setup lang="ts">
import { Head } from '@inertiajs/vue3'
import PanelLayout from '@laravilt/panel/layouts/PanelLayout.vue'

interface Props {
    page?: {
        heading?: string
        subheading?: string
        title?: string
    }
    breadcrumbs?: Array<{ title: string; href?: string }>
    panel?: {
        id: string
        path: string
        brandName: string
        brandLogo?: string
    }
}

const props = withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
})
</script>

<template>
    <Head :title="page?.title || page?.heading || 'Page'" />

    <PanelLayout :breadcrumbs="breadcrumbs">
        <div class="flex h-full flex-1 flex-col gap-4 p-4">
            <div v-if="page?.heading" class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-semibold">{{ page.heading }}</h1>
                    <p v-if="page.subheading" class="text-sm text-muted-foreground mt-1">
                        {{ page.subheading }}
                    </p>
                </div>
            </div>

            <!-- Page Content Slot -->
            <div class="flex-1">
                <slot />
            </div>
        </div>
    </PanelLayout>
</template>
</file>

<file path="resources/js/components/ManageRecords.vue">
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import Table from '@laravilt/tables/components/Table.vue'
import ActionButton from '@laravilt/actions/components/ActionButton.vue'
import * as LucideIcons from 'lucide-vue-next'

// Function to get Lucide icon component by name
const getIconComponent = (iconName: string | null | undefined) => {
    if (!iconName) return null
    const pascalCase = iconName
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join('')
    return (LucideIcons as any)[pascalCase] || null
}

interface ManageRecordsProps {
    resourceSlug: string
    panelId: string
    label: string
    pluralLabel: string
    icon?: string | null
    canView: boolean
    canCreate: boolean
    canEdit: boolean
    canDelete: boolean
    form: any
    infolist?: any
    table: any
    headerActions?: any[]
    queryRoute: string
}

const props = defineProps<ManageRecordsProps>()

// State for records
const records = ref<any[]>([])
const isLoading = ref(true)
const pagination = ref({
    total: 0,
    per_page: 10,
    current_page: 1,
    last_page: 1,
    from: 0,
    to: 0,
})

// Fetch records
const fetchRecords = async () => {
    isLoading.value = true
    try {
        const response = await fetch(props.queryRoute, {
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
        })

        if (response.ok) {
            const data = await response.json()
            records.value = data.data || []
            pagination.value = data.pagination || pagination.value
        }
    } catch (error) {
        console.error('Failed to fetch records:', error)
    } finally {
        isLoading.value = false
    }
}

// Refresh records after action completion
const handleActionComplete = () => {
    fetchRecords()
}

// Handle data loaded from Table component (for sorting/pagination)
const handleDataLoaded = (data: { records: any[], pagination: any }) => {
    records.value = data.records
    pagination.value = data.pagination
}

onMounted(() => {
    fetchRecords()
})
</script>

<template>
    <div class="manage-records">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <component
                    v-if="icon && getIconComponent(icon)"
                    :is="getIconComponent(icon)"
                    class="h-6 w-6 text-muted-foreground"
                />
                <div>
                    <h2 class="text-2xl font-bold tracking-tight">{{ pluralLabel }}</h2>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-2">
                <ActionButton
                    v-for="action in headerActions"
                    :key="action.name"
                    v-bind="action"
                    @action-complete="handleActionComplete"
                />
            </div>
        </div>

        <!-- Loading State (Shimmer Skeleton) -->
        <div v-if="isLoading" class="space-y-4">
            <!-- Toolbar skeleton -->
            <div class="flex items-center justify-between gap-4 py-2">
                <div class="h-10 w-80 bg-muted/60 rounded animate-pulse"></div>
                <div class="flex gap-2">
                    <div class="h-10 w-24 bg-muted/60 rounded animate-pulse" style="animation-delay: 50ms"></div>
                    <div class="h-10 w-24 bg-muted/60 rounded animate-pulse" style="animation-delay: 100ms"></div>
                </div>
            </div>
            <!-- Table skeleton -->
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-muted/30 px-4 py-3 flex gap-4">
                    <div class="h-4 w-8 bg-muted/60 rounded animate-pulse"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" style="animation-delay: 50ms"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" style="animation-delay: 100ms"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" style="animation-delay: 150ms"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" style="animation-delay: 200ms"></div>
                    <div class="h-4 w-20 bg-muted/60 rounded animate-pulse" style="animation-delay: 250ms"></div>
                </div>
                <div v-for="i in 8" :key="i" class="px-4 py-4 flex gap-4 border-t">
                    <div class="h-4 w-8 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30}ms` }"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30 + 50}ms` }"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30 + 100}ms` }"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30 + 150}ms` }"></div>
                    <div class="h-4 w-1/5 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30 + 200}ms` }"></div>
                    <div class="h-4 w-20 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 30 + 250}ms` }"></div>
                </div>
            </div>
            <!-- Pagination skeleton -->
            <div class="flex items-center justify-between py-2">
                <div class="h-4 w-32 bg-muted/60 rounded animate-pulse"></div>
                <div class="flex gap-2">
                    <div class="h-9 w-9 bg-muted/60 rounded animate-pulse"></div>
                    <div class="h-9 w-9 bg-muted/60 rounded animate-pulse" style="animation-delay: 50ms"></div>
                    <div class="h-9 w-9 bg-muted/60 rounded animate-pulse" style="animation-delay: 100ms"></div>
                    <div class="h-9 w-9 bg-muted/60 rounded animate-pulse" style="animation-delay: 150ms"></div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div v-else-if="records.length > 0">
            <Table
                :table="table"
                :records="records"
                :pagination="pagination"
                :resource-slug="resourceSlug"
                :query-route="queryRoute"
                :use-ajax="true"
                current-view="table"
                @action-complete="handleActionComplete"
                @data-loaded="handleDataLoaded"
            />
        </div>

        <!-- Empty State -->
        <div v-else class="flex flex-col items-center justify-center py-16 border rounded-lg bg-muted/10">
            <component
                v-if="icon && getIconComponent(icon)"
                :is="getIconComponent(icon)"
                class="h-12 w-12 text-muted-foreground/50 mb-4"
            />
            <h3 class="text-lg font-medium text-muted-foreground">No {{ pluralLabel.toLowerCase() }} found</h3>
            <p class="text-sm text-muted-foreground/70 mt-1">Get started by creating a new {{ label.toLowerCase() }}.</p>
        </div>
    </div>
</template>
</file>

<file path="resources/js/components/PanelPageLayout.vue">
<template>
    <!-- Slot mode for Blade usage -->
    <slot v-if="$slots.default" />

    <!-- Direct Vue mode -->
    <AppShell v-else variant="sidebar">
        <PanelSidebar
            :navigation="navigation"
            :panel="panel"
            :user="user"
        />
        <AppContent variant="sidebar" class="overflow-x-hidden">
            <AppSidebarHeader :breadcrumbs="breadcrumbs" />

            <div class="flex h-full flex-1 flex-col gap-4 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold">{{ heading }}</h1>
                        <p v-if="subheading" class="text-sm text-muted-foreground mt-1">
                            {{ subheading }}
                        </p>
                    </div>

                    <!-- Header actions placeholder -->
                    <div v-if="headerActions && headerActions.length">
                        <!-- TODO: Render header actions when actions package is ready -->
                    </div>
                </div>

                <!-- Page Content Area -->
                <div class="flex-1">
                    <div v-if="content" v-html="content" />
                    <slot v-else name="content">
                        <div class="flex h-full items-center justify-center rounded-lg border border-dashed p-8">
                            <div class="text-center">
                                <h3 class="text-lg font-semibold">Custom Page Content</h3>
                                <p class="text-sm text-muted-foreground mt-2">
                                    This is a standalone page. You can add custom components and content here.
                                </p>
                            </div>
                        </div>
                    </slot>
                </div>
            </div>
        </AppContent>
    </AppShell>
</template>

<script setup lang="ts">
import { useSlots } from 'vue'
import AppShell from '@/components/AppShell.vue'
import AppContent from '@/components/AppContent.vue'
import AppSidebarHeader from '@/components/AppSidebarHeader.vue'
import PanelSidebar from './PanelSidebar.vue'

const slots = useSlots()

interface BreadcrumbItem {
    title: string
    href: string
}

const props = defineProps<{
    breadcrumbs?: BreadcrumbItem[]
    heading?: string
    subheading?: string | null
    headerActions?: any[]
    content?: string | null
    navigation?: any[]
    panel?: {
        id: string
        path: string
        brandName: string
        brandLogo?: string
    }
    user?: {
        name: string
        email: string
    }
}>()
</script>
</file>

<file path="resources/js/components/RelationManager.vue">
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { router } from '@inertiajs/vue3'
import Table from '@laravilt/tables/components/Table.vue'
import ActionButton from '@laravilt/actions/components/ActionButton.vue'
import { useLocalization } from '@laravilt/support/composables'
import * as LucideIcons from 'lucide-vue-next'

const { trans } = useLocalization()

// Function to get Lucide icon component by name
const getIconComponent = (iconName: string | null | undefined) => {
    if (!iconName) return null
    // Convert icon name to PascalCase (e.g., 'star' -> 'Star', 'file-text' -> 'FileText')
    const pascalCase = iconName
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join('')
    return (LucideIcons as any)[pascalCase] || null
}

interface RelationManagerProps {
    relationship: string
    label: string
    pluralLabel: string
    icon?: string | null
    recordTitleAttribute?: string | null
    readOnly: boolean
    canCreate: boolean
    canEdit: boolean
    canDelete: boolean
    form: any
    infolist?: any
    table: any
    headerActions?: any[]
    ownerRecordId: string | number
    resourceSlug: string
    panelId: string
}

const props = defineProps<RelationManagerProps>()

// State for records
const records = ref<any[]>([])
const isLoading = ref(true)
const pagination = ref({
    total: 0,
    per_page: 10,
    current_page: 1,
    last_page: 1,
    from: 0,
    to: 0,
})

// Build the query route for the relation
const queryRoute = computed(() => {
    return `/${props.panelId}/${props.resourceSlug}/${props.ownerRecordId}/relations/${props.relationship}`
})

// Configure header actions with the correct URL for submission
const configuredHeaderActions = computed(() => {
    if (!props.headerActions) return []

    return props.headerActions.map(action => ({
        ...action,
        url: queryRoute.value, // Set URL for the action to submit to
        useAjax: true, // Use fetch instead of Inertia to avoid page reload
    }))
})

// Configure record actions with proper URLs for view/edit/delete
const configuredRecordActions = computed(() => {
    const actions: any[] = []

    // Get record actions from table config
    const tableRecordActions = props.table?.recordActions || []

    // Process each action and configure URLs
    tableRecordActions.forEach((action: any) => {
        if (action.name === 'view') {
            actions.push({
                ...action,
                // URL will be set per-record in the Table component
                useAjax: true,
                requiresConfirmation: true,
                modalHeading: trans('actions::actions.buttons.view') + ' ' + props.label,
                // Use infolist schema if available, otherwise fall back to form schema
                modalInfolistSchema: props.infolist?.schema || null,
                modalFormSchema: props.infolist?.schema ? null : props.form?.schema || [],
                modalSubmitActionLabel: null, // No submit button for view
                modalCancelActionLabel: trans('actions::actions.buttons.close'),
                isViewOnly: true, // Flag to indicate view-only mode
                modalWidth: 'lg', // Larger modal for view
            })
        } else if (action.name === 'edit' && props.canEdit) {
            actions.push({
                ...action,
                // URL will be set per-record in the Table component
                useAjax: true,
                method: 'PUT',
                requiresConfirmation: true,
                modalHeading: trans('actions::actions.buttons.edit') + ' ' + props.label,
                modalFormSchema: props.form?.schema || [],
                modalSubmitActionLabel: trans('actions::actions.buttons.save'),
                modalCancelActionLabel: trans('actions::actions.buttons.cancel'),
                modalWidth: 'lg', // Larger modal for edit
            })
        } else if (action.name === 'delete' && props.canDelete) {
            actions.push({
                ...action,
                useAjax: true,
                method: 'DELETE',
                requiresConfirmation: true,
                modalHeading: trans('actions::actions.buttons.delete') + ' ' + props.label,
                modalDescription: trans('actions::actions.confirm_delete_description'),
                modalSubmitActionLabel: trans('actions::actions.buttons.delete'),
                modalCancelActionLabel: trans('actions::actions.buttons.cancel'),
            })
        } else {
            // Pass through other actions as-is
            actions.push({
                ...action,
                useAjax: true,
            })
        }
    })

    return actions
})

// Configure bulk actions with proper URL
const configuredBulkActions = computed(() => {
    const actions: any[] = []

    // Get bulk actions from table config
    const tableBulkActions = props.table?.bulkActions || []

    tableBulkActions.forEach((action: any) => {
        if (action.name === 'delete' || action.name === 'bulk-delete') {
            actions.push({
                ...action,
                url: `${queryRoute.value}/bulk-delete`,
                useAjax: true,
                method: 'POST',
                requiresConfirmation: true,
                modalHeading: trans('actions::actions.buttons.delete') + ' ' + props.pluralLabel,
                modalDescription: trans('actions::actions.confirm_bulk_delete_description'),
                modalSubmitActionLabel: trans('actions::actions.buttons.delete'),
                modalCancelActionLabel: trans('actions::actions.buttons.cancel'),
            })
        } else {
            actions.push({
                ...action,
                useAjax: true,
            })
        }
    })

    return actions
})

// Fetch relation records
const fetchRecords = async () => {
    isLoading.value = true
    try {
        const response = await fetch(queryRoute.value, {
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
        })

        if (response.ok) {
            const data = await response.json()
            records.value = data.data || []
            pagination.value = data.pagination || pagination.value
        }
    } catch (error) {
        console.error('Failed to fetch relation records:', error)
    } finally {
        isLoading.value = false
    }
}

// Refresh records after action completion
const handleActionComplete = () => {
    fetchRecords()
}

// Handle data loaded from Table component (for sorting/pagination)
const handleDataLoaded = (data: { records: any[], pagination: any }) => {
    records.value = data.records
    pagination.value = data.pagination
}

onMounted(() => {
    fetchRecords()
})
</script>

<template>
    <div class="relation-manager">
        <!-- Relation Manager Header -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <component
                    v-if="icon && getIconComponent(icon)"
                    :is="getIconComponent(icon)"
                    class="h-5 w-5 text-muted-foreground"
                />
                <h3 class="text-lg font-semibold">{{ pluralLabel }}</h3>
            </div>

            <!-- Header Actions (Create button with modal) -->
            <div class="flex items-center gap-2">
                <ActionButton
                    v-for="action in configuredHeaderActions"
                    :key="action.name"
                    v-bind="action"
                    @action-complete="handleActionComplete"
                />
            </div>
        </div>

        <!-- Loading State (Shimmer Skeleton) -->
        <div v-if="isLoading" class="space-y-4">
            <!-- Table header skeleton -->
            <div class="flex items-center justify-between gap-4 py-2">
                <div class="h-9 w-64 bg-muted/60 rounded animate-pulse"></div>
                <div class="h-9 w-32 bg-muted/60 rounded animate-pulse"></div>
            </div>
            <!-- Table rows skeleton -->
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-muted/30 px-4 py-3 flex gap-4">
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" style="animation-delay: 75ms"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" style="animation-delay: 150ms"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" style="animation-delay: 225ms"></div>
                </div>
                <div v-for="i in 5" :key="i" class="px-4 py-3 flex gap-4 border-t">
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 50}ms` }"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 50 + 75}ms` }"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 50 + 150}ms` }"></div>
                    <div class="h-4 w-1/4 bg-muted/60 rounded animate-pulse" :style="{ animationDelay: `${i * 50 + 225}ms` }"></div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div v-else-if="records.length > 0">
            <Table
                :table="table"
                :records="records"
                :pagination="pagination"
                :record-actions="configuredRecordActions"
                :bulk-actions="configuredBulkActions"
                :resource-slug="resourceSlug"
                :query-route="queryRoute"
                current-view="table"
                :use-ajax="true"
                :relation-context="{ baseUrl: queryRoute, relationship, canEdit, canDelete, columnExecutionRoute: `${queryRoute}/__ID__/column` }"
                @data-loaded="handleDataLoaded"
                @action-complete="handleActionComplete"
            />
        </div>

        <!-- Empty State -->
        <div v-else class="flex flex-col items-center justify-center py-12 text-center border border-dashed rounded-lg">
            <component
                :is="getIconComponent(icon) || LucideIcons.Inbox"
                class="h-12 w-12 text-muted-foreground mb-4"
            />
            <h4 class="text-sm font-medium text-muted-foreground">
                {{ trans('table.no_data') }}
            </h4>
            <div v-if="configuredHeaderActions.length > 0" class="mt-4">
                <ActionButton
                    v-for="action in configuredHeaderActions"
                    :key="action.name"
                    v-bind="action"
                    @action-complete="handleActionComplete"
                />
            </div>
        </div>
    </div>
</template>
</file>

<file path="resources/js/components/RelationManagers.vue">
<script setup lang="ts">
import { ref, computed } from 'vue'
import * as LucideIcons from 'lucide-vue-next'
import RelationManager from './RelationManager.vue'
import { useLocalization } from '@laravilt/support/composables'

const { trans } = useLocalization()

// Function to get Lucide icon component by name
const getIconComponent = (iconName: string | null | undefined) => {
    if (!iconName) return null
    // Convert icon name to PascalCase (e.g., 'star' -> 'Star', 'file-text' -> 'FileText')
    const pascalCase = iconName
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join('')
    return (LucideIcons as any)[pascalCase] || null
}

interface RelationManagerData {
    relationship: string
    label: string
    pluralLabel: string
    icon?: string | null
    recordTitleAttribute?: string | null
    readOnly: boolean
    canCreate: boolean
    canEdit: boolean
    canDelete: boolean
    form: any
    infolist?: any
    table: any
    headerActions?: any[]
}

interface RelationManagersProps {
    relationManagers: RelationManagerData[]
    ownerRecordId: string | number
    resourceSlug: string
    panelId: string
}

const props = defineProps<RelationManagersProps>()

// Active tab state
const activeTab = ref<string>(props.relationManagers[0]?.relationship || '')

// Computed for tab items
const tabs = computed(() => {
    return props.relationManagers.map(rm => ({
        key: rm.relationship,
        label: rm.pluralLabel,
        icon: rm.icon,
    }))
})

// Get current relation manager
const currentRelationManager = computed(() => {
    return props.relationManagers.find(rm => rm.relationship === activeTab.value)
})
</script>

<template>
    <div v-if="relationManagers && relationManagers.length > 0" class="relation-managers mt-8">
        <!-- Tabs Header -->
        <div class="border-b">
            <nav class="flex space-x-4 overflow-x-auto" aria-label="Relation Tabs">
                <button
                    v-for="tab in tabs"
                    :key="tab.key"
                    type="button"
                    @click="activeTab = tab.key"
                    :class="[
                        'flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap',
                        activeTab === tab.key
                            ? 'border-primary text-primary'
                            : 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground/50'
                    ]"
                >
                    <component
                        v-if="tab.icon && getIconComponent(tab.icon)"
                        :is="getIconComponent(tab.icon)"
                        class="h-4 w-4"
                    />
                    {{ tab.label }}
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="py-6">
            <RelationManager
                v-if="currentRelationManager"
                :key="currentRelationManager.relationship"
                :relationship="currentRelationManager.relationship"
                :label="currentRelationManager.label"
                :plural-label="currentRelationManager.pluralLabel"
                :icon="currentRelationManager.icon"
                :record-title-attribute="currentRelationManager.recordTitleAttribute"
                :read-only="currentRelationManager.readOnly"
                :can-create="currentRelationManager.canCreate"
                :can-edit="currentRelationManager.canEdit"
                :can-delete="currentRelationManager.canDelete"
                :form="currentRelationManager.form"
                :infolist="currentRelationManager.infolist"
                :table="currentRelationManager.table"
                :header-actions="currentRelationManager.headerActions"
                :owner-record-id="ownerRecordId"
                :resource-slug="resourceSlug"
                :panel-id="panelId"
            />
        </div>
    </div>
</template>
</file>

<file path="resources/js/components/SettingsPageSkeleton.vue">
<script setup lang="ts">
import { Skeleton } from '@/components/ui/skeleton';
</script>

<template>
    <div class="max-w-2xl space-y-6">
        <!-- Page Header Skeleton -->
        <header class="space-y-2">
            <Skeleton class="h-6 w-48" />
            <Skeleton class="h-4 w-80" />
        </header>

        <!-- Content Skeleton -->
        <div class="space-y-6">
            <!-- Card/Section Skeleton -->
            <div class="flex items-start gap-3">
                <Skeleton class="h-10 w-10 rounded-lg shrink-0" />
                <div class="flex-1 space-y-2">
                    <Skeleton class="h-5 w-32" />
                    <Skeleton class="h-4 w-full max-w-md" />
                </div>
            </div>

            <!-- Form Fields Skeleton -->
            <div class="space-y-4">
                <div class="space-y-2">
                    <Skeleton class="h-4 w-24" />
                    <Skeleton class="h-10 w-full" />
                </div>
                <div class="space-y-2">
                    <Skeleton class="h-4 w-24" />
                    <Skeleton class="h-10 w-full" />
                </div>
            </div>

            <!-- Action Button Skeleton -->
            <Skeleton class="h-10 w-32" />
        </div>
    </div>
</template>
</file>

<file path="resources/js/layouts/AppLayout.vue">
<script setup lang="ts">
import AppLayout from '@laravilt/panel/layouts/app/AppSidebarLayout.vue';
import type { BreadcrumbItemType } from '@laravilt/support/types';

interface Props {
    breadcrumbs?: BreadcrumbItemType[];
}

withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
});
</script>

<template>
    <AppLayout :breadcrumbs="breadcrumbs">
        <slot />
    </AppLayout>
</template>
</file>

<file path="resources/js/pages/laravilt/Dashboard.vue">
<script setup lang="ts">
import { Head } from '@inertiajs/vue3';
import { computed, markRaw } from 'vue';
import PanelLayout from '../../layouts/PanelLayout.vue';
import WidgetRenderer from '@laravilt/widgets/components/WidgetRenderer.vue';

const PanelLayoutRaw = markRaw(PanelLayout);

interface BreadcrumbItem {
    label: string;
    url: string | null;
}

interface WidgetData {
    component: string;
    stats?: any[];
    columns?: number;
    [key: string]: any;
}

const props = defineProps<{
    title?: string;
    breadcrumbs?: BreadcrumbItem[];
    headerWidgets?: WidgetData[];
    footerWidgets?: WidgetData[];
}>();

// Transform breadcrumbs to frontend format
const transformedBreadcrumbs = computed(() => {
    if (!props.breadcrumbs) return [];
    return props.breadcrumbs.map(item => ({
        title: item.label,
        href: item.url || '#',
    }));
});
</script>

<template>
    <Head :title="title || 'Dashboard'" />

    <PanelLayoutRaw :breadcrumbs="transformedBreadcrumbs">
        <div class="flex flex-1 flex-col gap-6 p-4">
            <!-- Header Widgets -->
            <WidgetRenderer
                v-if="headerWidgets && headerWidgets.length"
                :widgets="headerWidgets"
            />

            <!-- Main Content Area (for extending) -->
            <slot />

            <!-- Footer Widgets -->
            <WidgetRenderer
                v-if="footerWidgets && footerWidgets.length"
                :widgets="footerWidgets"
            />
        </div>
    </PanelLayoutRaw>
</template>
</file>

<file path="resources/js/pages/laravilt/ManageRecords.vue">
<script setup lang="ts">
import { Head } from '@inertiajs/vue3'
import ManageRecordsComponent from '../../components/ManageRecords.vue'
import PanelLayout from '../../layouts/PanelLayout.vue'
import { computed, markRaw } from 'vue'

const PanelLayoutRaw = markRaw(PanelLayout)

interface BreadcrumbItem {
    label: string
    url: string | null
}

const props = defineProps<{
    page: {
        heading: string
        subheading?: string | null
        headerActions: any[]
        actionUrl?: string
    }
    breadcrumbs?: BreadcrumbItem[]
    panelId?: string
    resourceSlug: string
    label: string
    pluralLabel: string
    icon?: string | null
    canView: boolean
    canCreate: boolean
    canEdit: boolean
    canDelete: boolean
    form: any
    infolist?: any
    table: any
    headerActions?: any[]
    queryRoute: string
}>()

// Use breadcrumbs from props (backend) or fallback to simple default
const breadcrumbs = computed<BreadcrumbItem[]>(() => {
    if (props.breadcrumbs && props.breadcrumbs.length > 0) {
        return props.breadcrumbs
    }
    // Fallback: simple Dashboard  Current Page
    return [
        {
            label: 'Dashboard',
            url: `/${props.panelId}`,
        },
        {
            label: props.page.heading,
            url: null,
        },
    ]
})

// Transform breadcrumbs to frontend format (label/url  title/href)
const transformedBreadcrumbs = computed(() => {
    return breadcrumbs.value.map(item => ({
        title: item.label,
        href: item.url || '#',
    }))
})
</script>

<template>
    <Head :title="page.heading" />

    <component :is="PanelLayoutRaw" :breadcrumbs="transformedBreadcrumbs">
        <div class="flex flex-1 flex-col gap-4 p-4 min-h-0 overflow-hidden max-h-[calc(100vh-4rem)]">
            <!-- Page Content Area -->
            <div class="flex-1 min-h-0 flex flex-col overflow-y-auto">
                <ManageRecordsComponent
                    :resource-slug="resourceSlug"
                    :panel-id="panelId || ''"
                    :label="label"
                    :plural-label="pluralLabel"
                    :icon="icon"
                    :can-view="canView"
                    :can-create="canCreate"
                    :can-edit="canEdit"
                    :can-delete="canDelete"
                    :form="form"
                    :infolist="infolist"
                    :table="table"
                    :header-actions="headerActions"
                    :query-route="queryRoute"
                />
            </div>
        </div>
    </component>
</template>
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Panel Web Routes
|--------------------------------------------------------------------------
|
| Here is where you can register web routes for your plugin. These
| routes are loaded by the ServiceProvider within a group which
| contains the "web" middleware group.
|
*/

Route::middleware(['web'])->group(function () {
    // Add your web routes here
    // Example:
    // Route::get('/panel', function () {
    //     return view('panel::index');
    // });
});
</file>

<file path="src/Commands/InstallCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;

class InstallCommand extends Command
{
    protected $signature = 'panel:install {--force : Overwrite existing files}';

    protected $description = 'Install Laravilt Panel stubs and setup application';

    public function handle(): int
    {
        $this->info('Installing Laravilt Panel...');

        // Publish middleware
        $this->publishMiddleware();

        // Publish layouts
        $this->publishLayouts();

        // Publish bootstrap files
        $this->publishBootstrap();

        // Publish route files
        $this->publishRoutes();

        $this->newLine();
        $this->info(' Laravilt Panel installed successfully!');
        $this->info(' Run: php artisan make:panel admin to create your first panel.');

        return self::SUCCESS;
    }

    protected function publishMiddleware(): void
    {
        $this->copyStub(
            __DIR__.'/../../stubs/Middleware/HandleInertiaRequests.stub',
            app_path('Http/Middleware/HandleInertiaRequests.php')
        );

        $this->copyStub(
            __DIR__.'/../../stubs/Middleware/HandleAppearance.stub',
            app_path('Http/Middleware/HandleAppearance.php')
        );

        $this->components->info('Middleware published');
    }

    protected function publishLayouts(): void
    {
        $layouts = [
            'AppLayout.vue',
            'AuthLayout.vue',
            'app/AppSidebarLayout.vue',
            'app/AppHeaderLayout.vue',
            'auth/AuthSimpleLayout.vue',
            'auth/AuthSplitLayout.vue',
            'auth/AuthCardLayout.vue',
            'settings/Layout.vue',
        ];

        foreach ($layouts as $layout) {
            $stubPath = __DIR__."/../../stubs/layouts/{$layout}.stub";
            $targetPath = resource_path("js/layouts/{$layout}");

            $this->copyStub($stubPath, $targetPath);
        }

        $this->components->info('Layouts published');
    }

    protected function publishBootstrap(): void
    {
        // Only overwrite if force flag is set or user confirms
        if ($this->option('force') || $this->confirm('Overwrite bootstrap/app.php?', false)) {
            $this->copyStub(
                __DIR__.'/../../stubs/bootstrap/app.stub',
                base_path('bootstrap/app.php')
            );
            $this->components->info('Bootstrap app.php published');
        } else {
            $this->components->warn('Skipped bootstrap/app.php (already exists)');
        }

        // Publish providers if doesn't exist
        if (! File::exists(base_path('bootstrap/providers.php')) || $this->option('force')) {
            $this->copyStub(
                __DIR__.'/../../stubs/bootstrap/providers.stub',
                base_path('bootstrap/providers.php')
            );
            $this->components->info('Bootstrap providers.php published');
        } else {
            $this->components->warn('Skipped bootstrap/providers.php (already exists)');
        }
    }

    protected function publishRoutes(): void
    {
        // Publish web routes if doesn't exist
        if (! File::exists(base_path('routes/web.php')) || $this->option('force')) {
            $this->copyStub(
                __DIR__.'/../../stubs/routes/web.stub',
                base_path('routes/web.php')
            );
            $this->components->info('Route web.php published');
        } else {
            $this->components->warn('Skipped routes/web.php (already exists)');
        }

        // Publish settings routes
        $this->copyStub(
            __DIR__.'/../../stubs/routes/settings.stub',
            base_path('routes/settings.php')
        );
        $this->components->info('Route settings.php published');
    }

    protected function copyStub(string $from, string $to): void
    {
        $dir = dirname($to);

        if (! File::isDirectory($dir)) {
            File::makeDirectory($dir, 0755, true);
        }

        $content = file_get_contents($from);
        file_put_contents($to, $content);
    }
}
</file>

<file path="src/Commands/MakeClusterCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\GeneratorCommand;
use Illuminate\Support\Str;

class MakeClusterCommand extends GeneratorCommand
{
    protected $signature = 'laravilt:cluster {panel} {name}
                            {--icon=Folder : The navigation icon for the cluster}
                            {--sort=0 : The navigation sort order}
                            {--group= : The navigation group}';

    protected $description = 'Create a new panel cluster to group related pages';

    protected $type = 'Cluster';

    /**
     * Get the stub file for the generator.
     */
    protected function getStub(): string
    {
        return __DIR__.'/../../stubs/cluster.stub';
    }

    /**
     * Get the default namespace for the class.
     */
    protected function getDefaultNamespace($rootNamespace): string
    {
        $panel = Str::studly($this->argument('panel'));

        return $rootNamespace."\\Laravilt\\{$panel}\\Clusters";
    }

    /**
     * Build the class with the given name.
     */
    protected function buildClass($name): string
    {
        $stub = parent::buildClass($name);

        $clusterName = $this->argument('name');
        $label = Str::title(Str::snake($clusterName, ' '));
        $icon = $this->option('icon') ?: 'Folder';
        $sort = $this->option('sort') ?: 0;
        $group = $this->option('group') ? "'{$this->option('group')}'" : 'null';

        $replacements = [
            '{{ icon }}' => $icon,
            '{{ label }}' => $label,
            '{{ sort }}' => $sort,
            '{{ group }}' => $group,
        ];

        return str_replace(
            array_keys($replacements),
            array_values($replacements),
            $stub
        );
    }

    /**
     * Get the console command arguments.
     */
    protected function getArguments(): array
    {
        return [
            ['panel', \Symfony\Component\Console\Input\InputArgument::REQUIRED, 'The panel to create the cluster in'],
            ['name', \Symfony\Component\Console\Input\InputArgument::REQUIRED, 'The name of the cluster'],
        ];
    }
}
</file>

<file path="src/Concerns/HasBranding.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;

trait HasBranding
{
    protected string|Closure|null $brandName = null;

    protected string|Closure|null $brandLogo = null;

    protected string|Closure|null $brandLogoHeight = null;

    protected string|Closure|null $favicon = null;

    /**
     * Set the brand name.
     */
    public function brandName(string|Closure|null $name): static
    {
        $this->brandName = $name;

        return $this;
    }

    /**
     * Get the brand name.
     */
    public function getBrandName(): ?string
    {
        return $this->evaluate($this->brandName) ?? config('app.name');
    }

    /**
     * Set the brand logo.
     */
    public function brandLogo(string|Closure|null $logo): static
    {
        $this->brandLogo = $logo;

        return $this;
    }

    /**
     * Get the brand logo.
     */
    public function getBrandLogo(): ?string
    {
        return $this->evaluate($this->brandLogo);
    }

    /**
     * Set the brand logo height.
     */
    public function brandLogoHeight(string|Closure|null $height): static
    {
        $this->brandLogoHeight = $height;

        return $this;
    }

    /**
     * Get the brand logo height.
     */
    public function getBrandLogoHeight(): string
    {
        return $this->evaluate($this->brandLogoHeight) ?? '2rem';
    }

    /**
     * Set the favicon.
     */
    public function favicon(string|Closure|null $favicon): static
    {
        $this->favicon = $favicon;

        return $this;
    }

    /**
     * Get the favicon.
     */
    public function getFavicon(): ?string
    {
        return $this->evaluate($this->favicon);
    }
}
</file>

<file path="src/Concerns/HasClusters.php">
<?php

namespace Laravilt\Panel\Concerns;

use Illuminate\Support\Facades\File;
use ReflectionClass;
use Symfony\Component\Finder\SplFileInfo;

trait HasClusters
{
    protected array $clusters = [];

    protected array $clusterDirectories = [];

    /**
     * Register clusters.
     */
    public function clusters(array $clusters): static
    {
        $this->clusters = array_merge($this->clusters, $clusters);

        return $this;
    }

    /**
     * Get registered clusters.
     */
    public function getClusters(): array
    {
        return $this->clusters;
    }

    /**
     * Discover clusters in a directory.
     */
    public function discoverClusters(string $in, string $for): static
    {
        $this->clusterDirectories[] = [
            'directory' => $in,
            'namespace' => $for,
        ];

        return $this;
    }

    /**
     * Boot clusters - discover and register.
     */
    protected function bootClusters(): void
    {
        foreach ($this->clusterDirectories as $config) {
            if (! is_dir($config['directory'])) {
                continue;
            }

            $clusters = collect(File::allFiles($config['directory']))
                ->filter(fn (SplFileInfo $file) => $file->getExtension() === 'php')
                ->map(function (SplFileInfo $file) use ($config) {
                    $class = $config['namespace'].'\\'.
                        str_replace(
                            ['/', '.php'],
                            ['\\', ''],
                            $file->getRelativePathname()
                        );

                    if (! class_exists($class)) {
                        return;
                    }

                    $reflection = new ReflectionClass($class);

                    if ($reflection->isAbstract() || $reflection->isInterface()) {
                        return;
                    }

                    // Check if it's a Cluster class
                    if (! $reflection->isSubclassOf(\Laravilt\Panel\Cluster::class)) {
                        return;
                    }

                    return $class;
                })
                ->filter()
                ->all();

            $this->clusters(array_merge($this->clusters, $clusters));
        }
    }
}
</file>

<file path="src/Concerns/HasColors.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;
use Laravilt\Support\Colors\Color;

trait HasColors
{
    protected array|Closure $colors = [];

    /**
     * Set the panel colors.
     */
    public function colors(array|Closure $colors): static
    {
        $this->colors = $colors;

        return $this;
    }

    /**
     * Get the panel colors.
     */
    public function getColors(): array
    {
        $colors = $this->evaluate($this->colors);

        return array_map(function ($color) {
            if ($color instanceof Color) {
                return $color->getValue();
            }

            return $color;
        }, $colors);
    }

    /**
     * Get a specific color.
     */
    public function getColor(string $name): ?string
    {
        return $this->getColors()[$name] ?? null;
    }

    /**
     * Evaluate a closure or return the value.
     */
    protected function evaluate(mixed $value): mixed
    {
        if ($value instanceof Closure) {
            return $value();
        }

        return $value;
    }
}
</file>

<file path="src/Concerns/HasId.php">
<?php

namespace Laravilt\Panel\Concerns;

trait HasId
{
    protected string $id;

    /**
     * Set the panel ID.
     */
    public function id(string $id): static
    {
        $this->id = $id;

        return $this;
    }

    /**
     * Get the panel ID.
     */
    public function getId(): string
    {
        return $this->id;
    }
}
</file>

<file path="src/Concerns/HasMiddleware.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;

trait HasMiddleware
{
    protected array|Closure $middleware = [];

    protected array|Closure $authMiddleware = [];

    protected string|Closure|null $authGuard = null;

    /**
     * Set the panel middleware.
     */
    public function middleware(array|Closure $middleware): static
    {
        $this->middleware = $middleware;

        return $this;
    }

    /**
     * Get the panel middleware.
     */
    public function getMiddleware(): array
    {
        return $this->evaluate($this->middleware);
    }

    /**
     * Set the auth middleware.
     */
    public function authMiddleware(array|Closure $middleware): static
    {
        $this->authMiddleware = $middleware;

        return $this;
    }

    /**
     * Get the auth middleware.
     */
    public function getAuthMiddleware(): array
    {
        return $this->evaluate($this->authMiddleware);
    }

    /**
     * Set the auth guard.
     */
    public function authGuard(string|Closure|null $guard): static
    {
        $this->authGuard = $guard;

        return $this;
    }

    /**
     * Get the auth guard.
     */
    public function getAuthGuard(): ?string
    {
        return $this->evaluate($this->authGuard);
    }
}
</file>

<file path="src/Concerns/HasNavigation.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;
use Laravilt\Panel\Navigation\NavigationBuilder;
use Laravilt\Panel\Navigation\UserMenu;

trait HasNavigation
{
    protected ?Closure $navigationCallback = null;

    protected ?Closure $userMenuCallback = null;

    /**
     * Set the navigation callback.
     */
    public function navigation(Closure $callback): static
    {
        $this->navigationCallback = $callback;

        return $this;
    }

    /**
     * Get the navigation.
     */
    public function getNavigation(): array
    {
        if ($this->navigationCallback) {
            $builder = new NavigationBuilder;
            $builder->panel($this);
            call_user_func($this->navigationCallback, $builder);

            return collect($builder->get())
                ->map(fn ($item) => $item->toArray())
                ->all();
        }

        // Build from pages and resources
        return collect(NavigationBuilder::fromPagesAndResources(
            $this->getPages(),
            $this->getResources(),
            $this
        )->get())
            ->map(fn ($item) => $item->toArray())
            ->all();
    }

    /**
     * Set the user menu callback.
     */
    public function userMenu(Closure $callback): static
    {
        $this->userMenuCallback = $callback;

        return $this;
    }

    /**
     * Get the user menu.
     */
    public function getUserMenu(): array
    {
        $menuItems = [];

        if ($this->userMenuCallback) {
            $menu = new UserMenu;
            call_user_func($this->userMenuCallback, $menu);
            $menuItems = $menu->toArray();
        } else {
            $menuItems = UserMenu::default()->toArray();
        }

        // Add AI menu items if AI is configured
        if (method_exists($this, 'getAIMenuItems')) {
            $aiItems = $this->getAIMenuItems();
            if (! empty($aiItems)) {
                $aiMenuItems = collect($aiItems)->map(fn ($item) => $item->toArray())->all();
                // Insert AI items before the last item (logout)
                if (count($menuItems) > 0) {
                    array_splice($menuItems, -1, 0, $aiMenuItems);
                } else {
                    $menuItems = array_merge($menuItems, $aiMenuItems);
                }
            }
        }

        return $menuItems;
    }

    /**
     * Boot navigation.
     */
    protected function bootNavigation(): void
    {
        // Navigation is built on-demand
    }
}
</file>

<file path="src/Concerns/HasNotifications.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Concerns;

use Closure;

trait HasNotifications
{
    protected bool $hasDatabaseNotifications = false;

    protected string|Closure|null $databaseNotificationsPolling = '30s';

    protected bool $hasApiNotifications = false;

    /**
     * Enable database notifications for this panel.
     */
    public function databaseNotifications(bool $condition = true): static
    {
        $this->hasDatabaseNotifications = $condition;

        return $this;
    }

    /**
     * Check if database notifications are enabled.
     */
    public function hasDatabaseNotifications(): bool
    {
        return $this->hasDatabaseNotifications;
    }

    /**
     * Set the polling interval for database notifications.
     */
    public function databaseNotificationsPolling(string|Closure|null $interval): static
    {
        $this->databaseNotificationsPolling = $interval;

        return $this;
    }

    /**
     * Get the polling interval for database notifications.
     */
    public function getDatabaseNotificationsPolling(): ?string
    {
        if ($this->databaseNotificationsPolling instanceof Closure) {
            return ($this->databaseNotificationsPolling)();
        }

        return $this->databaseNotificationsPolling;
    }

    /**
     * Enable API notifications endpoints.
     */
    public function apiNotifications(bool $condition = true): static
    {
        $this->hasApiNotifications = $condition;

        return $this;
    }

    /**
     * Check if API notifications are enabled.
     */
    public function hasApiNotifications(): bool
    {
        return $this->hasApiNotifications;
    }

    /**
     * Register notification routes for this panel.
     */
    protected function registerNotificationRoutes(): void
    {
        if (! $this->hasDatabaseNotifications && ! $this->hasApiNotifications) {
            return;
        }

        $panelPath = $this->getPath();
        $panelId = $this->getId();

        \Illuminate\Support\Facades\Route::middleware($this->getMiddleware())
            ->prefix($panelPath.'/notifications')
            ->name($panelId.'.notifications.')
            ->group(function () {
                $controller = \Laravilt\Notifications\Http\Controllers\NotificationController::class;

                \Illuminate\Support\Facades\Route::get('/', [$controller, 'index'])->name('index');
                \Illuminate\Support\Facades\Route::get('/unread', [$controller, 'unread'])->name('unread');
                \Illuminate\Support\Facades\Route::post('/{id}/read', [$controller, 'markAsRead'])->name('mark-as-read');
                \Illuminate\Support\Facades\Route::post('/read-all', [$controller, 'markAllAsRead'])->name('mark-all-as-read');
                \Illuminate\Support\Facades\Route::delete('/{id}', [$controller, 'destroy'])->name('destroy');
                \Illuminate\Support\Facades\Route::delete('/', [$controller, 'destroyAll'])->name('destroy-all');
            });
    }
}
</file>

<file path="src/Concerns/HasPages.php">
<?php

namespace Laravilt\Panel\Concerns;

use Illuminate\Support\Facades\File;
use ReflectionClass;
use Symfony\Component\Finder\SplFileInfo;

trait HasPages
{
    protected array $pages = [];

    protected array $pageDirectories = [];

    /**
     * Register a page.
     */
    public function pages(array $pages): static
    {
        $this->pages = array_merge($this->pages, $pages);

        return $this;
    }

    /**
     * Get registered pages.
     */
    public function getPages(): array
    {
        return $this->pages;
    }

    /**
     * Discover pages in a directory.
     */
    public function discoverPages(string $in, string $for): static
    {
        $this->pageDirectories[] = [
            'directory' => $in,
            'namespace' => $for,
        ];

        return $this;
    }

    /**
     * Boot pages - discover and register.
     */
    protected function bootPages(): void
    {
        foreach ($this->pageDirectories as $config) {
            if (! is_dir($config['directory'])) {
                continue;
            }

            $pages = collect(File::allFiles($config['directory']))
                ->filter(fn (SplFileInfo $file) => $file->getExtension() === 'php')
                ->map(function (SplFileInfo $file) use ($config) {
                    $class = $config['namespace'].'\\'.
                        str_replace(
                            ['/', '.php'],
                            ['\\', ''],
                            $file->getRelativePathname()
                        );

                    if (! class_exists($class)) {
                        return;
                    }

                    $reflection = new ReflectionClass($class);

                    if ($reflection->isAbstract() || $reflection->isInterface()) {
                        return;
                    }

                    return $class;
                })
                ->filter()
                ->all();

            $this->pages = array_unique(array_merge($this->pages, $pages));
        }
    }
}
</file>

<file path="src/Concerns/HasPath.php">
<?php

namespace Laravilt\Panel\Concerns;

trait HasPath
{
    protected string $path;

    /**
     * Set the panel path.
     */
    public function path(string $path): static
    {
        $this->path = trim($path, '/');

        return $this;
    }

    /**
     * Get the panel path.
     */
    public function getPath(): string
    {
        return $this->path;
    }

    /**
     * Get the full URL path for this panel.
     */
    public function getUrl(string $path = ''): string
    {
        $url = '/'.$this->path;

        if ($path) {
            $url .= '/'.ltrim($path, '/');
        }

        return $url;
    }
}
</file>

<file path="src/Concerns/HasTenancy.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;

trait HasTenancy
{
    protected string|Closure|null $tenantModel = null;

    protected string|Closure|null $tenantOwnershipRelationship = null;

    protected mixed $tenantBillingProvider = null;

    protected bool $isTenancyEnabled = false;

    /**
     * Enable tenancy for this panel.
     */
    public function tenancy(string|Closure|null $tenantModel = null): static
    {
        $this->isTenancyEnabled = true;
        $this->tenantModel = $tenantModel;

        return $this;
    }

    /**
     * Set the tenant model for this panel.
     */
    public function tenant(string|Closure|null $tenantModel): static
    {
        $this->isTenancyEnabled = true;
        $this->tenantModel = $tenantModel;

        return $this;
    }

    /**
     * Set the tenant ownership relationship.
     */
    public function tenantOwnershipRelationship(string|Closure|null $relationship): static
    {
        $this->tenantOwnershipRelationship = $relationship;

        return $this;
    }

    /**
     * Set the tenant billing provider.
     */
    public function tenantBillingProvider(mixed $provider): static
    {
        $this->tenantBillingProvider = $provider;

        return $this;
    }

    /**
     * Check if tenancy is enabled.
     */
    public function hasTenancy(): bool
    {
        return $this->isTenancyEnabled;
    }

    /**
     * Get the tenant model.
     */
    public function getTenantModel(): ?string
    {
        return $this->evaluate($this->tenantModel);
    }

    /**
     * Get the tenant ownership relationship.
     */
    public function getTenantOwnershipRelationship(): ?string
    {
        return $this->evaluate($this->tenantOwnershipRelationship);
    }

    /**
     * Get the tenant billing provider.
     */
    public function getTenantBillingProvider(): mixed
    {
        return $this->tenantBillingProvider;
    }
}
</file>

<file path="src/Concerns/HasWidgets.php">
<?php

namespace Laravilt\Panel\Concerns;

use Illuminate\Support\Facades\File;
use ReflectionClass;
use Symfony\Component\Finder\SplFileInfo;

trait HasWidgets
{
    protected array $widgets = [];

    protected array $widgetDirectories = [];

    /**
     * Register widgets.
     */
    public function widgets(array $widgets): static
    {
        $this->widgets = array_merge($this->widgets, $widgets);

        return $this;
    }

    /**
     * Get registered widgets.
     */
    public function getWidgets(): array
    {
        return $this->widgets;
    }

    /**
     * Discover widgets in a directory.
     */
    public function discoverWidgets(string $in, string $for): static
    {
        $this->widgetDirectories[] = [
            'directory' => $in,
            'namespace' => $for,
        ];

        return $this;
    }

    /**
     * Boot widgets - discover and register.
     */
    protected function bootWidgets(): void
    {
        foreach ($this->widgetDirectories as $config) {
            if (! is_dir($config['directory'])) {
                continue;
            }

            $widgets = collect(File::allFiles($config['directory']))
                ->filter(fn (SplFileInfo $file) => $file->getExtension() === 'php')
                ->map(function (SplFileInfo $file) use ($config) {
                    $class = $config['namespace'].'\\'.
                        str_replace(
                            ['/', '.php'],
                            ['\\', ''],
                            $file->getRelativePathname()
                        );

                    if (! class_exists($class)) {
                        return;
                    }

                    $reflection = new ReflectionClass($class);

                    if ($reflection->isAbstract() || $reflection->isInterface()) {
                        return;
                    }

                    return $class;
                })
                ->filter()
                ->all();

            $this->widgets(array_merge($this->widgets, $widgets));
        }
    }
}
</file>

<file path="src/Contracts/HasPanel.php">
<?php

namespace Laravilt\Panel\Contracts;

use Laravilt\Panel\Panel;

interface HasPanel
{
    /**
     * Set the panel instance.
     */
    public function panel(Panel $panel): static;

    /**
     * Get the panel instance.
     */
    public function getPanel(): Panel;
}
</file>

<file path="src/Enums/PageLayout.php">
<?php

namespace Laravilt\Panel\Enums;

enum PageLayout: string
{
    case Panel = 'panel';
    case Card = 'card';
    case Simple = 'simple';
    case Full = 'full';
    case Settings = 'settings';
}
</file>

<file path="src/Facades/Panel.php">
<?php

namespace Laravilt\Panel\Facades;

use Illuminate\Support\Facades\Facade;
use Laravilt\Panel\PanelRegistry;

/**
 * @method static \Laravilt\Panel\Panel|null get(string $id)
 * @method static \Illuminate\Support\Collection all()
 * @method static \Laravilt\Panel\Panel|null getDefault()
 * @method static \Laravilt\Panel\Panel|null getCurrent()
 * @method static bool has(string $id)
 * @method static void setCurrent(string $id)
 *
 * @see \Laravilt\Panel\PanelRegistry
 */
class Panel extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return PanelRegistry::class;
    }
}
</file>

<file path="src/FontProviders/FontProvider.php">
<?php

namespace Laravilt\Panel\FontProviders;

interface FontProvider
{
    /**
     * Get the font family name for CSS.
     */
    public function getFamily(): string;

    /**
     * Get the URL to load the font from.
     */
    public function getUrl(): string;

    /**
     * Get the font weights to load.
     */
    public function getWeights(): array;

    /**
     * Convert the font provider to an array.
     */
    public function toArray(): array;
}
</file>

<file path="src/FontProviders/GoogleFontProvider.php">
<?php

namespace Laravilt\Panel\FontProviders;

class GoogleFontProvider implements FontProvider
{
    protected string $family;

    protected array $weights = [400, 500, 600, 700];

    protected ?string $display = 'swap';

    protected array $subsets = ['latin'];

    /**
     * Create a new Google Font provider instance.
     */
    public function __construct(string $family)
    {
        $this->family = $family;
    }

    /**
     * Create a new Google Font provider instance.
     */
    public static function make(string $family): static
    {
        return new static($family);
    }

    /**
     * Set the font weights to load.
     */
    public function weights(array $weights): static
    {
        $this->weights = $weights;

        return $this;
    }

    /**
     * Set the font display strategy.
     */
    public function display(string $display): static
    {
        $this->display = $display;

        return $this;
    }

    /**
     * Set the font subsets to load.
     */
    public function subsets(array $subsets): static
    {
        $this->subsets = $subsets;

        return $this;
    }

    /**
     * Get the font family name for CSS.
     */
    public function getFamily(): string
    {
        return $this->family;
    }

    /**
     * Get the URL to load the font from.
     * Uses fonts.bunny.net (GDPR-compliant alternative to Google Fonts).
     */
    public function getUrl(): string
    {
        // Format: https://fonts.bunny.net/css?family=Inter:400,500,600,700&display=swap
        $familySlug = str_replace(' ', '+', $this->family);
        $weights = implode(',', $this->weights);

        $url = "https://fonts.bunny.net/css?family={$familySlug}:{$weights}";

        if ($this->display) {
            $url .= "&display={$this->display}";
        }

        return $url;
    }

    /**
     * Get the URL for Google Fonts directly.
     * Use this if you prefer Google Fonts over Bunny.net.
     */
    public function getGoogleUrl(): string
    {
        // Format: https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap
        $familySlug = str_replace(' ', '+', $this->family);
        $weights = implode(';', $this->weights);

        $url = "https://fonts.googleapis.com/css2?family={$familySlug}:wght@{$weights}";

        if ($this->display) {
            $url .= "&display={$this->display}";
        }

        return $url;
    }

    /**
     * Get the font weights to load.
     */
    public function getWeights(): array
    {
        return $this->weights;
    }

    /**
     * Get the font subsets.
     */
    public function getSubsets(): array
    {
        return $this->subsets;
    }

    /**
     * Get the font display strategy.
     */
    public function getDisplay(): ?string
    {
        return $this->display;
    }

    /**
     * Convert the font provider to an array.
     */
    public function toArray(): array
    {
        return [
            'provider' => 'google',
            'family' => $this->family,
            'url' => $this->getUrl(),
            'weights' => $this->weights,
            'subsets' => $this->subsets,
            'display' => $this->display,
        ];
    }
}
</file>

<file path="src/Http/Controllers/LocaleController.php">
<?php

namespace Laravilt\Panel\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Routing\Controller;

class LocaleController extends Controller
{
    /**
     * Update the user's locale.
     */
    public function update(Request $request)
    {
        $request->validate([
            'locale' => ['required', 'string', 'max:10'],
        ]);

        $user = $request->user();

        if ($user) {
            $locale = $request->input('locale');

            \Log::info('Updating user locale', [
                'user_id' => $user->id,
                'old_locale' => $user->locale,
                'new_locale' => $locale,
            ]);

            $user->update([
                'locale' => $locale,
            ]);

            \Log::info('Locale updated successfully', [
                'user_id' => $user->id,
                'current_locale' => $user->fresh()->locale,
            ]);
        }

        return back();
    }
}
</file>

<file path="src/Mcp/Tools/ListPanelFeaturesTool.php">
<?php

namespace Laravilt\Panel\Mcp\Tools;

use Illuminate\JsonSchema\JsonSchema;
use Laravel\Mcp\Request;
use Laravel\Mcp\Response;
use Laravel\Mcp\Server\Tool;

class ListPanelFeaturesTool extends Tool
{
    protected string $description = 'List all available panel features with their configuration options';

    protected array $features = [
        'Basic Configuration' => [
            'description' => 'Core panel setup and URL configuration',
            'methods' => [
                'Panel::make(string $id)' => 'Create a new panel with ID',
                '->path(string $path)' => 'Set URL path (e.g., /admin)',
                '->domain(string $domain)' => 'Set custom domain',
                '->authGuard(string $guard)' => 'Set authentication guard',
                '->middleware(array $middleware)' => 'Add middleware stack',
            ],
            'example' => "Panel::make('admin')\n    ->path('/admin')\n    ->authGuard('web')\n    ->middleware(['auth', 'verified']);",
        ],
        'Authentication' => [
            'description' => 'Login, registration, and authentication features',
            'methods' => [
                '->login(bool|string $page = true)' => 'Enable login page',
                '->registration(bool|string $page)' => 'Enable registration',
                '->emailVerification()' => 'Require email verification',
                '->otp()' => 'Enable OTP verification',
                '->twoFactor(array $config)' => 'Enable 2FA',
                '->passwordReset()' => 'Enable password reset',
                '->socialLogin(array $providers)' => 'Enable social auth',
                '->passkeys()' => 'Enable passkey authentication',
                '->magicLinks()' => 'Enable magic link login',
            ],
            'example' => "->login()\n->registration()\n->passwordReset()\n->twoFactor()\n->socialLogin(['github', 'google'])",
        ],
        'Navigation' => [
            'description' => 'Sidebar navigation configuration',
            'methods' => [
                '->navigation(array $items)' => 'Set navigation items',
                '->navigationGroups(array $groups)' => 'Define navigation groups',
            ],
            'example' => "->navigationGroups([\n    'Content',\n    'Settings',\n])",
        ],
        'Pages & Resources' => [
            'description' => 'Register pages and CRUD resources',
            'methods' => [
                '->pages(array $pages)' => 'Register custom pages',
                '->resources(array $resources)' => 'Register CRUD resources',
                '->widgets(array $widgets)' => 'Register dashboard widgets',
            ],
            'example' => "->pages([\n    Dashboard::class,\n    Settings::class,\n])\n->resources([\n    UserResource::class,\n    ProductResource::class,\n])",
        ],
        'Branding' => [
            'description' => 'Customize panel appearance',
            'methods' => [
                '->brandName(string $name)' => 'Set brand name',
                '->brandLogo(string $url)' => 'Set logo URL',
                '->brandUrl(string $url)' => 'Set brand link',
                '->favicon(string $url)' => 'Set favicon',
            ],
            'example' => "->brandName('My Admin')\n->brandLogo('/images/logo.svg')\n->favicon('/favicon.ico')",
        ],
        'Multi-tenancy' => [
            'description' => 'Tenant-aware panel configuration',
            'methods' => [
                '->tenant(Model $model)' => 'Set tenant model',
                '->tenantMiddleware(array $middleware)' => 'Add tenant middleware',
                '->tenantRegistration()' => 'Enable tenant registration',
            ],
            'example' => "->tenant(Team::class)\n->tenantRegistration()\n->tenantMiddleware(['tenant.verified'])",
        ],
    ];

    public function handle(Request $request): Response
    {
        $output = " Laravilt Panel - Available Features\n\n";
        $output .= str_repeat('=', 70)."\n\n";

        foreach ($this->features as $name => $details) {
            $output .= "## {$name}\n\n";
            $output .= "{$details['description']}\n\n";
            $output .= "Methods:\n";
            foreach ($details['methods'] as $method => $desc) {
                $output .= "   `{$method}` - {$desc}\n";
            }
            $output .= "\nExample:\n```php\n{$details['example']}\n```\n\n";
            $output .= str_repeat('-', 70)."\n\n";
        }

        $output .= "\n## Generator Commands\n\n";
        $output .= "Create a new panel:\n";
        $output .= "```bash\nphp artisan laravilt:panel admin\nphp artisan laravilt:panel tenant --path=/tenant/{tenant}\n```\n\n";
        $output .= "Create a page:\n";
        $output .= "```bash\nphp artisan laravilt:page admin Settings\nphp artisan laravilt:page admin Users/Profile\n```\n\n";
        $output .= "Create a resource:\n";
        $output .= "```bash\nphp artisan laravilt:resource admin --table=products\nphp artisan laravilt:resource admin --table=orders --model=Order\n```\n";

        return Response::text($output);
    }

    public function schema(JsonSchema $schema): array
    {
        return [];
    }
}
</file>

<file path="src/Mcp/Tools/SearchDocsTool.php">
<?php

namespace Laravilt\Panel\Mcp\Tools;

use Illuminate\JsonSchema\JsonSchema;
use Illuminate\Support\Facades\File;
use Laravel\Mcp\Request;
use Laravel\Mcp\Response;
use Laravel\Mcp\Server\Tool;

class SearchDocsTool extends Tool
{
    protected string $description = 'Search the Laravilt Panel documentation to understand panel features, resources, pages, and configuration';

    public function handle(Request $request): Response
    {
        $query = $request->string('query');
        $packagePath = base_path('packages/laravilt/panel');

        $docFiles = $this->getDocumentationFiles($packagePath);
        $results = $this->searchDocumentation($docFiles, $query);

        if (empty($results)) {
            return Response::text("No documentation found matching '{$query}'.\n\nTry searching for: panel, resource, page, navigation, widgets, middleware, branding, multi-tenancy, authentication");
        }

        $output = " Panel Documentation Search: {$query}\n\n";
        $output .= 'Found '.count($results)." relevant section(s):\n\n";

        foreach ($results as $result) {
            $output .= " {$result['file']}\n";
            $output .= str_repeat('=', 70)."\n\n";
            $output .= $result['content']."\n\n";
            $output .= str_repeat('-', 70)."\n\n";
        }

        return Response::text($output);
    }

    public function schema(JsonSchema $schema): array
    {
        return [
            'query' => $schema->string()
                ->description('Search query (e.g., "resource generation", "navigation groups", "panel middleware", "page actions")')
                ->required(),
        ];
    }

    protected function getDocumentationFiles(string $path): array
    {
        $files = [];

        if (File::exists($path.'/README.md')) {
            $files[] = [
                'path' => $path.'/README.md',
                'name' => 'README.md',
                'content' => File::get($path.'/README.md'),
            ];
        }

        $docsPath = $path.'/docs';
        if (File::isDirectory($docsPath)) {
            foreach (File::allFiles($docsPath) as $file) {
                if ($file->getExtension() === 'md') {
                    $relativePath = str_replace($path.'/', '', $file->getPathname());
                    $files[] = [
                        'path' => $file->getPathname(),
                        'name' => $relativePath,
                        'content' => File::get($file->getPathname()),
                    ];
                }
            }
        }

        return $files;
    }

    protected function searchDocumentation(array $files, string $query): array
    {
        $results = [];
        $queryLower = strtolower($query);
        $keywords = explode(' ', $queryLower);

        foreach ($files as $file) {
            $content = $file['content'];
            $contentLower = strtolower($content);

            $matchCount = 0;
            foreach ($keywords as $keyword) {
                if (stripos($contentLower, $keyword) !== false) {
                    $matchCount++;
                }
            }

            if ($matchCount > 0) {
                $sections = $this->extractRelevantSections($content, $query, $keywords);
                foreach ($sections as $section) {
                    $results[] = [
                        'file' => $file['name'],
                        'content' => $section,
                        'relevance' => $matchCount,
                    ];
                }
            }
        }

        usort($results, fn ($a, $b) => $b['relevance'] <=> $a['relevance']);

        return array_slice($results, 0, 5);
    }

    protected function extractRelevantSections(string $content, string $query, array $keywords): array
    {
        $sections = [];
        $lines = explode("\n", $content);
        $currentSection = '';
        $currentHeader = '';
        $inRelevantSection = false;

        foreach ($lines as $line) {
            if (preg_match('/^#+\s+(.+)$/', $line, $matches)) {
                if ($inRelevantSection && ! empty(trim($currentSection))) {
                    $sections[] = trim($currentHeader."\n\n".$currentSection);
                }

                $currentHeader = $line;
                $currentSection = '';
                $headerLower = strtolower($matches[1]);
                $inRelevantSection = false;
                foreach ($keywords as $keyword) {
                    if (stripos($headerLower, $keyword) !== false) {
                        $inRelevantSection = true;
                        break;
                    }
                }
            } else {
                $currentSection .= $line."\n";
                if (! $inRelevantSection) {
                    $lineLower = strtolower($line);
                    foreach ($keywords as $keyword) {
                        if (stripos($lineLower, $keyword) !== false) {
                            $inRelevantSection = true;
                            break;
                        }
                    }
                }
            }
        }

        if ($inRelevantSection && ! empty(trim($currentSection))) {
            $sections[] = trim($currentHeader."\n\n".$currentSection);
        }

        return $sections;
    }
}
</file>

<file path="src/Mcp/LaraviltPanelServer.php">
<?php

namespace Laravilt\Panel\Mcp;

use Laravel\Mcp\Server;
use Laravilt\Panel\Mcp\Tools\GetResourceInfoTool;
use Laravilt\Panel\Mcp\Tools\ListPanelFeaturesTool;
use Laravilt\Panel\Mcp\Tools\SearchDocsTool;

class LaraviltPanelServer extends Server
{
    protected string $name = 'Laravilt Panel';

    protected string $version = '1.0.0';

    protected string $instructions = <<<'MARKDOWN'
        This server provides admin panel capabilities for Laravilt projects.

        You can:
        - Search panel documentation
        - List available panel features and configuration options
        - Get information about resources, pages, and navigation
        - Generate panels, resources, and pages using artisan commands

        Available generator commands:
        - php artisan laravilt:panel {id} --path={path}
        - php artisan laravilt:page {panel} {name}
        - php artisan laravilt:resource {panel} --table={table}

        Panel supports resources, pages, widgets, navigation groups, multi-tenancy, and authentication integration.
    MARKDOWN;

    protected array $tools = [
        SearchDocsTool::class,
        ListPanelFeaturesTool::class,
        GetResourceInfoTool::class,
    ];
}
</file>

<file path="src/Middleware/IdentifyPanel.php">
<?php

namespace Laravilt\Panel\Middleware;

use Closure;
use Illuminate\Http\Request;
use Laravilt\Panel\PanelRegistry;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class IdentifyPanel
{
    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, Closure $next, string $panelId): Response
    {
        $registry = app(PanelRegistry::class);

        if (! $registry->has($panelId)) {
            throw new NotFoundHttpException("Panel '{$panelId}' not found.");
        }

        $panel = $registry->get($panelId);

        // Set the current panel
        $registry->setCurrent($panelId);

        // Store panel in request
        $request->attributes->set('panel', $panel);

        // Set auth guard if specified
        if ($guard = $panel->getAuthGuard()) {
            auth()->shouldUse($guard);
        }

        return $next($request);
    }
}
</file>

<file path="src/Navigation/NavigationBuilder.php">
<?php

namespace Laravilt\Panel\Navigation;

use Closure;
use Laravilt\Panel\Panel;

class NavigationBuilder
{
    protected array $groups = [];

    protected array $items = [];

    protected ?Panel $panel = null;

    /**
     * Set the panel instance.
     */
    public function panel(Panel $panel): static
    {
        $this->panel = $panel;

        return $this;
    }

    /**
     * Add a navigation group.
     */
    public function group(string $label, array|Closure $items): static
    {
        $this->groups[] = NavigationGroup::make($label)
            ->items($this->evaluate($items));

        return $this;
    }

    /**
     * Add a navigation item.
     */
    public function item(NavigationItem|string $item): static
    {
        if (is_string($item)) {
            $item = NavigationItem::make($item);
        }

        $this->items[] = $item;

        return $this;
    }

    /**
     * Add multiple navigation items.
     */
    public function items(array $items): static
    {
        foreach ($items as $item) {
            $this->item($item);
        }

        return $this;
    }

    /**
     * Get all navigation groups.
     */
    public function getGroups(): array
    {
        return $this->groups;
    }

    /**
     * Get all navigation items (ungrouped).
     */
    public function getItems(): array
    {
        return $this->items;
    }

    /**
     * Get all navigation (groups + items).
     */
    public function get(): array
    {
        $navigation = [];

        // Add ungrouped items first
        foreach ($this->items as $item) {
            $navigation[] = $item;
        }

        // Add groups
        foreach ($this->groups as $group) {
            $navigation[] = $group;
        }

        return $navigation;
    }

    /**
     * Build from pages.
     */
    public static function fromPages(array $pages, Panel $panel): static
    {
        return static::fromPagesAndResources($pages, [], $panel);
    }

    /**
     * Build from pages and resources.
     */
    public static function fromPagesAndResources(array $pages, array $resources, Panel $panel): static
    {
        $builder = new static;
        $builder->panel($panel);

        // Combine pages and resources for navigation
        $navigationItems = collect($pages)
            ->filter(function ($page) {
                // Skip clusters - they don't register in navigation
                if (is_subclass_of($page, \Laravilt\Panel\Cluster::class)) {
                    return false;
                }

                return $page::shouldRegisterNavigation();
            });

        // Add resources to navigation items
        $resourceItems = collect($resources)
            ->filter(fn ($resource) => $resource::isNavigationVisible());

        // Merge and group by navigation group
        $grouped = $navigationItems
            ->merge($resourceItems)
            ->groupBy(fn ($item) => $item::getNavigationGroup() ?? '__ungrouped')
            ->map(function ($items, $group) {
                return $items->sortBy(fn ($item) => $item::getNavigationSort());
            });

        // Add ungrouped items
        if ($grouped->has('__ungrouped')) {
            foreach ($grouped->get('__ungrouped') as $item) {
                $builder->item(
                    NavigationItem::make($item::getLabel())
                        ->icon($item::getNavigationIcon())
                        ->url($item::getUrl($panel))
                        ->sort($item::getNavigationSort())
                );
            }

            $grouped->forget('__ungrouped');
        }

        // Add grouped items
        foreach ($grouped as $groupLabel => $items) {
            $groupItems = [];

            foreach ($items as $item) {
                $groupItems[] = NavigationItem::make($item::getLabel())
                    ->icon($item::getNavigationIcon())
                    ->url($item::getUrl($panel))
                    ->sort($item::getNavigationSort());
            }

            $builder->group($groupLabel, $groupItems);
        }

        return $builder;
    }

    /**
     * Evaluate a closure or return the value.
     */
    protected function evaluate(mixed $value): mixed
    {
        if ($value instanceof Closure) {
            return $value();
        }

        return $value;
    }
}
</file>

<file path="src/Navigation/NavigationGroup.php">
<?php

namespace Laravilt\Panel\Navigation;

use Closure;
use Illuminate\Contracts\Support\Arrayable;

class NavigationGroup implements Arrayable
{
    protected string|Closure $label;

    protected array $items = [];

    protected bool|Closure $collapsible = true;

    protected bool|Closure $collapsed = true;

    protected ?string $icon = null;

    /**
     * Make a new navigation group.
     */
    public static function make(string|Closure $label): static
    {
        $group = new static;
        $group->label = $label;

        return $group;
    }

    /**
     * Set the group items.
     */
    public function items(array $items): static
    {
        $this->items = $items;

        return $this;
    }

    /**
     * Get the group items.
     */
    public function getItems(): array
    {
        return $this->items;
    }

    /**
     * Set whether the group is collapsible.
     */
    public function collapsible(bool|Closure $condition = true): static
    {
        $this->collapsible = $condition;

        return $this;
    }

    /**
     * Check if the group is collapsible.
     */
    public function isCollapsible(): bool
    {
        return $this->evaluate($this->collapsible);
    }

    /**
     * Set whether the group is collapsed by default.
     */
    public function collapsed(bool|Closure $condition = true): static
    {
        $this->collapsed = $condition;

        return $this;
    }

    /**
     * Check if the group is collapsed.
     */
    public function isCollapsed(): bool
    {
        return $this->evaluate($this->collapsed);
    }

    /**
     * Set the group icon.
     */
    public function icon(?string $icon): static
    {
        $this->icon = $icon;

        return $this;
    }

    /**
     * Get the group icon.
     */
    public function getIcon(): ?string
    {
        return $this->icon;
    }

    /**
     * Get the group label.
     */
    public function getLabel(): string
    {
        return $this->evaluate($this->label);
    }

    /**
     * Convert to array.
     */
    public function toArray(): array
    {
        return [
            'type' => 'group',
            'title' => $this->getLabel(),  // Frontend expects 'title'
            'icon' => $this->getIcon(),
            'collapsible' => $this->isCollapsible(),
            'collapsed' => $this->isCollapsed(),
            'items' => collect($this->items)
                ->map(fn ($item) => $item->toArray())
                ->all(),
        ];
    }

    /**
     * Evaluate a closure or return the value.
     */
    protected function evaluate(mixed $value): mixed
    {
        if ($value instanceof Closure) {
            return $value();
        }

        return $value;
    }
}
</file>

<file path="src/Theme/ThemeManager.php">
<?php

namespace Laravilt\Panel\Theme;

use Laravilt\Panel\Panel;

class ThemeManager
{
    /**
     * Generate CSS variables for the panel.
     */
    public static function generateCssVariables(Panel $panel): string
    {
        $colors = $panel->getColors();
        $primaryColor = $colors['primary'] ?? '#6366f1';

        // Convert hex to RGB for Tailwind
        [$r, $g, $b] = sscanf($primaryColor, '#%02x%02x%02x');

        $css = ":root {\n";
        $css .= "    --color-primary: {$r} {$g} {$b};\n";

        // Add font if specified
        if ($font = $panel->getFont()) {
            $css .= "    --font-sans: '{$font}', ui-sans-serif, system-ui, sans-serif;\n";
        }

        $css .= "}\n";

        return $css;
    }

    /**
     * Generate Tailwind config for the panel.
     */
    public static function generateTailwindConfig(Panel $panel): array
    {
        $colors = $panel->getColors();

        return [
            'theme' => [
                'extend' => [
                    'colors' => [
                        'primary' => [
                            50 => 'rgb(var(--color-primary) / 0.05)',
                            100 => 'rgb(var(--color-primary) / 0.1)',
                            200 => 'rgb(var(--color-primary) / 0.2)',
                            300 => 'rgb(var(--color-primary) / 0.3)',
                            400 => 'rgb(var(--color-primary) / 0.4)',
                            500 => 'rgb(var(--color-primary) / 0.5)',
                            600 => 'rgb(var(--color-primary) / 1)',
                            700 => 'rgb(var(--color-primary) / 0.8)',
                            800 => 'rgb(var(--color-primary) / 0.7)',
                            900 => 'rgb(var(--color-primary) / 0.6)',
                        ],
                    ],
                ],
            ],
        ];
    }
}
</file>

<file path="src/Cluster.php">
<?php

namespace Laravilt\Panel;

use Illuminate\Support\Str;

abstract class Cluster
{
    /**
     * The cluster's navigation icon.
     */
    protected static ?string $navigationIcon = null;

    /**
     * The cluster's navigation label.
     */
    protected static ?string $navigationLabel = null;

    /**
     * The cluster's navigation sort order.
     */
    protected static ?int $navigationSort = null;

    /**
     * The cluster's navigation group.
     */
    protected static ?string $navigationGroup = null;

    /**
     * The cluster's slug.
     */
    protected static ?string $slug = null;

    /**
     * Whether the cluster should register navigation.
     */
    protected static bool $shouldRegisterNavigation = true;

    /**
     * The cluster's breadcrumb label.
     */
    protected static ?string $clusterBreadcrumb = null;

    /**
     * Get the cluster's navigation icon.
     */
    public static function getNavigationIcon(): ?string
    {
        return static::$navigationIcon;
    }

    /**
     * Get the cluster's navigation label.
     */
    public static function getNavigationLabel(): string
    {
        return static::$navigationLabel ?? Str::title(Str::kebab(class_basename(static::class)));
    }

    /**
     * Get the cluster's navigation sort order.
     */
    public static function getNavigationSort(): ?int
    {
        return static::$navigationSort;
    }

    /**
     * Get the cluster's navigation group.
     */
    public static function getNavigationGroup(): ?string
    {
        return static::$navigationGroup;
    }

    /**
     * Get the cluster's slug.
     */
    public static function getSlug(): string
    {
        return static::$slug ?? Str::slug(Str::kebab(class_basename(static::class)));
    }

    /**
     * Check if the cluster should register navigation.
     */
    public static function shouldRegisterNavigation(): bool
    {
        return static::$shouldRegisterNavigation;
    }

    /**
     * Get the cluster's breadcrumb label.
     */
    public static function getClusterBreadcrumb(): string
    {
        return static::$clusterBreadcrumb ?? static::getNavigationLabel();
    }

    /**
     * Get the panel instance.
     */
    public function getPanel(): ?Panel
    {
        $registry = app(\Laravilt\Panel\PanelRegistry::class);

        foreach ($registry->all() as $panel) {
            if ($this->belongsToPanel($panel)) {
                return $panel;
            }
        }

        return null;
    }

    /**
     * Check if the cluster belongs to a panel.
     */
    protected function belongsToPanel(Panel $panel): bool
    {
        return in_array(static::class, $panel->getClusters());
    }
}
</file>

<file path="src/PanelProvider.php">
<?php

namespace Laravilt\Panel;

use Illuminate\Support\ServiceProvider;

abstract class PanelProvider extends ServiceProvider
{
    /**
     * Bootstrap any panel services.
     */
    public function boot(): void
    {
        $panel = $this->panel(Panel::make($this->getPanelId()));

        $panel->register();
    }

    /**
     * Configure the panel.
     */
    abstract public function panel(Panel $panel): Panel;

    /**
     * Get the panel ID from the provider class name.
     */
    protected function getPanelId(): string
    {
        $className = class_basename($this);

        // AdminPanelProvider -> admin
        return strtolower(str_replace('PanelProvider', '', $className));
    }
}
</file>

<file path="src/PanelRegistry.php">
<?php

namespace Laravilt\Panel;

use Illuminate\Support\Collection;

class PanelRegistry
{
    /**
     * Registered panels.
     */
    protected array $panels = [];

    /**
     * Default panel ID.
     */
    protected ?string $defaultPanel = null;

    /**
     * Current panel ID.
     */
    protected ?string $currentPanel = null;

    /**
     * Register a panel.
     */
    public function register(Panel $panel): void
    {
        $this->panels[$panel->getId()] = $panel;

        if ($panel->isDefault()) {
            $this->defaultPanel = $panel->getId();
        }

        // Boot the panel
        $panel->boot();
    }

    /**
     * Get a panel by ID.
     */
    public function get(string $id): ?Panel
    {
        return $this->panels[$id] ?? null;
    }

    /**
     * Get all panels.
     */
    public function all(): Collection
    {
        return collect($this->panels);
    }

    /**
     * Get the default panel.
     */
    public function getDefault(): ?Panel
    {
        if ($this->defaultPanel) {
            return $this->get($this->defaultPanel);
        }

        return $this->all()->first();
    }

    /**
     * Set the current panel.
     */
    public function setCurrent(string $id): void
    {
        $this->currentPanel = $id;
    }

    /**
     * Get the current panel.
     */
    public function getCurrent(): ?Panel
    {
        if ($this->currentPanel) {
            return $this->get($this->currentPanel);
        }

        return $this->getDefault();
    }

    /**
     * Check if a panel exists.
     */
    public function has(string $id): bool
    {
        return isset($this->panels[$id]);
    }

    /**
     * Get panel by path.
     */
    public function getByPath(string $path): ?Panel
    {
        $path = trim($path, '/');

        foreach ($this->panels as $panel) {
            if ($panel->getPath() === $path) {
                return $panel;
            }
        }

        return null;
    }
}
</file>

<file path="stubs/bootstrap/app.stub">
<?php

use App\Http\Middleware\HandleAppearance;
use App\Http\Middleware\HandleInertiaRequests;
use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;
use Illuminate\Http\Middleware\AddLinkHeadersForPreloadedAssets;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {
        $middleware->encryptCookies(except: ['appearance', 'sidebar_state']);

        $middleware->web(append: [
            HandleAppearance::class,
            HandleInertiaRequests::class,
            AddLinkHeadersForPreloadedAssets::class,
        ]);

        $middleware->redirectUsersTo('/admin');
    })
    ->withExceptions(function (Exceptions $exceptions): void {
        //
    })->create();
</file>

<file path="stubs/bootstrap/providers.stub">
<?php

return [
    App\Providers\AppServiceProvider::class,
];
</file>

<file path="stubs/layouts/app/AppHeaderLayout.vue.stub">
<script setup lang="ts">
import AppContent from '@/components/AppContent.vue';
import AppHeader from '@/components/AppHeader.vue';
import AppShell from '@/components/AppShell.vue';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import type { BreadcrumbItemType } from '@/types';

interface Props {
    breadcrumbs?: BreadcrumbItemType[];
}

withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
});
</script>

<template>
    <AppShell class="flex-col">
        <AppHeader :breadcrumbs="breadcrumbs" />
        <AppContent>
            <slot />
        </AppContent>
        <NotificationContainer />
    </AppShell>
</template>
</file>

<file path="stubs/layouts/app/AppSidebarLayout.vue.stub">
<script setup lang="ts">
import AppContent from '@/components/AppContent.vue';
import AppShell from '@/components/AppShell.vue';
import AppSidebar from '@/components/AppSidebar.vue';
import AppSidebarHeader from '@/components/AppSidebarHeader.vue';
import { NotificationContainer, useNotification } from '@laravilt/notifications/app.ts';
import { usePage } from '@inertiajs/vue3';
import { onMounted, watch } from 'vue';
import type { BreadcrumbItemType } from '@/types';

interface Props {
    breadcrumbs?: BreadcrumbItemType[];
}

withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
});

const page = usePage();
const { notify: showNotification } = useNotification();

// Display session notifications on mount and when page props change
const displaySessionNotifications = () => {
    const notifications = page.props.notifications as Array<any>;
    if (notifications && Array.isArray(notifications)) {
        notifications.forEach((notification) => {
            // Support both old format (message) and new format (title/body)
            if (notification.title || notification.body) {
                showNotification(notification.title || '', notification.body, notification.type, {
                    icon: notification.icon,
                    color: notification.color,
                    actions: notification.actions,
                    duration: notification.duration,
                });
            } else {
                // Backward compatibility: just message
                showNotification(notification.message, undefined, notification.type);
            }
        });
    }
};

onMounted(() => {
    displaySessionNotifications();
});

// Watch for changes to notifications in page props (for Inertia visits)
watch(() => page.props.notifications, (newNotifications) => {
    if (newNotifications && Array.isArray(newNotifications) && newNotifications.length > 0) {
        displaySessionNotifications();
    }
}, { deep: true });
</script>

<template>
    <AppShell variant="sidebar">
        <AppSidebar />
        <AppContent variant="sidebar" class="overflow-x-hidden">
            <AppSidebarHeader :breadcrumbs="breadcrumbs" />
            <slot />
        </AppContent>
        <NotificationContainer />
    </AppShell>
</template>
</file>

<file path="stubs/layouts/auth/AuthCardLayout.vue.stub">
<script setup lang="ts">
import AppLogoIcon from '@/components/AppLogoIcon.vue';
import {
    Card,
    CardContent,
    CardDescription,
    CardHeader,
    CardTitle,
} from '@/components/ui/card';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import { home } from '@/routes';
import { Link } from '@inertiajs/vue3';

defineProps<{
    title?: string;
    description?: string;
}>();
</script>

<template>
    <div
        class="flex min-h-svh flex-col items-center justify-center gap-6 bg-muted p-6 md:p-10"
    >
        <div class="flex w-full max-w-md flex-col gap-6">
            <Link
                :href="home()"
                class="flex items-center gap-2 self-center font-medium"
            >
                <div class="flex h-9 w-9 items-center justify-center">
                    <AppLogoIcon
                        class="size-9 fill-current text-black dark:text-white"
                    />
                </div>
            </Link>

            <div class="flex flex-col gap-6">
                <Card class="rounded-xl">
                    <CardHeader class="px-10 pt-8 pb-0 text-center">
                        <CardTitle class="text-xl">{{ title }}</CardTitle>
                        <CardDescription>
                            {{ description }}
                        </CardDescription>
                    </CardHeader>
                    <CardContent class="px-10 py-8">
                        <slot />
                    </CardContent>
                </Card>
            </div>
        </div>
        <NotificationContainer />
    </div>
</template>
</file>

<file path="stubs/layouts/auth/AuthSimpleLayout.vue.stub">
<script setup lang="ts">
import AppLogoIcon from '@/components/AppLogoIcon.vue';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import { home } from '@/routes';
import { Link } from '@inertiajs/vue3';

defineProps<{
    title?: string;
    description?: string;
}>();
</script>

<template>
    <div
        class="flex min-h-svh flex-col items-center justify-center gap-6 bg-background p-6 md:p-10"
    >
        <div class="w-full max-w-sm">
            <div class="flex flex-col gap-8">
                <div class="flex flex-col items-center gap-4">
                    <Link
                        :href="home()"
                        class="flex flex-col items-center gap-2 font-medium"
                    >
                        <div
                            class="mb-1 flex h-9 w-9 items-center justify-center rounded-md"
                        >
                            <AppLogoIcon
                                class="size-9 fill-current text-[var(--foreground)] dark:text-white"
                            />
                        </div>
                        <span class="sr-only">{{ title }}</span>
                    </Link>
                    <div class="space-y-2 text-center">
                        <h1 class="text-xl font-medium">{{ title }}</h1>
                        <p class="text-center text-sm text-muted-foreground">
                            {{ description }}
                        </p>
                    </div>
                </div>
                <slot />
            </div>
        </div>
        <NotificationContainer />
    </div>
</template>
</file>

<file path="stubs/layouts/auth/AuthSplitLayout.vue.stub">
<script setup lang="ts">
import AppLogoIcon from '@/components/AppLogoIcon.vue';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import { home } from '@/routes';
import { Link, usePage } from '@inertiajs/vue3';

const page = usePage();
const name = page.props.name;
const quote = page.props.quote;

defineProps<{
    title?: string;
    description?: string;
}>();
</script>

<template>
    <div
        class="relative grid h-dvh flex-col items-center justify-center px-8 sm:px-0 lg:max-w-none lg:grid-cols-2 lg:px-0"
    >
        <div
            class="relative hidden h-full flex-col bg-muted p-10 text-white lg:flex dark:border-r"
        >
            <div class="absolute inset-0 bg-zinc-900" />
            <Link
                :href="home()"
                class="relative z-20 flex items-center text-lg font-medium"
            >
                <AppLogoIcon class="mr-2 size-8 fill-current text-white" />
                {{ name }}
            </Link>
            <div v-if="quote" class="relative z-20 mt-auto">
                <blockquote class="space-y-2">
                    <p class="text-lg">&ldquo;{{ quote.message }}&rdquo;</p>
                    <footer class="text-sm text-neutral-300">
                        {{ quote.author }}
                    </footer>
                </blockquote>
            </div>
        </div>
        <div class="lg:p-8">
            <div
                class="mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]"
            >
                <div class="flex flex-col space-y-2 text-center">
                    <h1 class="text-xl font-medium tracking-tight" v-if="title">
                        {{ title }}
                    </h1>
                    <p class="text-sm text-muted-foreground" v-if="description">
                        {{ description }}
                    </p>
                </div>
                <slot />
            </div>
        </div>
        <NotificationContainer />
    </div>
</template>
</file>

<file path="stubs/layouts/settings/Layout.vue.stub">
<script setup lang="ts">
import Heading from '@/components/Heading.vue';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { toUrl, urlIsActive } from '@/lib/utils';
import { edit as editAppearance } from '@/routes/appearance';
import { edit as editProfile } from '@/routes/profile';
import { show } from '@/routes/two-factor';
import { edit as editPassword } from '@/routes/user-password';
import { type NavItem } from '@/types';
import { Link } from '@inertiajs/vue3';

const sidebarNavItems: NavItem[] = [
    {
        title: 'Profile',
        href: editProfile(),
    },
    {
        title: 'Password',
        href: editPassword(),
    },
    {
        title: 'Two-Factor Auth',
        href: show(),
    },
    {
        title: 'Appearance',
        href: editAppearance(),
    },
];

const currentPath = typeof window !== undefined ? window.location.pathname : '';
</script>

<template>
    <div class="px-4 py-6">
        <Heading
            title="Settings"
            description="Manage your profile and account settings"
        />

        <div class="flex flex-col lg:flex-row lg:space-x-12">
            <aside class="w-full max-w-xl lg:w-48">
                <nav class="flex flex-col space-y-1 space-x-0">
                    <Button
                        v-for="item in sidebarNavItems"
                        :key="toUrl(item.href)"
                        variant="ghost"
                        :class="[
                            'w-full justify-start',
                            { 'bg-muted': urlIsActive(item.href, currentPath) },
                        ]"
                        as-child
                    >
                        <Link :href="item.href">
                            <component :is="item.icon" class="h-4 w-4" />
                            {{ item.title }}
                        </Link>
                    </Button>
                </nav>
            </aside>

            <Separator class="my-6 lg:hidden" />

            <div class="flex-1 md:max-w-2xl">
                <section class="max-w-xl space-y-12">
                    <slot />
                </section>
            </div>
        </div>
    </div>
</template>
</file>

<file path="stubs/layouts/AppLayout.vue.stub">
<script setup lang="ts">
import AppLayout from '@/layouts/app/AppSidebarLayout.vue';
import type { BreadcrumbItemType } from '@/types';

interface Props {
    breadcrumbs?: BreadcrumbItemType[];
}

withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
});
</script>

<template>
    <AppLayout :breadcrumbs="breadcrumbs">
        <slot />
    </AppLayout>
</template>
</file>

<file path="stubs/layouts/AuthLayout.vue.stub">
<script setup lang="ts">
import AuthLayout from '@/layouts/auth/AuthSimpleLayout.vue';

defineProps<{
    title?: string;
    description?: string;
}>();
</script>

<template>
    <AuthLayout :title="title" :description="description">
        <slot />
    </AuthLayout>
</template>
</file>

<file path="stubs/Middleware/HandleAppearance.stub">
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\View;
use Symfony\Component\HttpFoundation\Response;

class HandleAppearance
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        View::share('appearance', $request->cookie('appearance') ?? 'system');

        return $next($request);
    }
}
</file>

<file path="stubs/Middleware/HandleInertiaRequests.stub">
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Inspiring;
use Illuminate\Http\Request;
use Inertia\Middleware;

class HandleInertiaRequests extends Middleware
{
    /**
     * The root template that's loaded on the first page visit.
     *
     * @see https://inertiajs.com/server-side-setup#root-template
     *
     * @var string
     */
    protected $rootView = 'app';

    /**
     * Determines the current asset version.
     *
     * @see https://inertiajs.com/asset-versioning
     */
    public function version(Request $request): ?string
    {
        return parent::version($request);
    }

    /**
     * Define the props that are shared by default.
     *
     * @see https://inertiajs.com/shared-data
     *
     * @return array<string, mixed>
     */
    public function share(Request $request): array
    {
        [$message, $author] = str(Inspiring::quotes()->random())->explode('-');

        return [
            ...parent::share($request),
            'name' => config('app.name'),
            'quote' => ['message' => trim($message), 'author' => trim($author)],
            'auth' => [
                'user' => $request->user(),
            ],
            'sidebarOpen' => ! $request->hasCookie('sidebar_state') || $request->cookie('sidebar_state') === 'true',
            'notifications' => session()->get('notifications', []),
            'actionUpdatedData' => session()->get('action_updated_data'),
        ];
    }
}
</file>

<file path="stubs/routes/settings.stub">
<?php

use App\Http\Controllers\Settings\PasswordController;
use App\Http\Controllers\Settings\ProfileController;
use App\Http\Controllers\Settings\TwoFactorAuthenticationController;
use Illuminate\Support\Facades\Route;
use Inertia\Inertia;

Route::middleware('auth')->group(function () {
    Route::redirect('settings', '/settings/profile');

    Route::get('settings/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('settings/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('settings/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');

    Route::get('settings/password', [PasswordController::class, 'edit'])->name('user-password.edit');

    Route::put('settings/password', [PasswordController::class, 'update'])
        ->middleware('throttle:6,1')
        ->name('user-password.update');

    Route::get('settings/appearance', function () {
        return Inertia::render('settings/Appearance');
    })->name('appearance.edit');

    Route::get('settings/two-factor', [TwoFactorAuthenticationController::class, 'show'])
        ->name('two-factor.show');
});
</file>

<file path="stubs/routes/web.stub">
<?php

use Illuminate\Support\Facades\Route;
use Inertia\Inertia;

Route::get('/', function () {
    return Inertia::render('Welcome');
})->name('home');
</file>

<file path="stubs/cluster.stub">
<?php

namespace {{ namespace }};

use Laravilt\Panel\Cluster;

class {{ class }} extends Cluster
{
    /**
     * The cluster's navigation icon.
     */
    protected static ?string $navigationIcon = '{{ icon }}';

    /**
     * The cluster's navigation label.
     */
    protected static ?string $navigationLabel = '{{ label }}';

    /**
     * The cluster's navigation sort order.
     */
    protected static ?int $navigationSort = {{ sort }};

    /**
     * The cluster's navigation group.
     */
    protected static ?string $navigationGroup = {{ group }};

    /**
     * Whether the cluster should register navigation.
     */
    protected static bool $shouldRegisterNavigation = true;
}
</file>

<file path="stubs/dashboard-page.stub">
<?php

namespace {{ namespace }};

use Laravilt\Panel\Pages\Dashboard;

class {{ class }} extends Dashboard
{
    protected static ?string $title = '{{ title }}';

    public function getWidgets(): array
    {
        return [
            // Add widgets here
        ];
    }

    public function getWidgetColumns(): int|array
    {
        return [
            'default' => 1,
            'sm' => 2,
            'md' => 3,
            'lg' => 3,
        ];
    }
}
</file>

<file path="stubs/dashboard.stub">
<?php

namespace App\Laravilt\{{ studlyId }}\Pages;

use Laravilt\Panel\Pages\Dashboard as BaseDashboard;

class Dashboard extends BaseDashboard
{
    protected function getWidgets(): array
    {
        return [
            // Add dashboard widgets here
        ];
    }
}
</file>

<file path="stubs/page-view.stub">
<div class="grid gap-6">
    {{-- Page content goes here --}}
    <div class="rounded-lg border bg-card p-6">
        <h2 class="text-lg font-semibold mb-4">{{ title }}</h2>
        <p class="text-sm text-muted-foreground">
            This is a {{ title }} page. Add your content here.
        </p>
    </div>
</div>
</file>

<file path="stubs/page.stub">
<?php

namespace {{ namespace }};

use Laravilt\Panel\Pages\Page;

class {{ class }} extends Page
{
    protected static ?string $slug = '{{ slug }}';

    protected static ?string $title = '{{ title }}';

    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static ?string $navigationLabel = '{{ title }}';

    protected static string $view = 'laravilt-panel::pages.{{ panelSlug }}.{{ slug }}';

    protected function getHeaderActions(): array
    {
        return [
            // Define header actions here
        ];
    }
}
</file>

<file path="stubs/resource-Api.stub">
<?php

namespace {{ namespace }};

use Laravilt\Tables\ApiColumn;
use Laravilt\Tables\ApiResource;

class {{ class }}Api
{
    public static function configure(ApiResource $api): ApiResource
    {
        return $api
            ->columns([
                ApiColumn::make('id')->type('integer')->sortable(),
{{ columns }}
                ApiColumn::make('created_at')->type('datetime')->sortable(),
                ApiColumn::make('updated_at')->type('datetime')->sortable(),
            ]);
    }
}
</file>

<file path="stubs/resource-Create.stub">
<?php

namespace App\Laravilt\{{ panel }}\Resources\{{ name }};

use Laravilt\Panel\Pages\Page;

class Create extends Page
{
    protected static string $view = '{{ panel }}/{{ name }}/Create';

    protected static ?string $title = 'Create {{ name }}';

    public function mount(): void
    {
        // Initialize create form
    }
}
</file>

<file path="stubs/resource-Edit.stub">
<?php

namespace App\Laravilt\{{ panel }}\Resources\{{ name }};

use Laravilt\Panel\Pages\Page;

class Edit extends Page
{
    protected static string $view = '{{ panel }}/{{ name }}/Edit';

    protected static ?string $title = 'Edit {{ name }}';

    public function mount($id): void
    {
        // Load data for editing
    }
}
</file>

<file path="stubs/resource-List.stub">
<?php

namespace App\Laravilt\{{ panel }}\Resources\{{ name }};

use Laravilt\Panel\Pages\Page;

class List extends Page
{
    protected static string $view = '{{ panel }}/{{ name }}/List';

    protected static ?string $title = '{{ name }} List';

    public function mount(): void
    {
        // Load data for listing
    }
}
</file>

<file path="stubs/resource-View.stub">
<?php

namespace App\Laravilt\{{ panel }}\Resources\{{ name }};

use Laravilt\Panel\Pages\Page;

class View extends Page
{
    protected static string $view = '{{ panel }}/{{ name }}/View';

    protected static ?string $title = 'View {{ name }}';

    public function mount($id): void
    {
        // Load data for viewing
    }
}
</file>

<file path="tests/Feature/DebugTest.php">
<?php

it('will not use debugging functions', function () {
    expect(['dd', 'dump', 'ray'])->each->not->toBeUsed();
});
</file>

<file path="tests/Pest.php">
<?php

use Laravilt\Panel\Tests\TestCase;

uses(TestCase::class)->in(__DIR__);
</file>

<file path=".gitignore">
.idea
.phpunit.cache
.phpunit.result.cache
.DS_Store
Thumbs.db
/vendor/
/node_modules/
/.vscode/
composer.lock
package-lock.json
*.log
.env
.env.backup
.env.production
/dist/
/build/
</file>

<file path="CHANGELOG.md">
# Changelog

All notable changes to `Panel` will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Initial release

### Changed

### Deprecated

### Removed

### Fixed

### Security
</file>

<file path="CODE_OF_CONDUCT.md">
# Contributor Covenant Code of Conduct

## Our Pledge

We as members, contributors, and leaders pledge to make participation in our
community a harassment-free experience for everyone, regardless of age, body
size, visible or invisible disability, ethnicity, sex characteristics, gender
identity and expression, level of experience, education, socio-economic status,
nationality, personal appearance, race, religion, or sexual identity
and orientation.

We pledge to act and interact in ways that contribute to an open, welcoming,
diverse, inclusive, and healthy community.

## Our Standards

Examples of behavior that contributes to a positive environment for our
community include:

* Demonstrating empathy and kindness toward other people
* Being respectful of differing opinions, viewpoints, and experiences
* Giving and gracefully accepting constructive feedback
* Accepting responsibility and apologizing to those affected by our mistakes,
  and learning from the experience
* Focusing on what is best not just for us as individuals, but for the
  overall community

Examples of unacceptable behavior include:

* The use of sexualized language or imagery, and sexual attention or
  advances of any kind
* Trolling, insulting or derogatory comments, and personal or political attacks
* Public or private harassment
* Publishing others' private information, such as a physical or email
  address, without their explicit permission
* Other conduct which could reasonably be considered inappropriate in a
  professional setting

## Enforcement Responsibilities

Community leaders are responsible for clarifying and enforcing our standards of
acceptable behavior and will take appropriate and fair corrective action in
response to any behavior that they deem inappropriate, threatening, offensive,
or harmful.

## Scope

This Code of Conduct applies within all community spaces, and also applies when
an individual is officially representing the community in public spaces.

## Enforcement

Instances of abusive, harassing, or otherwise unacceptable behavior may be
reported to the community leaders responsible for enforcement.

All complaints will be reviewed and investigated promptly and fairly.

All community leaders are obligated to respect the privacy and security of the
reporter of any incident.

## Attribution

This Code of Conduct is adapted from the [Contributor Covenant](https://www.contributor-covenant.org),
version 2.0, available at https://www.contributor-covenant.org/version/2/0/code_of_conduct.html.
</file>

<file path="LICENSE.md">
MIT License

Copyright (c) 2025 Fady Mondy

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="phpstan.neon">
includes:
    - phpstan-baseline.neon

parameters:
    level: 5
    paths:
        - src
    tmpDir: build/phpstan
    checkOctaneCompatibility: true
    checkModelProperties: true
    checkMissingIterableValueType: false
</file>

<file path="phpunit.xml">
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/11.0/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Test Suite">
            <directory suffix="Test.php">./tests</directory>
        </testsuite>
    </testsuites>
    <coverage>
        <report>
            <html outputDirectory="build/coverage"/>
            <text outputFile="build/coverage.txt"/>
            <clover outputFile="build/logs/clover.xml"/>
        </report>
    </coverage>
    <source>
        <include>
            <directory suffix=".php">./src</directory>
        </include>
    </source>
</phpunit>
</file>

<file path="pint.json">
{
    "preset": "laravel",
    "rules": {
        "simplified_null_return": true,
        "braces": false,
        "new_with_braces": {
            "anonymous_class": false,
            "named_class": false
        }
    }
}
</file>

<file path="testbench.yaml">
providers:
  - Laravilt\Panel\PanelServiceProvider

workbench:
  welcome: false
  discovers:
    web: true
    api: true
    commands: true
    components: true
</file>

<file path="vite.plugin.js">
import { resolve } from 'path';

export default function PanelPlugin() {
    const pluginPath = resolve(__dirname);

    return {
        name: 'panel-plugin',
        config: () => ({
            build: {
                rollupOptions: {
                    input: {
                        'panel': resolve(pluginPath, 'resources/js/app.js'),
                    },
                    output: {
                        entryFileNames: 'js/[name].js',
                        chunkFileNames: 'js/[name].js',
                        assetFileNames: (assetInfo) => {
                            if (assetInfo.name.endsWith('.css')) {
                                return 'css/[name][extname]';
                            }
                            return 'assets/[name][extname]';
                        },
                    },
                },
                outDir: resolve(pluginPath, 'dist'),
                emptyOutDir: true,
            },
        }),
    };
}
</file>

<file path="config/laravilt-panel.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Panel Path
    |--------------------------------------------------------------------------
    |
    | The default path for panels. Individual panels can override this.
    |
    */

    'path' => env('LARAVILT_PANEL_PATH', 'admin'),

    /*
    |--------------------------------------------------------------------------
    | Panel Middleware
    |--------------------------------------------------------------------------
    |
    | The default middleware stack for panels.
    |
    */

    'middleware' => [
        'web',
        'auth',
    ],

    /*
    |--------------------------------------------------------------------------
    | Default Colors
    |--------------------------------------------------------------------------
    |
    | The default color scheme for panels.
    |
    */

    'colors' => [
        'primary' => '#6366f1', // Indigo
    ],

    /*
    |--------------------------------------------------------------------------
    | Branding
    |--------------------------------------------------------------------------
    |
    | Default branding configuration.
    |
    */

    'brand_name' => env('APP_NAME', 'Laravilt'),

    'brand_logo' => null,

    'favicon' => null,

    /*
    |--------------------------------------------------------------------------
    | Max Content Width
    |--------------------------------------------------------------------------
    |
    | The maximum content width for panel pages.
    |
    */

    'max_content_width' => '7xl',

];
</file>

<file path="lang/ar/panel.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Common
    |--------------------------------------------------------------------------
    */
    'common' => [
        'save' => '',
        'save_changes' => ' ',
        'saving' => ' ...',
        'cancel' => '',
        'delete' => '',
        'edit' => '',
        'create' => '',
        'create_and_create_another' => '  ',
        'update' => '',
        'search' => '',
        'filter' => '',
        'reset' => ' ',
        'close' => '',
        'confirm' => '',
        'yes' => '',
        'no' => '',
        'loading' => ' ...',
        'no_results' => '    ',
        'actions' => '',
        'view' => '',
        'back' => '',
        'next' => '',
        'previous' => '',
        'submit' => '',
        'logout' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Navigation
    |--------------------------------------------------------------------------
    */
    'navigation' => [
        'dashboard' => ' ',
        'home' => '',
        'settings' => '',
        'users' => '',
        'profile' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Resources
    |--------------------------------------------------------------------------
    */
    'resources' => [
        'create' => ' :label',
        'edit' => ' :label',
        'view' => ' :label',
        'list' => ':label',
        'delete' => ' :label',
    ],

    /*
    |--------------------------------------------------------------------------
    | Pages
    |--------------------------------------------------------------------------
    */
    'pages' => [
        'dashboard' => [
            'title' => ' ',
            'welcome' => ' !',
        ],
        'create_record' => [
            'title' => ' :label',
        ],
        'edit_record' => [
            'title' => ' :label',
        ],
        'view_record' => [
            'title' => ' :label',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Breadcrumbs
    |--------------------------------------------------------------------------
    */
    'breadcrumbs' => [
        'home' => '',
        'create' => '',
        'edit' => '',
        'view' => '',
    ],

    /*
    |--------------------------------------------------------------------------
    | User Menu
    |--------------------------------------------------------------------------
    */
    'user_menu' => [
        'profile' => ' ',
        'settings' => '',
        'logout' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Footer
    |--------------------------------------------------------------------------
    */
    'footer' => [
        'powered_by' => '  Laravilt',
        'all_rights_reserved' => '  ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Empty States
    |--------------------------------------------------------------------------
    */
    'empty' => [
        'title' => '  ',
        'description' => '   .',
        'action' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Search
    |--------------------------------------------------------------------------
    */
    'search' => [
        'placeholder' => '...',
        'global_placeholder' => '   ...',
        'no_results' => '  ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Dashboard
    |--------------------------------------------------------------------------
    */
    'dashboard' => [
        'title' => ' ',
        'total_revenue' => ' ',
        'customers' => '',
        'sales' => '',
        'active_now' => ' ',
        'from_last_month' => ':change   ',
        'since_last_hour' => ':count   ',
        'recent_activity' => ' ',
        'new_customer' => '  ',
        'customer_joined' => ':name   ',
        'new_order' => ' ',
        'order_info' => ' #:id - :amount',
        'payment_received' => '  ',
        'payment_info' => '   :amount',
        'time_ago' => ' :time',
        'minutes_ago' => ' :count ',
        'hour_ago' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Demo Pages
    |--------------------------------------------------------------------------
    */
    'demo' => [
        // Form Demo
        'form' => [
            'title' => ' ',
            'description' => '      .',
            'submitted' => '  ',
            'submitted_message' => '      .',
            'reset' => '   ',
            'reset_message' => '       .',
            'text_inputs' => ' ',
            'text_inputs_desc' => '      ',
            'selection' => '',
            'selection_desc' => '     ',
            'date_time' => ' ',
            'date_time_desc' => '    ',
            'rich_content' => ' ',
            'rich_content_desc' => '    ',
            'current_form_data' => '   ( )',
            'updates_realtime' => '     ',
            'code_example' => '  ',
        ],

        // Table Demo
        'table' => [
            'title' => ' ',
            'description' => '        .',
            'column_types' => '  ',
            'column_types_desc' => '   ',
            'sortable' => '  ',
            'sortable_desc' => '   ',
            'filters' => ' ',
            'filters_desc' => '  ',
            'bulk_actions' => ' ',
            'bulk_actions_desc' => '    ',
            'toggleable' => '  ',
            'toggleable_desc' => '/ ',
        ],

        // Infolist Demo
        'infolist' => [
            'title' => '  ',
            'description' => '         .',
            'text_entry' => ' ',
            'text_entry_desc' => '  ',
            'badge_entry' => ' ',
            'badge_entry_desc' => ' ',
            'image_entry' => ' ',
            'image_entry_desc' => ' ',
            'color_entry' => ' ',
            'color_entry_desc' => ' ',
            'code_entry' => ' ',
            'code_entry_desc' => ' ',
        ],

        // Actions Demo
        'actions' => [
            'title' => ' ',
            'description' => '          Laravilt.',
            'closure_actions' => ' ',
            'closure_actions_desc' => '  ',
            'confirmations' => '',
            'confirmations_desc' => ' ',
            'modal_forms' => ' ',
            'modal_forms_desc' => '  ',
            'url_actions' => ' ',
            'url_actions_desc' => ' ',
            'code_examples' => ' ',
        ],

        // Notifications Demo
        'notifications' => [
            'title' => ' ',
            'description' => '       .',
            'quick_notifications' => '  ( )',
            'quick_notifications_desc' => '       .',
            'success' => '',
            'success_title' => '!',
            'success_body' => '   .',
            'error' => '',
            'error_title' => '!',
            'error_body' => '  .    .',
            'warning' => '',
            'warning_title' => '!',
            'warning_body' => '     .',
            'info' => '',
            'info_title' => '',
            'info_body' => '    .',
            'duration_control' => '  ',
            'duration_control_desc' => '   .',
            'quick_2s' => ' (2 )',
            'quick_2s_body' => '  !',
            'normal_5s' => ' (5 )',
            'normal_5s_body' => '   .',
            'long_10s' => ' (10 )',
            'long_10s_body' => '    10 .',
            'persistent' => '',
            'persistent_body' => '  X   .',
            '2_seconds' => '2 ',
            '5_seconds' => '5 ',
            '10_seconds' => '10 ',
            'code_examples' => ' ',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Sidebar
    |--------------------------------------------------------------------------
    */
    'sidebar' => [
        'toggle' => '  ',
        'collapse' => '',
        'expand' => '',
    ],

    /*
    |--------------------------------------------------------------------------
    | Appearance
    |--------------------------------------------------------------------------
    */
    'appearance' => [
        'title' => '',
        'light' => '',
        'dark' => '',
        'system' => '',
    ],

    /*
    |--------------------------------------------------------------------------
    | Settings
    |--------------------------------------------------------------------------
    */
    'settings' => [
        'title' => '',
        'profile' => ' ',
        'profile_description' => '   ',
        'appearance' => '',
        'appearance_description' => '  ',
        'appearance_light' => '',
        'appearance_dark' => '',
        'appearance_system' => '',
    ],

    /*
    |--------------------------------------------------------------------------
    | Notifications
    |--------------------------------------------------------------------------
    */
    'notifications' => [
        'title' => '',
        'no_notifications' => '   ',
        'unread_count' => ':count  ',
        'mark_all_read' => '  ',
        'mark_as_read' => ' ',
        'delete' => '',
        'delete_all' => ' ',
    ],

    /*
    |--------------------------------------------------------------------------
    | Language
    |--------------------------------------------------------------------------
    */
    'language' => [
        'switch' => ' ',
        'current' => ' ',
    ],
];
</file>

<file path="lang/en/panel.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Common
    |--------------------------------------------------------------------------
    */
    'common' => [
        'save' => 'Save',
        'save_changes' => 'Save Changes',
        'saving' => 'Saving...',
        'cancel' => 'Cancel',
        'delete' => 'Delete',
        'edit' => 'Edit',
        'create' => 'Create',
        'create_and_create_another' => 'Create & Create Another',
        'update' => 'Update',
        'search' => 'Search',
        'filter' => 'Filter',
        'reset' => 'Reset',
        'close' => 'Close',
        'confirm' => 'Confirm',
        'yes' => 'Yes',
        'no' => 'No',
        'loading' => 'Loading...',
        'no_results' => 'No results found',
        'actions' => 'Actions',
        'view' => 'View',
        'back' => 'Back',
        'next' => 'Next',
        'previous' => 'Previous',
        'submit' => 'Submit',
        'logout' => 'Logout',
    ],

    /*
    |--------------------------------------------------------------------------
    | Navigation
    |--------------------------------------------------------------------------
    */
    'navigation' => [
        'dashboard' => 'Dashboard',
        'home' => 'Home',
        'settings' => 'Settings',
        'users' => 'Users',
        'profile' => 'Profile',
    ],

    /*
    |--------------------------------------------------------------------------
    | Resources
    |--------------------------------------------------------------------------
    */
    'resources' => [
        'create' => 'Create :label',
        'edit' => 'Edit :label',
        'view' => 'View :label',
        'list' => ':label',
        'delete' => 'Delete :label',
    ],

    /*
    |--------------------------------------------------------------------------
    | Pages
    |--------------------------------------------------------------------------
    */
    'pages' => [
        'dashboard' => [
            'title' => 'Dashboard',
            'welcome' => 'Welcome back!',
        ],
        'create_record' => [
            'title' => 'Create :label',
        ],
        'edit_record' => [
            'title' => 'Edit :label',
        ],
        'view_record' => [
            'title' => 'View :label',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Breadcrumbs
    |--------------------------------------------------------------------------
    */
    'breadcrumbs' => [
        'home' => 'Home',
        'create' => 'Create',
        'edit' => 'Edit',
        'view' => 'View',
    ],

    /*
    |--------------------------------------------------------------------------
    | User Menu
    |--------------------------------------------------------------------------
    */
    'user_menu' => [
        'profile' => 'Profile',
        'settings' => 'Settings',
        'logout' => 'Logout',
    ],

    /*
    |--------------------------------------------------------------------------
    | Footer
    |--------------------------------------------------------------------------
    */
    'footer' => [
        'powered_by' => 'Powered by Laravilt',
        'all_rights_reserved' => 'All rights reserved',
    ],

    /*
    |--------------------------------------------------------------------------
    | Empty States
    |--------------------------------------------------------------------------
    */
    'empty' => [
        'title' => 'No records found',
        'description' => 'Get started by creating a new record.',
        'action' => 'Create New',
    ],

    /*
    |--------------------------------------------------------------------------
    | Search
    |--------------------------------------------------------------------------
    */
    'search' => [
        'placeholder' => 'Search...',
        'global_placeholder' => 'Search anything...',
        'no_results' => 'No results found',
    ],

    /*
    |--------------------------------------------------------------------------
    | Dashboard
    |--------------------------------------------------------------------------
    */
    'dashboard' => [
        'title' => 'Dashboard',
        'total_revenue' => 'Total Revenue',
        'customers' => 'Customers',
        'sales' => 'Sales',
        'active_now' => 'Active Now',
        'from_last_month' => ':change from last month',
        'since_last_hour' => ':count since last hour',
        'recent_activity' => 'Recent Activity',
        'new_customer' => 'New customer registered',
        'customer_joined' => ':name joined the platform',
        'new_order' => 'New order placed',
        'order_info' => 'Order #:id - :amount',
        'payment_received' => 'Payment received',
        'payment_info' => 'Payment of :amount confirmed',
        'time_ago' => ':time ago',
        'minutes_ago' => ':count minutes ago',
        'hour_ago' => '1 hour ago',
    ],

    /*
    |--------------------------------------------------------------------------
    | Demo Pages
    |--------------------------------------------------------------------------
    */
    'demo' => [
        // Form Demo
        'form' => [
            'title' => 'Form Demo',
            'description' => 'A comprehensive showcase of all available form components and layouts.',
            'submitted' => 'Form Submitted',
            'submitted_message' => 'Form data has been logged to the console.',
            'reset' => 'Form Reset',
            'reset_message' => 'All fields have been reset to their default values.',
            'text_inputs' => 'Text Inputs',
            'text_inputs_desc' => 'Text, Email, URL, Phone, Textarea',
            'selection' => 'Selection',
            'selection_desc' => 'Select, Radio, Checkbox, Tags',
            'date_time' => 'Date & Time',
            'date_time_desc' => 'Date, DateTime, Time pickers',
            'rich_content' => 'Rich Content',
            'rich_content_desc' => 'Rich Editor, Markdown, Files',
            'current_form_data' => 'Current Form Data (Live Preview)',
            'updates_realtime' => 'Updates in real-time as you type',
            'code_example' => 'Code Example',
        ],

        // Table Demo
        'table' => [
            'title' => 'Table Demo',
            'description' => 'A showcase of the Table component with columns, filters, sorting, and inline actions.',
            'column_types' => 'Multiple Column Types',
            'column_types_desc' => 'Text, Image, Icon, Toggle',
            'sortable' => 'Sortable Columns',
            'sortable_desc' => 'Click headers to sort',
            'filters' => 'Advanced Filters',
            'filters_desc' => 'Select, Multi, Ternary',
            'bulk_actions' => 'Bulk Actions',
            'bulk_actions_desc' => 'Select & act on multiple',
            'toggleable' => 'Toggleable Columns',
            'toggleable_desc' => 'Show/hide columns',
        ],

        // Infolist Demo
        'infolist' => [
            'title' => 'InfoList Demo',
            'description' => 'A showcase of the InfoList component for displaying read-only data in a structured format.',
            'text_entry' => 'Text Entry',
            'text_entry_desc' => 'Display text values',
            'badge_entry' => 'Badge Entry',
            'badge_entry_desc' => 'Status indicators',
            'image_entry' => 'Image Entry',
            'image_entry_desc' => 'Display images',
            'color_entry' => 'Color Entry',
            'color_entry_desc' => 'Color swatches',
            'code_entry' => 'Code Entry',
            'code_entry_desc' => 'Code snippets',
        ],

        // Actions Demo
        'actions' => [
            'title' => 'Actions Demo',
            'description' => 'A comprehensive showcase of all action types, variants, and configurations available in the Laravilt panel.',
            'closure_actions' => 'Closure Actions',
            'closure_actions_desc' => 'Execute backend code',
            'confirmations' => 'Confirmations',
            'confirmations_desc' => 'Modal dialogs',
            'modal_forms' => 'Modal Forms',
            'modal_forms_desc' => 'Inline form inputs',
            'url_actions' => 'URL Actions',
            'url_actions_desc' => 'Navigation links',
            'code_examples' => 'Code Examples',
        ],

        // Notifications Demo
        'notifications' => [
            'title' => 'Notifications Demo',
            'description' => 'A showcase of the notification system with different types, durations, and configurations.',
            'quick_notifications' => 'Quick Notifications (Client-Side)',
            'quick_notifications_desc' => 'Instant client-side notifications without server roundtrip.',
            'success' => 'Success',
            'success_title' => 'Success!',
            'success_body' => 'Your action completed successfully.',
            'error' => 'Error',
            'error_title' => 'Error!',
            'error_body' => 'Something went wrong. Please try again.',
            'warning' => 'Warning',
            'warning_title' => 'Warning!',
            'warning_body' => 'Please review this action before proceeding.',
            'info' => 'Info',
            'info_title' => 'Information',
            'info_body' => 'Here is some useful information for you.',
            'duration_control' => 'Duration Control',
            'duration_control_desc' => 'Notifications with different display durations.',
            'quick_2s' => 'Quick (2s)',
            'quick_2s_body' => 'This disappears quickly!',
            'normal_5s' => 'Normal (5s)',
            'normal_5s_body' => 'This is the default duration.',
            'long_10s' => 'Long (10s)',
            'long_10s_body' => 'This stays visible for 10 seconds.',
            'persistent' => 'Persistent',
            'persistent_body' => 'Click X to dismiss this notification.',
            '2_seconds' => '2 Seconds',
            '5_seconds' => '5 Seconds',
            '10_seconds' => '10 Seconds',
            'code_examples' => 'Code Examples',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Sidebar
    |--------------------------------------------------------------------------
    */
    'sidebar' => [
        'toggle' => 'Toggle Sidebar',
        'collapse' => 'Collapse',
        'expand' => 'Expand',
    ],

    /*
    |--------------------------------------------------------------------------
    | Appearance
    |--------------------------------------------------------------------------
    */
    'appearance' => [
        'title' => 'Appearance',
        'light' => 'Light',
        'dark' => 'Dark',
        'system' => 'System',
    ],

    /*
    |--------------------------------------------------------------------------
    | Settings
    |--------------------------------------------------------------------------
    */
    'settings' => [
        'title' => 'Settings',
        'profile' => 'Profile',
        'profile_description' => 'Manage your profile settings',
        'appearance' => 'Appearance',
        'appearance_description' => 'Customize the appearance of the app',
        'appearance_light' => 'Light',
        'appearance_dark' => 'Dark',
        'appearance_system' => 'System',
    ],

    /*
    |--------------------------------------------------------------------------
    | Notifications
    |--------------------------------------------------------------------------
    */
    'notifications' => [
        'title' => 'Notifications',
        'no_notifications' => 'No notifications yet',
        'unread_count' => ':count unread',
        'mark_all_read' => 'Mark all as read',
        'mark_as_read' => 'Mark as read',
        'delete' => 'Delete',
        'delete_all' => 'Delete all',
    ],

    /*
    |--------------------------------------------------------------------------
    | Language
    |--------------------------------------------------------------------------
    */
    'language' => [
        'switch' => 'Switch Language',
        'current' => 'Current Language',
    ],
];
</file>

<file path="resources/css/app.css">
/* Plugin styles */
</file>

<file path="resources/js/components/PanelSidebar.vue">
<script setup lang="ts">
import NavMain from '@/components/NavMain.vue';
import NavUser from '@/components/NavUser.vue';
import {
    Sidebar,
    SidebarContent,
    SidebarFooter,
    SidebarHeader,
    SidebarMenu,
    SidebarMenuButton,
    SidebarMenuItem,
} from '@/components/ui/sidebar';
import { Link } from '@inertiajs/vue3';
import * as LucideIcons from 'lucide-vue-next';
import { computed, type Component } from 'vue';
import AppLogoIcon from './AppLogoIcon.vue';

// Props for component mode (when used via Blade bridge)
const props = defineProps<{
    navigation?: any[]
    panel?: {
        id: string
        path: string
        brandName: string
        brandLogo?: string
    }
    user?: {
        name: string
        email: string
    }
    collapsible?: boolean
    variant?: string
}>()

// Support prop-based panel data
const panel = computed(() => props.panel || {});
const panelNavigation = computed(() => {
    // Use component prop navigation if available
    const nav = props.navigation || panel.value.navigation || [];

    return nav.map((item: any) => ({
        type: item.type, // Preserve type field (item/group)
        title: item.title,
        href: item.url,
        url: item.url, // Include both href and url for compatibility
        icon: getIconComponent(item.icon),
        collapsed: item.collapsed, // Preserve collapsed state
        items: item.items?.map((subItem: any) => ({
            type: subItem.type,
            title: subItem.title,
            href: subItem.url,
            url: subItem.url,
            icon: getIconComponent(subItem.icon),
        })),
    }));
});

// Get Lucide icon component from icon name
const getIconComponent = (iconName: string | null | undefined): Component => {
    if (!iconName) return LucideIcons.LayoutGrid;

    // If it starts with 'heroicon-o-', map it to Lucide
    if (iconName.startsWith('heroicon-o-')) {
        const iconMap: Record<string, string> = {
            'heroicon-o-home': 'Home',
            'heroicon-o-user': 'User',
            'heroicon-o-users': 'Users',
            'heroicon-o-user-group': 'Users',
            'heroicon-o-cog': 'Settings',
            'heroicon-o-chart-bar': 'BarChart',
            'heroicon-o-document-text': 'FileText',
            'heroicon-o-folder': 'Folder',
            'heroicon-o-shopping-cart': 'ShoppingCart',
        };

        const lucideName = iconMap[iconName] || 'LayoutGrid';
        return (LucideIcons as any)[lucideName] || LucideIcons.LayoutGrid;
    }

    // Try to use it as a Lucide icon name directly
    return (LucideIcons as any)[iconName] || LucideIcons.LayoutGrid;
};

const dashboardHref = computed(() => `/${panel.value.path || 'admin'}`);
</script>

<template>
    <Sidebar collapsible="icon" variant="inset">
        <SidebarHeader>
            <SidebarMenu>
                <SidebarMenuItem>
                    <SidebarMenuButton size="lg" as-child>
                        <Link :href="dashboardHref">
                            <!-- Brand Logo -->
                            <div
                                class="flex aspect-square size-8 items-center justify-center rounded-md bg-sidebar-primary text-sidebar-primary-foreground"
                            >
                                <img
                                    v-if="panel.brandLogo"
                                    :src="panel.brandLogo"
                                    :alt="panel.brandName || 'Logo'"
                                    class="size-5 object-contain"
                                />
                                <AppLogoIcon
                                    v-else
                                    class="size-5 fill-current text-white dark:text-black"
                                />
                            </div>
                            <!-- Brand Name -->
                            <div class="ms-1 grid flex-1 text-sm">
                                <span class="mb-0.5 truncate leading-tight font-semibold text-start rtl:text-right">
                                    {{ panel.brandName || 'Admin Panel' }}
                                </span>
                            </div>
                        </Link>
                    </SidebarMenuButton>
                </SidebarMenuItem>
            </SidebarMenu>
        </SidebarHeader>

        <SidebarContent>
            <NavMain :items="panelNavigation" />
        </SidebarContent>

        <SidebarFooter>
            <NavUser :user="user" />
        </SidebarFooter>
    </Sidebar>
    <slot />
</template>
</file>

<file path="resources/js/layouts/CardLayout.vue">
<script setup lang="ts">
import AppLogoIcon from '@/components/AppLogoIcon.vue';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import { usePage } from '@inertiajs/vue3';
import { computed, onMounted, watchEffect } from 'vue';

interface Props {
    title?: string;
    description?: string;
}

const props = defineProps<Props>();
const page = usePage();

// Get the panel or home URL
const homeUrl = computed(() => {
    const panelId = (page.props as any).panelId;
    return panelId ? `/${panelId}` : '/';
});

// Get panel data
const panel = computed(() => (page.props as any).panel);
const brandLogo = computed(() => panel.value?.brandLogo);
const brandName = computed(() => panel.value?.brandName);
const font = computed(() => panel.value?.font);

// Apply font styles when component mounts
watchEffect(() => {
    if (font.value && typeof document !== 'undefined') {
        // Load Google Font if URL is provided
        if (font.value.url) {
            const existingLink = document.querySelector(`link[href="${font.value.url}"]`);
            if (!existingLink) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = font.value.url;
                document.head.appendChild(link);
            }
        }

        // Apply font family to body
        if (font.value.family) {
            document.body.style.fontFamily = `"${font.value.family}", sans-serif`;
        }
    }
});
</script>

<template>
    <div
        class="flex min-h-svh flex-col items-center justify-center gap-6 bg-background p-6 md:p-10"
        :style="font?.family ? { fontFamily: `'${font.family}', sans-serif` } : {}"
    >
        <div class="w-full max-w-sm">
            <div class="flex flex-col gap-6">
                <!-- Logo -->
                <div class="flex flex-col items-center gap-3">
                    <a
                        :href="homeUrl"
                        class="flex flex-col items-center gap-2 font-medium"
                    >
                        <div
                            class="flex items-center justify-center"
                        >
                            <!-- Use panel brand logo if available -->
                            <img
                                v-if="brandLogo"
                                :src="brandLogo"
                                :alt="brandName || title"
                                class="h-9 w-auto max-w-[200px] object-contain"
                            />
                            <!-- Fallback to AppLogoIcon -->
                            <AppLogoIcon
                                v-else
                                class="size-9 fill-current text-[var(--foreground)] dark:text-white"
                            />
                        </div>
                        <span class="sr-only">{{ brandName || title }}</span>
                    </a>

                    <!-- Title and Description -->
                    <div class="space-y-1 text-center">
                        <h1 class="text-xl font-medium">{{ title }}</h1>
                        <p
                            v-if="description"
                            class="text-center text-sm text-muted-foreground"
                        >
                            {{ description }}
                        </p>
                    </div>
                </div>

                <!-- Content -->
                <slot />
            </div>
        </div>
        <NotificationContainer />
    </div>
</template>
</file>

<file path="resources/js/layouts/PanelLayout.vue">
<script setup lang="ts">
import AppContent from '@/components/AppContent.vue';
import AppShell from '@/components/AppShell.vue';
import AppSidebar from '@laravilt/panel/components/PanelSidebar.vue';
import AppSidebarHeader from '@/components/AppSidebarHeader.vue';
import { NotificationContainer } from '@laravilt/notifications/app.ts';
import { usePage } from '@inertiajs/vue3';
import { computed, onMounted, watch } from 'vue';

interface BreadcrumbItem {
    title: string;
    href: string;
}

interface Props {
    breadcrumbs?: BreadcrumbItem[];
}

withDefaults(defineProps<Props>(), {
    breadcrumbs: () => [],
});

// Get shared panel data from Inertia
const page = usePage();
const panelData = computed(() => page.props.panel as any);
const user = computed(() => page.props.auth?.user as any);

// Panel Font Loading
const loadPanelFont = () => {
    const font = panelData.value?.font;
    if (font?.url && font?.family) {
        // Load font stylesheet
        const linkId = `panel-font-${font.family.replace(/\s+/g, '-').toLowerCase()}`;
        if (!document.getElementById(linkId)) {
            const link = document.createElement('link');
            link.id = linkId;
            link.rel = 'stylesheet';
            link.href = font.url;
            document.head.appendChild(link);
        }

        // Apply font family with !important to override Tailwind's @theme
        const fontValue = `"${font.family}", ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'`;
        document.documentElement.style.setProperty('--font-sans', fontValue);
        document.body.style.setProperty('font-family', fontValue, 'important');
        document.documentElement.style.setProperty('font-family', fontValue, 'important');
    }
};

onMounted(() => {
    loadPanelFont();
});

watch(panelData, () => {
    loadPanelFont();
});
</script>

<template>
    <AppShell variant="sidebar">
        <AppSidebar
            :navigation="panelData?.navigation"
            :panel="panelData"
            :user="user"
        />
        <AppContent variant="sidebar" class="overflow-hidden">
            <AppSidebarHeader :breadcrumbs="breadcrumbs" />
            <slot />
        </AppContent>
        <NotificationContainer />
    </AppShell>
</template>
</file>

<file path="resources/js/layouts/SettingsLayout.vue">
<script setup lang="ts">
import { Link } from '@inertiajs/vue3';
import { computed } from 'vue';
import PanelLayout from './PanelLayout.vue';
import { Skeleton } from '@/components/ui/skeleton';

interface NavigationItem {
    title: string;
    href: string;
    icon?: string;
    active?: boolean;
}

interface BreadcrumbItem {
    title: string;
    href: string;
}

const props = withDefaults(defineProps<{
    breadcrumbs?: BreadcrumbItem[];
    navigation?: NavigationItem[];
    title?: string;
    description?: string;
    loading?: boolean;
}>(), {
    loading: false,
});

// Get current URL to determine active navigation item
const currentUrl = computed(() => {
    return window.location.pathname;
});

// Enhance navigation items with active state
const enhancedNavigation = computed(() => {
    if (!props.navigation) return [];

    return props.navigation.map(item => ({
        ...item,
        active: currentUrl.value === item.href,
    }));
});
</script>

<template>
    <PanelLayout :breadcrumbs="breadcrumbs">
        <div class="px-4 py-6">
            <!-- Settings Title and Description -->
            <div v-if="title" class="mb-8 space-y-0.5">
                <h2 class="text-xl font-semibold tracking-tight">{{ title }}</h2>
                <p v-if="description" class="text-sm text-muted-foreground">
                    {{ description }}
                </p>
            </div>

            <div class="flex flex-col lg:flex-row lg:space-x-12">
                <!-- Sidebar Navigation -->
                <aside class="w-full max-w-xl lg:w-48">
                    <nav class="flex flex-col space-y-1 space-x-0">
                        <Link
                            v-for="item in enhancedNavigation"
                            :key="item.href"
                            :href="item.href"
                            data-slot="button"
                            :class="[
                                'inline-flex items-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all',
                                'disabled:pointer-events-none disabled:opacity-50',
                                '[&_svg]:pointer-events-none [&_svg:not([class*=\'size-\'])]:size-4 shrink-0 [&_svg]:shrink-0',
                                'outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
                                'aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive',
                                'hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50',
                                'h-9 px-4 py-2 has-[>svg]:px-3 w-full justify-start',
                                item.active ? 'bg-muted' : '',
                            ]"
                        >
                            {{ item.title }}
                        </Link>
                    </nav>
                </aside>

                <!-- Separator for mobile -->
                <div
                    data-orientation="horizontal"
                    role="none"
                    data-slot="separator-root"
                    class="bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px my-6 lg:hidden"
                ></div>

                <!-- Main Content Area -->
                <div class="flex-1 md:max-w-2xl">
                    <!-- Loading Skeleton -->
                    <div v-if="loading" v-cloak class="max-w-2xl space-y-6">
                        <!-- Page Header Skeleton -->
                        <header class="space-y-2">
                            <Skeleton class="h-6 w-48" />
                            <Skeleton class="h-4 w-80" />
                        </header>

                        <!-- Content Skeleton -->
                        <div class="space-y-6">
                            <!-- Card/Section Skeleton -->
                            <div class="flex items-start gap-3">
                                <Skeleton class="h-10 w-10 rounded-lg shrink-0" />
                                <div class="flex-1 space-y-2">
                                    <Skeleton class="h-5 w-32" />
                                    <Skeleton class="h-4 w-full max-w-md" />
                                </div>
                            </div>

                            <!-- Form Fields Skeleton -->
                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <Skeleton class="h-4 w-24" />
                                    <Skeleton class="h-10 w-full" />
                                </div>
                                <div class="space-y-2">
                                    <Skeleton class="h-4 w-24" />
                                    <Skeleton class="h-10 w-full" />
                                </div>
                            </div>

                            <!-- Action Button Skeleton -->
                            <Skeleton class="h-10 w-32" />
                        </div>
                    </div>

                    <!-- Actual Content -->
                    <div v-else v-cloak>
                        <slot />
                    </div>
                </div>
            </div>
        </div>
    </PanelLayout>
</template>
</file>

<file path="resources/js/pages/laravilt/Page.vue">
<script setup lang="ts">
import { Form, Head, Link, router } from '@inertiajs/vue3';
import ActionButton from '@laravilt/actions/components/ActionButton.vue';
import ErrorProvider from '@laravilt/forms/components/ErrorProvider.vue';
import Schema from '@laravilt/schemas/components/Schema.vue';
import Table from '@laravilt/tables/components/Table.vue';
import ApiTester from '@laravilt/tables/components/ApiTester.vue';
import SocialLogin from '@laravilt/auth/components/SocialLogin.vue';
import OtpResendHook from '@laravilt/auth/components/OtpResendHook.vue';
import RelationManagers from '../../components/RelationManagers.vue';
import { useLocalization } from '@laravilt/support/composables';
import { computed, onMounted, ref, markRaw, watch } from 'vue';

const { trans } = useLocalization();
import CardLayout from '../../layouts/CardLayout.vue';
import PanelLayout from '../../layouts/PanelLayout.vue';
import SettingsLayout from '../../layouts/SettingsLayout.vue';

// Mark layout components as raw to prevent Vue from making them reactive
// This helps with persistent layouts performance
const PanelLayoutRaw = markRaw(PanelLayout);
const CardLayoutRaw = markRaw(CardLayout);
const SettingsLayoutRaw = markRaw(SettingsLayout);

// Hook components map for dynamic rendering
const hookComponents: Record<string, any> = {
    OtpResendHook,
};

interface BreadcrumbItem {
    label: string;
    url: string | null;
}

interface NavigationItem {
    title: string;
    href: string;
    icon?: string;
    active?: boolean;
}

interface PageData {
    heading: string;
    subheading?: string | null;
    headerActions: any[];
    actionUrl?: string;
}

const props = defineProps<{
    page: PageData;
    content?: string | null;
    pageSlug?: string;
    panelId?: string;
    schema?: any[];
    layout?: 'panel' | 'card' | 'simple' | 'full' | 'settings';
    formAction?: string;
    formController?: string;
    clusterNavigation?: NavigationItem[];
    clusterTitle?: string;
    clusterDescription?: string;
    formMethod?: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
    canResetPassword?: boolean;
    canRegister?: boolean;
    canLogin?: boolean;
    resetPasswordUrl?: string;
    registerUrl?: string;
    loginUrl?: string;
    socialProviders?: any[];
    socialRedirectUrl?: string;
    status?: string;
    hasTwoFactorRecovery?: boolean;
    recoveryUrl?: string;
    hasPasskeys?: boolean;
    passkeyLoginOptionsUrl?: string;
    passkeyLoginUrl?: string;
    hasMagicLinks?: boolean;
    magicLinkSendUrl?: string;
    breadcrumbs?: BreadcrumbItem[];
    topHook?:
        | string
        | { component: string; props?: Record<string, any> }
        | null;
    bottomHook?:
        | string
        | { component: string; props?: Record<string, any> }
        | null;
    hasViewToggle?: boolean;
    hasGridOption?: boolean;
    hasApiOption?: boolean;
    availableViews?: string[];
    currentView?: 'table' | 'grid' | 'api';
    apiResource?: any;
    apiToken?: string | null;
    record?: any;
    relationManagers?: any[];
    resourceSlug?: string;
}>();

// View toggle functionality - saves preference to localStorage per resource
const getViewStorageKey = () => {
    // Use pageSlug to create a unique key per resource
    return `laravilt_view_${props.pageSlug || 'default'}`;
};

const getSavedView = (): 'table' | 'grid' | 'api' | null => {
    if (typeof window === 'undefined') return null;
    const saved = localStorage.getItem(getViewStorageKey());
    const validViews = props.availableViews || ['table', 'grid'];
    if (saved && validViews.includes(saved)) {
        return saved as 'table' | 'grid' | 'api';
    }
    return null;
};

const saveViewPreference = (view: 'table' | 'grid' | 'api') => {
    if (typeof window === 'undefined') return;
    localStorage.setItem(getViewStorageKey(), view);
};

const toggleView = (view: 'table' | 'grid' | 'api') => {
    // Save preference to localStorage
    saveViewPreference(view);

    const url = new URL(window.location.href);
    url.searchParams.set('view', view);
    router.visit(url.toString(), { preserveState: true, preserveScroll: true });
};

// Compute if we need to check/redirect for saved view preference
// This is true ONLY when we need to redirect to saved preference
const needsViewCheck = computed(() => {
    if (!props.hasViewToggle) return false;
    if (typeof window === 'undefined') return false;

    const urlParams = new URLSearchParams(window.location.search);
    const urlView = urlParams.get('view');

    // If URL already has a view param, no check needed
    if (urlView) return false;

    // If page > 1, it's infinite scroll, no check needed
    const pageParam = urlParams.get('page');
    if (pageParam && parseInt(pageParam) > 1) return false;

    // Check if saved view differs from current
    const saved = localStorage.getItem(`laravilt_view_${props.pageSlug || 'default'}`);
    const validViews = props.availableViews || ['table', 'grid'];
    if (saved && validViews.includes(saved)) {
        return saved !== (props.currentView || 'table');
    }

    return false;
});

// Computed to check if current view is API
const isApiView = computed(() => props.currentView === 'api');

// Computed to check if we have relation managers to display
const hasRelationManagers = computed(() => {
    return props.relationManagers && props.relationManagers.length > 0 && props.record && props.resourceSlug;
});

// Redirect to saved view preference on mount if needed
const checkSavedViewPreference = () => {
    if (needsViewCheck.value) {
        const savedView = getSavedView();
        if (savedView) {
            const url = new URL(window.location.href);
            url.searchParams.set('view', savedView);
            router.visit(url.toString(), { preserveState: true, preserveScroll: true, replace: true });
        }
    }
};

const contentRef = ref<HTMLElement | null>(null);
const vueApps = ref<any[]>([]);
const formRendererRef = ref<any>(null);

// Page loading state for smooth transitions
const isPageLoading = ref(true);
const isPageMounted = ref(false);

// Helper to get form data from formRendererRef (handles array case from v-for)
const getFormRendererData = () => {
    if (!formRendererRef.value) {
        return {};
    }

    // If it's an array (from v-for), get data from all renderers and merge
    if (Array.isArray(formRendererRef.value)) {
        let mergedData = {};
        for (const renderer of formRendererRef.value) {
            if (renderer?.getFormData) {
                mergedData = { ...mergedData, ...renderer.getFormData() };
            }
        }
        return mergedData;
    }

    // Single renderer
    if (formRendererRef.value?.getFormData) {
        return formRendererRef.value.getFormData();
    }

    return {};
};

// Use breadcrumbs from props (backend) or fallback to simple default
const breadcrumbs = computed<BreadcrumbItem[]>(() => {
    if (props.breadcrumbs && props.breadcrumbs.length > 0) {
        return props.breadcrumbs;
    }
    // Fallback: simple Dashboard  Current Page
    return [
        {
            label: 'Dashboard',
            url: `/${props.panelId}`,
        },
        {
            label: props.page.heading,
            url: null,
        },
    ];
});

// Merge actionUrl into each action (only if action doesn't have its own)
const actionsWithUrl = computed(() => {
    if (!props.page.headerActions) return [];

    return props.page.headerActions.map(action => ({
        ...action,
        actionUrl: action.actionUrl || props.page.actionUrl,
    }));
});

// Use action route if actions are available, otherwise use formAction
const computedFormAction = computed(() => {
    return actionsWithUrl.value && actionsWithUrl.value.length > 0
        ? undefined
        : props.formAction;
});

// Extract actions from schema (actions are embedded in form schemas for Create/Edit pages)
const schemaActions = computed(() => {
    if (!props.schema || !Array.isArray(props.schema)) return [];

    const actions: any[] = [];

    for (const item of props.schema) {
        // Check if this item is a schema container (form)
        if (item.fields || item.schema) {
            const schemaFields = item.schema || item.fields || [];
            // Find action objects in the schema
            for (const field of schemaFields) {
                if (field.hasAction === true || (field.name && !field.component)) {
                    actions.push({
                        ...field,
                        actionUrl: field.actionUrl || props.page.actionUrl,
                    });
                }
            }
        }
    }

    return actions;
});

// Check if schema contains form fields (not just Grid/Table/InfoList)
const hasFormSchema = computed(() => {
    if (!props.schema || !Array.isArray(props.schema)) return false;

    // Check if we have schema-embedded actions (indicates it's a form page like Create/Edit)
    if (schemaActions.value.length === 0) return false;

    // Check if schema has form fields (fields or schema property, but not columns/card which are Grid/Table)
    return props.schema.some((item: any) => {
        const hasFields = item.fields || item.schema;
        const isGridOrTable = item.columns || item.card;
        return hasFields && !isGridOrTable;
    });
});

// Check if schema contains InfoList (View pages - should not have internal scroll)
const hasInfoListSchema = computed(() => {
    if (!props.schema || !Array.isArray(props.schema)) return false;

    // InfoList pages have fields/schema but NO actions (no submit button)
    // Unlike form pages which have schemaActions
    return props.schema.some((item: any) => {
        const hasFields = item.fields || item.schema;
        const isGridOrTable = item.columns || item.card;
        return hasFields && !isGridOrTable;
    }) && schemaActions.value.length === 0;
});

// Determine if page should use internal scroll (only for Grid/Table views, not forms or infolists)
const shouldUseInternalScroll = computed(() => {
    return !hasFormSchema.value && !hasInfoListSchema.value;
});

const LayoutComponent = computed(() => {
    switch (props.layout) {
        case 'card':
            return CardLayoutRaw;
        case 'settings':
            return SettingsLayoutRaw;
        case 'panel':
        default:
            return PanelLayoutRaw;
    }
});

// Transform breadcrumbs to frontend format (label/url  title/href)
const transformedBreadcrumbs = computed(() => {
    return breadcrumbs.value.map(item => ({
        title: item.label,
        href: item.url || '#',
    }));
});

const layoutProps = computed(() => {
    if (props.layout === 'card') {
        return {
            title: props.page.heading,
            description: props.page.subheading,
        };
    }
    if (props.layout === 'settings') {
        return {
            breadcrumbs: transformedBreadcrumbs.value,
            navigation: props.clusterNavigation,
            title: props.clusterTitle,
            description: props.clusterDescription,
        };
    }
    return {
        breadcrumbs: transformedBreadcrumbs.value,
    };
});

const handleFormSubmit = (event: Event) => {
    event.preventDefault();

    // Step 1: Get the first action
    const action = actionsWithUrl.value[0];
    if (!action || !action.actionUrl) {
        console.error('No action found for form submission');
        return;
    }

    // Step 2: Get form data from FormRenderer
    let data: Record<string, any> = {};

    if (formRendererRef.value && typeof formRendererRef.value.getFormData === 'function') {
        data = formRendererRef.value.getFormData();
    } else {
        console.error('FormRenderer ref not available or getFormData method not found');
        return;
    }

    console.log(' Form data collected from FormRenderer:', data);

    // Step 3: Add action token
    if (action.actionToken) {
        data.token = action.actionToken;
    } else {
        data.action = action.name;
    }

    console.log(' Data with token:', data);

    // Step 4: Submit via Inertia - Backend validation will run in the action closure
    router.post(action.actionUrl, data, {
        preserveState: (page) => {
            // Preserve state if there are errors (for validation)
            return Object.keys(page.props.errors || {}).length > 0;
        },
        preserveScroll: true,
        onError: (errors) => {
            console.error(' Validation errors received:', errors);
            console.log(' Page props errors:', props);
        },
        onSuccess: () => {
            console.log(' Action executed successfully');
        },
    });
};

// Passkey login handler
const handlePasskeyLogin = async () => {
    if (!props.passkeyLoginOptionsUrl || !props.passkeyLoginUrl) {
        return;
    }

    try {
        console.log('Starting passkey login...');

        // Get WebAuthn assertion options from server
        const optionsResponse = await fetch(props.passkeyLoginOptionsUrl, {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
            }
        });

        if (!optionsResponse.ok) {
            const text = await optionsResponse.text();
            console.error('Failed to fetch options:', optionsResponse.status, text);
            throw new Error(`Failed to fetch WebAuthn options: ${optionsResponse.status}`);
        }

        const options = await optionsResponse.json();
        console.log('Received WebAuthn options:', options);

        // Convert base64url strings to ArrayBuffer
        options.challenge = base64urlDecode(options.challenge);
        if (options.allowCredentials) {
            options.allowCredentials = options.allowCredentials.map((cred: any) => ({
                ...cred,
                id: base64urlDecode(cred.id)
            }));
        }

        // Get credential using WebAuthn API
        console.log('Calling navigator.credentials.get...');
        const credential = await navigator.credentials.get({
            publicKey: options
        }) as PublicKeyCredential;

        if (!credential) {
            throw new Error('No credential received');
        }

        console.log('Credential received:', credential.id);

        // Prepare assertion data for server
        const assertionResponse = credential.response as AuthenticatorAssertionResponse;
        const assertionData = {
            id: credential.id,
            rawId: arrayBufferToBase64url(credential.rawId),
            type: credential.type,
            response: {
                clientDataJSON: arrayBufferToBase64url(assertionResponse.clientDataJSON),
                authenticatorData: arrayBufferToBase64url(assertionResponse.authenticatorData),
                signature: arrayBufferToBase64url(assertionResponse.signature),
                userHandle: assertionResponse.userHandle ? arrayBufferToBase64url(assertionResponse.userHandle) : null
            }
        };

        console.log('Sending assertion to server...');

        // Send assertion to server
        const response = await fetch(props.passkeyLoginUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify(assertionData)
        });

        if (!response.ok) {
            throw new Error(`Login failed: ${response.status}`);
        }

        const result = await response.json();
        console.log('Login successful:', result);

        // Redirect to dashboard
        if (result.redirect) {
            window.location.href = result.redirect;
        }

    } catch (error) {
        console.error('Passkey login failed:', error);
        alert('Failed to login with passkey: ' + (error as Error).message);
    }
};

// Magic link handler
const sendingMagicLink = ref(false);
const handleSendMagicLink = async () => {
    if (!props.magicLinkSendUrl) {
        return;
    }

    if (sendingMagicLink.value) {
        return;
    }

    sendingMagicLink.value = true;

    try {
        console.log('Sending magic link...');

        const response = await fetch(props.magicLinkSendUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to send magic link: ${response.status}`);
        }

        const result = await response.json();
        console.log('Magic link sent:', result);

        alert('Magic link sent! Check your email.');

        // If in debug mode and URL is provided, log it
        if (result.debug_url) {
            console.log('Debug magic link URL:', result.debug_url);
        }

    } catch (error) {
        console.error('Failed to send magic link:', error);
        alert('Failed to send magic link: ' + (error as Error).message);
    } finally {
        sendingMagicLink.value = false;
    }
};

// Helper functions for base64url encoding/decoding
function base64urlDecode(base64url: string): ArrayBuffer {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const padded = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
    const binary = atob(padded);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

function arrayBufferToBase64url(buffer: ArrayBuffer): string {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

onMounted(() => {
    // Check if we should redirect to saved view preference
    checkSavedViewPreference();

    // Mark page as mounted and hide loading after a short delay
    isPageMounted.value = true;
    setTimeout(() => {
        isPageLoading.value = false;
    }, 100);
});
</script>

<template>
    <Head :title="page.heading" />

    <component :is="LayoutComponent" v-bind="layoutProps">
        <template v-if="layout === 'settings'">
            <section class="max-w-xl space-y-12">
                <div class="flex flex-col space-y-6">
                    <header>
                        <h3 class="mb-0.5 text-base font-medium">
                            {{ page.heading }}
                        </h3>
                        <p
                            v-if="page.subheading"
                            class="text-sm text-muted-foreground"
                        >
                            {{ page.subheading }}
                        </p>
                    </header>

                    <!-- Render Blade view content if provided -->
                    <div v-if="content" ref="contentRef" v-html="content" />

                    <!-- Render Schema Form if available -->
                    <div v-else-if="schema && schema.length">
                        <!-- Status Message -->
                        <div
                            v-if="status"
                            class="mb-4 rounded-md bg-green-50 p-4 text-sm font-medium text-green-600 dark:bg-green-950 dark:text-green-400"
                        >
                            {{ status }}
                        </div>

                        <!-- Top Hook -->
                        <component
                            v-if="topHook && typeof topHook === 'object'"
                            :is="topHook.component"
                            v-bind="topHook.props || {}"
                            class="mb-6"
                        />
                        <div
                            v-else-if="topHook && typeof topHook === 'string'"
                            v-html="topHook"
                            class="mb-6"
                        />

                        <!-- Use regular form when actions are present (ActionButton handles submission) -->
                        <form
                            v-if="actionsWithUrl && actionsWithUrl.length"
                            @submit.prevent="handleFormSubmit"
                            class="space-y-6"
                        >
                            <ErrorProvider :errors="$page.props.errors || {}">
                                <!-- Render Schema -->
                                <Schema ref="formRendererRef" :schema="schema" :form-controller="formController" />

                                <!-- Submit Actions -->
                                <div class="flex items-center gap-4">
                                    <ActionButton
                                        v-for="action in actionsWithUrl"
                                        :key="action.name"
                                        v-bind="action"
                                        :getFormData="() => formRendererRef?.getFormData()"
                                    />
                                </div>
                            </ErrorProvider>
                        </form>

                        <!-- Use Inertia Form when no actions (traditional form submission) -->
                        <Form
                            v-else
                            :action="computedFormAction"
                            :method="formMethod"
                            #default="{ errors, processing }"
                            class="space-y-6"
                        >
                            <ErrorProvider :errors="errors">
                                <!-- Render Schema -->
                                <Schema :schema="schema" :form-controller="formController" />
                            </ErrorProvider>
                        </Form>

                        <!-- Bottom Hook -->
                        <component
                            v-if="bottomHook && typeof bottomHook === 'object' && hookComponents[bottomHook.component]"
                            :is="hookComponents[bottomHook.component]"
                            v-bind="bottomHook.props || {}"
                            class="mt-6"
                        />
                        <div
                            v-else-if="bottomHook && typeof bottomHook === 'string'"
                            v-html="bottomHook"
                            class="mt-6"
                        />
                    </div>

                    <slot v-else />
                </div>
            </section>
        </template>

        <template v-else-if="layout === 'panel' || !layout">
            <div :class="[
                'flex flex-1 flex-col gap-4 p-4',
                shouldUseInternalScroll ? 'min-h-0 overflow-hidden max-h-[calc(100vh-4rem)]' : ''
            ]">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 flex-shrink-0">
                    <div>
                        <h1 class="text-2xl font-semibold">
                            {{ page.heading }}
                        </h1>
                        <p
                            v-if="page.subheading"
                            class="mt-1 text-sm text-muted-foreground"
                        >
                            {{ page.subheading }}
                        </p>
                    </div>

                    <!-- Header Actions -->
                    <div class="flex flex-wrap items-center gap-2">
                        <!-- View Toggle (Table/Grid/API) -->
                        <div
                            v-if="hasViewToggle"
                            class="flex items-center rounded-md border bg-muted p-1"
                            data-view-toggle
                        >
                            <!-- Table View Button (always shown) -->
                            <button
                                type="button"
                                @click="toggleView('table')"
                                :class="[
                                    'inline-flex items-center justify-center rounded px-3 py-1.5 text-sm font-medium transition-colors',
                                    currentView === 'table'
                                        ? 'bg-background text-foreground shadow-sm'
                                        : 'text-muted-foreground hover:text-foreground'
                                ]"
                                data-view-toggle-table
                                title="Table View"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="3" y1="9" x2="21" y2="9"/>
                                    <line x1="3" y1="15" x2="21" y2="15"/>
                                    <line x1="9" y1="3" x2="9" y2="21"/>
                                </svg>
                            </button>
                            <!-- Grid View Button (only if grid option is available) -->
                            <button
                                v-if="hasGridOption"
                                type="button"
                                @click="toggleView('grid')"
                                :class="[
                                    'inline-flex items-center justify-center rounded px-3 py-1.5 text-sm font-medium transition-colors',
                                    currentView === 'grid'
                                        ? 'bg-background text-foreground shadow-sm'
                                        : 'text-muted-foreground hover:text-foreground'
                                ]"
                                data-view-toggle-grid
                                title="Grid View"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                            </button>
                            <!-- API View Button (only if API option is available) -->
                            <button
                                v-if="hasApiOption"
                                type="button"
                                @click="toggleView('api')"
                                :class="[
                                    'inline-flex items-center justify-center rounded px-3 py-1.5 text-sm font-medium transition-colors',
                                    currentView === 'api'
                                        ? 'bg-background text-foreground shadow-sm'
                                        : 'text-muted-foreground hover:text-foreground'
                                ]"
                                data-view-toggle-api
                                title="API Tester"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 4h6v6H4z"/>
                                    <path d="M14 4h6v6h-6z"/>
                                    <path d="M4 14h6v6H4z"/>
                                    <path d="M17 14v3a2 2 0 0 1-2 2h-3"/>
                                    <path d="M14 17l3-3 3 3"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Action Buttons -->
                        <template v-if="actionsWithUrl && actionsWithUrl.length">
                            <ActionButton
                                v-for="action in actionsWithUrl"
                                :key="action.name"
                                v-bind="action"
                            />
                        </template>
                    </div>
                </div>

                <!-- Page Content Area -->
                <div class="flex-1 min-h-0 flex flex-col">
                    <!-- Render Blade view content if provided -->
                    <div v-if="content" ref="contentRef" v-html="content" />

                    <!-- Render Schema (Table/Grid/Form/InfoList) if available -->
                    <div v-else-if="schema && schema.length" :class="[
                        'flex-1 flex flex-col',
                        shouldUseInternalScroll ? 'min-h-0 overflow-y-auto' : ''
                    ]">
                        <ErrorProvider :errors="$page.props.errors || {}">
                            <!-- Form Schema (Create/Edit pages) -->
                            <template v-if="hasFormSchema">
                                <!-- Form Skeleton while loading -->
                                <div v-if="isPageLoading" class="space-y-6 pb-6 animate-in fade-in duration-150">
                                    <div class="bg-card rounded-xl border shadow-sm p-6 space-y-6">
                                        <!-- Section header skeleton -->
                                        <div class="flex items-center gap-3 pb-4 border-b">
                                            <div class="h-10 w-10 bg-muted/60 rounded-lg animate-pulse"></div>
                                            <div class="space-y-2 flex-1">
                                                <div class="h-4 bg-muted/60 rounded w-1/4 animate-pulse" style="animation-delay: 0ms"></div>
                                                <div class="h-3 bg-muted/60 rounded w-1/3 animate-pulse" style="animation-delay: 50ms"></div>
                                            </div>
                                        </div>
                                        <!-- Form fields skeleton -->
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <div class="h-4 bg-muted/60 rounded w-20 animate-pulse" style="animation-delay: 75ms"></div>
                                                <div class="h-10 bg-muted/60 rounded animate-pulse" style="animation-delay: 100ms"></div>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="h-4 bg-muted/60 rounded w-24 animate-pulse" style="animation-delay: 125ms"></div>
                                                <div class="h-10 bg-muted/60 rounded animate-pulse" style="animation-delay: 150ms"></div>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="h-4 bg-muted/60 rounded w-16 animate-pulse" style="animation-delay: 175ms"></div>
                                                <div class="h-24 bg-muted/60 rounded animate-pulse" style="animation-delay: 200ms"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Action button skeleton -->
                                    <div class="h-10 bg-muted/60 rounded w-32 animate-pulse" style="animation-delay: 225ms"></div>
                                </div>

                                <!-- Actual Form -->
                                <form
                                    v-else
                                    v-cloak
                                    @submit.prevent="handleFormSubmit"
                                    class="space-y-6 pb-6 animate-in fade-in duration-200"
                                >
                                    <div v-for="(item, index) in schema" :key="index">
                                        <!-- Render Schema (Form) - skip actions, they're rendered separately -->
                                        <Schema
                                            v-if="item.fields || item.schema"
                                            ref="formRendererRef"
                                            :schema="item.schema || item.fields || []"
                                            :parent-handles-actions="true"
                                            :form-controller="formController"
                                        />
                                    </div>

                                    <!-- Submit Actions for form -->
                                    <div
                                        v-if="schemaActions && schemaActions.length"
                                        class="flex items-center gap-4"
                                    >
                                        <ActionButton
                                            v-for="action in schemaActions"
                                            :key="action.name"
                                            v-bind="action"
                                            :getFormData="getFormRendererData"
                                        />
                                    </div>

                                    <!-- Relation Managers (for Edit pages with Form) -->
                                    <RelationManagers
                                        v-if="hasRelationManagers"
                                        :relation-managers="relationManagers"
                                        :owner-record-id="record?.id"
                                        :resource-slug="props.resourceSlug"
                                        :panel-id="panelId || ''"
                                    />
                                </form>
                            </template>

                            <!-- Non-form schema (Grid/Table/InfoList/API) -->
                            <template v-else>
                                <!-- InfoList/View Skeleton while loading -->
                                <div v-if="hasInfoListSchema && isPageLoading" class="space-y-6 animate-in fade-in duration-150">
                                    <div class="bg-card rounded-xl border shadow-sm">
                                        <!-- Section header skeleton -->
                                        <div class="flex items-center gap-3 p-6 border-b">
                                            <div class="h-10 w-10 bg-muted/60 rounded-lg animate-pulse"></div>
                                            <div class="space-y-2 flex-1">
                                                <div class="h-4 bg-muted/60 rounded w-1/4 animate-pulse" style="animation-delay: 0ms"></div>
                                                <div class="h-3 bg-muted/60 rounded w-1/3 animate-pulse" style="animation-delay: 50ms"></div>
                                            </div>
                                        </div>
                                        <!-- InfoList entries skeleton -->
                                        <div class="p-6 space-y-4">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="space-y-2">
                                                    <div class="h-3 bg-muted/60 rounded w-16 animate-pulse" style="animation-delay: 75ms"></div>
                                                    <div class="h-5 bg-muted/60 rounded w-3/4 animate-pulse" style="animation-delay: 100ms"></div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="h-3 bg-muted/60 rounded w-20 animate-pulse" style="animation-delay: 125ms"></div>
                                                    <div class="h-5 bg-muted/60 rounded w-2/3 animate-pulse" style="animation-delay: 150ms"></div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="h-3 bg-muted/60 rounded w-14 animate-pulse" style="animation-delay: 175ms"></div>
                                                    <div class="h-5 bg-muted/60 rounded w-1/2 animate-pulse" style="animation-delay: 200ms"></div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="h-3 bg-muted/60 rounded w-18 animate-pulse" style="animation-delay: 225ms"></div>
                                                    <div class="h-5 bg-muted/60 rounded w-full animate-pulse" style="animation-delay: 250ms"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- View redirect skeleton -->
                                <div v-else-if="needsViewCheck" class="space-y-4 animate-in fade-in duration-150">
                                    <div class="h-12 bg-muted/60 rounded-lg animate-pulse"></div>
                                    <div class="h-64 bg-muted/60 rounded-lg animate-pulse" style="animation-delay: 100ms"></div>
                                </div>

                                <!-- API View - Render ApiTester component -->
                                <div v-else-if="isApiView && apiResource" class="h-full flex flex-col animate-in fade-in duration-200">
                                    <ApiTester :api-resource="apiResource" :api-token="apiToken" />
                                </div>

                                <!-- Actual content (Table/InfoList) -->
                                <div v-else v-cloak class="h-full flex flex-col space-y-6 animate-in fade-in duration-200">
                                    <div v-for="(item, index) in schema" :key="index" class="h-full flex flex-col">
                                        <!-- Render Table (handles both table and grid views based on currentView) -->
                                        <Table
                                            v-if="item.columns"
                                            :table="item"
                                            :records="item.records || []"
                                            :pagination="item.pagination"
                                            :record-actions="item.recordActions || []"
                                            :bulk-actions="item.bulkActions || []"
                                            :filter-indicators="item.filterIndicators || []"
                                            :resource-slug="item.resourceSlug || ''"
                                            :query-route="item.queryRoute || ''"
                                            :current-view="currentView || 'table'"
                                        />

                                        <!-- Render Schema (InfoList - no actions) -->
                                        <Schema
                                            v-else-if="item.fields || item.schema"
                                            :schema="item.schema || item.fields || []"
                                            :form-controller="formController"
                                        />

                                        <!-- Fallback for unknown types -->
                                        <div v-else>
                                            <pre>{{ item }}</pre>
                                        </div>
                                    </div>

                                    <!-- Relation Managers (for View/Edit pages with InfoList) -->
                                    <RelationManagers
                                        v-if="hasRelationManagers && hasInfoListSchema"
                                        :relation-managers="relationManagers"
                                        :owner-record-id="record?.id"
                                        :resource-slug="props.resourceSlug"
                                        :panel-id="panelId || ''"
                                    />
                                </div>
                            </template>
                        </ErrorProvider>
                    </div>

                    <!-- Slot for programmatic content -->
                    <slot v-else>
                        <!-- Default empty state for custom pages -->
                        <div
                            class="flex h-full items-center justify-center rounded-lg border border-dashed p-8"
                        >
                            <div class="text-center">
                                <h3 class="text-lg font-semibold">
                                    Custom Page Content
                                </h3>
                                <p class="mt-2 text-sm text-muted-foreground">
                                    This is a standalone page. You can add
                                    custom components and content here.
                                </p>
                            </div>
                        </div>
                    </slot>
                </div>
            </div>
        </template>

        <template v-else>
            <!-- Non-panel layouts (like AuthCard) render content directly -->
            <div v-if="content" ref="contentRef" v-html="content" />

            <!-- Render Schema Form if available -->
            <div v-else-if="schema && schema.length">
                <!-- Status Message -->
                <div
                    v-if="status"
                    class="mb-4 rounded-md bg-green-50 p-4 text-sm font-medium text-green-600 dark:bg-green-950 dark:text-green-400"
                >
                    {{ status }}
                </div>

                <!-- Top Hook -->
                <component
                    v-if="topHook && typeof topHook === 'object'"
                    :is="topHook.component"
                    v-bind="topHook.props || {}"
                    class="mb-6"
                />
                <div
                    v-else-if="topHook && typeof topHook === 'string'"
                    v-html="topHook"
                    class="mb-6"
                />

                <!-- Use regular form when actions are present (ActionButton handles submission) -->
                <form
                    v-if="actionsWithUrl && actionsWithUrl.length"
                    @submit.prevent="handleFormSubmit"
                    class="flex flex-col gap-6"
                >
                    <ErrorProvider :errors="$page.props.errors || {}">
                        <!-- Render Schema -->
                        <Schema ref="formRendererRef" :schema="schema" :form-controller="formController" />

                        <!-- Submit Actions -->
                        <div class="flex flex-col gap-4">
                            <ActionButton
                                v-for="action in actionsWithUrl"
                                :key="action.name"
                                v-bind="action"
                                :getFormData="() => formRendererRef?.getFormData()"
                            />
                        </div>

                        <!-- Social Login -->
                        <SocialLogin
                            v-if="socialProviders && socialProviders.length > 0"
                            :providers="socialProviders"
                            :redirectUrl="socialRedirectUrl"
                        >
                            {{ trans('laravilt-auth::auth.social.or_continue_with') }}
                        </SocialLogin>

                        <!-- Auth Footer Links -->
                        <div v-if="canRegister && registerUrl" class="text-center text-sm text-muted-foreground">
                            {{ trans('laravilt-auth::auth.login.no_account') }}
                            <Link
                                :href="registerUrl"
                                class="text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500"
                            >
                                {{ trans('laravilt-auth::auth.login.sign_up') }}
                            </Link>
                        </div>

                        <div v-if="canLogin && loginUrl" class="text-center text-sm text-muted-foreground">
                            {{ trans('laravilt-auth::auth.register.have_account') }}
                            <Link
                                :href="loginUrl"
                                class="text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500"
                            >
                                {{ trans('laravilt-auth::auth.register.sign_in') }}
                            </Link>
                        </div>

                        <!-- Two-Factor Recovery Code Link -->
                        <div v-if="hasTwoFactorRecovery && recoveryUrl" class="text-center text-sm text-muted-foreground">
                            {{ trans('laravilt-auth::auth.two_factor_challenge.lost_device') }}
                            <Link
                                :href="recoveryUrl"
                                class="text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500"
                            >
                                {{ trans('laravilt-auth::auth.two_factor_challenge.use_recovery') }}
                            </Link>
                        </div>

                        <!-- Passkey Authentication Option -->
                        <div v-if="hasPasskeys && passkeyLoginOptionsUrl && passkeyLoginUrl" class="text-center text-sm text-muted-foreground">
                            {{ trans('laravilt-auth::auth.common.or') }}
                            <button
                                type="button"
                                @click="handlePasskeyLogin"
                                class="text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500"
                            >
                                {{ trans('laravilt-auth::auth.login.use_passkey') }}
                            </button>
                        </div>

                        <!-- Magic Link Authentication Option -->
                        <div v-if="hasMagicLinks && magicLinkSendUrl" class="text-center text-sm text-muted-foreground">
                            {{ trans('laravilt-auth::auth.common.or') }}
                            <button
                                type="button"
                                @click="handleSendMagicLink"
                                :disabled="sendingMagicLink"
                                class="text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {{ sendingMagicLink ? trans('laravilt-auth::auth.common.processing') : trans('laravilt-auth::auth.magic_link.send') }}
                            </button>
                        </div>
                    </ErrorProvider>
                </form>

                <!-- Use Inertia Form when no actions (traditional form submission) -->
                <Form
                    v-else
                    :action="computedFormAction"
                    :method="formMethod"
                    #default="{ errors, processing }"
                    class="flex flex-col gap-6"
                >
                    <ErrorProvider :errors="errors">
                        <!-- Render Schema -->
                        <Schema :schema="schema" :form-controller="formController" />
                    </ErrorProvider>
                </Form>

                <!-- Bottom Hook -->
                <component
                    v-if="bottomHook && typeof bottomHook === 'object' && hookComponents[bottomHook.component]"
                    :is="hookComponents[bottomHook.component]"
                    v-bind="bottomHook.props || {}"
                    class="mt-6"
                />
                <div
                    v-else-if="bottomHook && typeof bottomHook === 'string'"
                    v-html="bottomHook"
                    class="mt-6"
                />
            </div>

            <slot v-else />
        </template>
    </component>
</template>
</file>

<file path="resources/js/app.js">
// Plugin JavaScript
console.log('Plugin loaded: panel');
</file>

<file path="resources/js/index.js">
/**
 * Laravilt Panel Components
 *
 * Export all panel components for use in Vue applications
 */

// Panel Components
export { default as PanelSidebar } from './components/PanelSidebar.vue'
export { default as PanelPageLayout } from './components/PanelPageLayout.vue'
export { default as ManageRecordsComponent } from './components/ManageRecords.vue'

// Panel Pages
export { default as Page } from './pages/laravilt/Page.vue'
export { default as ManageRecords } from './pages/laravilt/ManageRecords.vue'
</file>

<file path="src/Commands/InstallPanelCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Artisan;

class InstallPanelCommand extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'panel:install
                            {--force : Overwrite existing files}
                            {--without-assets : Skip asset publishing}';

    /**
     * The console command description.
     */
    protected $description = 'Install Panel plugin';

    /**
     * Execute the console command.
     */
    public function handle(): int
    {
        $this->info('Installing {{ name }} plugin...');
        $this->newLine();

        // Publish config
        $this->publishConfig();

        $this->publishAssets();
        if (! $this->option('without-assets')) {
            $this->buildAssets();
        }
        $this->newLine();
        $this->info(' {{ name }} plugin installed successfully!');
        $this->newLine();

        return self::SUCCESS;
    }

    /**
     * Publish configuration file.
     */
    protected function publishConfig(): void
    {
        $this->info('Publishing configuration...');

        $params = ['--tag' => '{{ config }}-config'];

        if ($this->option('force')) {
            $params['--force'] = true;
        }

        Artisan::call('vendor:publish', $params, $this->output);
    }

    protected function publishAssets(): void
    {
        $this->info('Publishing assets...');

        $this->call('vendor:publish', [
            '--tag' => 'panel-assets',
            '--force' => true,
        ]);

        $this->components->success('Assets published successfully!');
    }

    protected function buildAssets(): void
    {
        $this->info('Building assets...');

        $process = Process::path(base_path('packages/laravilt/panel'))
            ->run('npm install && npm run build');

        if ($process->successful()) {
            $this->components->success('Assets built successfully!');
        } else {
            $this->components->error('Failed to build assets: '.$process->errorOutput());
        }
    }
}
</file>

<file path="src/Commands/MakePanelCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;

class MakePanelCommand extends Command
{
    protected $signature = 'laravilt:panel {id} {--path=}';

    protected $description = 'Create a new panel';

    public function handle(): int
    {
        $id = $this->argument('id');
        $path = $this->option('path') ?? $id;
        $studlyId = Str::studly($id);

        // Create provider
        $this->createPanelProvider($studlyId, $id, $path);

        // Create directory structure
        $this->createDirectories($studlyId);

        // Create dashboard page
        $this->createDashboard($studlyId);

        // Register provider
        $this->registerProvider($studlyId);

        $this->newLine();
        $this->components->info("Panel [{$id}] created successfully!");
        $this->components->info("Panel provider: app/Providers/Laravilt/{$studlyId}PanelProvider.php");
        $this->components->info("Pages directory: app/Laravilt/{$studlyId}/Pages");
        $this->components->info("Resources directory: app/Laravilt/{$studlyId}/Resources");
        $this->components->info("Widgets directory: app/Laravilt/{$studlyId}/Widgets");

        return self::SUCCESS;
    }

    protected function createPanelProvider(string $studlyId, string $id, string $path): void
    {
        $stub = File::get(__DIR__.'/../../stubs/panel-provider.stub');

        $content = str_replace(
            ['{{ studlyId }}', '{{ id }}', '{{ path }}'],
            [$studlyId, $id, $path],
            $stub
        );

        $providerPath = app_path("Providers/Laravilt/{$studlyId}PanelProvider.php");

        File::ensureDirectoryExists(dirname($providerPath));
        File::put($providerPath, $content);

        $this->components->info("Provider created: {$providerPath}");
    }

    protected function createDirectories(string $studlyId): void
    {
        $basePath = app_path("Laravilt/{$studlyId}");

        $directories = [
            'Pages',
            'Widgets',
            'Resources',
        ];

        foreach ($directories as $directory) {
            File::ensureDirectoryExists("{$basePath}/{$directory}");
        }

        $this->components->info("Directories created in app/Laravilt/{$studlyId}");
    }

    protected function createDashboard(string $studlyId): void
    {
        // Create PHP Dashboard page
        $stub = File::get(__DIR__.'/../../stubs/dashboard-page.stub');
        $content = str_replace(
            ['{{ namespace }}', '{{ class }}', '{{ title }}'],
            ["App\\Laravilt\\{$studlyId}\\Pages", 'Dashboard', "{$studlyId} Dashboard"],
            $stub
        );
        $path = app_path("Laravilt/{$studlyId}/Pages/Dashboard.php");
        File::put($path, $content);
        $this->components->info("Dashboard page created: {$path}");

        // Create Vue Dashboard page
        $vueStub = File::get(__DIR__.'/../../stubs/dashboard.stub');
        $vueContent = str_replace('{{ studlyId }}', $studlyId, $vueStub);
        $vuePath = resource_path("js/pages/{$studlyId}/Dashboard.vue");
        File::ensureDirectoryExists(dirname($vuePath));
        File::put($vuePath, $vueContent);
        $this->components->info("Dashboard view created: {$vuePath}");
    }

    protected function registerProvider(string $studlyId): void
    {
        $provider = "App\\Providers\\Laravilt\\{$studlyId}PanelProvider::class";
        $providersFile = base_path('bootstrap/providers.php');

        if (! File::exists($providersFile)) {
            $this->components->warn('bootstrap/providers.php not found. Please register the provider manually.');

            return;
        }

        $content = File::get($providersFile);

        if (str_contains($content, $provider)) {
            $this->components->warn('Provider already registered in bootstrap/providers.php');

            return;
        }

        // Add provider to the array
        $content = str_replace(
            'return [',
            "return [\n    {$provider},",
            $content
        );

        File::put($providersFile, $content);
        $this->components->info('Provider registered in bootstrap/providers.php');
    }
}
</file>

<file path="src/Commands/MakeRelationManagerCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;

use function Laravel\Prompts\select;
use function Laravel\Prompts\text;

class MakeRelationManagerCommand extends Command
{
    protected $signature = 'laravilt:relation {panel?} {resource?} {relationship?}';

    protected $description = 'Create a new relation manager for a resource';

    public function handle(): int
    {
        // Get available panels
        $panels = $this->getAvailablePanels();

        if (empty($panels)) {
            $this->components->error('No panels found. Please create a panel first.');

            return self::FAILURE;
        }

        // Get panel name
        $panel = $this->argument('panel');
        if (! $panel) {
            $panel = select(
                label: 'Select a panel:',
                options: $panels,
                default: $panels[0] ?? 'Admin'
            );
        }
        $panel = Str::studly($panel);

        // Get available resources
        $resources = $this->getAvailableResources($panel);

        if (empty($resources)) {
            $this->components->error("No resources found in panel [{$panel}]. Please create a resource first.");

            return self::FAILURE;
        }

        // Get resource name
        $resource = $this->argument('resource');
        if (! $resource) {
            $resource = select(
                label: 'Select a resource:',
                options: $resources,
                default: $resources[0] ?? null
            );
        }
        $resource = Str::studly($resource);

        // Get the model class from resource
        $modelClass = $this->getModelFromResource($panel, $resource);

        if (! $modelClass) {
            $this->components->error("Could not determine model class for resource [{$resource}].");

            return self::FAILURE;
        }

        // Get available relationships from the model
        $relationships = $this->getModelRelationships($modelClass);

        if (empty($relationships)) {
            $this->components->warn("No HasMany or BelongsToMany relationships found on model [{$modelClass}].");
            $relationship = text(
                label: 'Enter the relationship method name:',
                placeholder: 'e.g., reviews, variants, images',
                required: true
            );
        } else {
            $relationship = $this->argument('relationship');
            if (! $relationship) {
                $relationship = select(
                    label: 'Select a relationship:',
                    options: array_combine($relationships, $relationships),
                    default: $relationships[0] ?? null
                );
            }
        }

        $relationship = Str::camel($relationship);
        $relationManagerName = Str::studly($relationship).'RelationManager';

        // Get the related model
        $relatedModel = $this->getRelatedModel($modelClass, $relationship);
        $relatedModelName = class_basename($relatedModel ?? Str::studly(Str::singular($relationship)));

        // Ask for record title attribute
        $recordTitleAttribute = text(
            label: 'What is the title attribute for related records?',
            placeholder: 'e.g., name, title, label',
            default: $this->guessRecordTitleAttribute($relatedModel),
            required: true
        );

        // Create the relation manager directory
        $relationManagerDir = app_path("Laravilt/{$panel}/Resources/{$resource}/RelationManagers");
        File::ensureDirectoryExists($relationManagerDir);

        // Generate the relation manager file
        $this->createRelationManagerFile(
            $panel,
            $resource,
            $relationManagerName,
            $relationship,
            $relatedModelName,
            $recordTitleAttribute,
            $relationManagerDir
        );

        $this->newLine();
        $this->components->info("Relation Manager [{$relationManagerName}] created successfully!");
        $this->newLine();
        $this->components->info('File created:');
        $this->line("  app/Laravilt/{$panel}/Resources/{$resource}/RelationManagers/{$relationManagerName}.php");
        $this->newLine();
        $this->components->info("Don't forget to register the relation manager in your resource:");
        $this->line('  public static function getRelations(): array');
        $this->line('  {');
        $this->line('      return [');
        $this->line("          {$relationManagerName}::class,");
        $this->line('      ];');
        $this->line('  }');

        return self::SUCCESS;
    }

    protected function getAvailablePanels(): array
    {
        $laraviltPath = app_path('Laravilt');

        if (! File::isDirectory($laraviltPath)) {
            return [];
        }

        $directories = File::directories($laraviltPath);

        return collect($directories)
            ->map(fn ($dir) => basename($dir))
            ->values()
            ->toArray();
    }

    protected function getAvailableResources(string $panel): array
    {
        $resourcesPath = app_path("Laravilt/{$panel}/Resources");

        if (! File::isDirectory($resourcesPath)) {
            return [];
        }

        $directories = File::directories($resourcesPath);

        return collect($directories)
            ->map(fn ($dir) => basename($dir))
            ->values()
            ->toArray();
    }

    protected function getModelFromResource(string $panel, string $resource): ?string
    {
        $resourcePath = app_path("Laravilt/{$panel}/Resources/{$resource}/{$resource}Resource.php");

        if (! File::exists($resourcePath)) {
            return null;
        }

        $content = File::get($resourcePath);

        // Extract model class from protected static string $model = ModelClass::class;
        if (preg_match('/protected\s+static\s+string\s+\$model\s*=\s*([^;]+)::class/', $content, $matches)) {
            $modelClass = trim($matches[1]);

            // Check if it's a full namespace or just a class name
            if (! str_contains($modelClass, '\\')) {
                // Try to find the use statement
                if (preg_match('/use\s+([^;]+\\\\'.preg_quote($modelClass).')\s*;/', $content, $useMatch)) {
                    return $useMatch[1];
                }

                // Default to App\Models namespace
                return "App\\Models\\{$modelClass}";
            }

            return $modelClass;
        }

        return null;
    }

    protected function getModelRelationships(string $modelClass): array
    {
        if (! class_exists($modelClass)) {
            return [];
        }

        $reflection = new \ReflectionClass($modelClass);
        $relationships = [];

        foreach ($reflection->getMethods(\ReflectionMethod::IS_PUBLIC) as $method) {
            if ($method->class !== $modelClass) {
                continue;
            }

            $returnType = $method->getReturnType();
            if (! $returnType) {
                continue;
            }

            $typeName = $returnType->getName();

            // Check for HasMany, BelongsToMany, MorphMany, etc.
            if (in_array($typeName, [
                'Illuminate\Database\Eloquent\Relations\HasMany',
                'Illuminate\Database\Eloquent\Relations\BelongsToMany',
                'Illuminate\Database\Eloquent\Relations\MorphMany',
                'Illuminate\Database\Eloquent\Relations\HasManyThrough',
            ])) {
                $relationships[] = $method->getName();
            }
        }

        return $relationships;
    }

    protected function getRelatedModel(string $modelClass, string $relationship): ?string
    {
        if (! class_exists($modelClass)) {
            return null;
        }

        try {
            $model = new $modelClass;
            if (method_exists($model, $relationship)) {
                $relation = $model->{$relationship}();

                return get_class($relation->getRelated());
            }
        } catch (\Exception $e) {
            // Ignore errors
        }

        return null;
    }

    protected function guessRecordTitleAttribute(?string $modelClass): string
    {
        if (! $modelClass || ! class_exists($modelClass)) {
            return 'name';
        }

        $model = new $modelClass;
        $fillable = $model->getFillable();

        $candidates = ['name', 'title', 'label', 'subject', 'heading', 'email'];

        foreach ($candidates as $candidate) {
            if (in_array($candidate, $fillable)) {
                return $candidate;
            }
        }

        return 'id';
    }

    protected function createRelationManagerFile(
        string $panel,
        string $resource,
        string $relationManagerName,
        string $relationship,
        string $relatedModelName,
        string $recordTitleAttribute,
        string $dir
    ): void {
        $singularLabel = Str::title(Str::singular($relationship));
        $pluralLabel = Str::title($relationship);
        $icon = $this->guessIcon($relationship);

        // Generate columns based on common patterns
        $tableColumns = $this->generateTableColumns($relatedModelName, $recordTitleAttribute);
        $formFields = $this->generateFormFields($relatedModelName);

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$resource}\RelationManagers;

use Laravilt\Actions\CreateAction;
use Laravilt\Actions\DeleteAction;
use Laravilt\Actions\DeleteBulkAction;
use Laravilt\Actions\EditAction;
use Laravilt\Forms\Components\TextInput;
use Laravilt\Forms\Components\Textarea;
use Laravilt\Forms\Components\Toggle;
use Laravilt\Panel\Resources\RelationManagers\RelationManager;
use Laravilt\Schemas\Components\Grid;
use Laravilt\Schemas\Schema;
use Laravilt\Tables\Columns\TextColumn;
use Laravilt\Tables\Columns\ToggleColumn;
use Laravilt\Tables\Table;

class {$relationManagerName} extends RelationManager
{
    protected static string \$relationship = '{$relationship}';

    protected static ?string \$recordTitleAttribute = '{$recordTitleAttribute}';

    protected static ?string \$label = '{$singularLabel}';

    protected static ?string \$pluralLabel = '{$pluralLabel}';

    protected static ?string \$icon = '{$icon}';

    public function form(Schema \$schema): Schema
    {
        return \$schema
            ->schema([
                Grid::make(2)
                    ->columns(2)
                    ->schema([
{$formFields}
                    ]),
            ]);
    }

    public function table(Table \$table): Table
    {
        return \$table
            ->columns([
{$tableColumns}
            ])
            ->filters([
                // Add filters here
            ])
            ->headerActions([
                CreateAction::make(),
            ])
            ->recordActions([
                EditAction::make(),
                DeleteAction::make(),
            ])
            ->bulkActions([
                DeleteBulkAction::make(),
            ])
            ->defaultSort('created_at', 'desc');
    }
}
PHP;

        File::put("{$dir}/{$relationManagerName}.php", $content);
    }

    protected function guessIcon(string $relationship): string
    {
        $iconMap = [
            'review' => 'Star',
            'reviews' => 'Star',
            'comment' => 'MessageCircle',
            'comments' => 'MessageCircle',
            'image' => 'Image',
            'images' => 'Image',
            'photo' => 'Camera',
            'photos' => 'Camera',
            'variant' => 'Layers',
            'variants' => 'Layers',
            'option' => 'Settings',
            'options' => 'Settings',
            'attribute' => 'Tag',
            'attributes' => 'Tag',
            'tag' => 'Tag',
            'tags' => 'Tags',
            'category' => 'FolderTree',
            'categories' => 'FolderTree',
            'order' => 'ShoppingCart',
            'orders' => 'ShoppingCart',
            'item' => 'Box',
            'items' => 'Box',
            'file' => 'File',
            'files' => 'File',
            'document' => 'FileText',
            'documents' => 'FileText',
            'attachment' => 'Paperclip',
            'attachments' => 'Paperclip',
            'address' => 'MapPin',
            'addresses' => 'MapPin',
            'user' => 'Users',
            'users' => 'Users',
            'member' => 'UserCheck',
            'members' => 'UserCheck',
            'note' => 'StickyNote',
            'notes' => 'StickyNote',
            'activity' => 'Activity',
            'activities' => 'Activity',
            'log' => 'ScrollText',
            'logs' => 'ScrollText',
        ];

        $singular = Str::singular(strtolower($relationship));

        return $iconMap[$singular] ?? $iconMap[$relationship] ?? 'List';
    }

    protected function generateTableColumns(string $relatedModelName, string $recordTitleAttribute): string
    {
        $indent = '                ';
        $columns = [];

        // Add record title attribute
        $columns[] = "{$indent}TextColumn::make('{$recordTitleAttribute}')\n{$indent}    ->searchable()\n{$indent}    ->sortable(),";

        // Add common columns based on model name patterns
        $modelLower = strtolower($relatedModelName);

        if (str_contains($modelLower, 'review')) {
            $columns[] = "{$indent}TextColumn::make('rating')\n{$indent}    ->sortable(),";
            $columns[] = "{$indent}ToggleColumn::make('is_approved'),";
        } elseif (str_contains($modelLower, 'variant')) {
            $columns[] = "{$indent}TextColumn::make('sku')\n{$indent}    ->searchable(),";
            $columns[] = "{$indent}TextColumn::make('price')\n{$indent}    ->money('USD')\n{$indent}    ->sortable(),";
            $columns[] = "{$indent}TextColumn::make('stock_quantity')\n{$indent}    ->sortable(),";
            $columns[] = "{$indent}ToggleColumn::make('is_active'),";
        } elseif (str_contains($modelLower, 'image')) {
            $columns[] = "{$indent}TextColumn::make('alt'),";
            $columns[] = "{$indent}ToggleColumn::make('is_primary'),";
        }

        // Add created_at
        $columns[] = "{$indent}TextColumn::make('created_at')\n{$indent}    ->dateTime()\n{$indent}    ->sortable()\n{$indent}    ->toggleable(isToggledHiddenByDefault: true),";

        return implode("\n\n", $columns);
    }

    protected function generateFormFields(string $relatedModelName): string
    {
        $indent = '                        ';
        $fields = [];

        $modelLower = strtolower($relatedModelName);

        if (str_contains($modelLower, 'review')) {
            $fields[] = "{$indent}TextInput::make('reviewer_name')\n{$indent}    ->required()\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('reviewer_email')\n{$indent}    ->email()\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('rating')\n{$indent}    ->required()\n{$indent}    ->numeric()\n{$indent}    ->minValue(1)\n{$indent}    ->maxValue(5),";
            $fields[] = "{$indent}TextInput::make('title')\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}Textarea::make('body')\n{$indent}    ->required()\n{$indent}    ->columnSpanFull(),";
            $fields[] = "{$indent}Toggle::make('is_verified'),";
            $fields[] = "{$indent}Toggle::make('is_approved'),";
        } elseif (str_contains($modelLower, 'variant')) {
            $fields[] = "{$indent}TextInput::make('name')\n{$indent}    ->required()\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('sku')\n{$indent}    ->required()\n{$indent}    ->unique(ignoreRecord: true)\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('price')\n{$indent}    ->required()\n{$indent}    ->numeric()\n{$indent}    ->prefix('\$'),";
            $fields[] = "{$indent}TextInput::make('cost')\n{$indent}    ->numeric()\n{$indent}    ->prefix('\$'),";
            $fields[] = "{$indent}TextInput::make('stock_quantity')\n{$indent}    ->required()\n{$indent}    ->numeric()\n{$indent}    ->default(0),";
            $fields[] = "{$indent}TextInput::make('color')\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('size')\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}Toggle::make('is_active')\n{$indent}    ->default(true),";
        } elseif (str_contains($modelLower, 'image')) {
            $fields[] = "{$indent}TextInput::make('url')\n{$indent}    ->required()\n{$indent}    ->url()\n{$indent}    ->maxLength(2048)\n{$indent}    ->columnSpanFull(),";
            $fields[] = "{$indent}TextInput::make('alt')\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}TextInput::make('title')\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}Toggle::make('is_primary'),";
            $fields[] = "{$indent}TextInput::make('sort_order')\n{$indent}    ->numeric()\n{$indent}    ->default(0),";
        } else {
            // Default fields
            $fields[] = "{$indent}TextInput::make('name')\n{$indent}    ->required()\n{$indent}    ->maxLength(255),";
            $fields[] = "{$indent}Textarea::make('description')\n{$indent}    ->columnSpanFull(),";
        }

        return implode("\n\n", $fields);
    }
}
</file>

<file path="src/Concerns/HasAuth.php">
<?php

namespace Laravilt\Panel\Concerns;

use Illuminate\Support\Facades\Route;

trait HasAuth
{
    /**
     * Login configuration.
     */
    protected ?array $loginConfig = null;

    /**
     * Register configuration.
     */
    protected ?array $registerConfig = null;

    /**
     * Password reset configuration.
     */
    protected ?array $passwordResetConfig = null;

    /**
     * Reset password configuration.
     */
    protected ?array $resetPasswordConfig = null;

    /**
     * Email verification configuration.
     */
    protected ?array $emailVerificationConfig = null;

    /**
     * OTP configuration.
     */
    protected ?array $otpConfig = null;

    /**
     * Profile configuration.
     */
    protected ?array $profileConfig = null;

    /**
     * Social login configuration.
     */
    protected ?array $socialLoginConfig = null;

    protected ?\Laravilt\Auth\Services\SocialProviderManager $socialProviderManager = null;

    /**
     * Two-factor provider manager.
     */
    protected ?\Laravilt\Auth\Services\TwoFactorProviderManager $twoFactorProviderManager = null;

    /**
     * Two-factor authentication configuration.
     */
    protected ?array $twoFactorConfig = null;

    /**
     * Session management configuration.
     */
    protected ?array $sessionManagementConfig = null;

    /**
     * API tokens configuration.
     */
    protected ?array $apiTokensConfig = null;

    /**
     * Passkeys configuration.
     */
    protected ?array $passkeysConfig = null;

    /**
     * Magic links configuration.
     */
    protected ?array $magicLinksConfig = null;

    /**
     * Connected accounts configuration.
     */
    protected ?array $connectedAccountsConfig = null;

    /**
     * Locale and timezone configuration.
     */
    protected ?array $localeTimezoneConfig = null;

    /**
     * Require password for social login users.
     */
    protected bool $requirePasswordForSocialLogin = true;

    /**
     * Require password for social login users.
     */
    public function requirePasswordForSocialLogin(bool $require = true): static
    {
        $this->requirePasswordForSocialLogin = $require;

        return $this;
    }

    /**
     * Check if password is required for social login users.
     */
    public function shouldRequirePasswordForSocialLogin(): bool
    {
        return $this->requirePasswordForSocialLogin;
    }

    /**
     * Configure login.
     */
    public function login(?string $page = null, ?string $path = null): static
    {
        $this->loginConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Login::class,
            'path' => $path ?? 'login',
        ];

        // Automatically add auth middleware when login is enabled
        $this->ensureAuthMiddleware();

        return $this;
    }

    /**
     * Disable login.
     */
    public function disableLogin(): static
    {
        $this->loginConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if login is enabled.
     */
    public function hasLogin(): bool
    {
        return $this->loginConfig['enabled'] ?? false;
    }

    /**
     * Get login page class.
     */
    public function getLoginPage(): ?string
    {
        return $this->loginConfig['page'] ?? \Laravilt\Auth\Pages\Login::class;
    }

    /**
     * Get login path.
     */
    public function getLoginPath(): string
    {
        return $this->loginConfig['path'] ?? 'login';
    }

    /**
     * Get the full login URL.
     */
    public function loginUrl(): string
    {
        return $this->url($this->getLoginPath());
    }

    /**
     * Configure registration.
     */
    public function registration(?string $page = null, ?string $path = null): static
    {
        $this->registerConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Register::class,
            'path' => $path ?? 'register',
        ];

        return $this;
    }

    /**
     * Disable registration.
     */
    public function disableRegistration(): static
    {
        $this->registerConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if registration is enabled.
     */
    public function hasRegistration(): bool
    {
        return $this->registerConfig['enabled'] ?? false;
    }

    /**
     * Get register page class.
     */
    public function getRegisterPage(): ?string
    {
        return $this->registerConfig['page'] ?? \Laravilt\Auth\Pages\Register::class;
    }

    /**
     * Get register path.
     */
    public function getRegisterPath(): string
    {
        return $this->registerConfig['path'] ?? 'register';
    }

    /**
     * Get the full register URL.
     */
    public function registerUrl(): string
    {
        return $this->url($this->getRegisterPath());
    }

    /**
     * Configure password reset.
     */
    public function passwordReset(?string $page = null, ?string $path = null): static
    {
        $this->passwordResetConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\ForgotPassword::class,
            'path' => $path ?? 'forgot-password',
        ];

        // Also enable reset password page by default
        $this->resetPassword();

        return $this;
    }

    /**
     * Disable password reset.
     */
    public function disablePasswordReset(): static
    {
        $this->passwordResetConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if password reset is enabled.
     */
    public function hasPasswordReset(): bool
    {
        return $this->passwordResetConfig['enabled'] ?? false;
    }

    /**
     * Get password reset page class.
     */
    public function getPasswordResetPage(): ?string
    {
        return $this->passwordResetConfig['page'] ?? null;
    }

    /**
     * Get password reset path.
     */
    public function getPasswordResetPath(): string
    {
        return $this->passwordResetConfig['path'] ?? 'forgot-password';
    }

    /**
     * Configure reset password.
     */
    public function resetPassword(?string $page = null, ?string $path = null): static
    {
        $this->resetPasswordConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\ResetPassword::class,
            'path' => $path ?? 'reset-password',
        ];

        return $this;
    }

    /**
     * Get reset password page class.
     */
    public function getResetPasswordPage(): ?string
    {
        return $this->resetPasswordConfig['page'] ?? \Laravilt\Auth\Pages\ResetPassword::class;
    }

    /**
     * Get reset password path.
     */
    public function getResetPasswordPath(): string
    {
        return $this->resetPasswordConfig['path'] ?? 'reset-password';
    }

    /**
     * Configure email verification.
     */
    public function emailVerification(?string $page = null, ?string $path = null): static
    {
        $this->emailVerificationConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\EmailVerification::class,
            'path' => $path ?? 'verify-email',
        ];

        return $this;
    }

    /**
     * Disable email verification.
     */
    public function disableEmailVerification(): static
    {
        $this->emailVerificationConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if email verification is enabled.
     */
    public function hasEmailVerification(): bool
    {
        return $this->emailVerificationConfig['enabled'] ?? false;
    }

    /**
     * Configure OTP authentication.
     */
    public function otp(?string $page = null, ?string $path = null): static
    {
        $this->otpConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\OTP::class,
            'path' => $path ?? 'otp',
        ];

        return $this;
    }

    /**
     * Disable OTP authentication.
     */
    public function disableOtp(): static
    {
        $this->otpConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if OTP is enabled.
     */
    public function hasOtp(): bool
    {
        return $this->otpConfig['enabled'] ?? false;
    }

    /**
     * Get OTP page class.
     */
    public function getOtpPage(): ?string
    {
        return $this->otpConfig['page'] ?? null;
    }

    /**
     * Get OTP path.
     */
    public function getOtpPath(): string
    {
        return $this->otpConfig['path'] ?? 'otp';
    }

    /**
     * Configure profile page.
     */
    public function profile(?string $page = null, ?string $path = null): static
    {
        $this->profileConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile::class,
            'path' => $path ?? 'profile',
        ];

        return $this;
    }

    /**
     * Disable profile page.
     */
    public function disableProfile(): static
    {
        $this->profileConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if profile is enabled.
     */
    public function hasProfile(): bool
    {
        return $this->profileConfig['enabled'] ?? false;
    }

    /**
     * Get profile page class.
     */
    public function getProfilePage(): ?string
    {
        return $this->profileConfig['page'] ?? null;
    }

    /**
     * Get profile path.
     */
    public function getProfilePath(): string
    {
        return $this->profileConfig['path'] ?? 'profile';
    }

    /**
     * Configure social login with builder or array.
     */
    public function socialLogin(\Closure|array $config): static
    {
        $builder = new \Laravilt\Auth\Builders\SocialProviderBuilder;

        if ($config instanceof \Closure) {
            // New builder pattern
            $config($builder);
        } else {
            // Legacy array pattern - auto-register default providers
            foreach ($config as $providerName) {
                $providerClass = match ($providerName) {
                    'google' => \Laravilt\Auth\Drivers\SocialProviders\GoogleProvider::class,
                    'github' => \Laravilt\Auth\Drivers\SocialProviders\GitHubProvider::class,
                    'facebook' => \Laravilt\Auth\Drivers\SocialProviders\FacebookProvider::class,
                    'twitter' => \Laravilt\Auth\Drivers\SocialProviders\TwitterProvider::class,
                    'linkedin' => \Laravilt\Auth\Drivers\SocialProviders\LinkedInProvider::class,
                    'discord' => \Laravilt\Auth\Drivers\SocialProviders\DiscordProvider::class,
                    'jira' => \Laravilt\Auth\Drivers\SocialProviders\JiraProvider::class,
                    default => null,
                };

                if ($providerClass) {
                    $builder->provider($providerClass);
                }
            }
        }

        $this->socialProviderManager = new \Laravilt\Auth\Services\SocialProviderManager($this->getId());
        $this->socialProviderManager->setBuilder($builder);

        $this->socialLoginConfig = [
            'enabled' => true,
        ];

        return $this;
    }

    /**
     * Disable social login.
     */
    public function disableSocialLogin(): static
    {
        $this->socialLoginConfig = ['enabled' => false];
        $this->socialProviderManager = null;

        return $this;
    }

    /**
     * Check if social login is enabled.
     */
    public function hasSocialLogin(): bool
    {
        return $this->socialLoginConfig['enabled'] ?? false;
    }

    /**
     * Get social provider manager.
     */
    public function getSocialProviderManager(): ?\Laravilt\Auth\Services\SocialProviderManager
    {
        return $this->socialProviderManager;
    }

    /**
     * Get social login providers (for backwards compatibility).
     */
    public function getSocialProviders(): array
    {
        if (! $this->socialProviderManager) {
            return [];
        }

        return $this->socialProviderManager->getProvidersForFrontend();
    }

    /**
     * Get enabled social provider objects.
     */
    public function getEnabledSocialProviders(): array
    {
        if (! $this->socialProviderManager) {
            return [];
        }

        return $this->socialProviderManager->getEnabledProviders();
    }

    /**
     * Configure two-factor authentication.
     */
    public function twoFactor(?string $page = null, ?string $path = null, ?callable $builder = null): static
    {
        // Initialize the provider manager
        $this->twoFactorProviderManager = new \Laravilt\Auth\Services\TwoFactorProviderManager($this->getId());

        // Initialize builder
        $builderInstance = new \Laravilt\Auth\Builders\TwoFactorProviderBuilder;

        // If no custom builder provided, register default providers
        if ($builder === null) {
            $builderInstance
                ->provider(\Laravilt\Auth\Drivers\TotpDriver::class)
                ->provider(\Laravilt\Auth\Drivers\EmailDriver::class);
        } else {
            // Call the builder callback
            $builder($builderInstance);
        }

        // Register all providers from builder
        foreach ($builderInstance->getProviders() as $driver) {
            $this->twoFactorProviderManager->register($driver);
        }

        $this->twoFactorConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile\ManageTwoFactor::class,
            'path' => $path ?? 'profile/two-factor',
        ];

        return $this;
    }

    /**
     * Disable two-factor authentication.
     */
    public function disableTwoFactor(): static
    {
        $this->twoFactorConfig = ['enabled' => false];
        $this->twoFactorProviderManager = null;

        return $this;
    }

    /**
     * Check if two-factor authentication is enabled.
     */
    public function hasTwoFactor(): bool
    {
        return $this->twoFactorConfig['enabled'] ?? false;
    }

    /**
     * Get two-factor provider manager.
     */
    public function getTwoFactorProviderManager(): ?\Laravilt\Auth\Services\TwoFactorProviderManager
    {
        return $this->twoFactorProviderManager;
    }

    /**
     * Get two-factor providers (for frontend).
     */
    public function getTwoFactorProviders(): array
    {
        if (! $this->twoFactorProviderManager) {
            return [];
        }

        return $this->twoFactorProviderManager->getDriversForFrontend();
    }

    /**
     * Get two-factor page class.
     */
    public function getTwoFactorPage(): ?string
    {
        return $this->twoFactorConfig['page'] ?? null;
    }

    /**
     * Get two-factor path.
     */
    public function getTwoFactorPath(): string
    {
        return $this->twoFactorConfig['path'] ?? 'profile/two-factor';
    }

    /**
     * Configure session management.
     */
    public function sessionManagement(?string $page = null, ?string $path = null): static
    {
        $this->sessionManagementConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile\ManageSessions::class,
            'path' => $path ?? 'profile/sessions',
        ];

        return $this;
    }

    /**
     * Disable session management.
     */
    public function disableSessionManagement(): static
    {
        $this->sessionManagementConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if session management is enabled.
     */
    public function hasSessionManagement(): bool
    {
        return $this->sessionManagementConfig['enabled'] ?? false;
    }

    /**
     * Get session management page class.
     */
    public function getSessionManagementPage(): ?string
    {
        return $this->sessionManagementConfig['page'] ?? null;
    }

    /**
     * Get session management path.
     */
    public function getSessionManagementPath(): string
    {
        return $this->sessionManagementConfig['path'] ?? 'profile/sessions';
    }

    /**
     * Configure API tokens.
     */
    public function apiTokens(?string $page = null, ?string $path = null): static
    {
        $this->apiTokensConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile\ManageApiTokens::class,
            'path' => $path ?? 'profile/api-tokens',
        ];

        return $this;
    }

    /**
     * Disable API tokens.
     */
    public function disableApiTokens(): static
    {
        $this->apiTokensConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if API tokens is enabled.
     */
    public function hasApiTokens(): bool
    {
        return $this->apiTokensConfig['enabled'] ?? false;
    }

    /**
     * Get API tokens page class.
     */
    public function getApiTokensPage(): ?string
    {
        return $this->apiTokensConfig['page'] ?? null;
    }

    /**
     * Get API tokens path.
     */
    public function getApiTokensPath(): string
    {
        return $this->apiTokensConfig['path'] ?? 'profile/api-tokens';
    }

    /**
     * Configure passkeys.
     */
    public function passkeys(?string $page = null, ?string $path = null): static
    {
        $this->passkeysConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile\ManagePasskeys::class,
            'path' => $path ?? 'profile/passkeys',
        ];

        return $this;
    }

    /**
     * Disable passkeys.
     */
    public function disablePasskeys(): static
    {
        $this->passkeysConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if passkeys is enabled.
     */
    public function hasPasskeys(): bool
    {
        return $this->passkeysConfig['enabled'] ?? false;
    }

    /**
     * Get passkeys page class.
     */
    public function getPasskeysPage(): ?string
    {
        return $this->passkeysConfig['page'] ?? null;
    }

    /**
     * Get passkeys path.
     */
    public function getPasskeysPath(): string
    {
        return $this->passkeysConfig['path'] ?? 'profile/passkeys';
    }

    /**
     * Configure magic links.
     */
    public function magicLinks(?string $page = null, ?string $path = null): static
    {
        $this->magicLinksConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\MagicLink::class,
            'path' => $path ?? 'magic-link',
        ];

        return $this;
    }

    /**
     * Disable magic links.
     */
    public function disableMagicLinks(): static
    {
        $this->magicLinksConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if magic links is enabled.
     */
    public function hasMagicLinks(): bool
    {
        return $this->magicLinksConfig['enabled'] ?? false;
    }

    /**
     * Get magic links page class.
     */
    public function getMagicLinksPage(): ?string
    {
        return $this->magicLinksConfig['page'] ?? null;
    }

    /**
     * Get magic links path.
     */
    public function getMagicLinksPath(): string
    {
        return $this->magicLinksConfig['path'] ?? 'magic-link';
    }

    /**
     * Configure connected accounts.
     */
    public function connectedAccounts(?string $page = null, ?string $path = null): static
    {
        $this->connectedAccountsConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\Profile\ConnectedAccounts::class,
            'path' => $path ?? 'profile/connected-accounts',
        ];

        return $this;
    }

    /**
     * Disable connected accounts.
     */
    public function disableConnectedAccounts(): static
    {
        $this->connectedAccountsConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if connected accounts is enabled.
     */
    public function hasConnectedAccounts(): bool
    {
        return $this->connectedAccountsConfig['enabled'] ?? false;
    }

    /**
     * Get connected accounts page class.
     */
    public function getConnectedAccountsPage(): ?string
    {
        return $this->connectedAccountsConfig['page'] ?? null;
    }

    /**
     * Get connected accounts path.
     */
    public function getConnectedAccountsPath(): string
    {
        return $this->connectedAccountsConfig['path'] ?? 'profile/connected-accounts';
    }

    /**
     * Configure locale and timezone settings.
     */
    public function localeTimezone(?string $page = null, ?string $path = null): static
    {
        $this->localeTimezoneConfig = [
            'enabled' => true,
            'page' => $page ?? \Laravilt\Auth\Pages\LocaleTimezone::class,
            'path' => $path ?? 'settings/locale-timezone',
        ];

        return $this;
    }

    /**
     * Disable locale and timezone settings.
     */
    public function disableLocaleTimezone(): static
    {
        $this->localeTimezoneConfig = ['enabled' => false];

        return $this;
    }

    /**
     * Check if locale and timezone settings is enabled.
     */
    public function hasLocaleTimezone(): bool
    {
        return $this->localeTimezoneConfig['enabled'] ?? false;
    }

    /**
     * Get locale and timezone page class.
     */
    public function getLocaleTimezonePage(): ?string
    {
        return $this->localeTimezoneConfig['page'] ?? null;
    }

    /**
     * Get locale and timezone path.
     */
    public function getLocaleTimezonePath(): string
    {
        return $this->localeTimezoneConfig['path'] ?? 'settings/locale-timezone';
    }

    /**
     * Build auth user menu items.
     */
    public function buildAuthUserMenu(\Laravilt\Panel\Navigation\UserMenu $menu): void
    {
        // Add Settings link if any profile features are enabled
        if ($this->hasProfile() || $this->hasTwoFactor() || $this->hasSessionManagement() ||
            $this->hasApiTokens() || $this->hasPasskeys() || $this->hasConnectedAccounts()) {

            $menu->item(\Laravilt\Panel\Navigation\NavigationItem::make(__('laravilt-panel::panel.user_menu.settings'))
                ->translationKey('laravilt-panel::panel.user_menu.settings')
                ->icon('cog-6-tooth')
                ->url($this->url('settings/profile')));
        }

        // Add Logout - use panel's logout route if login is enabled, otherwise fallback to Laravel's logout route
        $logoutUrl = $this->hasLogin()
            ? route($this->getId().'.logout')
            : (Route::has('logout') ? route('logout') : '/logout');

        $menu->item(\Laravilt\Panel\Navigation\NavigationItem::make(__('laravilt-panel::panel.user_menu.logout'))
            ->translationKey('laravilt-panel::panel.user_menu.logout')
            ->icon('arrow-right-on-rectangle')
            ->url($logoutUrl)
            ->method('post'));
    }

    /**
     * Get profile pages based on enabled features.
     */
    protected function getAuthPages(): array
    {
        $pages = [];

        if ($this->hasProfile() && class_exists(\Laravilt\Auth\Pages\Profile::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile::class;
        }

        if ($this->hasProfile() && class_exists(\Laravilt\Auth\Pages\Profile\ChangePassword::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ChangePassword::class;
        }

        if ($this->hasTwoFactor() && class_exists(\Laravilt\Auth\Pages\Profile\ManageTwoFactor::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ManageTwoFactor::class;
        }

        if ($this->hasSessionManagement() && class_exists(\Laravilt\Auth\Pages\Profile\ManageSessions::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ManageSessions::class;
        }

        if ($this->hasApiTokens() && class_exists(\Laravilt\Auth\Pages\Profile\ManageApiTokens::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ManageApiTokens::class;
        }

        if ($this->hasPasskeys() && class_exists(\Laravilt\Auth\Pages\Profile\ManagePasskeys::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ManagePasskeys::class;
        }

        if ($this->hasConnectedAccounts() && class_exists(\Laravilt\Auth\Pages\Profile\ConnectedAccounts::class)) {
            $pages[] = \Laravilt\Auth\Pages\Profile\ConnectedAccounts::class;
        }

        if ($this->hasLocaleTimezone() && class_exists(\Laravilt\Auth\Pages\LocaleTimezone::class)) {
            $pages[] = \Laravilt\Auth\Pages\LocaleTimezone::class;
        }

        // Add Settings cluster if not already registered
        if (count($pages) > 0 && class_exists(\Laravilt\Auth\Clusters\Settings::class)) {
            array_unshift($pages, \Laravilt\Auth\Clusters\Settings::class);
        }

        return $pages;
    }

    /**
     * Register auth routes for this panel.
     */
    public function registerAuthRoutes(): void
    {
        Route::middleware([
            'web',
            \Laravilt\Panel\Middleware\IdentifyPanel::class.':'.$this->getId(),
            \Laravilt\Panel\Http\Middleware\HandleLocalization::class,
            \Laravilt\Panel\Http\Middleware\SharePanelData::class,
        ])
            ->prefix($this->getPath())
            ->group(function () {
                // Login routes
                if ($this->hasLogin() && $loginPage = $this->getLoginPage()) {
                    Route::get($this->getLoginPath(), [$loginPage, 'create'])
                        ->middleware('guest')
                        ->name($this->getId().'.login');

                    Route::post($this->getLoginPath(), [$loginPage, 'store'])
                        ->name($this->getId().'.login.store');
                }

                // Registration routes
                if ($this->hasRegistration() && $registerPage = $this->getRegisterPage()) {
                    Route::get($this->getRegisterPath(), [$registerPage, 'create'])
                        ->middleware('guest')
                        ->name($this->getId().'.register');

                    Route::post($this->getRegisterPath(), [$registerPage, 'store'])
                        ->name($this->getId().'.register.store');
                }

                // Password reset routes
                if ($this->hasPasswordReset()) {
                    if ($passwordResetPage = $this->getPasswordResetPage()) {
                        Route::get($this->getPasswordResetPath(), [$passwordResetPage, 'create'])
                            ->name($this->getId().'.password.request');

                        Route::post($this->getPasswordResetPath(), [$passwordResetPage, 'store'])
                            ->name($this->getId().'.password.email');
                    }

                    if ($resetPasswordPage = $this->getResetPasswordPage()) {
                        Route::get($this->getResetPasswordPath().'/{token}', [$resetPasswordPage, 'create'])
                            ->name($this->getId().'.password.reset');

                        Route::post($this->getResetPasswordPath(), [$resetPasswordPage, 'store'])
                            ->name($this->getId().'.password.update');
                    }
                }

                // Email verification routes
                if ($this->hasEmailVerification() && $emailVerificationPage = $this->getEmailVerificationConfig()['page'] ?? null) {
                    Route::get($this->getEmailVerificationConfig()['path'] ?? 'verify-email', [$emailVerificationPage, 'create'])
                        ->name($this->getId().'.verification.notice');

                    Route::post('email/verification-notification', [$emailVerificationPage, 'store'])
                        ->middleware(['auth', 'throttle:6,1'])
                        ->name($this->getId().'.verification.send');
                }

                // OTP routes
                if ($this->hasOtp() && $otpPage = $this->getOtpPage()) {
                    Route::get($this->getOtpPath(), [$otpPage, 'create'])
                        ->name($this->getId().'.otp.login');

                    Route::post($this->getOtpPath(), [$otpPage, 'store'])
                        ->name($this->getId().'.otp.verify');

                    Route::post('otp/resend', [$otpPage, 'resend'])
                        ->middleware(['throttle:6,1'])
                        ->name($this->getId().'.otp.resend');
                }

                // Magic Links routes
                if ($this->hasMagicLinks() && $magicLinksPage = $this->getMagicLinksPage()) {
                    Route::get($this->getMagicLinksPath(), [$magicLinksPage, 'create'])
                        ->name($this->getId().'.magic-link.create');

                    Route::post($this->getMagicLinksPath(), [$magicLinksPage, 'store'])
                        ->name($this->getId().'.magic-link.store');

                    Route::get('magic-link/verify/{token}', [$magicLinksPage, 'verify'])
                        ->middleware(['signed'])
                        ->name('laravilt.auth.magic-link.verify');
                }

                // Social Login routes
                if ($this->hasSocialLogin() && class_exists(\Laravilt\Auth\Http\Controllers\Auth\SocialAuthController::class)) {
                    Route::get('auth/{provider}/redirect', [\Laravilt\Auth\Http\Controllers\Auth\SocialAuthController::class, 'redirect'])
                        ->name($this->getId().'.auth.social.redirect');

                    Route::get('auth/{provider}/callback', [\Laravilt\Auth\Http\Controllers\Auth\SocialAuthController::class, 'callback'])
                        ->name($this->getId().'.auth.social.callback');
                }
            });

        // Set Password routes (authenticated but nullable password)
        Route::middleware(array_merge(
            ['web'],
            ['auth'.($this->getAuthGuard() ? ':'.$this->getAuthGuard() : '')],
            [\Laravilt\Panel\Middleware\IdentifyPanel::class.':'.$this->getId()],
            [\Laravilt\Panel\Http\Middleware\HandleLocalization::class]
        ))
            ->prefix($this->getPath())
            ->group(function () {
                if (class_exists(\Laravilt\Auth\Pages\SetPassword::class)) {
                    Route::get('set-password', [\Laravilt\Auth\Pages\SetPassword::class, 'create'])
                        ->name($this->getId().'.auth.set-password');
                }
            });

        // Two-Factor Authentication challenge routes (guest or mid-authentication)
        Route::middleware(array_merge(
            ['web'],
            [\Laravilt\Panel\Middleware\IdentifyPanel::class.':'.$this->getId()],
            [\Laravilt\Panel\Http\Middleware\HandleLocalization::class],
            [\Laravilt\Panel\Http\Middleware\SharePanelData::class]
        ))
            ->prefix($this->getPath())
            ->group(function () {
                if (class_exists(\Laravilt\Auth\Pages\Auth\TwoFactorChallenge::class)) {
                    Route::get('two-factor/challenge', [\Laravilt\Auth\Pages\Auth\TwoFactorChallenge::class, 'create'])
                        ->name($this->getId().'.two-factor.challenge');

                    Route::post('two-factor/challenge', [\Laravilt\Auth\Pages\Auth\TwoFactorChallenge::class, 'store'])
                        ->name($this->getId().'.two-factor.challenge.verify');

                    Route::post('two-factor/resend', [\Laravilt\Auth\Pages\Auth\TwoFactorChallenge::class, 'resend'])
                        ->middleware(['throttle:3,1'])
                        ->name($this->getId().'.two-factor.resend');
                }

                if (class_exists(\Laravilt\Auth\Pages\Auth\TwoFactorRecovery::class)) {
                    Route::get('two-factor/recovery', [\Laravilt\Auth\Pages\Auth\TwoFactorRecovery::class, 'create'])
                        ->name($this->getId().'.two-factor.recovery');

                    Route::post('two-factor/recovery', [\Laravilt\Auth\Pages\Auth\TwoFactorRecovery::class, 'store'])
                        ->name($this->getId().'.two-factor.recovery.verify');
                }

                // Passkey login routes (for 2FA alternative)
                Route::get('passkey/login-options', [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'loginOptions'])
                    ->name($this->getId().'.passkey.login-options');

                Route::post('passkey/login', [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'login'])
                    ->name($this->getId().'.passkey.login');

                // Magic link routes (for 2FA alternative)
                Route::post('magic-link/send', [\Laravilt\Auth\Http\Controllers\MagicLinkController::class, 'send'])
                    ->middleware(['throttle:3,1'])
                    ->name($this->getId().'.magic-link.send');

                Route::get('magic-link/verify/{token}', [\Laravilt\Auth\Http\Controllers\MagicLinkController::class, 'verify'])
                    ->middleware(['signed'])
                    ->name($this->getId().'.magic-link.verify');
            });

        // Authenticated routes
        // IMPORTANT: IdentifyPanel must come BEFORE 'panel.auth' so that redirectTo() knows the current panel
        $authenticatedMiddleware = array_merge(
            ['web'],
            [\Laravilt\Panel\Middleware\IdentifyPanel::class.':'.$this->getId()],
            ['panel.auth'],
            [\Laravilt\Panel\Http\Middleware\HandleLocalization::class],
            [\Laravilt\Panel\Http\Middleware\SharePanelData::class]
        );

        // Only add RequirePassword middleware if social login is enabled and requires password
        if ($this->hasSocialLogin() && $this->shouldRequirePasswordForSocialLogin()) {
            $authenticatedMiddleware[] = \Laravilt\Auth\Http\Middleware\RequirePassword::class;
        }

        // Only add RequireTwoFactorAuthentication middleware if 2FA is enabled for this panel
        if ($this->hasTwoFactor()) {
            $authenticatedMiddleware[] = \Laravilt\Auth\Http\Middleware\RequireTwoFactorAuthentication::class;
        }

        Route::middleware($authenticatedMiddleware)
            ->prefix($this->getPath())
            ->group(function () {
                // Logout route
                if ($this->hasLogin() && $loginPage = $this->getLoginPage()) {
                    Route::post('logout', [$loginPage, 'destroy'])
                        ->name($this->getId().'.logout');
                }

                // Quick locale update route
                Route::post('locale', [\Laravilt\Panel\Http\Controllers\LocaleController::class, 'update'])
                    ->name($this->getId().'.locale.update');

                // Email verification verify route
                if ($this->hasEmailVerification() && $emailVerificationPage = $this->getEmailVerificationConfig()['page'] ?? null) {
                    Route::get('email/verify/{id}/{hash}', [$emailVerificationPage, 'verify'])
                        ->middleware(['signed', 'throttle:6,1'])
                        ->name($this->getId().'.verification.verify');
                }

                // Profile routes - Check if profile page belongs to a cluster
                if ($this->hasProfile() && $profilePage = $this->getProfilePage()) {
                    $clusterClass = $profilePage::getCluster();

                    if ($clusterClass) {
                        // Register cluster routes
                        $this->registerClusterRoutes($clusterClass);

                        // Add redirect from old profile path to cluster path
                        $clusterSlug = $clusterClass::getSlug();
                        $pageSlug = $profilePage::getSlug();
                        Route::get($this->getProfilePath(), function () use ($clusterSlug, $pageSlug) {
                            $panel = app(\Laravilt\Panel\PanelRegistry::class)->getCurrent();

                            return redirect($panel->url("{$clusterSlug}/{$pageSlug}"));
                        })->name($this->getId().'.profile');
                    } else {
                        // Legacy non-cluster routes
                        Route::get($this->getProfilePath(), [$profilePage, 'edit'])
                            ->name($this->getId().'.profile.edit');

                        Route::patch($this->getProfilePath(), [$profilePage, 'update'])
                            ->name($this->getId().'.profile.update');

                        Route::put('password', [$profilePage, 'updatePassword'])
                            ->name($this->getId().'.profile.password.update');

                        Route::delete('profile', [$profilePage, 'destroy'])
                            ->name($this->getId().'.profile.destroy');
                    }
                }

                // Two-Factor Authentication routes (only if not using cluster)
                if ($this->hasTwoFactor()) {
                    $twoFactorPage = $this->getTwoFactorPage();

                    // Only register legacy routes if two-factor page is NOT in a cluster
                    if (! $twoFactorPage::getCluster()) {
                        Route::get($this->getTwoFactorPath().'/status', [\Laravilt\Auth\Http\Controllers\TwoFactorAuthController::class, 'status'])
                            ->name($this->getId().'.two-factor.status');

                        Route::post($this->getTwoFactorPath().'/enable', [$twoFactorPage, 'enable'])
                            ->name($this->getId().'.two-factor.enable');

                        Route::post($this->getTwoFactorPath().'/confirm', [$twoFactorPage, 'confirm'])
                            ->name($this->getId().'.two-factor.confirm');

                        Route::delete($this->getTwoFactorPath().'/disable', [$twoFactorPage, 'disable'])
                            ->name($this->getId().'.two-factor.disable');

                        Route::post($this->getTwoFactorPath().'/recovery-codes', [$twoFactorPage, 'regenerateRecoveryCodes'])
                            ->name($this->getId().'.two-factor.recovery-codes');
                    }
                }

                // Session Management routes (only if not using cluster)
                if ($this->hasSessionManagement()) {
                    $sessionsPage = $this->getSessionManagementPage();

                    if (! $sessionsPage::getCluster()) {
                        Route::get($this->getSessionManagementPath(), [$sessionsPage, 'index'])
                            ->name($this->getId().'.sessions.index');

                        Route::delete($this->getSessionManagementPath().'/{sessionId}', [$sessionsPage, 'destroy'])
                            ->name($this->getId().'.sessions.destroy');

                        Route::delete($this->getSessionManagementPath().'/others', [$sessionsPage, 'destroyOthers'])
                            ->name($this->getId().'.sessions.destroy-others');
                    }
                }

                // API Tokens routes (only if not using cluster)
                if ($this->hasApiTokens()) {
                    $apiTokensPage = $this->getApiTokensPage();

                    if (! $apiTokensPage::getCluster()) {
                        Route::get($this->getApiTokensPath(), [$apiTokensPage, 'index'])
                            ->name($this->getId().'.api-tokens.index');

                        Route::post($this->getApiTokensPath(), [$apiTokensPage, 'store'])
                            ->name($this->getId().'.api-tokens.store');

                        Route::put($this->getApiTokensPath().'/{tokenId}', [$apiTokensPage, 'update'])
                            ->name($this->getId().'.api-tokens.update');

                        Route::delete($this->getApiTokensPath().'/{tokenId}', [$apiTokensPage, 'destroy'])
                            ->name($this->getId().'.api-tokens.destroy');
                    }
                }

                // Passkeys routes (only if not using cluster)
                if ($this->hasPasskeys() && $passkeysPage = $this->getPasskeysPage()) {
                    if (! $passkeysPage::getCluster()) {
                        Route::get($this->getPasskeysPath().'/register-options', [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'registerOptions'])
                            ->name($this->getId().'.passkeys.register-options');

                        Route::post($this->getPasskeysPath().'/register', [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'register'])
                            ->name($this->getId().'.passkeys.register');

                        Route::delete($this->getPasskeysPath().'/{credentialId}', [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'destroy'])
                            ->name($this->getId().'.passkeys.destroy');
                    }
                }

                // Connected Accounts routes (only if not using cluster)
                if ($this->hasConnectedAccounts() && $connectedAccountsPage = $this->getConnectedAccountsPage()) {
                    if (! $connectedAccountsPage::getCluster()) {
                        Route::get($this->getConnectedAccountsPath(), [$connectedAccountsPage, 'index'])
                            ->name($this->getId().'.connected-accounts.index');

                        Route::delete($this->getConnectedAccountsPath().'/{provider}', [$connectedAccountsPage, 'destroy'])
                            ->name($this->getId().'.connected-accounts.destroy');
                    }
                }
            });
    }

    /**
     * Get email verification config.
     */
    protected function getEmailVerificationConfig(): array
    {
        return $this->emailVerificationConfig ?? [];
    }

    /**
     * Ensure auth middleware is added to the panel.
     */
    protected function ensureAuthMiddleware(): void
    {
        $currentMiddleware = $this->getMiddleware();

        // Check if 'auth' middleware is already present
        $hasAuthMiddleware = collect($currentMiddleware)->contains(function ($middleware) {
            return is_string($middleware) && str_starts_with($middleware, 'auth');
        });

        if (! $hasAuthMiddleware) {
            // Get the auth guard
            $guard = $this->getAuthGuard();

            // Use panel's custom auth middleware or default
            $authMiddleware = \Laravilt\Panel\Http\Middleware\Authenticate::class;

            if ($guard) {
                $authMiddleware .= ":{$guard}";
            }

            $this->middleware([...$currentMiddleware, $authMiddleware]);
        }
    }

    /**
     * Ensure RequirePassword middleware is added/removed based on configuration.
     */
    protected function ensureRequirePasswordMiddleware(): void
    {
        $currentMiddleware = $this->getMiddleware();
        $requirePasswordClass = \Laravilt\Auth\Http\Middleware\RequirePassword::class;

        // Check if RequirePassword middleware is present
        $hasRequirePassword = collect($currentMiddleware)->contains($requirePasswordClass);

        if ($this->shouldRequirePasswordForSocialLogin() && $this->hasSocialLogin()) {
            // Should have the middleware
            if (! $hasRequirePassword) {
                $this->middleware([...$currentMiddleware, $requirePasswordClass]);
            }
        } else {
            // Should not have the middleware
            if ($hasRequirePassword) {
                $filtered = collect($currentMiddleware)
                    ->reject(fn ($m) => $m === $requirePasswordClass)
                    ->values()
                    ->toArray();
                $this->middleware($filtered);
            }
        }
    }

    /**
     * Configure Laravel's default auth routes for this panel.
     */
    public function configureAuthDefaults(): void
    {
        if ($this->hasLogin()) {
            // Override the default 'login' route name
            config([
                'auth.defaults.guard' => $this->getAuthGuard() ?? 'web',
            ]);
        }
    }

    /**
     * Register routes for a cluster and its pages.
     */
    protected function registerClusterRoutes(string $clusterClass): void
    {
        $clusterSlug = $clusterClass::getSlug();

        // Find all pages that belong to this cluster
        $clusterPages = collect($this->getPages())
            ->filter(fn ($pageClass) => method_exists($pageClass, 'getCluster') && $pageClass::getCluster() === $clusterClass)
            ->values();

        // Register routes for each page in the cluster
        foreach ($clusterPages as $pageClass) {
            $pageSlug = $pageClass::getSlug();
            $pagePath = "{$clusterSlug}/{$pageSlug}";

            // Determine which methods exist on the page
            $reflection = new \ReflectionClass($pageClass);

            // GET route (index, create, or edit)
            if ($reflection->hasMethod('index')) {
                \Illuminate\Support\Facades\Route::get($pagePath, [$pageClass, 'index'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}.index");
            } elseif ($reflection->hasMethod('edit')) {
                \Illuminate\Support\Facades\Route::get($pagePath, [$pageClass, 'edit'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}.edit");
            } elseif ($reflection->hasMethod('create')) {
                \Illuminate\Support\Facades\Route::get($pagePath, [$pageClass, 'create'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}");
            }

            // POST route (store)
            if ($reflection->hasMethod('store')) {
                \Illuminate\Support\Facades\Route::post($pagePath, [$pageClass, 'store'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}.store");
            }

            // PATCH/PUT routes (update)
            if ($reflection->hasMethod('update')) {
                \Illuminate\Support\Facades\Route::patch($pagePath, [$pageClass, 'update'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}.update");

                \Illuminate\Support\Facades\Route::put($pagePath, [$pageClass, 'update']);
            }

            // DELETE route (destroy)
            if ($reflection->hasMethod('destroy')) {
                \Illuminate\Support\Facades\Route::delete($pagePath, [$pageClass, 'destroy'])
                    ->name($this->getId().".{$clusterSlug}.{$pageSlug}.destroy");
            }
        }

        // Also register the Two-Factor routes under the cluster if ManageTwoFactor is in the cluster
        if ($this->hasTwoFactor()) {
            $twoFactorPage = \Laravilt\Auth\Pages\Profile\ManageTwoFactor::class;
            if (in_array($twoFactorPage, $clusterPages->toArray())) {
                $twoFactorSlug = $twoFactorPage::getSlug();
                $twoFactorPath = "{$clusterSlug}/{$twoFactorSlug}";

                \Illuminate\Support\Facades\Route::post("{$twoFactorPath}/enable", [$twoFactorPage, 'enable'])
                    ->name($this->getId().'.two-factor.enable');

                \Illuminate\Support\Facades\Route::post("{$twoFactorPath}/confirm", [$twoFactorPage, 'confirm'])
                    ->name($this->getId().'.two-factor.confirm');

                \Illuminate\Support\Facades\Route::post("{$twoFactorPath}/cancel", [$twoFactorPage, 'cancel'])
                    ->name($this->getId().'.two-factor.cancel');

                \Illuminate\Support\Facades\Route::delete("{$twoFactorPath}/disable", [$twoFactorPage, 'disable'])
                    ->name($this->getId().'.two-factor.disable');

                \Illuminate\Support\Facades\Route::post("{$twoFactorPath}/recovery-codes", [$twoFactorPage, 'regenerateRecoveryCodes'])
                    ->name($this->getId().'.two-factor.recovery-codes');
            }
        }

        // Also register the API Token routes under the cluster if ManageApiTokens is in the cluster
        if ($this->hasApiTokens()) {
            $apiTokensPage = \Laravilt\Auth\Pages\Profile\ManageApiTokens::class;
            if (in_array($apiTokensPage, $clusterPages->toArray())) {
                $apiTokensSlug = $apiTokensPage::getSlug();
                $apiTokensPath = "{$clusterSlug}/{$apiTokensSlug}";

                \Illuminate\Support\Facades\Route::post("{$apiTokensPath}/store", [\Laravilt\Auth\Http\Controllers\ApiTokenController::class, 'store'])
                    ->name($this->getId().'.api-tokens.store');

                \Illuminate\Support\Facades\Route::delete("{$apiTokensPath}/{token}", [\Laravilt\Auth\Http\Controllers\ApiTokenController::class, 'destroy'])
                    ->name($this->getId().'.api-tokens.destroy');

                \Illuminate\Support\Facades\Route::post("{$apiTokensPath}/revoke-all", [\Laravilt\Auth\Http\Controllers\ApiTokenController::class, 'revokeAll'])
                    ->name($this->getId().'.api-tokens.revoke-all');
            }
        }

        // Also register the Passkeys routes under the cluster if ManagePasskeys is in the cluster
        if ($this->hasPasskeys()) {
            $passkeysPage = \Laravilt\Auth\Pages\Profile\ManagePasskeys::class;
            if (in_array($passkeysPage, $clusterPages->toArray())) {
                $passkeysSlug = $passkeysPage::getSlug();
                $passkeysPath = "{$clusterSlug}/{$passkeysSlug}";

                \Illuminate\Support\Facades\Route::get("{$passkeysPath}/register-options", [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'registerOptions'])
                    ->name($this->getId().'.passkeys.register-options');

                \Illuminate\Support\Facades\Route::post("{$passkeysPath}/register", [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'register'])
                    ->name($this->getId().'.passkeys.register');

                \Illuminate\Support\Facades\Route::delete("{$passkeysPath}/{credentialId}", [\Laravilt\Auth\Http\Controllers\PasskeyController::class, 'destroy'])
                    ->name($this->getId().'.passkeys.destroy');
            }
        }
    }
}
</file>

<file path="src/Concerns/HasTheme.php">
<?php

namespace Laravilt\Panel\Concerns;

use Closure;
use Laravilt\Panel\FontProviders\FontProvider;
use Laravilt\Panel\FontProviders\GoogleFontProvider;

trait HasTheme
{
    protected string|FontProvider|Closure|null $font = null;

    protected bool|Closure $darkMode = true;

    protected array|Closure $customCss = [];

    protected array|Closure $customJs = [];

    /**
     * Set the panel font.
     *
     * Accepts a string (font family name), a FontProvider instance, or a closure.
     *
     * Examples:
     * - ->font('Inter')
     * - ->font(GoogleFontProvider::make('Inter')->weights([400, 500, 600, 700]))
     */
    public function font(string|FontProvider|Closure|null $font): static
    {
        $this->font = $font;

        return $this;
    }

    /**
     * Get the panel font.
     * Returns null if no custom font is set.
     */
    public function getFont(): ?FontProvider
    {
        $font = $this->evaluate($this->font);

        if ($font === null) {
            return null;
        }

        // If it's already a FontProvider, return it
        if ($font instanceof FontProvider) {
            return $font;
        }

        // If it's a string, wrap it in a GoogleFontProvider
        if (is_string($font)) {
            return GoogleFontProvider::make($font);
        }

        return null;
    }

    /**
     * Get the font family name for CSS.
     */
    public function getFontFamily(): ?string
    {
        $font = $this->getFont();

        return $font?->getFamily();
    }

    /**
     * Get the font URL for loading.
     */
    public function getFontUrl(): ?string
    {
        $font = $this->getFont();

        return $font?->getUrl();
    }

    /**
     * Check if a custom font is configured.
     */
    public function hasFont(): bool
    {
        return $this->getFont() !== null;
    }

    /**
     * Get font data as array for sharing with frontend.
     */
    public function getFontData(): ?array
    {
        $font = $this->getFont();

        return $font?->toArray();
    }

    /**
     * Enable/disable dark mode.
     */
    public function darkMode(bool|Closure $enabled = true): static
    {
        $this->darkMode = $enabled;

        return $this;
    }

    /**
     * Check if dark mode is enabled.
     */
    public function hasDarkMode(): bool
    {
        return $this->evaluate($this->darkMode);
    }

    /**
     * Add custom CSS files.
     */
    public function customCss(array|Closure $files): static
    {
        $this->customCss = $files;

        return $this;
    }

    /**
     * Get custom CSS files.
     */
    public function getCustomCss(): array
    {
        return $this->evaluate($this->customCss);
    }

    /**
     * Add custom JS files.
     */
    public function customJs(array|Closure $files): static
    {
        $this->customJs = $files;

        return $this;
    }

    /**
     * Get custom JS files.
     */
    public function getCustomJs(): array
    {
        return $this->evaluate($this->customJs);
    }
}
</file>

<file path="src/Discovery/PanelDiscovery.php">
<?php

namespace Laravilt\Panel\Discovery;

use Laravilt\Panel\Panel;

class PanelDiscovery
{
    /**
     * Auto-discover and register panel components.
     */
    public static function discover(Panel $panel): void
    {
        $panelId = $panel->getId();
        $studlyId = str_replace('-', '', ucwords($panelId, '-'));

        // Discover from app/Laravilt/{PanelId}
        static::discoverFromApp($panel, $studlyId);

        // Discover from modules if they exist
        static::discoverFromModules($panel, $panelId, $studlyId);
    }

    /**
     * Discover components from app/Laravilt directory.
     */
    protected static function discoverFromApp(Panel $panel, string $studlyId): void
    {
        $basePath = app_path("Laravilt/{$studlyId}");

        if (! is_dir($basePath)) {
            return;
        }

        // Discover Pages
        $pagesPath = "{$basePath}/Pages";
        if (is_dir($pagesPath)) {
            $panel->discoverPages(
                $pagesPath,
                "App\\Laravilt\\{$studlyId}\\Pages"
            );
        }

        // Discover Resources
        $resourcesPath = "{$basePath}/Resources";
        if (is_dir($resourcesPath)) {
            $panel->discoverResources(
                $resourcesPath,
                "App\\Laravilt\\{$studlyId}\\Resources"
            );
        }

        // Discover Clusters
        $clustersPath = "{$basePath}/Clusters";
        if (is_dir($clustersPath)) {
            $panel->discoverClusters(
                $clustersPath,
                "App\\Laravilt\\{$studlyId}\\Clusters"
            );
        }

        // Discover Widgets
        $widgetsPath = "{$basePath}/Widgets";
        if (is_dir($widgetsPath)) {
            $panel->discoverWidgets(
                $widgetsPath,
                "App\\Laravilt\\{$studlyId}\\Widgets"
            );
        }
    }

    /**
     * Discover components from modules.
     */
    protected static function discoverFromModules(Panel $panel, string $panelId, string $studlyId): void
    {
        // Check if nwidart/laravel-modules is installed
        if (! class_exists(\Nwidart\Modules\Facades\Module::class)) {
            return;
        }

        $modules = \Nwidart\Modules\Facades\Module::allEnabled();

        foreach ($modules as $module) {
            $modulePath = $module->getPath();
            $moduleName = $module->getName();

            // Look for Laravilt/{PanelId} inside module
            $panelPath = "{$modulePath}/Laravilt/{$studlyId}";

            if (! is_dir($panelPath)) {
                continue;
            }

            // Discover Pages from module
            $pagesPath = "{$panelPath}/Pages";
            if (is_dir($pagesPath)) {
                $panel->discoverPages(
                    $pagesPath,
                    "Modules\\{$moduleName}\\Laravilt\\{$studlyId}\\Pages"
                );
            }

            // Discover Resources from module
            $resourcesPath = "{$panelPath}/Resources";
            if (is_dir($resourcesPath)) {
                $panel->discoverResources(
                    $resourcesPath,
                    "Modules\\{$moduleName}\\Laravilt\\{$studlyId}\\Resources"
                );
            }

            // Discover Clusters from module
            $clustersPath = "{$panelPath}/Clusters";
            if (is_dir($clustersPath)) {
                $panel->discoverClusters(
                    $clustersPath,
                    "Modules\\{$moduleName}\\Laravilt\\{$studlyId}\\Clusters"
                );
            }

            // Discover Widgets from module
            $widgetsPath = "{$panelPath}/Widgets";
            if (is_dir($widgetsPath)) {
                $panel->discoverWidgets(
                    $widgetsPath,
                    "Modules\\{$moduleName}\\Laravilt\\{$studlyId}\\Widgets"
                );
            }
        }
    }

    /**
     * Get all discoverable paths for a panel.
     */
    public static function getDiscoverablePaths(string $panelId): array
    {
        $studlyId = str_replace('-', '', ucwords($panelId, '-'));
        $paths = [];

        // App paths
        $appBasePath = app_path("Laravilt/{$studlyId}");
        if (is_dir($appBasePath)) {
            $paths['app'] = [
                'pages' => "{$appBasePath}/Pages",
                'resources' => "{$appBasePath}/Resources",
                'clusters' => "{$appBasePath}/Clusters",
                'widgets' => "{$appBasePath}/Widgets",
            ];
        }

        // Module paths
        if (class_exists(\Nwidart\Modules\Facades\Module::class)) {
            $modules = \Nwidart\Modules\Facades\Module::allEnabled();

            foreach ($modules as $module) {
                $modulePath = $module->getPath();
                $moduleName = $module->getName();
                $panelPath = "{$modulePath}/Laravilt/{$studlyId}";

                if (is_dir($panelPath)) {
                    $paths["module:{$moduleName}"] = [
                        'pages' => "{$panelPath}/Pages",
                        'resources' => "{$panelPath}/Resources",
                        'clusters' => "{$panelPath}/Clusters",
                        'widgets' => "{$panelPath}/Widgets",
                    ];
                }
            }
        }

        return $paths;
    }
}
</file>

<file path="src/Http/Middleware/HandleLocalization.php">
<?php

namespace Laravilt\Panel\Http\Middleware;

use Closure;
use DateTimeZone;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\Lang;
use Inertia\Inertia;
use Symfony\Component\HttpFoundation\Response;

class HandleLocalization
{
    /**
     * RTL (Right-to-Left) locales.
     */
    protected array $rtlLocales = [
        'ar', // Arabic
        'he', // Hebrew
        'fa', // Persian/Farsi
        'ur', // Urdu
        'ps', // Pashto
        'sd', // Sindhi
        'yi', // Yiddish
        'ku', // Kurdish (some variants)
        'ug', // Uyghur
        'dv', // Divehi
    ];

    /**
     * Translation files to load for the frontend.
     * Format: 'namespace::file' for package translations or 'file' for app translations.
     */
    protected array $translationFiles = [
        'laravilt-panel::panel',     // Panel package
        'laravilt-auth::auth',       // Auth package
        'laravilt-support::support', // Support package
        'laravilt-forms::fields',    // Forms package
        'laravilt-schemas::schemas', // Schemas package
        'laravilt-ai::ai',           // AI package
        'tables::tables',            // Tables package
        'actions::actions',          // Actions package
        'notifications::notifications', // Notifications package
        'widgets::widgets',          // Widgets package
    ];

    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, Closure $next): Response
    {
        $user = $request->user();

        // Get user's locale and timezone
        $locale = $user?->locale ?? config('app.locale', 'en');
        $timezone = $user?->timezone ?? config('app.timezone', 'UTC');

        // Set the application locale
        App::setLocale($locale);

        // Set the default timezone for the application
        if ($this->isValidTimezone($timezone)) {
            date_default_timezone_set($timezone);
            config(['app.timezone' => $timezone]);
        }

        // Determine if the locale is RTL
        $direction = $this->isRtlLocale($locale) ? 'rtl' : 'ltr';

        // Load translations using Laravel's translator
        $translations = $this->loadTranslations($locale);

        // Share localization data with Inertia
        Inertia::share([
            'localization' => [
                'locale' => $locale,
                'timezone' => $timezone,
                'direction' => $direction,
                'isRtl' => $direction === 'rtl',
            ],
            'translations' => $translations,
        ]);

        // Store in request for Blade templates
        $request->attributes->set('locale', $locale);
        $request->attributes->set('timezone', $timezone);
        $request->attributes->set('direction', $direction);

        // Also share with view for Blade templates
        view()->share('locale', $locale);
        view()->share('timezone', $timezone);
        view()->share('direction', $direction);

        return $next($request);
    }

    /**
     * Check if a locale is RTL.
     */
    protected function isRtlLocale(string $locale): bool
    {
        // Get the base locale (e.g., 'ar' from 'ar_EG')
        $baseLocale = explode('_', $locale)[0];
        $baseLocale = explode('-', $baseLocale)[0];

        return in_array(strtolower($baseLocale), $this->rtlLocales);
    }

    /**
     * Check if a timezone is valid.
     */
    protected function isValidTimezone(string $timezone): bool
    {
        return in_array($timezone, DateTimeZone::listIdentifiers());
    }

    /**
     * Load translations for the given locale.
     * This flattens the PHP translation arrays into dot notation for frontend use.
     * Keys are preserved with their full namespace (e.g., 'laravilt-auth::auth.login.title').
     */
    protected function loadTranslations(string $locale): array
    {
        $translations = [];
        $translator = app('translator');

        // Load JSON translation file from lang directory (e.g., lang/en.json)
        $jsonPath = lang_path("{$locale}.json");
        if (file_exists($jsonPath)) {
            $jsonTranslations = json_decode(file_get_contents($jsonPath), true);
            if (is_array($jsonTranslations)) {
                $translations = array_merge($translations, $jsonTranslations);
            }
        }

        // Load PHP translation files from lang/{locale}/ directory
        $phpLangPath = lang_path("{$locale}");
        if (is_dir($phpLangPath)) {
            foreach (glob("{$phpLangPath}/*.php") as $file) {
                $fileName = basename($file, '.php');
                $fileTranslations = require $file;
                if (is_array($fileTranslations)) {
                    $flattened = $this->flattenTranslations($fileTranslations, $fileName);
                    $translations = array_merge($translations, $flattened);
                }
            }
        }

        // Load PHP translation files from packages and flatten them
        foreach ($this->translationFiles as $file) {
            // Use Laravel's translator to get the translation array
            // Lang::get() with '*' returns all translations for the file
            $fileTranslations = $translator->get($file, [], $locale);

            // If it's an array, flatten it with the namespace prefix
            if (is_array($fileTranslations)) {
                // Prefix with the full namespace (e.g., 'laravilt-auth::auth')
                $flattened = $this->flattenTranslations($fileTranslations, $file);
                $translations = array_merge($translations, $flattened);
            }
        }

        return $translations;
    }

    /**
     * Flatten a nested array to dot notation keys.
     * Example: ['common' => ['save' => 'Save']] becomes ['common.save' => 'Save']
     */
    protected function flattenTranslations(array $array, string $prefix = ''): array
    {
        $result = [];

        foreach ($array as $key => $value) {
            $newKey = $prefix === '' ? $key : "{$prefix}.{$key}";

            if (is_array($value)) {
                // Recursively flatten nested arrays
                $result = array_merge($result, $this->flattenTranslations($value, $newKey));
            } else {
                $result[$newKey] = $value;
            }
        }

        return $result;
    }
}
</file>

<file path="src/Http/Middleware/SharePanelData.php">
<?php

namespace Laravilt\Panel\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Inertia\Inertia;
use Laravilt\Auth\Pages\LocaleTimezone;
use Laravilt\Panel\PanelRegistry;
use Symfony\Component\HttpFoundation\Response;

class SharePanelData
{
    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, Closure $next): Response
    {
        $registry = app(PanelRegistry::class);
        $panel = $registry->getCurrent();

        if ($panel) {
            Inertia::share([
                'panel' => fn () => [
                    'id' => $panel->getId(),
                    'path' => $panel->getPath(),
                    'brandName' => $panel->getBrandName(),
                    'brandLogo' => $panel->getBrandLogo(),
                    'navigation' => $panel->getNavigation(),
                    'userMenu' => $panel->getUserMenu(),
                    'user' => $request->user() ? [
                        'name' => $request->user()->name,
                        'email' => $request->user()->email,
                    ] : null,
                    'auth' => [
                        'hasProfile' => $panel->hasProfile(),
                        'hasLogin' => $panel->hasLogin(),
                        'hasRegistration' => $panel->hasRegistration(),
                        'hasPasswordReset' => $panel->hasPasswordReset(),
                        'hasEmailVerification' => $panel->hasEmailVerification(),
                        'hasOtp' => $panel->hasOtp(),
                    ],
                    'hasDatabaseNotifications' => $panel->hasDatabaseNotifications(),
                    'databaseNotificationsPolling' => $panel->getDatabaseNotificationsPolling(),
                    'availableLocales' => $this->getAvailableLocales(),
                    'currentLocale' => $request->user()?->locale ?? config('app.locale', 'en'),
                    'font' => $panel->getFontData(),
                    'hasDarkMode' => $panel->hasDarkMode(),
                    // Global search config
                    'hasGlobalSearch' => $panel->hasGlobalSearch(),
                    'globalSearchEndpoint' => $panel->hasGlobalSearch() ? $panel->getGlobalSearchEndpoint() : null,
                    'globalSearchConfig' => $panel->getGlobalSearchConfig(),
                    // AI config
                    'hasAI' => $panel->hasAIProviders(),
                    'aiConfig' => $panel->getAIConfig(),
                ],
                'notifications' => fn () => $this->getNotifications($request),
                'databaseNotifications' => fn () => $this->getDatabaseNotifications($request),
            ]);
        }

        return $next($request);
    }

    /**
     * Get notifications from session (supports multiple session keys).
     */
    protected function getNotifications(Request $request): array
    {
        $notifications = [];

        // Check for notifications passed via redirect->with() (most reliable method)
        $redirectNotifications = $request->session()->pull('_laravilt_notifications', []);
        if ($redirectNotifications) {
            $notifications = array_merge($notifications, $redirectNotifications);
        }

        // Check for single notification from Notification::send()
        $laraviltNotification = $request->session()->pull('laravilt.notification');
        if ($laraviltNotification) {
            $notifications[] = $laraviltNotification;
        }

        // Also check for legacy 'notifications' key (array of notifications)
        $legacyNotifications = $request->session()->pull('notifications', []);
        if ($legacyNotifications) {
            $notifications = array_merge($notifications, $legacyNotifications);
        }

        return $notifications;
    }

    /**
     * Get database notifications for the authenticated user.
     */
    protected function getDatabaseNotifications(Request $request): array
    {
        $user = $request->user();

        if (! $user || ! method_exists($user, 'notifications')) {
            return [
                'notifications' => [],
                'unreadCount' => 0,
            ];
        }

        $notifications = $user->notifications()
            ->latest()
            ->take(20)
            ->get()
            ->map(fn ($notification) => $this->formatDatabaseNotification($notification))
            ->toArray();

        $unreadCount = $user->unreadNotifications()->count();

        return [
            'notifications' => $notifications,
            'unreadCount' => $unreadCount,
        ];
    }

    /**
     * Format a database notification for the frontend.
     */
    protected function formatDatabaseNotification($notification): array
    {
        $data = $notification->data;

        return [
            'id' => $notification->id,
            'type' => $notification->type,
            'title' => $data['title'] ?? null,
            'body' => $data['body'] ?? ($data['message'] ?? null),
            'icon' => $data['icon'] ?? null,
            'iconColor' => $data['icon_color'] ?? ($data['color'] ?? null),
            'status' => $data['status'] ?? 'info',
            'color' => $data['color'] ?? null,
            'actions' => $data['actions'] ?? [],
            'data' => $data['data'] ?? $data,
            'readAt' => $notification->read_at?->toISOString(),
            'createdAt' => $notification->created_at?->toISOString(),
            'humanTime' => $notification->created_at?->diffForHumans(),
        ];
    }

    /**
     * Get available locales with flags.
     */
    protected function getAvailableLocales(): array
    {
        // Map locale codes to country codes for flags
        $flagMap = [
            'en' => 'us',
            'es' => 'es',
            'fr' => 'fr',
            'de' => 'de',
            'it' => 'it',
            'pt' => 'pt',
            'ru' => 'ru',
            'zh' => 'cn',
            'ja' => 'jp',
            'ko' => 'kr',
            'ar' => 'sa',
            'he' => 'il',
            'fa' => 'ir',
            'ur' => 'pk',
            'hi' => 'in',
            'nl' => 'nl',
            'pl' => 'pl',
            'tr' => 'tr',
        ];

        // Get available locales from LocaleTimezone page or config
        if (class_exists(LocaleTimezone::class)) {
            $locales = LocaleTimezone::getAvailableLocales();

            return array_map(function ($locale) use ($flagMap) {
                $locale['flag'] = $flagMap[$locale['value']] ?? $locale['value'];

                return $locale;
            }, $locales);
        }

        // Fallback locales
        return [
            ['value' => 'en', 'label' => 'English', 'dir' => 'ltr', 'flag' => 'us'],
            ['value' => 'ar', 'label' => '', 'dir' => 'rtl', 'flag' => 'sa'],
        ];
    }
}
</file>

<file path="src/Mcp/Tools/GetResourceInfoTool.php">
<?php

namespace Laravilt\Panel\Mcp\Tools;

use Illuminate\JsonSchema\JsonSchema;
use Laravel\Mcp\Request;
use Laravel\Mcp\Response;
use Laravel\Mcp\Server\Tool;

class GetResourceInfoTool extends Tool
{
    protected string $description = 'Get detailed information about resource structure, properties, and methods';

    protected array $resourceInfo = [
        'properties' => [
            'protected static string $model' => 'The Eloquent model class for this resource',
            'protected static ?string $table' => 'Database table name (optional)',
            'protected static ?string $navigationIcon' => 'Lucide icon name for navigation',
            'protected static ?string $navigationGroup' => 'Navigation group name',
            'protected static int $navigationSort' => 'Sort order in navigation (default: 0)',
            'protected static bool $hasApi = false' => 'Enable API endpoints',
            'protected static bool $hasGrid = false' => 'Enable grid view',
        ],
        'methods' => [
            'form(Schema $schema): Schema' => 'Define form fields for create/edit',
            'table(Table $table): Table' => 'Define table columns and filters',
            'infolist(Schema $schema): Schema' => 'Define view page layout',
            'grid(Grid $grid): Grid' => 'Define grid card layout (if hasGrid)',
            'api(ApiResource $api): ApiResource' => 'Define API endpoints (if hasApi)',
            'getPages(): array' => 'Return resource page classes',
            'getRelations(): array' => 'Return relation manager classes',
        ],
        'pages' => [
            'ListResource' => 'Table view of all records with filtering/sorting',
            'CreateResource' => 'Form for creating new records',
            'EditResource' => 'Form for editing existing records',
            'ViewResource' => 'Read-only view of a single record',
        ],
    ];

    protected array $iconMappings = [
        'user' => 'Users',
        'customer' => 'UserCircle',
        'product' => 'Package',
        'order' => 'ShoppingCart',
        'payment' => 'CreditCard',
        'post' => 'FileText',
        'article' => 'FileText',
        'category' => 'FolderTree',
        'tag' => 'Tag',
        'setting' => 'Settings',
        'notification' => 'Bell',
        'message' => 'MessageSquare',
        'comment' => 'MessageCircle',
        'project' => 'FolderKanban',
        'task' => 'CheckSquare',
        'event' => 'Calendar',
        'company' => 'Building2',
        'team' => 'Users2',
        'role' => 'Shield',
        'permission' => 'Key',
        'report' => 'FileBarChart',
        'invoice' => 'Receipt',
        'subscription' => 'CreditCard',
        'log' => 'FileCode',
        'media' => 'Image',
        'file' => 'File',
        'folder' => 'Folder',
        'email' => 'Mail',
        'phone' => 'Phone',
        'address' => 'MapPin',
        'location' => 'Navigation',
        'country' => 'Globe',
        'language' => 'Languages',
        'currency' => 'DollarSign',
        'discount' => 'Percent',
        'coupon' => 'Ticket',
        'review' => 'Star',
        'rating' => 'ThumbsUp',
        'faq' => 'HelpCircle',
        'page' => 'FileText',
        'menu' => 'Menu',
        'widget' => 'LayoutGrid',
        'block' => 'LayoutDashboard',
        'template' => 'FileCode2',
        'theme' => 'Palette',
        'plugin' => 'Puzzle',
    ];

    public function handle(Request $request): Response
    {
        $output = " Laravilt Panel - Resource Structure\n\n";
        $output .= str_repeat('=', 70)."\n\n";

        $output .= "## Resource Properties\n\n";
        foreach ($this->resourceInfo['properties'] as $prop => $desc) {
            $output .= " `{$prop}`\n  {$desc}\n\n";
        }

        $output .= "\n## Resource Methods\n\n";
        foreach ($this->resourceInfo['methods'] as $method => $desc) {
            $output .= " `{$method}`\n  {$desc}\n\n";
        }

        $output .= "\n## Resource Pages\n\n";
        foreach ($this->resourceInfo['pages'] as $page => $desc) {
            $output .= " **{$page}** - {$desc}\n";
        }

        $output .= "\n\n## Generated File Structure\n\n";
        $output .= "```\n";
        $output .= "app/Laravilt/{Panel}/Resources/{Model}/\n";
        $output .= " {Model}Resource.php      # Main resource class\n";
        $output .= " Form/\n";
        $output .= "    {Model}Form.php      # Form schema definition\n";
        $output .= " Table/\n";
        $output .= "    {Model}Table.php     # Table columns & filters\n";
        $output .= " InfoList/\n";
        $output .= "    {Model}InfoList.php  # View page layout\n";
        $output .= " Grid/\n";
        $output .= "    {Model}Grid.php      # Grid card layout (optional)\n";
        $output .= " Api/\n";
        $output .= "    {Model}Api.php       # API endpoints (optional)\n";
        $output .= " Pages/\n";
        $output .= "     List{Model}.php      # Index page\n";
        $output .= "     Create{Model}.php    # Create page\n";
        $output .= "     Edit{Model}.php      # Edit page\n";
        $output .= "     View{Model}.php      # View page\n";
        $output .= "```\n\n";

        $output .= "## Example Resource\n\n";
        $output .= "```php\n";
        $output .= "<?php\n\n";
        $output .= "namespace App\\Laravilt\\Admin\\Resources\\Product;\n\n";
        $output .= "use App\\Models\\Product;\n";
        $output .= "use Laravilt\\Panel\\Resources\\Resource;\n";
        $output .= "use Laravilt\\Schemas\\Schema;\n";
        $output .= "use Laravilt\\Tables\\Table;\n\n";
        $output .= "class ProductResource extends Resource\n";
        $output .= "{\n";
        $output .= "    protected static string \$model = Product::class;\n";
        $output .= "    protected static ?string \$navigationIcon = 'Package';\n";
        $output .= "    protected static ?string \$navigationGroup = 'Shop';\n\n";
        $output .= "    public static function form(Schema \$schema): Schema\n";
        $output .= "    {\n";
        $output .= "        return \$schema->components([\n";
        $output .= "            TextInput::make('name')->required(),\n";
        $output .= "            Textarea::make('description'),\n";
        $output .= "            NumberInput::make('price')->required(),\n";
        $output .= "        ]);\n";
        $output .= "    }\n\n";
        $output .= "    public static function table(Table \$table): Table\n";
        $output .= "    {\n";
        $output .= "        return \$table->columns([\n";
        $output .= "            TextColumn::make('name')->searchable()->sortable(),\n";
        $output .= "            TextColumn::make('price')->money(),\n";
        $output .= "            TextColumn::make('created_at')->dateTime(),\n";
        $output .= "        ]);\n";
        $output .= "    }\n";
        $output .= "}\n";
        $output .= "```\n\n";

        $output .= "## Icon Mapping (Sample)\n\n";
        $output .= "The resource generator uses smart icon mapping:\n\n";
        $count = 0;
        foreach ($this->iconMappings as $keyword => $icon) {
            $output .= " {$keyword}  {$icon}\n";
            $count++;
            if ($count >= 15) {
                $output .= ' ... and '.count($this->iconMappings) - 15 ." more\n";
                break;
            }
        }

        return Response::text($output);
    }

    public function schema(JsonSchema $schema): array
    {
        return [];
    }
}
</file>

<file path="src/Navigation/UserMenu.php">
<?php

namespace Laravilt\Panel\Navigation;

use Illuminate\Contracts\Support\Arrayable;

class UserMenu implements Arrayable
{
    protected array $items = [];

    /**
     * Add a menu item.
     */
    public function item(NavigationItem $item): static
    {
        $this->items[] = $item;

        return $this;
    }

    /**
     * Add multiple items.
     */
    public function items(array $items): static
    {
        foreach ($items as $item) {
            $this->item($item);
        }

        return $this;
    }

    /**
     * Get all items.
     */
    public function getItems(): array
    {
        return $this->items;
    }

    /**
     * Build default user menu.
     */
    public static function default(): static
    {
        $menu = new static;

        $items = [];

        // Add profile link if route exists
        try {
            if (function_exists('route') && route('profile.edit', [], false)) {
                $items[] = NavigationItem::make(__('laravilt-panel::panel.user_menu.profile'))
                    ->translationKey('laravilt-panel::panel.user_menu.profile')
                    ->icon('heroicon-o-user')
                    ->url(route('profile.edit'));
            }
        } catch (\Exception $e) {
            // Route doesn't exist, skip
        }

        // Add settings link if route exists
        try {
            if (function_exists('route') && route('settings.index', [], false)) {
                $items[] = NavigationItem::make(__('laravilt-panel::panel.user_menu.settings'))
                    ->translationKey('laravilt-panel::panel.user_menu.settings')
                    ->icon('heroicon-o-cog-6-tooth')
                    ->url(route('settings.index'));
            }
        } catch (\Exception $e) {
            // Route doesn't exist, skip
        }

        // Add logout link
        try {
            $logoutUrl = route('logout', [], false) ?: '#';
            $items[] = NavigationItem::make(__('laravilt-panel::panel.user_menu.logout'))
                ->translationKey('laravilt-panel::panel.user_menu.logout')
                ->icon('heroicon-o-arrow-right-on-rectangle')
                ->url($logoutUrl)
                ->method('post');
        } catch (\Exception $e) {
            // Fallback to # if route doesn't exist
            $items[] = NavigationItem::make(__('laravilt-panel::panel.user_menu.logout'))
                ->translationKey('laravilt-panel::panel.user_menu.logout')
                ->icon('heroicon-o-arrow-right-on-rectangle')
                ->url('#')
                ->method('post');
        }

        return $menu->items($items);
    }

    /**
     * Convert to array.
     */
    public function toArray(): array
    {
        return collect($this->items)
            ->map(fn ($item) => $item->toArray())
            ->all();
    }
}
</file>

<file path="src/Pages/Dashboard.php">
<?php

namespace Laravilt\Panel\Pages;

use Laravilt\Panel\Resources\Resource;
use Laravilt\Widgets\Stat;
use Laravilt\Widgets\StatsOverviewWidget;
use Laravilt\Widgets\Widget;

class Dashboard extends Page
{
    protected static ?string $title = 'Dashboard';

    protected static ?string $navigationIcon = 'heroicon-o-home';

    protected static ?int $navigationSort = -999;

    protected static ?string $slug = '';

    /**
     * The default Vue component for the dashboard.
     */
    protected static string $view = 'laravilt/Dashboard';

    /**
     * Whether to auto-generate stats widgets from resources.
     */
    protected static bool $shouldGenerateResourceStats = true;

    /**
     * The number of columns for the stats overview widget.
     */
    protected static int $statsColumns = 4;

    public static function getTitle(): string
    {
        return trans('laravilt-panel::panel.navigation.dashboard');
    }

    public static function getLabel(): string
    {
        return trans('laravilt-panel::panel.navigation.dashboard');
    }

    /**
     * Get breadcrumbs for dashboard.
     */
    public function getBreadcrumbs(): array
    {
        return [
            [
                'label' => static::getTitle(),
                'url' => null,
            ],
        ];
    }

    /**
     * Get the widgets for the dashboard.
     * Override this method to customize dashboard widgets.
     *
     * @return array<Widget|string>
     */
    public function getWidgets(): array
    {
        return [];
    }

    /**
     * Get the header widgets (displayed above the main content).
     *
     * @return array<Widget|string>
     */
    public function getHeaderWidgets(): array
    {
        $widgets = [];

        // Auto-generate resource stats if enabled
        if (static::$shouldGenerateResourceStats) {
            $resourceStats = $this->generateResourceStats();
            if (! empty($resourceStats)) {
                $widgets[] = StatsOverviewWidget::make()
                    ->stats($resourceStats)
                    ->columns(static::$statsColumns);
            }
        }

        return array_merge($widgets, $this->getWidgets());
    }

    /**
     * Get the footer widgets (displayed below the main content).
     *
     * @return array<Widget|string>
     */
    public function getFooterWidgets(): array
    {
        return [];
    }

    /**
     * Generate stats from panel resources.
     *
     * @return array<Stat>
     */
    protected function generateResourceStats(): array
    {
        $stats = [];
        $panel = $this->getPanel();
        $resources = $panel->getResources();

        foreach ($resources as $resourceClass) {
            if (! class_exists($resourceClass)) {
                continue;
            }

            // Check if resource should show on dashboard
            if (method_exists($resourceClass, 'shouldShowOnDashboard') && ! $resourceClass::shouldShowOnDashboard()) {
                continue;
            }

            $model = $resourceClass::getModel();
            if (! $model || ! class_exists($model)) {
                continue;
            }

            $label = $resourceClass::getPluralLabel() ?? $resourceClass::getLabel() ?? class_basename($model);
            $icon = $resourceClass::getNavigationIcon() ?? 'Database';
            $count = $model::count();

            // Get the list URL for the resource
            $url = null;
            if (method_exists($resourceClass, 'getUrl')) {
                try {
                    $url = $resourceClass::getUrl('list');
                } catch (\Exception $e) {
                    // URL generation might fail if routes aren't registered
                }
            }

            $stat = Stat::make($label, $count)
                ->icon($this->normalizeIcon($icon))
                ->color($this->getColorForIndex(count($stats)));

            if ($url) {
                $stat->url($url);
            }

            $stats[] = $stat;
        }

        return $stats;
    }

    /**
     * Normalize icon name (remove heroicon prefix if present).
     */
    protected function normalizeIcon(string $icon): string
    {
        // Remove heroicon prefixes
        $icon = preg_replace('/^heroicon-[os]-/', '', $icon);

        // Convert kebab-case to PascalCase for Lucide icons
        return str_replace(' ', '', ucwords(str_replace('-', ' ', $icon)));
    }

    /**
     * Get a color based on index for variety.
     */
    protected function getColorForIndex(int $index): string
    {
        $colors = ['primary', 'success', 'warning', 'info', 'danger', 'gray'];

        return $colors[$index % count($colors)];
    }

    /**
     * Disable auto-generation of resource stats.
     */
    public static function disableResourceStats(): void
    {
        static::$shouldGenerateResourceStats = false;
    }

    /**
     * Enable auto-generation of resource stats.
     */
    public static function enableResourceStats(): void
    {
        static::$shouldGenerateResourceStats = true;
    }

    /**
     * Check if resource stats should be generated.
     */
    public static function shouldGenerateResourceStats(): bool
    {
        return static::$shouldGenerateResourceStats;
    }

    /**
     * Render the dashboard using Inertia.
     */
    public function render(?string $component = null)
    {
        // Use the $view property as the default component, or custom component if provided
        $component = $component ?? static::$view;

        // Collect and serialize widgets
        $headerWidgets = $this->serializeWidgets($this->getHeaderWidgets());
        $footerWidgets = $this->serializeWidgets($this->getFooterWidgets());

        return \Inertia\Inertia::render($component, [
            'title' => static::getTitle(),
            'breadcrumbs' => $this->getBreadcrumbs(),
            'headerWidgets' => $headerWidgets,
            'footerWidgets' => $footerWidgets,
        ]);
    }

    /**
     * Serialize widgets for Inertia.
     *
     * @param  array<Widget|string>  $widgets
     */
    protected function serializeWidgets(array $widgets): array
    {
        return collect($widgets)
            ->map(function ($widget) {
                // If it's a class name string, instantiate it
                if (is_string($widget) && class_exists($widget)) {
                    $widget = new $widget;
                }

                // If it's a Widget instance, convert to props
                if ($widget instanceof Widget) {
                    return $widget->toInertiaProps();
                }

                return $widget;
            })
            ->filter()
            ->values()
            ->all();
    }
}
</file>

<file path="src/Pages/ListRecords.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Pages;

use Illuminate\Http\Request;
use Laravilt\Tables\Table;

abstract class ListRecords extends Page
{
    /**
     * Default view mode: 'table', 'grid', or 'api'
     */
    protected string $defaultView = 'table';

    /**
     * Get the page title using the resource's plural label.
     */
    public static function getTitle(): string
    {
        $resource = static::getResource();

        if ($resource) {
            return $resource::getPluralLabel();
        }

        return parent::getTitle();
    }

    /**
     * Get the navigation label using the resource's plural label.
     */
    public static function getLabel(): string
    {
        $resource = static::getResource();

        if ($resource) {
            return $resource::getPluralLabel();
        }

        return parent::getLabel();
    }

    /**
     * Get the page heading using the resource's plural label.
     */
    public function getHeading(): string
    {
        return static::getTitle();
    }

    public function table(Table $table): Table
    {
        $resource = static::getResource();

        return $resource::table($table);
    }

    /**
     * Define header actions for this page.
     * Override this method in your page class to customize actions.
     *
     * @return array<\Laravilt\Actions\Action>
     */
    protected function headerActions(): array
    {
        return [];
    }

    /**
     * Get all header actions for this page.
     * Automatically includes CreateAction if the resource has a create page.
     *
     * @return array<mixed>
     */
    public function getHeaderActions(): array
    {
        $actions = $this->headerActions();

        // Auto-add CreateAction if resource has a create page and no create action exists
        $resource = static::getResource();
        if ($resource) {
            $pages = $resource::getPages();
            $hasCreatePage = isset($pages['create']);

            // Check if headerActions already has a CreateAction
            $hasCreateAction = collect($actions)->contains(function ($action) {
                return $action instanceof \Laravilt\Actions\CreateAction;
            });

            if ($hasCreatePage && ! $hasCreateAction) {
                // Add CreateAction that will auto-configure based on page context
                array_unshift($actions, \Laravilt\Actions\CreateAction::make());
            }
        }

        return $actions;
    }

    public function getTableQuery()
    {
        $resource = static::getResource();

        return $resource::getModel()::query();
    }

    /**
     * Check if this resource supports view toggle (table has card configuration or API enabled).
     */
    public function hasViewToggle(): bool
    {
        $resource = static::getResource();

        // View toggle is available if we have grid OR api options
        $hasGridOption = $resource::hasTable() && $resource::hasCardConfig();
        $hasApiOption = $resource::hasApi();

        return $hasGridOption || $hasApiOption;
    }

    /**
     * Check if this resource has API enabled.
     */
    public function hasApiOption(): bool
    {
        $resource = static::getResource();

        return $resource::hasApi();
    }

    /**
     * Check if this resource has grid option (card configuration).
     */
    public function hasGridOption(): bool
    {
        $resource = static::getResource();

        return $resource::hasTable() && $resource::hasCardConfig();
    }

    /**
     * Get the session key for storing view preference.
     */
    protected function getViewSessionKey(): string
    {
        $resource = static::getResource();

        return 'laravilt_view_preference_'.$resource::getSlug();
    }

    /**
     * Get the available views for this resource.
     *
     * @return array<string>
     */
    public function getAvailableViews(): array
    {
        $views = ['table'];

        if ($this->hasGridOption()) {
            $views[] = 'grid';
        }

        if ($this->hasApiOption()) {
            $views[] = 'api';
        }

        return $views;
    }

    /**
     * Get the current view mode from request, session, or default.
     */
    public function getCurrentView(): string
    {
        $sessionKey = $this->getViewSessionKey();
        $urlView = request()->query('view');
        $availableViews = $this->getAvailableViews();

        // If URL has view param, validate and save to session
        if ($urlView !== null) {
            if (in_array($urlView, $availableViews)) {
                session()->put($sessionKey, $urlView);

                return $urlView;
            }

            return $this->defaultView;
        }

        // No URL param - check session for saved preference
        $sessionView = session()->get($sessionKey);

        if ($sessionView !== null && in_array($sessionView, $availableViews)) {
            return $sessionView;
        }

        return $this->defaultView;
    }

    /**
     * Get extra props for Inertia response.
     *
     * @return array<string, mixed>
     */
    protected function getInertiaProps(): array
    {
        $resource = static::getResource();
        $apiResourceProps = null;

        if ($this->hasApiOption()) {
            $apiResource = $resource::getApiResource();
            if ($apiResource) {
                $apiResourceProps = $apiResource->toInertiaProps();
                // Set the correct endpoint based on panel path
                $panelPath = $this->getPanel()?->getPath() ?? 'admin';
                $correctEndpoint = "/{$panelPath}/api/".$resource::getSlug();
                $correctBaseUrl = url('');
                $correctFullUrl = url($correctEndpoint);

                $apiResourceProps['endpoint'] = $correctEndpoint;
                $apiResourceProps['fullUrl'] = $correctFullUrl;

                // Also fix the OpenAPI spec with correct URLs
                if (isset($apiResourceProps['openApiSpec'])) {
                    $openApiSpec = &$apiResourceProps['openApiSpec'];

                    // Update server URL
                    if (isset($openApiSpec['servers'][0])) {
                        $openApiSpec['servers'][0]['url'] = $correctBaseUrl;
                    }

                    // Update paths with correct prefix
                    if (isset($openApiSpec['paths'])) {
                        $newPaths = [];
                        $oldBasePath = '/api/'.$resource::getSlug();
                        foreach ($openApiSpec['paths'] as $path => $methods) {
                            // Replace old path with correct panel-prefixed path
                            $newPath = str_replace($oldBasePath, $correctEndpoint, $path);
                            $newPaths[$newPath] = $methods;
                        }
                        $openApiSpec['paths'] = $newPaths;
                    }
                }
            }
        }

        // Generate API token for testing if we're showing the API view
        $apiToken = null;
        if ($this->getCurrentView() === 'api' && auth()->check()) {
            $user = auth()->user();
            // Check if user has createToken method (Sanctum's HasApiTokens trait)
            if (method_exists($user, 'createToken')) {
                // Create a temporary token for API testing (expires in 1 hour)
                $token = $user->createToken('api-tester', ['*'], now()->addHour());
                $apiToken = $token->plainTextToken;
            }
        }

        return [
            'hasViewToggle' => $this->hasViewToggle(),
            'hasGridOption' => $this->hasGridOption(),
            'hasApiOption' => $this->hasApiOption(),
            'availableViews' => $this->getAvailableViews(),
            'currentView' => $this->getCurrentView(),
            'apiResource' => $apiResourceProps,
            'apiToken' => $apiToken,
        ];
    }

    /**
     * Get the schema (table) for this page.
     * The table handles both table and grid views based on card configuration.
     */
    public function getSchema(): array
    {
        $resource = static::getResource();
        $table = $this->table(new Table);
        $table->query(fn () => $this->getTableQuery());
        $table->model($resource::getModel());
        $table->resourceSlug($resource::getSlug());

        return [$table];
    }
}
</file>

<file path="src/Pages/ManageRecords.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Pages;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Laravilt\Actions\Action;
use Laravilt\Actions\DeleteBulkAction;
use Laravilt\Infolists\Infolist;
use Laravilt\Schemas\Schema;
use Laravilt\Tables\Table;

/**
 * ManageRecords page for simple resources.
 * Handles all CRUD operations (list, create, edit, view, delete) on a single page using modals.
 * Similar to FilamentPHP v4's simple resource pattern.
 */
abstract class ManageRecords extends ListRecords
{
    /**
     * Whether to show the view action in modal.
     */
    protected bool $canView = true;

    /**
     * Whether to show the create action.
     */
    protected bool $canCreate = true;

    /**
     * Whether to show the edit action in modal.
     */
    protected bool $canEdit = true;

    /**
     * Whether to show the delete action.
     */
    protected bool $canDelete = true;

    /**
     * Configure the form schema for create/edit modals.
     */
    public function form(Schema $schema): Schema
    {
        $resource = static::getResource();

        return $resource::form($schema);
    }

    /**
     * Configure the infolist schema for view modals.
     */
    public function infolist(Infolist $infolist): Infolist
    {
        $resource = static::getResource();

        return $resource::infolist($infolist);
    }

    /**
     * Get the resource label (singular).
     */
    public function getResourceLabel(): string
    {
        $resource = static::getResource();

        return $resource::getLabel();
    }

    /**
     * Get the resource plural label.
     */
    public function getResourcePluralLabel(): string
    {
        $resource = static::getResource();

        return $resource::getPluralLabel();
    }

    /**
     * Check if records can be viewed.
     */
    public function canView(): bool
    {
        return $this->canView;
    }

    /**
     * Check if records can be created.
     */
    public function canCreate(): bool
    {
        return $this->canCreate;
    }

    /**
     * Check if records can be edited.
     */
    public function canEdit(): bool
    {
        return $this->canEdit;
    }

    /**
     * Check if records can be deleted.
     */
    public function canDelete(): bool
    {
        return $this->canDelete;
    }

    /**
     * Define header actions for this page.
     * Override this method in your page class to add actions.
     *
     * Example in ManageUser:
     *   protected function headerActions(): array
     *   {
     *       return [
     *           $this->getCreateAction(),
     *       ];
     *   }
     *
     * @return array<Action>
     */
    protected function headerActions(): array
    {
        return [];
    }

    /**
     * Get all header actions for this page.
     */
    public function getHeaderActions(): array
    {
        return $this->headerActions();
    }

    /**
     * Get the create action configured for this resource.
     * Use CreateAction::make() in your headerActions() and customize as needed.
     */
    protected function getCreateAction(): \Laravilt\Actions\CreateAction
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();
        $formSchema = $this->form(Schema::make())->getSchema();
        $slug = $resource::getSlug();

        return \Laravilt\Actions\CreateAction::make()
            ->stableId("{$slug}_create")
            ->label(__('actions::actions.buttons.create').' '.$this->getResourceLabel())
            ->modalHeading(__('actions::actions.buttons.create').' '.$this->getResourceLabel())
            ->model($modelClass)
            ->formSchema($formSchema)
            ->using();
    }

    /**
     * Override the table configuration to add modal-based actions.
     */
    protected function configureTableForModalCrud(Table $table): Table
    {
        $resource = static::getResource();
        $panelId = $this->getPanel()->getId();
        $slug = $resource::getSlug();

        // Get form and infolist schemas for modals
        $formSchema = $this->form(Schema::make())->getSchema();
        $infolistSchema = $this->infolist(Infolist::make())->toInertiaProps();

        // Build modal-based record actions
        $recordActions = [];
        $modelClass = $resource::getModel();

        if ($this->canView()) {
            $recordActions[] = Action::make('view')
                ->stableId("{$slug}_view")
                ->label(__('actions::actions.buttons.view'))
                ->icon('Eye')
                ->color('secondary')
                ->tooltip(__('actions::actions.tooltips.view'))
                ->modal(true)
                ->modalHeading(__('actions::actions.buttons.view').' '.$this->getResourceLabel())
                ->modalInfolistSchema($infolistSchema['schema'] ?? [])
                ->modalSubmitActionLabel(null)
                ->modalCancelActionLabel(__('actions::actions.buttons.close'))
                ->modalWidth('lg')
                ->isViewOnly(true);
        }

        if ($this->canEdit()) {
            $recordActions[] = Action::make('edit')
                ->stableId("{$slug}_edit")
                ->label(__('actions::actions.buttons.edit'))
                ->icon('Pencil')
                ->color('warning')
                ->tooltip(__('actions::actions.tooltips.edit'))
                ->modal(true)
                ->modalHeading(__('actions::actions.buttons.edit').' '.$this->getResourceLabel())
                ->modalFormSchema($formSchema)
                ->modalSubmitActionLabel(__('actions::actions.buttons.save'))
                ->modalCancelActionLabel(__('actions::actions.buttons.cancel'))
                ->modalWidth('lg')
                ->action(function ($record, array $data) use ($modelClass) {
                    // Get record ID - handle both object and array formats
                    $recordId = null;
                    if (is_object($record) && isset($record->id)) {
                        $recordId = $record->id;
                    } elseif (is_array($record) && isset($record['id'])) {
                        $recordId = $record['id'];
                    }

                    if (! $recordId) {
                        throw new \Exception(__('actions::actions.errors.no_record_id'));
                    }

                    $existingRecord = $modelClass::findOrFail($recordId);
                    $existingRecord->fill($data);
                    $existingRecord->save();

                    \Laravilt\Notifications\Notification::success()
                        ->title(__('notifications::notifications.success'))
                        ->body(__('actions::actions.messages.saved'))
                        ->send();

                    return $existingRecord;
                });
        }

        if ($this->canDelete()) {
            $recordActions[] = Action::make('delete')
                ->stableId("{$slug}_delete")
                ->label(__('actions::actions.buttons.delete'))
                ->icon('Trash2')
                ->color('destructive')
                ->tooltip(__('actions::actions.tooltips.delete'))
                ->requiresConfirmation(true)
                ->modalHeading(__('actions::actions.buttons.delete').' '.$this->getResourceLabel())
                ->modalDescription(__('actions::actions.confirm_delete_description'))
                ->modalSubmitActionLabel(__('actions::actions.buttons.confirm'))
                ->modalCancelActionLabel(__('actions::actions.buttons.cancel'))
                ->action(function ($record) use ($modelClass) {
                    // Get record ID - handle both object and array formats
                    $recordId = null;
                    if (is_object($record) && isset($record->id)) {
                        $recordId = $record->id;
                    } elseif (is_array($record) && isset($record['id'])) {
                        $recordId = $record['id'];
                    }

                    if (! $recordId) {
                        throw new \Exception(__('actions::actions.errors.no_record_id'));
                    }

                    $existingRecord = $modelClass::findOrFail($recordId);
                    $existingRecord->delete();

                    \Laravilt\Notifications\Notification::success()
                        ->title(__('notifications::notifications.success'))
                        ->body(__('notifications::notifications.record_deleted'))
                        ->send();
                });
        }

        // Build bulk actions
        $bulkActions = [];
        if ($this->canDelete()) {
            $bulkActions[] = DeleteBulkAction::make();
        }

        // Apply to table
        $table->recordActions($recordActions);
        $table->bulkActions($bulkActions);

        // Set modal CRUD context
        $table->setOption('isManageRecords', true);
        $table->setOption('modalFormSchema', $formSchema);
        $table->setOption('modalInfolistSchema', $infolistSchema['schema'] ?? []);
        $table->setOption('canView', $this->canView());
        $table->setOption('canCreate', $this->canCreate());
        $table->setOption('canEdit', $this->canEdit());
        $table->setOption('canDelete', $this->canDelete());
        $table->setOption('label', $this->getResourceLabel());
        $table->setOption('pluralLabel', $this->getResourcePluralLabel());

        return $table;
    }

    /**
     * Get the schema (table) for this page.
     */
    public function getSchema(): array
    {
        $resource = static::getResource();

        // Configure the table
        $table = new Table;
        $table = $resource::table($table);
        $table->query(fn () => $this->getTableQuery());
        $table->model($resource::getModel());
        $table->resourceSlug($resource::getSlug());

        // Add modal CRUD configuration
        $table = $this->configureTableForModalCrud($table);

        // Return the Table object - Page::render() will call toInertiaProps()
        return [$table];
    }

    /**
     * Get additional Inertia props for ManageRecords page.
     * Merges with parent props to maintain standard page behavior.
     */
    protected function getInertiaProps(): array
    {
        // Get parent props (view toggle, grid option, etc.)
        return parent::getInertiaProps();
    }

    /**
     * Get paginated records for AJAX request.
     */
    public function index(Request $request): JsonResponse
    {
        $resource = static::getResource();

        // Configure the table with modal CRUD actions
        $table = new Table;
        $table = $resource::table($table);
        $table->query(fn () => $this->getTableQuery());
        $table->model($resource::getModel());
        $table->resourceSlug($resource::getSlug());
        $table = $this->configureTableForModalCrud($table);

        // Get the records using the table's toInertiaProps which handles pagination
        $tableProps = $table->toInertiaProps();

        return response()->json([
            'data' => $tableProps['records'] ?? [],
            'pagination' => $tableProps['pagination'] ?? [
                'total' => 0,
                'per_page' => 12,
                'current_page' => 1,
                'last_page' => 1,
                'from' => 0,
                'to' => 0,
            ],
        ]);
    }

    /**
     * Store a new record (create via modal).
     */
    public function store(Request $request): JsonResponse
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        try {
            $data = $request->all();
            $record = new $modelClass;
            $record->fill($data);
            $record->save();

            return response()->json([
                'success' => true,
                'message' => __('actions::actions.messages.created'),
                'record' => $record,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 422);
        }
    }

    /**
     * Show a single record (for view/edit modal).
     */
    public function show(Request $request, $id): JsonResponse
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        try {
            $record = $modelClass::findOrFail($id);

            return response()->json([
                'success' => true,
                'record' => $record,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 404);
        }
    }

    /**
     * Update a record (edit via modal).
     */
    public function update(Request $request, $id): JsonResponse
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        try {
            $record = $modelClass::findOrFail($id);
            $data = $request->all();
            $record->fill($data);
            $record->save();

            return response()->json([
                'success' => true,
                'message' => __('actions::actions.messages.saved'),
                'record' => $record,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 422);
        }
    }

    /**
     * Delete a record.
     */
    public function destroy(Request $request, $id): JsonResponse
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        try {
            $record = $modelClass::findOrFail($id);
            $record->delete();

            return response()->json([
                'success' => true,
                'message' => __('actions::actions.messages.deleted'),
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 422);
        }
    }

    /**
     * Bulk delete records.
     */
    public function bulkDelete(Request $request): JsonResponse
    {
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        try {
            $ids = $request->input('ids', []);

            if (empty($ids)) {
                return response()->json([
                    'success' => false,
                    'message' => __('actions::actions.messages.no_records_selected'),
                ], 422);
            }

            $modelClass::whereIn('id', $ids)->delete();

            return response()->json([
                'success' => true,
                'message' => __('actions::actions.messages.bulk_deleted', ['count' => count($ids)]),
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 422);
        }
    }
}
</file>

<file path="src/Panel.php">
<?php

namespace Laravilt\Panel;

use Closure;
use Illuminate\Support\Traits\Conditionable;
use Illuminate\Support\Traits\Macroable;
use Laravilt\Panel\Concerns\HasAI;
use Laravilt\Panel\Concerns\HasAuth;
use Laravilt\Panel\Concerns\HasBranding;
use Laravilt\Panel\Concerns\HasClusters;
use Laravilt\Panel\Concerns\HasColors;
use Laravilt\Panel\Concerns\HasId;
use Laravilt\Panel\Concerns\HasMiddleware;
use Laravilt\Panel\Concerns\HasNavigation;
use Laravilt\Panel\Concerns\HasNotifications;
use Laravilt\Panel\Concerns\HasPages;
use Laravilt\Panel\Concerns\HasPath;
use Laravilt\Panel\Concerns\HasResources;
use Laravilt\Panel\Concerns\HasTenancy;
use Laravilt\Panel\Concerns\HasTheme;
use Laravilt\Panel\Concerns\HasWidgets;
use Laravilt\Panel\Discovery\PanelDiscovery;

class Panel
{
    use Conditionable;
    use HasAI;
    use HasAuth;
    use HasBranding;
    use HasClusters;
    use HasColors;
    use HasId;
    use HasMiddleware;
    use HasNavigation;
    use HasNotifications;
    use HasPages;
    use HasPath;
    use HasResources;
    use HasTenancy;
    use HasTheme;
    use HasWidgets;
    use Macroable;

    /**
     * Is this the default panel?
     */
    protected bool $isDefault = false;

    /**
     * Panel configuration.
     */
    protected array $configuration = [];

    /**
     * Maximum content width.
     */
    protected string|Closure|null $maxContentWidth = null;

    /**
     * Enable auto-discovery of components.
     */
    protected bool $autoDiscovery = false;

    /**
     * Create a new panel instance.
     */
    public function __construct(string $id)
    {
        $this->id($id);
        $this->path($id);
        $this->middleware(['web']);
    }

    /**
     * Make a new panel instance.
     */
    public static function make(string $id): static
    {
        return new static($id);
    }

    /**
     * Mark this panel as the default.
     */
    public function default(bool $condition = true): static
    {
        $this->isDefault = $condition;

        return $this;
    }

    /**
     * Check if this is the default panel.
     */
    public function isDefault(): bool
    {
        return $this->isDefault;
    }

    /**
     * Enable auto-discovery of pages, resources, clusters, and widgets.
     */
    public function discoverAutomatically(bool $condition = true): static
    {
        $this->autoDiscovery = $condition;

        return $this;
    }

    /**
     * Check if auto-discovery is enabled.
     */
    public function hasAutoDiscovery(): bool
    {
        return $this->autoDiscovery;
    }

    /**
     * Register this panel.
     */
    public function register(): void
    {
        // Auto-discover components if enabled
        if ($this->autoDiscovery) {
            PanelDiscovery::discover($this);
        }

        // Ensure RequirePassword middleware is added if social login requires it
        if (method_exists($this, 'ensureRequirePasswordMiddleware')) {
            $this->ensureRequirePasswordMiddleware();
        }

        app(PanelRegistry::class)->register($this);
    }

    /**
     * Get the user menu.
     */
    public function getUserMenu(): array
    {
        $menu = new \Laravilt\Panel\Navigation\UserMenu;

        // If custom user menu callback is set, use it
        if ($this->userMenuCallback) {
            call_user_func($this->userMenuCallback, $menu);
        } else {
            // Build default user menu with auth items
            if (method_exists($this, 'buildAuthUserMenu')) {
                $this->buildAuthUserMenu($menu);
            }
        }

        $menuItems = $menu->toArray();

        // Add AI menu items if AI providers are configured
        if ($this->hasAIProviders()) {
            $aiItems = $this->getAIMenuItems();
            if (! empty($aiItems)) {
                $aiMenuItems = collect($aiItems)->map(fn ($item) => $item->toArray())->all();
                // Insert AI items before the last item (logout)
                if (count($menuItems) > 0) {
                    array_splice($menuItems, -1, 0, $aiMenuItems);
                } else {
                    $menuItems = array_merge($menuItems, $aiMenuItems);
                }
            }
        }

        return $menuItems;
    }

    /**
     * Get the panel URL.
     */
    public function url(string $path = ''): string
    {
        $panelPath = trim($this->getPath(), '/');
        $basePath = $panelPath ? '/'.$panelPath : '';

        if ($path) {
            $path = '/'.trim($path, '/');
        }

        return $basePath.$path ?: '/';
    }

    /**
     * Get the panel route name.
     */
    public function route(string $name = ''): string
    {
        $routeName = $this->getId();

        if ($name) {
            $routeName .= '.'.$name;
        }

        return $routeName;
    }

    /**
     * Set the maximum content width.
     */
    public function maxContentWidth(string|Closure|null $width): static
    {
        $this->maxContentWidth = $width;

        return $this;
    }

    /**
     * Get the maximum content width.
     */
    public function getMaxContentWidth(): string
    {
        return $this->evaluate($this->maxContentWidth) ?? config('laravilt.panel.max_content_width', '7xl');
    }

    /**
     * Boot the panel.
     */
    public function boot(): void
    {
        // Register auth pages before booting
        if (method_exists($this, 'getAuthPages')) {
            $authPages = $this->getAuthPages();
            if (! empty($authPages)) {
                $this->pages($authPages);
            }
        }

        $this->bootClusters();
        $this->bootPages();
        $this->bootWidgets();
        $this->bootResources();
        $this->bootNavigation();
        $this->registerAuthRoutes();
        $this->registerNotificationRoutes();
        $this->registerAIRoutes();
        $this->registerResourcesForGlobalSearch();
    }

    /**
     * Convert panel to array.
     */
    public function toArray(): array
    {
        return [
            'id' => $this->getId(),
            'path' => $this->getPath(),
            'colors' => $this->getColors(),
            'brandName' => $this->getBrandName(),
            'brandLogo' => $this->getBrandLogo(),
            'isDefault' => $this->isDefault(),
            'middleware' => $this->getMiddleware(),
        ];
    }

    /**
     * Evaluate a value that might be a closure.
     */
    protected function evaluate(mixed $value): mixed
    {
        if ($value instanceof Closure) {
            return $value();
        }

        return $value;
    }
}
</file>

<file path="stubs/panel-provider.stub">
<?php

namespace App\Providers\Laravilt;

use Laravilt\Panel\Panel;
use Laravilt\Panel\PanelProvider;

class {{ studlyId }}PanelProvider extends PanelProvider
{
    /**
     * Configure the panel.
     */
    public function panel(Panel $panel): Panel
    {
        return $panel
            ->path('{{ path }}')
            ->brandName('{{ studlyId }}')
            ->discoverAutomatically()
            ->middleware(['web', 'auth'])
            ->authMiddleware(['auth']);
    }
}
</file>

<file path="tests/TestCase.php">
<?php

namespace Laravilt\Panel\Tests;

use Orchestra\Testbench\TestCase as Orchestra;

class TestCase extends Orchestra
{
    protected function setUp(): void
    {
        parent::setUp();
    }

    protected function getPackageProviders($app): array
    {
        return [
            \Laravilt\Support\SupportServiceProvider::class,
            \Laravilt\Panel\PanelServiceProvider::class,
        ];
    }

    protected function getEnvironmentSetUp($app): void
    {
        config()->set('database.default', 'sqlite');
        config()->set('database.connections.sqlite.database', ':memory:');
        config()->set('app.key', 'base64:'.base64_encode(random_bytes(32)));
    }
}
</file>

<file path="mcp-server.json">
{
  "name": "laravilt-panel",
  "version": "1.0.0",
  "description": "MCP Server for Laravilt Panel Package Documentation",
  "mcpServers": {
    "laravilt-panel-docs": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "./docs"
      ],
      "metadata": {
        "description": "Provides access to Laravilt Panel package documentation",
        "categories": ["panel", "admin", "laravel", "documentation"]
      }
    }
  },
  "resources": [
    {
      "uri": "laravilt://panel/docs/index",
      "name": "Laravilt Panel Documentation",
      "description": "Complete documentation for the Laravilt Panel package",
      "mimeType": "text/markdown"
    },
    {
      "uri": "laravilt://panel/docs/mcp-server",
      "name": "MCP Server Integration Guide",
      "description": "Guide for MCP server integration and generator commands",
      "mimeType": "text/markdown"
    },
    {
      "uri": "laravilt://panel/api",
      "name": "Panel API Reference",
      "description": "Complete API reference for Panel configuration",
      "mimeType": "text/markdown"
    },
    {
      "uri": "laravilt://panel/pages",
      "name": "Page Development Guide",
      "description": "Guide for creating custom pages",
      "mimeType": "text/markdown"
    },
    {
      "uri": "laravilt://panel/resources",
      "name": "Resource Development Guide",
      "description": "Guide for creating CRUD resources",
      "mimeType": "text/markdown"
    }
  ],
  "tools": [
    {
      "name": "search_panel_docs",
      "description": "Search the Laravilt Panel documentation for specific topics",
      "inputSchema": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string",
            "description": "Search query (e.g., 'navigation', 'middleware', 'multi-tenancy')"
          }
        },
        "required": ["query"]
      }
    },
    {
      "name": "get_panel_config",
      "description": "Get panel configuration options and examples",
      "inputSchema": {
        "type": "object",
        "properties": {
          "feature": {
            "type": "string",
            "description": "Feature name (e.g., 'authentication', 'navigation', 'pages')"
          }
        },
        "required": ["feature"]
      }
    },
    {
      "name": "list_panel_methods",
      "description": "List all available Panel methods and their signatures",
      "inputSchema": {
        "type": "object",
        "properties": {}
      }
    },
    {
      "name": "get_page_example",
      "description": "Get example code for creating custom pages",
      "inputSchema": {
        "type": "object",
        "properties": {
          "pageType": {
            "type": "string",
            "description": "Type of page (e.g., 'dashboard', 'form', 'table', 'settings')"
          }
        },
        "required": ["pageType"]
      }
    },
    {
      "name": "list_panels",
      "description": "List all available panels in the application",
      "inputSchema": {
        "type": "object",
        "properties": {}
      }
    },
    {
      "name": "panel_info",
      "description": "Get detailed information about a specific panel",
      "inputSchema": {
        "type": "object",
        "properties": {
          "panelId": {
            "type": "string",
            "description": "Panel identifier (e.g., 'admin', 'app')"
          }
        },
        "required": ["panelId"]
      }
    },
    {
      "name": "generate_panel",
      "description": "Generate a new panel with scaffolding. Uses: php artisan laravilt:panel {id} [--path=]",
      "inputSchema": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Panel identifier (kebab-case recommended)"
          },
          "path": {
            "type": "string",
            "description": "Custom URL path for the panel (defaults to /{id})"
          }
        },
        "required": ["id"]
      }
    },
    {
      "name": "generate_page",
      "description": "Generate a new page for a panel. Uses: php artisan laravilt:page {panel} {name}",
      "inputSchema": {
        "type": "object",
        "properties": {
          "panel": {
            "type": "string",
            "description": "Panel name (StudlyCase)"
          },
          "name": {
            "type": "string",
            "description": "Page name (can include subdirectories like Users/Profile)"
          }
        },
        "required": ["panel", "name"]
      }
    },
    {
      "name": "generate_resource",
      "description": "Generate a complete CRUD resource from a database table. Uses: php artisan laravilt:resource {panel} [--table=] [--model=]",
      "inputSchema": {
        "type": "object",
        "properties": {
          "panel": {
            "type": "string",
            "description": "Panel name (StudlyCase)"
          },
          "table": {
            "type": "string",
            "description": "Database table name"
          },
          "model": {
            "type": "string",
            "description": "Custom model name (defaults to singular StudlyCase of table)"
          },
          "withGrid": {
            "type": "boolean",
            "description": "Generate Grid view (default: false)"
          },
          "withApi": {
            "type": "boolean",
            "description": "Generate API endpoints (default: false)"
          }
        },
        "required": ["panel", "table"]
      }
    },
    {
      "name": "list_resources",
      "description": "List all resources in a panel",
      "inputSchema": {
        "type": "object",
        "properties": {
          "panel": {
            "type": "string",
            "description": "Panel name"
          }
        },
        "required": ["panel"]
      }
    },
    {
      "name": "resource_info",
      "description": "Get detailed information about a specific resource",
      "inputSchema": {
        "type": "object",
        "properties": {
          "panel": {
            "type": "string",
            "description": "Panel name"
          },
          "resource": {
            "type": "string",
            "description": "Resource name"
          }
        },
        "required": ["panel", "resource"]
      }
    },
    {
      "name": "get_icon_mapping",
      "description": "Get the icon name for a table/model name based on keyword mapping",
      "inputSchema": {
        "type": "object",
        "properties": {
          "keyword": {
            "type": "string",
            "description": "Table or model name to look up icon for"
          }
        },
        "required": ["keyword"]
      }
    }
  ]
}
</file>

<file path="package.json">
{
    "name": "@laravilt/panel",
    "version": "1.0.0",
    "description": "Complete admin panel system with resources, pages, navigation, multi-tenancy, and customizable layouts. Build powerful admin interfaces with CRUD resources, custom pages, and multiple panels.",
    "author": "Fady Mondy <info@3x1.io>",
    "license": "MIT",
    "type": "module",
    "main": "./dist/panel.umd.js",
    "module": "./dist/panel.es.js",
    "types": "./dist/index.d.ts",
    "exports": {
        ".": {
            "types": "./dist/index.d.ts",
            "import": "./dist/panel.es.js",
            "require": "./dist/panel.umd.js"
        },
        "./style.css": "./dist/style.css"
    },
    "files": [
        "dist",
        "resources"
    ],
    "keywords": [
        "laravilt",
        "panel",
        "admin",
        "dashboard",
        "resources",
        "crud",
        "pages",
        "navigation",
        "multi-tenancy",
        "vue",
        "vue3",
        "inertia",
        "laravel"
    ],
    "repository": {
        "type": "git",
        "url": "https://github.com/laravilt/panel"
    },
    "bugs": {
        "url": "https://github.com/laravilt/panel/issues"
    },
    "homepage": "https://laravilt.dev/panel",
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "build:types": "vue-tsc --declaration --emitDeclarationOnly --outDir dist resources/js/app.ts || true",
        "build:npm": "npm run build",
        "prepublishOnly": "npm run build:npm",
        "format": "prettier --write resources/",
        "format:check": "prettier --check resources/",
        "lint": "eslint . --fix",
        "test": "npx playwright test",
        "test:headed": "npx playwright test --headed"
    },
    "peerDependencies": {
        "@inertiajs/vue3": "^2.0.0",
        "@laravilt/support": "^1.0.0",
        "@laravilt/schemas": "^1.0.0",
        "@laravilt/forms": "^1.0.0",
        "@laravilt/tables": "^1.0.0",
        "@laravilt/actions": "^1.0.0",
        "@laravilt/notifications": "^1.0.0",
        "vue": "^3.3.0"
    },
    "peerDependenciesMeta": {
        "@laravilt/auth": {
            "optional": true
        },
        "@laravilt/widgets": {
            "optional": true
        },
        "@laravilt/infolists": {
            "optional": true
        }
    },
    "devDependencies": {
        "@eslint/js": "^9.19.0",
        "@playwright/test": "^1.49.1",
        "@tailwindcss/vite": "^4.1.11",
        "@types/node": "^22.13.5",
        "@vitejs/plugin-vue": "^6.0.0",
        "@vue/eslint-config-typescript": "^14.3.0",
        "@vueuse/core": "^14.1.0",
        "class-variance-authority": "^0.7.1",
        "clsx": "^2.1.1",
        "eslint": "^9.17.0",
        "eslint-config-prettier": "^10.0.1",
        "eslint-plugin-vue": "^9.32.0",
        "lucide-vue-next": "^0.555.0",
        "prettier": "^3.4.2",
        "prettier-plugin-organize-imports": "^4.1.0",
        "prettier-plugin-tailwindcss": "^0.6.11",
        "radix-vue": "^1.9.17",
        "reka-ui": "^2.6.1",
        "tailwind-merge": "^3.4.0",
        "typescript": "^5.2.2",
        "typescript-eslint": "^8.23.0",
        "vite": "^7.0.4",
        "vue": "^3.5.13",
        "vue-tsc": "^2.2.4"
    },
    "dependencies": {
        "tailwindcss": "^4.1.1"
    }
}
</file>

<file path=".github/workflows/tests.yml">
name: Tests

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        php: [8.3, 8.4]
        laravel: [12.*]
        dependency-version: [prefer-stable]

    name: PHP ${{ matrix.php }} - Laravel ${{ matrix.laravel }} - ${{ matrix.dependency-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Install dependencies
        run: |
          composer require "laravel/framework:${{ matrix.laravel }}" --no-interaction --no-update
          composer update --${{ matrix.dependency-version }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/pest
</file>

<file path="src/Commands/MakePageCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\GeneratorCommand;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;

class MakePageCommand extends GeneratorCommand
{
    protected $signature = 'laravilt:page {panel} {name}';

    protected $description = 'Create a new panel page';

    protected $type = 'Page';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $result = parent::handle();

        if ($result !== false) {
            $this->createVueViewFile();
        }

        return $result;
    }

    /**
     * Get the stub file for the generator.
     */
    protected function getStub(): string
    {
        return __DIR__.'/../../stubs/page.stub';
    }

    /**
     * Get the default namespace for the class.
     */
    protected function getDefaultNamespace($rootNamespace): string
    {
        $panel = Str::studly($this->argument('panel'));

        return $rootNamespace."\\Laravilt\\{$panel}\\Pages";
    }

    /**
     * Build the class with the given name.
     */
    protected function buildClass($name): string
    {
        $stub = parent::buildClass($name);

        $panel = Str::studly($this->argument('panel'));
        $pageName = Str::studly($this->argument('name'));

        $replacements = [
            '{{ panel }}' => $panel,
            '{{ name }}' => $pageName,
        ];

        return str_replace(
            array_keys($replacements),
            array_values($replacements),
            $stub
        );
    }

    /**
     * Create the Vue view file for the page.
     */
    protected function createVueViewFile(): void
    {
        $panel = Str::studly($this->argument('panel'));
        $name = Str::studly($this->argument('name'));

        $viewPath = resource_path("js/pages/{$panel}");
        $viewFile = "{$viewPath}/{$name}.vue";

        if (File::exists($viewFile)) {
            $this->components->error("Vue view already exists: {$viewFile}");

            return;
        }

        File::ensureDirectoryExists($viewPath);

        $stub = File::get(__DIR__.'/../../stubs/page-view.stub');
        $content = str_replace('{{ name }}', $name, $stub);

        File::put($viewFile, $content);

        $this->components->info("Vue view created: {$viewFile}");
    }
}
</file>

<file path="src/Commands/MakeResourceCommand.php">
<?php

namespace Laravilt\Panel\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;

use function Laravel\Prompts\confirm;
use function Laravel\Prompts\multiselect;
use function Laravel\Prompts\search;
use function Laravel\Prompts\select;
use function Laravel\Prompts\text;

class MakeResourceCommand extends Command
{
    protected $signature = 'laravilt:resource {panel?} {--table=} {--model=} {--simple}';

    protected $description = 'Create a new panel resource from database table with CRUD pages';

    protected array $excludedColumns = [
        'id', 'created_at', 'updated_at', 'deleted_at', 'remember_token',
        'email_verified_at', 'password', 'two_factor_secret', 'two_factor_recovery_codes',
        'two_factor_confirmed_at',
    ];

    protected array $columnTypeMap = [
        'string' => 'TextInput',
        'text' => 'Textarea',
        'integer' => 'TextInput',
        'bigint' => 'TextInput',
        'smallint' => 'TextInput',
        'tinyint' => 'TextInput',
        'float' => 'TextInput',
        'double' => 'TextInput',
        'decimal' => 'TextInput',
        'boolean' => 'Toggle',
        'date' => 'DatePicker',
        'datetime' => 'DateTimePicker',
        'timestamp' => 'DateTimePicker',
        'time' => 'TimePicker',
        'json' => 'KeyValue',
        'enum' => 'Select',
    ];

    /**
     * Icon mapping based on table/model name keywords
     */
    protected array $iconMap = [
        // Users & Auth
        'user' => 'Users',
        'users' => 'Users',
        'customer' => 'UserCircle',
        'customers' => 'UserCircle',
        'member' => 'UserCheck',
        'members' => 'UserCheck',
        'admin' => 'UserCog',
        'admins' => 'UserCog',
        'employee' => 'BadgeCheck',
        'employees' => 'BadgeCheck',
        'staff' => 'UsersRound',
        'role' => 'Shield',
        'roles' => 'Shield',
        'permission' => 'Key',
        'permissions' => 'Key',
        'auth' => 'Lock',
        'account' => 'User',
        'accounts' => 'User',
        'profile' => 'UserCircle2',
        'profiles' => 'UserCircle2',

        // Content & Media
        'post' => 'FileText',
        'posts' => 'FileText',
        'article' => 'Newspaper',
        'articles' => 'Newspaper',
        'blog' => 'BookOpen',
        'blogs' => 'BookOpen',
        'page' => 'File',
        'pages' => 'File',
        'document' => 'FileText',
        'documents' => 'FileText',
        'media' => 'Image',
        'image' => 'Image',
        'images' => 'Image',
        'photo' => 'Camera',
        'photos' => 'Camera',
        'video' => 'Video',
        'videos' => 'Video',
        'file' => 'File',
        'files' => 'File',
        'attachment' => 'Paperclip',
        'attachments' => 'Paperclip',
        'gallery' => 'Images',

        // E-commerce
        'product' => 'Package',
        'products' => 'Package',
        'item' => 'Box',
        'items' => 'Box',
        'order' => 'ShoppingCart',
        'orders' => 'ShoppingCart',
        'cart' => 'ShoppingBag',
        'carts' => 'ShoppingBag',
        'invoice' => 'Receipt',
        'invoices' => 'Receipt',
        'payment' => 'CreditCard',
        'payments' => 'CreditCard',
        'transaction' => 'ArrowLeftRight',
        'transactions' => 'ArrowLeftRight',
        'category' => 'FolderTree',
        'categories' => 'FolderTree',
        'brand' => 'Award',
        'brands' => 'Award',
        'coupon' => 'Ticket',
        'coupons' => 'Ticket',
        'discount' => 'Percent',
        'discounts' => 'Percent',
        'shipping' => 'Truck',
        'wishlist' => 'Heart',
        'review' => 'Star',
        'reviews' => 'Star',
        'subscription' => 'Repeat',
        'subscriptions' => 'Repeat',
        'plan' => 'CreditCard',
        'plans' => 'CreditCard',

        // Communication
        'message' => 'MessageSquare',
        'messages' => 'MessageSquare',
        'comment' => 'MessageCircle',
        'comments' => 'MessageCircle',
        'notification' => 'Bell',
        'notifications' => 'Bell',
        'email' => 'Mail',
        'emails' => 'Mail',
        'chat' => 'MessagesSquare',
        'chats' => 'MessagesSquare',
        'contact' => 'Contact',
        'contacts' => 'Contact',
        'newsletter' => 'Newspaper',

        // Organization
        'company' => 'Building2',
        'companies' => 'Building2',
        'organization' => 'Building',
        'organizations' => 'Building',
        'department' => 'Network',
        'departments' => 'Network',
        'team' => 'Users',
        'teams' => 'Users',
        'branch' => 'GitBranch',
        'branches' => 'GitBranch',
        'office' => 'Landmark',
        'offices' => 'Landmark',

        // Location
        'address' => 'MapPin',
        'addresses' => 'MapPin',
        'location' => 'MapPinned',
        'locations' => 'MapPinned',
        'country' => 'Globe',
        'countries' => 'Globe',
        'city' => 'Building',
        'cities' => 'Building',
        'state' => 'Map',
        'states' => 'Map',
        'region' => 'Globe2',
        'regions' => 'Globe2',

        // Tasks & Projects
        'task' => 'CheckSquare',
        'tasks' => 'CheckSquare',
        'project' => 'FolderKanban',
        'projects' => 'FolderKanban',
        'ticket' => 'Ticket',
        'tickets' => 'Ticket',
        'issue' => 'CircleAlert',
        'issues' => 'CircleAlert',
        'milestone' => 'Flag',
        'milestones' => 'Flag',
        'sprint' => 'Zap',
        'sprints' => 'Zap',

        // Calendar & Time
        'event' => 'Calendar',
        'events' => 'Calendar',
        'appointment' => 'CalendarCheck',
        'appointments' => 'CalendarCheck',
        'booking' => 'CalendarDays',
        'bookings' => 'CalendarDays',
        'schedule' => 'Clock',
        'schedules' => 'Clock',
        'meeting' => 'Video',
        'meetings' => 'Video',

        // Settings & Config
        'setting' => 'Settings',
        'settings' => 'Settings',
        'config' => 'Cog',
        'configuration' => 'Cog',
        'option' => 'SlidersHorizontal',
        'options' => 'SlidersHorizontal',
        'preference' => 'Settings2',
        'preferences' => 'Settings2',

        // Finance
        'budget' => 'Wallet',
        'budgets' => 'Wallet',
        'expense' => 'TrendingDown',
        'expenses' => 'TrendingDown',
        'income' => 'TrendingUp',
        'revenue' => 'DollarSign',
        'tax' => 'Receipt',
        'taxes' => 'Receipt',
        'report' => 'FileBarChart',
        'reports' => 'FileBarChart',
        'analytics' => 'BarChart3',

        // Inventory
        'inventory' => 'Package',
        'stock' => 'Boxes',
        'warehouse' => 'Warehouse',
        'supplier' => 'Truck',
        'suppliers' => 'Truck',
        'vendor' => 'Store',
        'vendors' => 'Store',

        // Support
        'faq' => 'HelpCircle',
        'faqs' => 'HelpCircle',
        'help' => 'LifeBuoy',
        'support' => 'Headphones',

        // Misc
        'log' => 'ScrollText',
        'logs' => 'ScrollText',
        'activity' => 'Activity',
        'activities' => 'Activity',
        'audit' => 'ClipboardList',
        'tag' => 'Tag',
        'tags' => 'Tags',
        'label' => 'Tag',
        'labels' => 'Tags',
        'language' => 'Languages',
        'languages' => 'Languages',
        'translation' => 'Languages',
        'currency' => 'Coins',
        'currencies' => 'Coins',
        'note' => 'StickyNote',
        'notes' => 'StickyNote',
        'link' => 'Link',
        'links' => 'Link',
        'menu' => 'Menu',
        'menus' => 'Menu',
        'banner' => 'PanelTop',
        'banners' => 'PanelTop',
        'slider' => 'GalleryHorizontal',
        'sliders' => 'GalleryHorizontal',
        'widget' => 'LayoutGrid',
        'widgets' => 'LayoutGrid',
        'template' => 'LayoutTemplate',
        'templates' => 'LayoutTemplate',
        'theme' => 'Palette',
        'themes' => 'Palette',
    ];

    // Generator options
    protected bool $generateApi = false;

    protected bool $isSimple = false;

    protected array $apiMethods = [];

    protected array $relations = [];

    protected bool $useApiTester = false;

    /**
     * Field name patterns for intelligent input type selection
     */
    protected array $fieldPatterns = [
        // Select fields
        'status' => 'Select',
        'type' => 'Select',
        'role' => 'Select',
        'category' => 'Select',
        'priority' => 'Select',
        'visibility' => 'Select',
        'level' => 'Select',
        'gender' => 'Select',
        'currency' => 'Select',
        'language' => 'Select',
        'timezone' => 'Select',

        // Location fields (dependent selects)
        'country' => 'Select',
        'country_id' => 'Select',
        'state' => 'Select',
        'state_id' => 'Select',
        'city' => 'Select',
        'city_id' => 'Select',
        'region' => 'Select',
        'province' => 'Select',

        // Tags
        'tags' => 'TagsInput',
        'keywords' => 'TagsInput',
        'skills' => 'TagsInput',
        'labels' => 'TagsInput',
        'categories' => 'TagsInput',

        // Code editors
        'code' => 'CodeEditor',
        'html' => 'CodeEditor',
        'css' => 'CodeEditor',
        'javascript' => 'CodeEditor',
        'js' => 'CodeEditor',
        'json_content' => 'CodeEditor',
        'script' => 'CodeEditor',
        'style' => 'CodeEditor',
        'template' => 'CodeEditor',
        'source' => 'CodeEditor',
        'snippet' => 'CodeEditor',

        // Rich text
        'body' => 'RichEditor',
        'content' => 'RichEditor',
        'article' => 'RichEditor',
        'post_content' => 'RichEditor',
        'message' => 'RichEditor',
        'bio' => 'RichEditor',
        'about' => 'RichEditor',

        // Textarea
        'description' => 'Textarea',
        'summary' => 'Textarea',
        'excerpt' => 'Textarea',
        'notes' => 'Textarea',
        'comment' => 'Textarea',
        'remarks' => 'Textarea',
        'address' => 'Textarea',
        'instructions' => 'Textarea',

        // Color
        'color' => 'ColorPicker',
        'colour' => 'ColorPicker',
        'background_color' => 'ColorPicker',
        'text_color' => 'ColorPicker',
        'border_color' => 'ColorPicker',
        'primary_color' => 'ColorPicker',
        'secondary_color' => 'ColorPicker',
        'accent_color' => 'ColorPicker',
        'hex_color' => 'ColorPicker',

        // Icons
        'icon' => 'IconPicker',
        'icon_name' => 'IconPicker',
        'menu_icon' => 'IconPicker',
        'nav_icon' => 'IconPicker',

        // Key-value
        'metadata' => 'KeyValue',
        'meta' => 'KeyValue',
        'attributes' => 'KeyValue',
        'settings' => 'KeyValue',
        'options' => 'KeyValue',
        'config' => 'KeyValue',
        'properties' => 'KeyValue',
        'extra' => 'KeyValue',
        'data' => 'KeyValue',
        'params' => 'KeyValue',
        'parameters' => 'KeyValue',
    ];

    /**
     * Section groupings for form fields
     */
    protected array $sectionGroups = [
        'basic' => [
            'title' => 'Basic Information',
            'icon' => 'info',
            'fields' => ['name', 'title', 'label', 'email', 'phone', 'mobile', 'username', 'slug', 'subject', 'heading'],
        ],
        'content' => [
            'title' => 'Content',
            'icon' => 'FileText',
            'fields' => ['body', 'content', 'description', 'summary', 'excerpt', 'bio', 'about', 'notes', 'message', 'article', 'post_content'],
        ],
        'media' => [
            'title' => 'Media',
            'icon' => 'Image',
            'fields' => ['image', 'photo', 'avatar', 'logo', 'thumbnail', 'cover', 'banner', 'picture', 'file', 'attachment', 'document', 'video', 'gallery'],
        ],
        'location' => [
            'title' => 'Location',
            'icon' => 'MapPin',
            'fields' => ['address', 'city', 'state', 'country', 'region', 'province', 'postal_code', 'zip_code', 'zipcode', 'latitude', 'longitude', 'lat', 'lng', 'location'],
        ],
        'status' => [
            'title' => 'Status & Classification',
            'icon' => 'Tag',
            'fields' => ['status', 'type', 'category', 'role', 'priority', 'visibility', 'level', 'tags', 'labels', 'keywords'],
        ],
        'pricing' => [
            'title' => 'Pricing & Finance',
            'icon' => 'DollarSign',
            'fields' => ['price', 'cost', 'amount', 'total', 'subtotal', 'discount', 'tax', 'fee', 'credit_limit', 'balance', 'budget', 'revenue', 'profit', 'spent', 'currency'],
        ],
        'dates' => [
            'title' => 'Dates & Time',
            'icon' => 'Calendar',
            'fields' => ['date', 'start_date', 'end_date', 'due_date', 'birth_date', 'published_at', 'expires_at', 'scheduled_at', 'event_date', 'time', 'start_time', 'end_time', 'duration', 'last_order_at'],
        ],
        'settings' => [
            'title' => 'Settings & Configuration',
            'icon' => 'Settings',
            'fields' => ['metadata', 'meta', 'settings', 'options', 'config', 'attributes', 'properties', 'params', 'parameters', 'extra', 'data'],
        ],
        'code' => [
            'title' => 'Code & Scripts',
            'icon' => 'Code',
            'fields' => ['code', 'html', 'css', 'javascript', 'js', 'json_content', 'script', 'style', 'template', 'source', 'snippet'],
        ],
        'appearance' => [
            'title' => 'Appearance',
            'icon' => 'Palette',
            'fields' => ['color', 'colour', 'background_color', 'text_color', 'border_color', 'icon', 'icon_name', 'theme'],
        ],
        'social' => [
            'title' => 'Social & Links',
            'icon' => 'Link',
            'fields' => ['url', 'website', 'link', 'facebook', 'twitter', 'instagram', 'linkedin', 'github', 'youtube', 'social'],
        ],
        'seo' => [
            'title' => 'SEO',
            'icon' => 'Search',
            'fields' => ['meta_title', 'meta_description', 'meta_keywords', 'og_title', 'og_description', 'og_image', 'canonical_url', 'robots'],
        ],
        'flags' => [
            'title' => 'Options',
            'icon' => 'ToggleLeft',
            'fields' => ['is_active', 'is_enabled', 'is_visible', 'is_featured', 'is_verified', 'is_published', 'is_approved', 'is_default', 'active', 'enabled', 'visible', 'featured', 'verified', 'published', 'approved'],
        ],
    ];

    public function handle(): int
    {
        // Get available panels from the Laravilt directory
        $panels = $this->getAvailablePanels();

        if (empty($panels)) {
            $this->components->error('No panels found. Please create a panel first.');

            return self::FAILURE;
        }

        // Get panel name
        $panel = $this->argument('panel');
        if (! $panel) {
            $panel = select(
                label: 'Select a panel:',
                options: $panels,
                default: $panels[0] ?? 'Admin'
            );
        }
        $panel = Str::studly($panel);

        // Get all tables from database
        $tables = $this->getDatabaseTables();

        if (empty($tables)) {
            $this->components->error('No tables found in the database.');

            return self::FAILURE;
        }

        // Let user select a table
        $tableName = $this->option('table');
        if (! $tableName) {
            $tableName = search(
                label: 'Select a database table to generate resource from:',
                options: fn (string $value) => strlen($value) > 0
                    ? collect($tables)->filter(fn ($table) => str_contains(strtolower($table), strtolower($value)))->values()->all()
                    : $tables,
                placeholder: 'Search for a table...',
                scroll: 15
            );
        }

        if (! in_array($tableName, $tables)) {
            $this->components->error("Table '{$tableName}' not found in database.");

            return self::FAILURE;
        }

        // Get model name from table
        $modelName = $this->option('model') ?? Str::studly(Str::singular($tableName));

        // Get table columns
        $columns = $this->getTableColumns($tableName);

        if (empty($columns)) {
            $this->components->error("No columns found in table '{$tableName}'.");

            return self::FAILURE;
        }

        // Detect foreign key relations
        $this->relations = $this->detectRelations($tableName, $columns);

        $this->components->info("Generating resource for table: {$tableName}");
        $this->components->info("Model: {$modelName}");
        $this->newLine();

        // Display columns info
        $this->components->info('Found '.count($columns).' columns:');
        foreach ($columns as $column) {
            $relationInfo = '';
            if (isset($this->relations[$column['name']])) {
                $rel = $this->relations[$column['name']];
                $relationInfo = " -> BelongsTo {$rel['model']}";
            }
            $this->line("  - {$column['name']} ({$column['type']}".($column['nullable'] ? ', nullable' : '')."){$relationInfo}");
        }
        $this->newLine();

        // Display detected relations
        if (! empty($this->relations)) {
            $this->components->info('Detected '.count($this->relations).' relations:');
            foreach ($this->relations as $column => $relation) {
                $this->line("  - {$column} -> {$relation['model']} (via {$relation['table']})");
            }
            $this->newLine();
        }

        // Ask about simple resource (--simple flag or prompt)
        $this->isSimple = $this->option('simple') || confirm(
            label: 'Generate as simple resource? (Single page with modal CRUD)',
            default: false,
            hint: 'Simple resources use a single ManageRecords page with modal forms'
        );

        // Ask about API generation
        $this->generateApi = confirm(
            label: 'Generate API endpoints?',
            default: false,
            hint: 'API provides RESTful endpoints for external access'
        );

        if ($this->generateApi) {
            $this->apiMethods = multiselect(
                label: 'Select API methods to generate:',
                options: [
                    'index' => 'GET /api/{resource} - List all records',
                    'show' => 'GET /api/{resource}/{id} - Get single record',
                    'store' => 'POST /api/{resource} - Create new record',
                    'update' => 'PUT /api/{resource}/{id} - Update record',
                    'destroy' => 'DELETE /api/{resource}/{id} - Delete record',
                ],
                default: ['index', 'show', 'store', 'update', 'destroy'],
                hint: 'Use space to select/deselect methods'
            );

            $this->useApiTester = confirm(
                label: 'Enable API Tester interface?',
                default: false,
                hint: 'Shows an interactive API testing UI in the panel for this resource'
            );
        }

        // Confirm generation
        $this->newLine();
        $this->components->info('Will generate:');
        $this->line('  - Resource, Form, Table, InfoList');
        if ($this->isSimple) {
            $this->line('  - Pages: ManageRecords (single page with modal CRUD)');
        } else {
            $this->line('  - Pages: List, Create, Edit, View');
        }
        if ($this->generateApi) {
            $this->line('  - API endpoints: '.implode(', ', $this->apiMethods));
            if ($this->useApiTester) {
                $this->line('  - API Tester interface: Enabled');
            }
        }
        $this->newLine();

        if (! confirm('Proceed with resource generation?', true)) {
            $this->components->info('Generation cancelled.');

            return self::SUCCESS;
        }

        // Create model if it doesn't exist
        $this->createModel($modelName, $tableName, $columns);

        // Create resource directory structure
        $resourceDir = app_path("Laravilt/{$panel}/Resources/{$modelName}");
        File::ensureDirectoryExists($resourceDir);
        File::ensureDirectoryExists("{$resourceDir}/Form");
        File::ensureDirectoryExists("{$resourceDir}/Table");
        File::ensureDirectoryExists("{$resourceDir}/InfoList");
        File::ensureDirectoryExists("{$resourceDir}/Pages");

        if ($this->generateApi) {
            File::ensureDirectoryExists("{$resourceDir}/Api");
        }

        // Detect soft deletes
        $hasSoftDeletes = collect($columns)->contains(fn ($col) => $col['name'] === 'deleted_at');

        // Generate all files
        $this->createResourceFile($panel, $modelName, $tableName, $resourceDir, $this->isSimple, $hasSoftDeletes);
        $this->createFormFile($panel, $modelName, $columns, $resourceDir);
        $this->createTableFile($panel, $modelName, $columns, $resourceDir, $hasSoftDeletes);
        $this->createInfoListFile($panel, $modelName, $columns, $resourceDir);
        $this->createPageFiles($panel, $modelName, $resourceDir, $this->isSimple);

        if ($this->generateApi) {
            $this->createApiFile($panel, $modelName, $columns, $resourceDir);
        }

        $this->newLine();
        $this->components->info("Resource [{$modelName}] created successfully for panel [{$panel}]!");
        $this->newLine();
        $this->components->info('Generated files:');
        $this->line("  Resource: app/Laravilt/{$panel}/Resources/{$modelName}/{$modelName}Resource.php");
        $this->line("  Form: app/Laravilt/{$panel}/Resources/{$modelName}/Form/{$modelName}Form.php");
        $this->line("  Table: app/Laravilt/{$panel}/Resources/{$modelName}/Table/{$modelName}Table.php");
        $this->line("  InfoList: app/Laravilt/{$panel}/Resources/{$modelName}/InfoList/{$modelName}InfoList.php");
        if ($this->isSimple) {
            $this->line("  Pages: Manage{$modelName} (single page with modal CRUD)");
        } else {
            $this->line('  Pages: List, Create, Edit, View');
        }
        if ($this->generateApi) {
            $this->line("  API: app/Laravilt/{$panel}/Resources/{$modelName}/Api/{$modelName}Api.php");
        }

        return self::SUCCESS;
    }

    /**
     * Get the icon name based on table/model name
     */
    protected function getIconForModel(string $modelName, string $tableName): string
    {
        $searchTerms = [
            strtolower($modelName),
            strtolower($tableName),
            strtolower(Str::singular($tableName)),
        ];

        foreach ($searchTerms as $term) {
            // Direct match
            if (isset($this->iconMap[$term])) {
                return $this->iconMap[$term];
            }

            // Partial match
            foreach ($this->iconMap as $keyword => $icon) {
                if (str_contains($term, $keyword) || str_contains($keyword, $term)) {
                    return $icon;
                }
            }
        }

        return 'Database'; // Default fallback
    }

    /**
     * Detect foreign key relations from columns
     */
    protected function detectRelations(string $tableName, array $columns): array
    {
        $relations = [];
        $allTables = $this->getDatabaseTables();

        foreach ($columns as $column) {
            $name = $column['name'];

            // Check for _id suffix (common convention)
            if (Str::endsWith($name, '_id')) {
                $relatedTableSingular = Str::beforeLast($name, '_id');
                $relatedTablePlural = Str::plural($relatedTableSingular);

                // Check if related table exists
                if (in_array($relatedTablePlural, $allTables)) {
                    $relations[$name] = [
                        'type' => 'belongsTo',
                        'table' => $relatedTablePlural,
                        'model' => Str::studly($relatedTableSingular),
                        'foreign_key' => $name,
                        'title_column' => $this->guessRelationTitleColumn($relatedTablePlural),
                    ];
                } elseif (in_array($relatedTableSingular, $allTables)) {
                    $relations[$name] = [
                        'type' => 'belongsTo',
                        'table' => $relatedTableSingular,
                        'model' => Str::studly($relatedTableSingular),
                        'foreign_key' => $name,
                        'title_column' => $this->guessRelationTitleColumn($relatedTableSingular),
                    ];
                }
            }
        }

        return $relations;
    }

    /**
     * Guess the title column for a related table
     */
    protected function guessRelationTitleColumn(string $tableName): string
    {
        $columns = $this->getTableColumns($tableName);
        $columnNames = collect($columns)->pluck('name')->toArray();

        // Common title column names
        $candidates = ['name', 'title', 'label', 'email', 'username', 'display_name', 'full_name'];

        foreach ($candidates as $candidate) {
            if (in_array($candidate, $columnNames)) {
                return $candidate;
            }
        }

        // Return first string column
        foreach ($columns as $column) {
            if ($column['type'] === 'string' && ! in_array($column['name'], ['id', 'uuid', 'slug'])) {
                return $column['name'];
            }
        }

        return 'id';
    }

    protected function getAvailablePanels(): array
    {
        // First try to get panels from the registry
        $registry = app(\Laravilt\Panel\PanelRegistry::class);
        $registeredPanels = $registry->all();

        if (! empty($registeredPanels)) {
            return collect($registeredPanels)
                ->map(fn ($panel) => Str::studly($panel->getId()))
                ->values()
                ->toArray();
        }

        // Fallback to checking app/Laravilt directory structure
        $laraviltPath = app_path('Laravilt');

        if (! File::isDirectory($laraviltPath)) {
            return [];
        }

        $directories = File::directories($laraviltPath);

        return collect($directories)
            ->map(fn ($dir) => basename($dir))
            ->values()
            ->toArray();
    }

    protected function getDatabaseTables(): array
    {
        $tables = [];
        $connection = config('database.default');
        $driver = config("database.connections.{$connection}.driver");

        if ($driver === 'sqlite') {
            $results = DB::select("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
            $tables = array_map(fn ($row) => $row->name, $results);
        } elseif ($driver === 'mysql') {
            $database = config("database.connections.{$connection}.database");
            $results = DB::select('SELECT table_name FROM information_schema.tables WHERE table_schema = ? ORDER BY table_name', [$database]);
            $tables = array_map(fn ($row) => $row->table_name ?? $row->TABLE_NAME, $results);
        } elseif ($driver === 'pgsql') {
            $results = DB::select("SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename");
            $tables = array_map(fn ($row) => $row->tablename, $results);
        }

        // Filter out Laravel system tables
        $systemTables = ['migrations', 'password_reset_tokens', 'password_resets', 'failed_jobs', 'personal_access_tokens', 'jobs', 'job_batches', 'cache', 'cache_locks', 'sessions'];

        return array_values(array_filter($tables, fn ($table) => ! in_array($table, $systemTables)));
    }

    protected function getTableColumns(string $tableName): array
    {
        $columns = [];
        $connection = config('database.default');
        $driver = config("database.connections.{$connection}.driver");

        if ($driver === 'sqlite') {
            $results = DB::select("PRAGMA table_info({$tableName})");
            foreach ($results as $column) {
                $columns[] = [
                    'name' => $column->name,
                    'type' => $this->normalizeColumnType($column->type),
                    'nullable' => ! $column->notnull,
                    'default' => $column->dflt_value,
                ];
            }
        } elseif ($driver === 'mysql') {
            $database = config("database.connections.{$connection}.database");
            $results = DB::select('SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT, COLUMN_TYPE FROM information_schema.columns WHERE table_schema = ? AND table_name = ? ORDER BY ORDINAL_POSITION', [$database, $tableName]);
            foreach ($results as $column) {
                $columns[] = [
                    'name' => $column->COLUMN_NAME,
                    'type' => $this->normalizeColumnType($column->DATA_TYPE),
                    'nullable' => $column->IS_NULLABLE === 'YES',
                    'default' => $column->COLUMN_DEFAULT,
                    'full_type' => $column->COLUMN_TYPE,
                ];
            }
        } elseif ($driver === 'pgsql') {
            $results = DB::select('SELECT column_name, data_type, is_nullable, column_default FROM information_schema.columns WHERE table_name = ? ORDER BY ordinal_position', [$tableName]);
            foreach ($results as $column) {
                $columns[] = [
                    'name' => $column->column_name,
                    'type' => $this->normalizeColumnType($column->data_type),
                    'nullable' => $column->is_nullable === 'YES',
                    'default' => $column->column_default,
                ];
            }
        }

        return $columns;
    }

    protected function normalizeColumnType(string $type): string
    {
        $type = strtolower($type);

        $typeMap = [
            'varchar' => 'string',
            'char' => 'string',
            'text' => 'text',
            'mediumtext' => 'text',
            'longtext' => 'text',
            'int' => 'integer',
            'integer' => 'integer',
            'bigint' => 'bigint',
            'smallint' => 'smallint',
            'tinyint' => 'boolean',
            'float' => 'float',
            'double' => 'double',
            'decimal' => 'decimal',
            'numeric' => 'decimal',
            'boolean' => 'boolean',
            'bool' => 'boolean',
            'date' => 'date',
            'datetime' => 'datetime',
            'timestamp' => 'timestamp',
            'time' => 'time',
            'json' => 'json',
            'jsonb' => 'json',
            'enum' => 'enum',
        ];

        return $typeMap[$type] ?? 'string';
    }

    protected function createModel(string $modelName, string $tableName, array $columns): void
    {
        $modelPath = app_path("Models/{$modelName}.php");

        if (File::exists($modelPath)) {
            $this->components->info("Model [{$modelName}] already exists, skipping...");

            return;
        }

        $fillable = collect($columns)
            ->pluck('name')
            ->filter(fn ($name) => ! in_array($name, ['id', 'created_at', 'updated_at', 'deleted_at']))
            ->map(fn ($name) => "        '{$name}'")
            ->implode(",\n");

        $casts = collect($columns)
            ->filter(fn ($col) => in_array($col['type'], ['boolean', 'date', 'datetime', 'timestamp', 'json', 'decimal', 'float', 'double']))
            ->map(function ($col) {
                $castType = match ($col['type']) {
                    'boolean' => 'boolean',
                    'date' => 'date',
                    'datetime', 'timestamp' => 'datetime',
                    'json' => 'array',
                    'decimal', 'float', 'double' => 'decimal:2',
                    default => 'string',
                };

                return "        '{$col['name']}' => '{$castType}'";
            })
            ->implode(",\n");

        // Generate relation methods
        $relationMethods = $this->generateModelRelations();

        $hasSoftDeletes = collect($columns)->contains(fn ($col) => $col['name'] === 'deleted_at');
        $softDeletesUse = $hasSoftDeletes ? "use Illuminate\\Database\\Eloquent\\SoftDeletes;\n" : '';
        $softDeletesTrait = $hasSoftDeletes ? ', SoftDeletes' : '';

        $content = <<<PHP
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
{$softDeletesUse}
class {$modelName} extends Model
{
    use HasFactory{$softDeletesTrait};

    protected \$table = '{$tableName}';

    protected \$fillable = [
{$fillable},
    ];

    protected \$casts = [
{$casts},
    ];
{$relationMethods}
}
PHP;

        File::put($modelPath, $content);
        $this->components->info("Created Model: app/Models/{$modelName}.php");
    }

    /**
     * Generate model relation methods
     */
    protected function generateModelRelations(): string
    {
        if (empty($this->relations)) {
            return '';
        }

        $methods = "\n";

        foreach ($this->relations as $column => $relation) {
            $methodName = Str::camel(Str::beforeLast($column, '_id'));
            $modelClass = $relation['model'];

            $methods .= <<<PHP

    public function {$methodName}(): BelongsTo
    {
        return \$this->belongsTo({$modelClass}::class, '{$column}');
    }
PHP;
        }

        return $methods;
    }

    protected function createResourceFile(string $panel, string $modelName, string $tableName, string $dir, bool $isSimple = false, bool $hasSoftDeletes = false): void
    {
        $icon = $this->getIconForModel($modelName, $tableName);

        // Build imports and method references based on options
        $apiImport = $this->generateApi ? "use App\\Laravilt\\{$panel}\\Resources\\{$modelName}\\Api\\{$modelName}Api;\nuse Laravilt\\Tables\\ApiResource;\n" : '';

        // Soft delete imports
        $softDeleteImport = $hasSoftDeletes ? "use Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\SoftDeletingScope;\n" : '';

        $apiMethod = $this->generateApi ? <<<PHP


    public static function api(ApiResource \$api): ApiResource
    {
        return {$modelName}Api::configure(\$api);
    }
PHP : '';

        // Soft delete method - allows editing/viewing trashed records
        $softDeleteMethod = $hasSoftDeletes ? <<<'PHP'


    /**
     * Get the Eloquent query for retrieving records.
     * This removes the SoftDeletingScope to allow accessing trashed records
     * when the TrashedFilter is active.
     */
    public static function getEloquentQuery(): Builder
    {
        return parent::getEloquentQuery()
            ->withoutGlobalScopes([
                SoftDeletingScope::class,
            ]);
    }
PHP : '';

        // Build page imports based on simple or full resource
        if ($isSimple) {
            $pageImports = "use App\\Laravilt\\{$panel}\\Resources\\{$modelName}\\Pages\\Manage{$modelName};";
            $pagesMethod = <<<PHP
    public static function getPages(): array
    {
        return [
            'index' => Manage{$modelName}::route('/'),
        ];
    }
PHP;
        } else {
            $pageImports = <<<PHP
use App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages\Create{$modelName};
use App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages\Edit{$modelName};
use App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages\List{$modelName};
use App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages\View{$modelName};
PHP;
            $pagesMethod = <<<PHP
    public static function getPages(): array
    {
        return [
            'list' => List{$modelName}::route('/'),
            'create' => Create{$modelName}::route('/create'),
            'edit' => Edit{$modelName}::route('/{record}/edit'),
            'view' => View{$modelName}::route('/{record}'),
        ];
    }
PHP;
        }

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName};

{$apiImport}{$softDeleteImport}use App\Laravilt\\{$panel}\Resources\\{$modelName}\Form\\{$modelName}Form;
use App\Laravilt\\{$panel}\Resources\\{$modelName}\InfoList\\{$modelName}InfoList;
{$pageImports}
use App\Laravilt\\{$panel}\Resources\\{$modelName}\Table\\{$modelName}Table;
use App\Models\\{$modelName};
use Laravilt\Panel\Resources\Resource;
use Laravilt\Schemas\Schema;
use Laravilt\Tables\Table;

class {$modelName}Resource extends Resource
{
    protected static string \$model = {$modelName}::class;

    protected static ?string \$table = '{$tableName}';

    protected static ?string \$navigationIcon = '{$icon}';

    protected static ?string \$navigationGroup = null;

    protected static int \$navigationSort = 1;

    public static function form(Schema \$schema): Schema
    {
        return {$modelName}Form::configure(\$schema);
    }

    public static function table(Table \$table): Table
    {
        return {$modelName}Table::configure(\$table);
    }

    public static function infolist(Schema \$schema): Schema
    {
        return {$modelName}InfoList::configure(\$schema);
    }{$apiMethod}{$softDeleteMethod}

{$pagesMethod}

    public static function getRelations(): array
    {
        return [
            // Add relation managers here
        ];
    }
}
PHP;

        File::put("{$dir}/{$modelName}Resource.php", $content);
    }

    protected function createFormFile(string $panel, string $modelName, array $columns, string $dir): void
    {
        $imports = $this->generateFormImports($columns);
        $sectionsCode = $this->generateFormSections($columns);

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Form;

{$imports}
use Laravilt\Schemas\Components\Grid;
use Laravilt\Schemas\Components\Section;
use Laravilt\Schemas\Schema;

class {$modelName}Form
{
    public static function configure(Schema \$form): Schema
    {
        return \$form
            ->schema([
{$sectionsCode}
            ]);
    }
}
PHP;

        File::put("{$dir}/Form/{$modelName}Form.php", $content);
    }

    /**
     * Generate form sections with grouped fields
     */
    protected function generateFormSections(array $columns): string
    {
        $groupedColumns = $this->groupColumnsBySection($columns);

        if (empty($groupedColumns)) {
            // Fallback: single section with all fields
            $formFields = $this->generateFormFields($columns);

            return <<<PHP
                Section::make('Information')
                    ->icon('info')
                    ->collapsible()
                    ->schema([
                        Grid::make(2)
                            ->columns(2)
                            ->schema([
{$formFields}
                            ]),
                    ]),
PHP;
        }

        $sections = [];
        $sectionIndent = '                ';

        foreach ($groupedColumns as $sectionKey => $sectionColumns) {
            $sectionInfo = $this->sectionGroups[$sectionKey] ?? [
                'title' => Str::title(str_replace('_', ' ', $sectionKey)),
                'icon' => 'info',
            ];

            $fields = [];
            foreach ($sectionColumns as $column) {
                $field = $this->generateFormField($column);
                if ($field) {
                    $fields[] = $field;
                }
            }

            if (empty($fields)) {
                continue;
            }

            $fieldsCode = implode("\n\n", $fields);
            $title = $sectionInfo['title'];
            $icon = $sectionInfo['icon'];

            $sections[] = <<<PHP
{$sectionIndent}Section::make('{$title}')
{$sectionIndent}    ->icon('{$icon}')
{$sectionIndent}    ->collapsible()
{$sectionIndent}    ->schema([
{$sectionIndent}        Grid::make(2)
{$sectionIndent}            ->columns(2)
{$sectionIndent}            ->schema([
{$fieldsCode}
{$sectionIndent}            ]),
{$sectionIndent}    ]),
PHP;
        }

        return implode("\n\n", $sections);
    }

    protected function createTableFile(string $panel, string $modelName, array $columns, string $dir, bool $hasSoftDeletes = false): void
    {
        $tableColumns = $this->generateTableColumns($columns);
        $tableImports = $this->generateTableImports($columns);

        // Soft delete imports
        $softDeleteImports = '';
        $softDeleteFilters = '';
        $softDeleteRecordActions = '';
        $softDeleteBulkActions = '';

        if ($hasSoftDeletes) {
            $softDeleteImports = <<<PHP
use Laravilt\Actions\ForceDeleteAction;
use Laravilt\Actions\ForceDeleteBulkAction;
use Laravilt\Actions\RestoreAction;
use Laravilt\Actions\RestoreBulkAction;
use Laravilt\Tables\Filters\TrashedFilter;
PHP;
            $softDeleteFilters = "\n                TrashedFilter::make(),";
            $softDeleteRecordActions = <<<'PHP'

                ForceDeleteAction::make(),
                RestoreAction::make(),
PHP;
            $softDeleteBulkActions = <<<'PHP'

                    ForceDeleteBulkAction::make(),
                    RestoreBulkAction::make(),
PHP;
        }

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Table;

use Laravilt\Actions\BulkActionGroup;
use Laravilt\Actions\DeleteAction;
use Laravilt\Actions\DeleteBulkAction;
use Laravilt\Actions\EditAction;
use Laravilt\Actions\ViewAction;
{$softDeleteImports}
{$tableImports}
use Laravilt\Tables\Table;

class {$modelName}Table
{
    public static function configure(Table \$table): Table
    {
        return \$table
            ->columns([
{$tableColumns}
            ])
            ->filters([{$softDeleteFilters}
                // Add filters here
            ])
            ->recordActions([
                ViewAction::make(),
                EditAction::make(),
                DeleteAction::make(),{$softDeleteRecordActions}
            ])
            ->toolbarActions([
                BulkActionGroup::make([
                    DeleteBulkAction::make(),{$softDeleteBulkActions}
                ]),
            ])
            ->defaultSort('created_at', 'desc');
    }
}
PHP;

        File::put("{$dir}/Table/{$modelName}Table.php", $content);
    }

    protected function createInfoListFile(string $panel, string $modelName, array $columns, string $dir): void
    {
        $infoEntries = $this->generateInfoEntries($columns);

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\InfoList;

use Laravilt\Infolists\Entries\TextEntry;
use Laravilt\Schemas\Components\Grid;
use Laravilt\Schemas\Components\Section;
use Laravilt\Schemas\Schema;

class {$modelName}InfoList
{
    public static function configure(Schema \$infolist): Schema
    {
        return \$infolist
            ->schema([
                Section::make('Information')
                    ->schema([
                        Grid::make(2)
                            ->columns(2)
                            ->schema([
{$infoEntries}
                            ]),
                    ]),
            ]);
    }
}
PHP;

        File::put("{$dir}/InfoList/{$modelName}InfoList.php", $content);
    }

    protected function createApiFile(string $panel, string $modelName, array $columns, string $dir): void
    {
        $apiColumns = $this->generateApiColumns($columns);

        // Generate method flags
        $methodFlags = [];
        if (! in_array('index', $this->apiMethods)) {
            $methodFlags[] = '->disableIndex()';
        }
        if (! in_array('show', $this->apiMethods)) {
            $methodFlags[] = '->disableShow()';
        }
        if (! in_array('store', $this->apiMethods)) {
            $methodFlags[] = '->disableStore()';
        }
        if (! in_array('update', $this->apiMethods)) {
            $methodFlags[] = '->disableUpdate()';
        }
        if (! in_array('destroy', $this->apiMethods)) {
            $methodFlags[] = '->disableDestroy()';
        }

        // Add API tester option if enabled
        if ($this->useApiTester) {
            $methodFlags[] = '->useAPITester()';
        }

        $methodFlagsStr = ! empty($methodFlags) ? "\n            ".implode("\n            ", $methodFlags) : '';

        $content = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Api;

use Laravilt\Tables\ApiColumn;
use Laravilt\Tables\ApiResource;

class {$modelName}Api
{
    public static function configure(ApiResource \$api): ApiResource
    {
        return \$api
            ->columns([
{$apiColumns}
            ]){$methodFlagsStr};
    }
}
PHP;

        File::put("{$dir}/Api/{$modelName}Api.php", $content);
    }

    protected function createPageFiles(string $panel, string $modelName, string $dir, bool $isSimple = false): void
    {
        if ($isSimple) {
            // ManageRecords Page (single page with modal CRUD)
            $manageContent = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages;

use App\Laravilt\\{$panel}\Resources\\{$modelName}\\{$modelName}Resource;
use Laravilt\Panel\Pages\ManageRecords;

class Manage{$modelName} extends ManageRecords
{
    protected static ?string \$resource = {$modelName}Resource::class;
}
PHP;
            File::put("{$dir}/Pages/Manage{$modelName}.php", $manageContent);

            return;
        }

        // List Page
        $listContent = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages;

use App\Laravilt\\{$panel}\Resources\\{$modelName}\\{$modelName}Resource;
use Laravilt\Actions\CreateAction;
use Laravilt\Panel\Pages\ListRecords;

class List{$modelName} extends ListRecords
{
    protected static ?string \$resource = {$modelName}Resource::class;

    public function getHeaderActions(): array
    {
        return [
            CreateAction::make(),
        ];
    }
}
PHP;
        File::put("{$dir}/Pages/List{$modelName}.php", $listContent);

        // Create Page
        $createContent = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages;

use App\Laravilt\\{$panel}\Resources\\{$modelName}\\{$modelName}Resource;
use Laravilt\Panel\Pages\CreateRecord;

class Create{$modelName} extends CreateRecord
{
    protected static ?string \$resource = {$modelName}Resource::class;
}
PHP;
        File::put("{$dir}/Pages/Create{$modelName}.php", $createContent);

        // Edit Page
        $editContent = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages;

use App\Laravilt\\{$panel}\Resources\\{$modelName}\\{$modelName}Resource;
use Laravilt\Actions\DeleteAction;
use Laravilt\Actions\ViewAction;
use Laravilt\Panel\Pages\EditRecord;

class Edit{$modelName} extends EditRecord
{
    protected static ?string \$resource = {$modelName}Resource::class;

    public function getHeaderActions(): array
    {
        return [
            ViewAction::make(),
            DeleteAction::make(),
        ];
    }
}
PHP;
        File::put("{$dir}/Pages/Edit{$modelName}.php", $editContent);

        // View Page
        $viewContent = <<<PHP
<?php

namespace App\Laravilt\\{$panel}\Resources\\{$modelName}\Pages;

use App\Laravilt\\{$panel}\Resources\\{$modelName}\\{$modelName}Resource;
use Laravilt\Actions\DeleteAction;
use Laravilt\Actions\EditAction;
use Laravilt\Panel\Pages\ViewRecord;

class View{$modelName} extends ViewRecord
{
    protected static ?string \$resource = {$modelName}Resource::class;

    public function getHeaderActions(): array
    {
        return [
            EditAction::make(),
            DeleteAction::make(),
        ];
    }
}
PHP;
        File::put("{$dir}/Pages/View{$modelName}.php", $viewContent);
    }

    protected function generateFormFields(array $columns): string
    {
        $fields = [];

        foreach ($columns as $column) {
            if (in_array($column['name'], $this->excludedColumns)) {
                continue;
            }

            $field = $this->generateFormField($column);
            if ($field) {
                $fields[] = $field;
            }
        }

        return implode("\n\n", $fields);
    }

    /**
     * Detect intelligent field type based on name patterns
     */
    protected function detectFieldType(string $name, string $dbType): string
    {
        // FIRST: Check database type for specific types that should take priority
        // Boolean fields should ALWAYS be Toggle regardless of name
        if ($dbType === 'boolean') {
            return 'Toggle';
        }

        // Also check for boolean-like field names even if DB type is not boolean
        if (str_starts_with($name, 'is_') || str_starts_with($name, 'has_') || str_starts_with($name, 'can_') || str_starts_with($name, 'should_') || str_starts_with($name, 'allow_')) {
            return 'Toggle';
        }

        // Check for common boolean field names
        if (in_array($name, ['active', 'enabled', 'visible', 'featured', 'verified', 'published', 'approved', 'default', 'primary', 'public', 'private', 'locked', 'archived', 'deleted', 'confirmed', 'completed', 'paid', 'refunded', 'shipped', 'delivered', 'read', 'seen', 'processed', 'accepted', 'rejected', 'blocked', 'banned', 'suspended', 'draft', 'hidden', 'starred', 'pinned', 'highlighted'])) {
            return 'Toggle';
        }

        // Check exact matches in fieldPatterns
        if (isset($this->fieldPatterns[$name])) {
            return $this->fieldPatterns[$name];
        }

        // Check partial matches for patterns
        foreach ($this->fieldPatterns as $pattern => $component) {
            if (str_contains($name, $pattern)) {
                return $component;
            }
        }

        // Check for common field patterns
        if (str_contains($name, 'email')) {
            return 'TextInput:email';
        }
        if (str_contains($name, 'url') || str_contains($name, 'website') || str_contains($name, 'link')) {
            return 'TextInput:url';
        }
        if (str_contains($name, 'phone') || str_contains($name, 'tel') || str_contains($name, 'mobile')) {
            return 'TextInput:tel';
        }
        if (str_contains($name, 'password')) {
            return 'TextInput:password';
        }
        if (str_contains($name, 'image') || str_contains($name, 'photo') || str_contains($name, 'avatar') || str_contains($name, 'logo') || str_contains($name, 'thumbnail') || str_contains($name, 'cover') || str_contains($name, 'banner') || str_contains($name, 'picture')) {
            return 'FileUpload:image';
        }
        if (str_contains($name, 'file') || str_contains($name, 'attachment') || str_contains($name, 'document')) {
            return 'FileUpload';
        }
        if (str_contains($name, 'price') || str_contains($name, 'amount') || str_contains($name, 'cost') || str_contains($name, 'total') || str_contains($name, 'spent') || str_contains($name, 'balance') || str_contains($name, 'fee')) {
            return 'TextInput:money';
        }

        // Fall back to database type mapping
        return $this->columnTypeMap[$dbType] ?? 'TextInput';
    }

    /**
     * Get section for a field based on name
     */
    protected function getFieldSection(string $name): string
    {
        foreach ($this->sectionGroups as $sectionKey => $section) {
            foreach ($section['fields'] as $field) {
                if ($name === $field || str_contains($name, $field)) {
                    return $sectionKey;
                }
            }
        }

        return 'basic'; // default section
    }

    /**
     * Group columns by section
     */
    protected function groupColumnsBySection(array $columns): array
    {
        $sections = [];

        foreach ($columns as $column) {
            if (in_array($column['name'], $this->excludedColumns)) {
                continue;
            }

            $sectionKey = $this->getFieldSection($column['name']);
            if (! isset($sections[$sectionKey])) {
                $sections[$sectionKey] = [];
            }
            $sections[$sectionKey][] = $column;
        }

        // Sort sections by priority
        $priority = ['basic', 'content', 'media', 'location', 'status', 'pricing', 'dates', 'settings', 'code', 'appearance', 'social', 'seo', 'flags'];
        $sortedSections = [];
        foreach ($priority as $key) {
            if (isset($sections[$key]) && ! empty($sections[$key])) {
                $sortedSections[$key] = $sections[$key];
            }
        }

        return $sortedSections;
    }

    protected function generateFormField(array $column): ?string
    {
        $name = $column['name'];
        $type = $column['type'];
        $nullable = $column['nullable'];
        $indent = '                                ';

        // Check if this is a relation field
        if (isset($this->relations[$name])) {
            $relation = $this->relations[$name];
            $relationMethod = Str::camel(Str::beforeLast($name, '_id'));
            $titleColumn = $relation['title_column'];
            $required = ! $nullable ? "\n{$indent}    ->required()" : '';

            return "{$indent}Select::make('{$name}')\n{$indent}    ->relationship('{$relationMethod}', '{$titleColumn}')\n{$indent}    ->searchable()\n{$indent}    ->preload(){$required},";
        }

        // Detect intelligent field type
        $fieldType = $this->detectFieldType($name, $type);
        $required = ! $nullable ? "\n{$indent}    ->required()" : '';

        // Handle field type with modifiers (e.g., TextInput:email)
        $parts = explode(':', $fieldType);
        $component = $parts[0];
        $modifier = $parts[1] ?? null;

        switch ($component) {
            case 'Select':
                // Check for common status/type fields with predefined options
                if ($name === 'status') {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        'active' => 'Active',\n{$indent}        'inactive' => 'Inactive',\n{$indent}        'pending' => 'Pending',\n{$indent}    ])\n{$indent}    ->default('active'),";
                } elseif ($name === 'gender') {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        'male' => 'Male',\n{$indent}        'female' => 'Female',\n{$indent}        'other' => 'Other',\n{$indent}    ]),";
                } elseif ($name === 'priority') {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        'low' => 'Low',\n{$indent}        'medium' => 'Medium',\n{$indent}        'high' => 'High',\n{$indent}        'urgent' => 'Urgent',\n{$indent}    ])\n{$indent}    ->default('medium'),";
                } elseif ($name === 'visibility') {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        'public' => 'Public',\n{$indent}        'private' => 'Private',\n{$indent}        'draft' => 'Draft',\n{$indent}    ])\n{$indent}    ->default('public'),";
                } elseif (in_array($name, ['country', 'country_id'])) {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        // Load countries from your data source\n{$indent}    ])\n{$indent}    ->searchable()\n{$indent}    ->live(),";
                } elseif (in_array($name, ['state', 'state_id', 'province'])) {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options(fn (Get \$get) => \n{$indent}        // Load states based on selected country\n{$indent}        []\n{$indent}    )\n{$indent}    ->searchable()\n{$indent}    ->live(),";
                } elseif (in_array($name, ['city', 'city_id'])) {
                    return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options(fn (Get \$get) => \n{$indent}        // Load cities based on selected state\n{$indent}        []\n{$indent}    )\n{$indent}    ->searchable(),";
                }

                return "{$indent}Select::make('{$name}'){$required}\n{$indent}    ->options([\n{$indent}        // Add options here\n{$indent}    ]),";

            case 'TagsInput':
                return "{$indent}TagsInput::make('{$name}')\n{$indent}    ->separator(',')\n{$indent}    ->splitKeys(['Tab', ',']){$required},";

            case 'CodeEditor':
                $language = $this->guessCodeLanguage($name);

                return "{$indent}CodeEditor::make('{$name}')\n{$indent}    ->language('{$language}')\n{$indent}    ->columnSpanFull(){$required},";

            case 'RichEditor':
                return "{$indent}RichEditor::make('{$name}'){$required}\n{$indent}    ->columnSpanFull(),";

            case 'Textarea':
                return "{$indent}Textarea::make('{$name}'){$required}\n{$indent}    ->rows(3)\n{$indent}    ->columnSpanFull(),";

            case 'ColorPicker':
                return "{$indent}ColorPicker::make('{$name}'){$required},";

            case 'IconPicker':
                return "{$indent}IconPicker::make('{$name}'){$required}\n{$indent}    ->searchable(),";

            case 'KeyValue':
                return "{$indent}KeyValue::make('{$name}')\n{$indent}    ->keyLabel('Key')\n{$indent}    ->valueLabel('Value')\n{$indent}    ->columnSpanFull(){$required},";

            case 'FileUpload':
                if ($modifier === 'image') {
                    return "{$indent}FileUpload::make('{$name}')\n{$indent}    ->image()\n{$indent}    ->directory('{$name}s'){$required},";
                }

                return "{$indent}FileUpload::make('{$name}')\n{$indent}    ->directory('{$name}s'){$required},";

            case 'TextInput':
                $extra = '';
                if ($modifier === 'email') {
                    $extra = "\n{$indent}    ->email()";
                } elseif ($modifier === 'url') {
                    $extra = "\n{$indent}    ->url()";
                } elseif ($modifier === 'tel') {
                    $extra = "\n{$indent}    ->tel()";
                } elseif ($modifier === 'password') {
                    $extra = "\n{$indent}    ->password()\n{$indent}    ->revealable()";
                } elseif ($modifier === 'money') {
                    $extra = "\n{$indent}    ->numeric()\n{$indent}    ->prefix('\$')";
                } elseif (in_array($type, ['integer', 'bigint', 'smallint', 'float', 'double', 'decimal'])) {
                    $extra = "\n{$indent}    ->numeric()";
                }

                return "{$indent}TextInput::make('{$name}'){$extra}{$required}\n{$indent}    ->maxLength(255),";

            case 'Toggle':
                $default = str_contains($name, 'active') || str_contains($name, 'enabled') || str_contains($name, 'verified') || str_contains($name, 'published') || str_contains($name, 'approved') ? 'true' : 'false';

                return "{$indent}Toggle::make('{$name}')\n{$indent}    ->default({$default}),";

            case 'DatePicker':
                return "{$indent}DatePicker::make('{$name}'){$required},";

            case 'DateTimePicker':
                return "{$indent}DateTimePicker::make('{$name}'){$required},";

            case 'TimePicker':
                return "{$indent}TimePicker::make('{$name}'){$required},";

            default:
                return "{$indent}TextInput::make('{$name}'){$required}\n{$indent}    ->maxLength(255),";
        }
    }

    /**
     * Guess the code language based on field name
     */
    protected function guessCodeLanguage(string $name): string
    {
        if (str_contains($name, 'html')) {
            return 'html';
        }
        if (str_contains($name, 'css') || str_contains($name, 'style')) {
            return 'css';
        }
        if (str_contains($name, 'javascript') || str_contains($name, 'js') || str_contains($name, 'script')) {
            return 'javascript';
        }
        if (str_contains($name, 'json')) {
            return 'json';
        }
        if (str_contains($name, 'php')) {
            return 'php';
        }
        if (str_contains($name, 'sql')) {
            return 'sql';
        }
        if (str_contains($name, 'xml')) {
            return 'xml';
        }
        if (str_contains($name, 'yaml') || str_contains($name, 'yml')) {
            return 'yaml';
        }
        if (str_contains($name, 'markdown') || str_contains($name, 'md')) {
            return 'markdown';
        }

        return 'plaintext';
    }

    protected function generateFormImports(array $columns): string
    {
        $imports = ['use Laravilt\Forms\Components\TextInput;'];

        $types = collect($columns)->pluck('type')->unique()->toArray();
        $names = collect($columns)
            ->pluck('name')
            ->filter(fn ($n) => ! in_array($n, $this->excludedColumns))
            ->toArray();

        // Check for relations (need Select)
        if (! empty($this->relations)) {
            $imports[] = 'use Laravilt\Forms\Components\Select;';
        }

        // Check each field for its detected type
        foreach ($columns as $column) {
            if (in_array($column['name'], $this->excludedColumns)) {
                continue;
            }

            $fieldType = $this->detectFieldType($column['name'], $column['type']);
            $component = explode(':', $fieldType)[0];

            switch ($component) {
                case 'Select':
                    $imports[] = 'use Laravilt\Forms\Components\Select;';
                    // Add Get import for dependent selects
                    if (in_array($column['name'], ['state', 'state_id', 'province', 'city', 'city_id'])) {
                        $imports[] = 'use Laravilt\Support\Utilities\Get;';
                    }
                    break;
                case 'TagsInput':
                    $imports[] = 'use Laravilt\Forms\Components\TagsInput;';
                    break;
                case 'CodeEditor':
                    $imports[] = 'use Laravilt\Forms\Components\CodeEditor;';
                    break;
                case 'RichEditor':
                    $imports[] = 'use Laravilt\Forms\Components\RichEditor;';
                    break;
                case 'Textarea':
                    $imports[] = 'use Laravilt\Forms\Components\Textarea;';
                    break;
                case 'ColorPicker':
                    $imports[] = 'use Laravilt\Forms\Components\ColorPicker;';
                    break;
                case 'IconPicker':
                    $imports[] = 'use Laravilt\Forms\Components\IconPicker;';
                    break;
                case 'KeyValue':
                    $imports[] = 'use Laravilt\Forms\Components\KeyValue;';
                    break;
                case 'FileUpload':
                    $imports[] = 'use Laravilt\Forms\Components\FileUpload;';
                    break;
                case 'Toggle':
                    $imports[] = 'use Laravilt\Forms\Components\Toggle;';
                    break;
                case 'DatePicker':
                    $imports[] = 'use Laravilt\Forms\Components\DatePicker;';
                    break;
                case 'DateTimePicker':
                    $imports[] = 'use Laravilt\Forms\Components\DateTimePicker;';
                    break;
                case 'TimePicker':
                    $imports[] = 'use Laravilt\Forms\Components\TimePicker;';
                    break;
            }
        }

        // Handle boolean type from database
        if (in_array('boolean', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\Toggle;';
        }

        // Handle json type from database
        if (in_array('json', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\KeyValue;';
        }

        // Handle date types from database
        if (in_array('date', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\DatePicker;';
        }
        if (in_array('datetime', $types) || in_array('timestamp', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\DateTimePicker;';
        }
        if (in_array('time', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\TimePicker;';
        }

        // Handle text type from database
        if (in_array('text', $types)) {
            $imports[] = 'use Laravilt\Forms\Components\Textarea;';
        }

        sort($imports);

        return implode("\n", array_unique($imports));
    }

    protected function generateTableColumns(array $columns): string
    {
        $tableColumns = [];
        $indent = '                ';

        foreach ($columns as $column) {
            $name = $column['name'];
            $type = $column['type'];

            if ($name === 'deleted_at') {
                continue;
            }

            $extra = '';
            $hidden = '';
            $columnType = 'TextColumn';

            // Add sortable to most columns
            $sortable = '->sortable()';

            // Add searchable to text columns
            $searchable = in_array($name, ['name', 'email', 'title', 'description', 'subject']) ? '->searchable()' : '';

            // Check if this is a relation field
            if (isset($this->relations[$name])) {
                $relation = $this->relations[$name];
                $relationMethod = Str::camel(Str::beforeLast($name, '_id'));
                $titleColumn = $relation['title_column'];
                $tableColumns[] = "{$indent}TextColumn::make('{$relationMethod}.{$titleColumn}')\n{$indent}    ->label('".Str::title(str_replace('_', ' ', Str::beforeLast($name, '_id')))."'){$sortable},";

                continue;
            }

            // Handle image columns
            if (str_contains($name, 'image') || str_contains($name, 'photo') || str_contains($name, 'avatar') || str_contains($name, 'logo') || str_contains($name, 'thumbnail') || str_contains($name, 'cover') || str_contains($name, 'banner') || str_contains($name, 'picture')) {
                $tableColumns[] = "{$indent}ImageColumn::make('{$name}')\n{$indent}    ->circular(),";

                continue;
            }

            // Handle tags columns (array/json fields displayed as badges)
            if (in_array($name, ['tags', 'keywords', 'skills', 'labels', 'categories'])) {
                $tableColumns[] = "{$indent}TextColumn::make('{$name}')\n{$indent}    ->badge(),";

                continue;
            }

            // Handle boolean columns (is_*, has_*, can_*, etc.) - use ToggleColumn
            if ($type === 'boolean' || str_starts_with($name, 'is_') || str_starts_with($name, 'has_') || str_starts_with($name, 'can_') || in_array($name, ['active', 'enabled', 'visible', 'featured', 'verified', 'published', 'approved'])) {
                $tableColumns[] = "{$indent}ToggleColumn::make('{$name}'),";

                continue;
            }

            // Handle special column types
            if (in_array($name, ['status'])) {
                $extra = "\n{$indent}    ->badge()\n{$indent}    ->color(fn (string \$state): string => match (\$state) {\n{$indent}        'active' => 'success',\n{$indent}        'inactive' => 'danger',\n{$indent}        'pending' => 'warning',\n{$indent}        default => 'secondary',\n{$indent}    })";
            } elseif (in_array($name, ['type', 'role'])) {
                $extra = "\n{$indent}    ->badge()";
            } elseif (in_array($type, ['datetime', 'timestamp'])) {
                $extra = "\n{$indent}    ->dateTime()";
            } elseif ($type === 'date') {
                $extra = "\n{$indent}    ->date()";
            } elseif (in_array($type, ['decimal', 'float', 'double']) && (str_contains($name, 'price') || str_contains($name, 'amount') || str_contains($name, 'total') || str_contains($name, 'spent') || str_contains($name, 'cost'))) {
                $extra = "\n{$indent}    ->money('USD')";
            } elseif (str_contains($name, 'color') || str_contains($name, 'colour')) {
                $columnType = 'ColorColumn';
                $sortable = '';
            }

            // Hide some columns by default
            if (in_array($name, ['created_at', 'updated_at', 'id'])) {
                $hidden = "\n{$indent}    ->toggleable(isToggledHiddenByDefault: true)";
            }

            $tableColumns[] = "{$indent}{$columnType}::make('{$name}'){$searchable}{$sortable}{$extra}{$hidden},";
        }

        return implode("\n\n", $tableColumns);
    }

    protected function generateTableImports(array $columns): string
    {
        $imports = ['use Laravilt\Tables\Columns\TextColumn;'];

        $names = collect($columns)->pluck('name')->toArray();
        $types = collect($columns)->pluck('type')->toArray();

        // Check for image columns
        if (collect($names)->contains(fn ($n) => str_contains($n, 'image') || str_contains($n, 'photo') || str_contains($n, 'avatar') || str_contains($n, 'logo') || str_contains($n, 'thumbnail') || str_contains($n, 'cover') || str_contains($n, 'banner') || str_contains($n, 'picture'))) {
            $imports[] = 'use Laravilt\Tables\Columns\ImageColumn;';
        }

        // Check for boolean columns (by type or name pattern)
        $hasBooleanColumns = in_array('boolean', $types) ||
            collect($names)->contains(fn ($n) => str_starts_with($n, 'is_') ||
                str_starts_with($n, 'has_') ||
                str_starts_with($n, 'can_') ||
                in_array($n, ['active', 'enabled', 'visible', 'featured', 'verified', 'published', 'approved'])
            );
        if ($hasBooleanColumns) {
            $imports[] = 'use Laravilt\Tables\Columns\ToggleColumn;';
        }

        // Check for color columns
        if (collect($names)->contains(fn ($n) => str_contains($n, 'color') || str_contains($n, 'colour'))) {
            $imports[] = 'use Laravilt\Tables\Columns\ColorColumn;';
        }

        sort($imports);

        return implode("\n", array_unique($imports));
    }

    protected function generateInfoEntries(array $columns): string
    {
        $entries = [];
        $indent = '                                ';

        foreach ($columns as $column) {
            $name = $column['name'];
            $type = $column['type'];

            if (in_array($name, ['id', 'deleted_at', 'password', 'remember_token'])) {
                continue;
            }

            $extra = '';

            // Check if this is a relation field
            if (isset($this->relations[$name])) {
                $relation = $this->relations[$name];
                $relationMethod = Str::camel(Str::beforeLast($name, '_id'));
                $titleColumn = $relation['title_column'];
                $entries[] = "{$indent}TextEntry::make('{$relationMethod}.{$titleColumn}')\n{$indent}    ->label('".Str::title(str_replace('_', ' ', Str::beforeLast($name, '_id')))."'),";

                continue;
            }

            if (in_array($name, ['status', 'type', 'role'])) {
                $extra = "\n{$indent}    ->badge()";
            } elseif (in_array($type, ['datetime', 'timestamp'])) {
                $extra = "\n{$indent}    ->dateTime()";
            } elseif ($type === 'date') {
                $extra = "\n{$indent}    ->date()";
            } elseif (in_array($type, ['decimal', 'float', 'double']) && (str_contains($name, 'price') || str_contains($name, 'amount') || str_contains($name, 'total') || str_contains($name, 'spent') || str_contains($name, 'cost'))) {
                $extra = "\n{$indent}    ->money('USD')";
            }

            $entries[] = "{$indent}TextEntry::make('{$name}'){$extra},";
        }

        return implode("\n\n", $entries);
    }

    protected function generateApiColumns(array $columns): string
    {
        $apiColumns = [];
        $indent = '                ';

        // Fields that should be searchable
        $searchableFields = ['name', 'email', 'title', 'description', 'subject', 'company'];
        // Fields that should be sortable
        $sortableFields = ['id', 'name', 'email', 'created_at', 'updated_at', 'title'];
        // Fields that should be filterable
        $filterableFields = ['status', 'type', 'category', 'is_active', 'is_verified'];

        foreach ($columns as $column) {
            $name = $column['name'];
            $type = $column['type'] ?? 'string';

            if (in_array($name, ['password', 'remember_token', 'two_factor_secret', 'two_factor_recovery_codes'])) {
                continue;
            }

            $methods = [];

            // Add type for non-string columns
            $apiType = match ($type) {
                'integer', 'bigint', 'smallint', 'tinyint' => 'integer',
                'decimal', 'float', 'double' => 'decimal',
                'boolean' => 'boolean',
                'date' => 'date',
                'datetime', 'timestamp' => 'datetime',
                'time' => 'time',
                'json', 'array' => 'array',
                'object' => 'object',
                default => null,
            };

            if ($apiType) {
                $methods[] = "->type('{$apiType}')";
            }

            // Add searchable
            if (in_array($name, $searchableFields)) {
                $methods[] = '->searchable()';
            }

            // Add sortable
            if (in_array($name, $sortableFields)) {
                $methods[] = '->sortable()';
            }

            // Add filterable
            if (in_array($name, $filterableFields)) {
                $methods[] = '->filterable()';
            }

            $methodsStr = implode('', $methods);
            $apiColumns[] = "{$indent}ApiColumn::make('{$name}'){$methodsStr},";
        }

        return implode("\n", $apiColumns);
    }

    protected function findTitleField(array $columns): string
    {
        $titleCandidates = ['name', 'title', 'label', 'subject', 'heading'];

        foreach ($titleCandidates as $candidate) {
            if (collect($columns)->contains(fn ($col) => $col['name'] === $candidate)) {
                return $candidate;
            }
        }

        // Return first string column
        foreach ($columns as $column) {
            if ($column['type'] === 'string' && ! in_array($column['name'], $this->excludedColumns)) {
                return $column['name'];
            }
        }

        return 'id';
    }

    protected function findDescriptionField(array $columns): string
    {
        $descCandidates = ['email', 'description', 'subtitle', 'summary', 'excerpt'];

        foreach ($descCandidates as $candidate) {
            if (collect($columns)->contains(fn ($col) => $col['name'] === $candidate)) {
                return $candidate;
            }
        }

        // Return second string column or created_at
        $stringColumns = collect($columns)->filter(fn ($col) => $col['type'] === 'string' && ! in_array($col['name'], $this->excludedColumns))->values();

        if ($stringColumns->count() > 1) {
            return $stringColumns[1]['name'];
        }

        return 'created_at';
    }

    protected function findImageField(array $columns): ?string
    {
        $imageCandidates = ['image', 'photo', 'avatar', 'thumbnail', 'logo', 'picture', 'cover'];

        foreach ($columns as $column) {
            foreach ($imageCandidates as $candidate) {
                if (str_contains($column['name'], $candidate)) {
                    return $column['name'];
                }
            }
        }

        return null;
    }
}
</file>

<file path="src/Concerns/HasBreadcrumbs.php">
<?php

namespace Laravilt\Panel\Concerns;

trait HasBreadcrumbs
{
    /**
     * Get the page breadcrumbs.
     */
    public function getBreadcrumbs(): array
    {
        $breadcrumbs = [];

        // Add home/dashboard
        $breadcrumbs[] = [
            'label' => __('laravilt-panel::panel.navigation.dashboard'),
            'url' => $this->getPanel()->url(),
        ];

        // Add cluster if this page belongs to one
        if (method_exists(static::class, 'getCluster') && ($clusterClass = static::getCluster())) {
            if (class_exists($clusterClass)) {
                $clusterLabel = method_exists($clusterClass, 'getNavigationLabel')
                    ? $clusterClass::getNavigationLabel()
                    : (method_exists($clusterClass, 'getClusterTitle')
                        ? $clusterClass::getClusterTitle()
                        : class_basename($clusterClass));

                $clusterUrl = method_exists($clusterClass, 'getUrl')
                    ? $clusterClass::getUrl()
                    : null;

                $breadcrumbs[] = [
                    'label' => $clusterLabel,
                    'url' => $clusterUrl,
                ];
            }
        }
        // Add navigation group if exists (and no cluster)
        elseif ($group = static::getNavigationGroup()) {
            $breadcrumbs[] = [
                'label' => $group,
                'url' => null,
            ];
        }

        // Add resource list page if this is a resource page (Create, Edit, View)
        if (method_exists(static::class, 'getResource')) {
            $resource = static::getResource();
            if ($resource) {
                // Only add the list page breadcrumb if we're NOT on the list page itself
                if (! ($this instanceof \Laravilt\Panel\Pages\ListRecords)) {
                    $breadcrumbs[] = [
                        'label' => $resource::getPluralLabel() ?? $resource::getLabel(),
                        'url' => $resource::getUrl('list'),
                    ];
                }
            }
        }

        // Add current page
        $breadcrumbs[] = [
            'label' => static::getTitle(),
            'url' => null,
        ];

        return $breadcrumbs;
    }
}
</file>

<file path="src/Concerns/HasResources.php">
<?php

namespace Laravilt\Panel\Concerns;

use Illuminate\Support\Facades\File;
use ReflectionClass;
use Symfony\Component\Finder\SplFileInfo;

trait HasResources
{
    protected array $resources = [];

    protected array $resourceDirectories = [];

    /**
     * Register resources.
     */
    public function resources(array $resources): static
    {
        $this->resources = array_merge($this->resources, $resources);

        return $this;
    }

    /**
     * Get registered resources.
     */
    public function getResources(): array
    {
        return $this->resources;
    }

    /**
     * Discover resources in a directory.
     */
    public function discoverResources(string $in, string $for): static
    {
        $this->resourceDirectories[] = [
            'directory' => $in,
            'namespace' => $for,
        ];

        return $this;
    }

    /**
     * Boot resources - discover and register.
     */
    protected function bootResources(): void
    {
        foreach ($this->resourceDirectories as $config) {
            if (! is_dir($config['directory'])) {
                continue;
            }

            $resources = collect(File::allFiles($config['directory']))
                ->filter(fn (SplFileInfo $file) => $file->getExtension() === 'php')
                ->filter(function (SplFileInfo $file) {
                    // Exclude files in configuration subdirectories (Pages, Form, Table, Grid, InfoList, Api, Flutter, RelationManagers)
                    $excludedDirs = ['Pages', 'Form', 'Table', 'Grid', 'InfoList', 'Api', 'Flutter', 'RelationManagers'];
                    foreach ($excludedDirs as $dir) {
                        if (str_contains($file->getRelativePath(), $dir)) {
                            return false;
                        }
                    }

                    return true;
                })
                ->map(function (SplFileInfo $file) use ($config) {
                    $class = $config['namespace'].'\\'.
                        str_replace(
                            ['/', '.php'],
                            ['\\', ''],
                            $file->getRelativePathname()
                        );

                    if (! class_exists($class)) {
                        return;
                    }

                    $reflection = new ReflectionClass($class);

                    if ($reflection->isAbstract() || $reflection->isInterface()) {
                        return;
                    }

                    return $class;
                })
                ->filter()
                ->all();

            $this->resources = array_unique(array_merge($this->resources, $resources));
        }
    }
}
</file>

<file path="src/Http/Middleware/Authenticate.php">
<?php

namespace Laravilt\Panel\Http\Middleware;

use Illuminate\Auth\Middleware\Authenticate as Middleware;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use Laravilt\Panel\PanelRegistry;

class Authenticate extends Middleware
{
    /**
     * Get the path the user should be redirected to when they are not authenticated.
     */
    protected function redirectTo(Request $request): ?string
    {
        if (! $request->expectsJson()) {
            // Try to get the current panel from the registry first
            $panel = \Laravilt\Panel\Facades\Panel::getCurrent();

            // If no panel in registry, try to detect from URL path
            if (! $panel) {
                $panel = $this->detectPanelFromRequest($request);
            }

            if ($panel && $panel->hasLogin()) {
                return $panel->loginUrl();
            }

            // Fallback to default login route if it exists
            if (Route::has('login')) {
                return route('login');
            }

            // Last resort fallback
            return '/login';
        }

        return null;
    }

    /**
     * Try to detect the panel from the request URL path.
     */
    protected function detectPanelFromRequest(Request $request): ?\Laravilt\Panel\Panel
    {
        $registry = app(PanelRegistry::class);
        $path = trim($request->path(), '/');
        $segments = explode('/', $path);

        if (empty($segments[0])) {
            return null;
        }

        // Check if the first segment matches a panel path
        foreach ($registry->all() as $panel) {
            $panelPath = trim($panel->getPath(), '/');
            if ($panelPath === $segments[0]) {
                // Set as current panel
                $registry->setCurrent($panel->getId());

                return $panel;
            }
        }

        return null;
    }
}
</file>

<file path="src/Navigation/NavigationItem.php">
<?php

namespace Laravilt\Panel\Navigation;

use Closure;
use Illuminate\Contracts\Support\Arrayable;

class NavigationItem implements Arrayable
{
    protected string|Closure $label;

    protected string|Closure|null $url = null;

    protected string|Closure|null $icon = null;

    protected string|int|Closure|null $badge = null;

    protected string|Closure|null $badgeColor = null;

    protected int|Closure $sort = 0;

    protected bool|Closure $active = false;

    protected string|Closure|null $method = null;

    protected ?string $translationKey = null;

    /**
     * Make a new navigation item.
     */
    public static function make(string|Closure $label): static
    {
        $item = new static;
        $item->label = $label;

        return $item;
    }

    /**
     * Set the item URL.
     */
    public function url(string|Closure|null $url): static
    {
        $this->url = $url;

        return $this;
    }

    /**
     * Get the item URL.
     */
    public function getUrl(): ?string
    {
        return $this->evaluate($this->url);
    }

    /**
     * Set the item icon.
     */
    public function icon(string|Closure|null $icon): static
    {
        $this->icon = $icon;

        return $this;
    }

    /**
     * Get the item icon.
     */
    public function getIcon(): ?string
    {
        return $this->evaluate($this->icon);
    }

    /**
     * Set the item badge.
     */
    public function badge(string|int|Closure|null $badge, string|Closure|null $color = null): static
    {
        $this->badge = $badge;
        $this->badgeColor = $color;

        return $this;
    }

    /**
     * Get the item badge.
     */
    public function getBadge(): ?string
    {
        $value = $this->evaluate($this->badge);

        return $value !== null ? (string) $value : null;
    }

    /**
     * Get the badge color.
     */
    public function getBadgeColor(): string
    {
        return $this->evaluate($this->badgeColor) ?? 'primary';
    }

    /**
     * Set the sort order.
     */
    public function sort(int|Closure $sort): static
    {
        $this->sort = $sort;

        return $this;
    }

    /**
     * Get the sort order.
     */
    public function getSort(): int
    {
        return $this->evaluate($this->sort);
    }

    /**
     * Mark as active.
     */
    public function active(bool|Closure $condition = true): static
    {
        $this->active = $condition;

        return $this;
    }

    /**
     * Check if active.
     */
    public function isActive(): bool
    {
        if ($this->evaluate($this->active)) {
            return true;
        }

        // Auto-detect active state from URL
        $url = $this->getUrl();

        if (! $url) {
            return false;
        }

        // Check if request helper is available (won't be in unit tests)
        try {
            if (! function_exists('request')) {
                return false;
            }

            $request = request();

            if (! $request) {
                return false;
            }

            return $request->is(trim($url, '/').'*');
        } catch (\Exception $e) {
            return false;
        }
    }

    /**
     * Get the item label.
     */
    public function getLabel(): string
    {
        return $this->evaluate($this->label);
    }

    /**
     * Set the HTTP method.
     */
    public function method(string|Closure|null $method): static
    {
        $this->method = $method;

        return $this;
    }

    /**
     * Get the HTTP method.
     */
    public function getMethod(): ?string
    {
        return $this->evaluate($this->method);
    }

    /**
     * Set translation key for frontend translation.
     */
    public function translationKey(string $key): static
    {
        $this->translationKey = $key;

        return $this;
    }

    /**
     * Get translation key.
     */
    public function getTranslationKey(): ?string
    {
        return $this->translationKey;
    }

    /**
     * Convert to array.
     */
    public function toArray(): array
    {
        return [
            'type' => 'item',
            'title' => $this->getLabel(),  // Frontend expects 'title'
            'translationKey' => $this->translationKey,  // Send translation key to frontend
            'url' => $this->getUrl(),      // Frontend expects 'url'
            'icon' => $this->getIcon(),
            'badge' => $this->getBadge(),
            'badgeColor' => $this->getBadgeColor(),
            'sort' => $this->getSort(),
            'active' => $this->isActive(),
            'method' => $this->getMethod(),
        ];
    }

    /**
     * Evaluate a closure or return the value.
     */
    protected function evaluate(mixed $value): mixed
    {
        if ($value instanceof Closure) {
            return $value();
        }

        return $value;
    }
}
</file>

<file path="src/Pages/CreateRecord.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Pages;

use Illuminate\Database\Eloquent\Model;
use Laravilt\Schemas\Schema;

abstract class CreateRecord extends Page
{
    /**
     * @var array<string, mixed>
     */
    protected array $data = [];

    /**
     * Get the page title using the resource's label with "Create" prefix.
     */
    public static function getTitle(): string
    {
        $resource = static::getResource();

        if ($resource) {
            return __('laravilt-panel::panel.pages.create_record.title', [
                'label' => $resource::getLabel(),
            ]);
        }

        return parent::getTitle();
    }

    /**
     * Get the page heading using the resource's label with "Create" prefix.
     */
    public function getHeading(): string
    {
        return static::getTitle();
    }

    public function form(Schema $schema): Schema
    {
        $resource = static::getResource();

        return $resource::form($schema);
    }

    /**
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    public function mutateFormDataBeforeCreate(array $data): array
    {
        return $data;
    }

    protected function afterCreate(): void
    {
        //
    }

    protected function getRedirectUrl(): ?string
    {
        $resource = static::getResource();

        return $resource::getUrl('list');
    }

    public function createRecord(array $data): Model
    {
        $resource = static::getResource();
        $model = $resource::getModel();

        $data = $this->mutateFormDataBeforeCreate($data);

        // Extract relationship data for many-to-many relationships
        $relationships = $this->extractRelationshipData($data);

        $record = $model::create($data);

        // Sync many-to-many relationships
        $this->syncRelationships($record, $relationships);

        $this->afterCreate();

        return $record;
    }

    /**
     * Extract many-to-many relationship data from form data.
     *
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    protected function extractRelationshipData(array &$data): array
    {
        $model = static::getResource()::getModel();
        $modelInstance = new $model;
        $relationships = [];

        foreach ($data as $key => $value) {
            // Check if this key corresponds to a relationship method
            if (method_exists($modelInstance, $key)) {
                try {
                    $relation = $modelInstance->{$key}();

                    // Check if it's a BelongsToMany relationship
                    if ($relation instanceof \Illuminate\Database\Eloquent\Relations\BelongsToMany) {
                        $relationships[$key] = $value;
                        unset($data[$key]);
                    }
                } catch (\Throwable $e) {
                    // Not a relationship method, skip
                    continue;
                }
            }
        }

        return $relationships;
    }

    /**
     * Sync many-to-many relationships.
     *
     * @param  array<string, mixed>  $relationships
     */
    protected function syncRelationships(Model $record, array $relationships): void
    {
        foreach ($relationships as $relationName => $relationData) {
            if ($relationData !== null) {
                $record->{$relationName}()->sync($relationData);
            }
        }
    }

    /**
     * Validate form data using schema validation rules.
     *
     * @param  array<string, mixed>  $data
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    protected function validateFormData(array $data): array
    {
        $form = $this->form(new \Laravilt\Schemas\Schema);

        $rules = $form->getValidationRules();
        $messages = $form->getValidationMessages();
        $attributes = $form->getValidationAttributes();
        $prefixes = $form->getFieldPrefixes();

        // Only validate if there are rules
        if (empty($rules)) {
            return $data;
        }

        // Prepend prefixes to field values for validation (e.g., https:// for URL fields)
        $dataForValidation = $data;
        foreach ($prefixes as $fieldName => $prefix) {
            if (isset($dataForValidation[$fieldName]) && is_string($dataForValidation[$fieldName]) && $dataForValidation[$fieldName] !== '') {
                // Only prepend if value doesn't already start with the prefix
                if (! str_starts_with($dataForValidation[$fieldName], $prefix)) {
                    $dataForValidation[$fieldName] = $prefix.$dataForValidation[$fieldName];
                }
            }
        }

        // Validate with prefixed data
        validator($dataForValidation, $rules, $messages, $attributes)->validate();

        // Return original data (without prefixes) - the storage should save the user-entered value
        return $data;
    }

    /**
     * Get the schema (form) for this page.
     */
    public function getSchema(): array
    {
        $form = $this->form(new \Laravilt\Schemas\Schema);

        $resource = static::getResource();

        // Get the form schema
        $schema = $form->getSchema();

        // Add actions to the bottom of the form (as standalone actions, not component-based)
        $actions = [
            \Laravilt\Actions\Action::make('create')
                ->label(__('laravilt-panel::panel.common.create'))
                ->color('primary')
                ->submit()
                ->preserveState(false)
                ->action(function (mixed $record, array $data) {
                    // Validate form data
                    $validated = $this->validateFormData($data);

                    $newRecord = $this->createRecord($validated);
                    $redirectUrl = $this->getRedirectUrl();

                    \Laravilt\Notifications\Notification::success()
                        ->title(__('notifications::notifications.success'))
                        ->body(__('notifications::notifications.record_created'))
                        ->send();

                    return redirect($redirectUrl);
                }),

            \Laravilt\Actions\Action::make('createAnother')
                ->label(__('laravilt-panel::panel.common.create_and_create_another'))
                ->color('secondary')
                ->submit()
                ->preserveState(false)
                ->action(function (mixed $record, array $data) {
                    // Validate form data
                    $validated = $this->validateFormData($data);

                    $this->createRecord($validated);
                    $resource = static::getResource();
                    $createUrl = $resource::getUrl('create');

                    \Laravilt\Notifications\Notification::success()
                        ->title(__('notifications::notifications.success'))
                        ->body(__('notifications::notifications.record_created'))
                        ->send();

                    return redirect($createUrl);
                }),

            \Laravilt\Actions\Action::make('cancel')
                ->label(__('laravilt-panel::panel.common.cancel'))
                ->color('secondary')
                ->outlined()
                ->method('GET')
                ->url($resource::getUrl('list')),
        ];

        // Append actions to schema (they will use standalone action tokens)
        foreach ($actions as $action) {
            $schema[] = $action;
        }

        $form->schema($schema);

        return [$form];
    }
}
</file>

<file path="src/Pages/EditRecord.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Pages;

use Illuminate\Database\Eloquent\Model;
use Laravilt\Schemas\Schema;

abstract class EditRecord extends Page
{
    protected Model $record;

    /**
     * Get the page title using the resource's label with "Edit" prefix.
     */
    public static function getTitle(): string
    {
        $resource = static::getResource();

        if ($resource) {
            return __('laravilt-panel::panel.pages.edit_record.title', [
                'label' => $resource::getLabel(),
            ]);
        }

        return parent::getTitle();
    }

    /**
     * Get the page heading using the resource's label with "Edit" prefix.
     */
    public function getHeading(): string
    {
        return static::getTitle();
    }

    /**
     * Display the page (GET request handler).
     * Receives the record ID from route parameter and resolves the model.
     */
    public function create(\Illuminate\Http\Request $request, ...$parameters)
    {
        // Extract the record ID from parameters (first parameter after request)
        $recordId = $parameters[0] ?? null;

        if (! $recordId) {
            throw new \InvalidArgumentException('Record ID parameter is required for EditRecord pages');
        }

        // Get the model class from the resource
        $resource = static::getResource();

        if (! $resource) {
            throw new \InvalidArgumentException('Resource is not set for '.static::class);
        }

        $modelClass = $resource::getModel();

        if (! $modelClass) {
            throw new \InvalidArgumentException('Model class is not set for resource '.$resource);
        }

        // Resolve the model instance from the ID
        $this->record = $modelClass::findOrFail($recordId);

        return $this->render();
    }

    /**
     * @var array<string, mixed>
     */
    protected array $data = [];

    public function form(Schema $schema): Schema
    {
        $resource = static::getResource();

        return $resource::form($schema);
    }

    /**
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    public function mutateFormDataBeforeFill(array $data): array
    {
        // Load many-to-many relationship IDs for the form
        $data = $this->loadRelationshipData($data);

        return $data;
    }

    /**
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    public function mutateFormDataBeforeSave(array $data): array
    {
        return $data;
    }

    protected function afterSave(): void
    {
        //
    }

    protected function getRedirectUrl(): ?string
    {
        $resource = static::getResource();

        return $resource::getUrl('list');
    }

    public function save(array $data): Model
    {
        $data = $this->mutateFormDataBeforeSave($data);

        // Extract relationship data for many-to-many relationships
        $relationships = $this->extractRelationshipData($data);

        $this->record->update($data);

        // Sync many-to-many relationships
        $this->syncRelationships($this->record, $relationships);

        $this->afterSave();

        return $this->record;
    }

    /**
     * Load many-to-many relationship IDs into form data.
     *
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    protected function loadRelationshipData(array $data): array
    {
        $reflectionClass = new \ReflectionClass($this->record);

        // List of methods to skip (Eloquent methods that should not be called)
        $skipMethods = [
            'delete', 'forceDelete', 'restore', 'save', 'update', 'fresh', 'refresh',
            'push', 'touch', 'replicate', 'toArray', 'toJson', 'jsonSerialize',
            'getKey', 'getTable', 'getConnection', 'newQuery', 'newQueryWithoutScopes',
            // SoftDeletes trait methods
            'forceDeleteQuietly', 'deleteQuietly', 'restoreQuietly',
        ];

        foreach ($reflectionClass->getMethods(\ReflectionMethod::IS_PUBLIC) as $method) {
            $methodName = $method->getName();

            // Skip magic methods, methods with parameters, and dangerous Eloquent methods
            if (str_starts_with($methodName, '__')
                || $method->getNumberOfParameters() > 0
                || in_array($methodName, $skipMethods)
                || $method->getDeclaringClass()->getName() !== $this->record::class) {
                continue;
            }

            try {
                $relation = $this->record->{$methodName}();

                // Check if it's a BelongsToMany relationship
                if ($relation instanceof \Illuminate\Database\Eloquent\Relations\BelongsToMany) {
                    $data[$methodName] = $this->record->{$methodName}()->pluck($relation->getRelated()->getTable().'.id')->toArray();
                }
            } catch (\Throwable $e) {
                // Not a relationship method, skip
                continue;
            }
        }

        return $data;
    }

    /**
     * Extract many-to-many relationship data from form data.
     *
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    protected function extractRelationshipData(array &$data): array
    {
        $relationships = [];

        $reflectionClass = new \ReflectionClass($this->record);

        // List of methods to skip (Eloquent methods that should not be called)
        $skipMethods = [
            'delete', 'forceDelete', 'restore', 'save', 'update', 'fresh', 'refresh',
            'push', 'touch', 'replicate', 'toArray', 'toJson', 'jsonSerialize',
            'getKey', 'getTable', 'getConnection', 'newQuery', 'newQueryWithoutScopes',
            // SoftDeletes trait methods
            'forceDeleteQuietly', 'deleteQuietly', 'restoreQuietly',
        ];

        foreach ($reflectionClass->getMethods(\ReflectionMethod::IS_PUBLIC) as $method) {
            $methodName = $method->getName();

            // Skip magic methods, methods with parameters, and dangerous Eloquent methods
            if (str_starts_with($methodName, '__')
                || $method->getNumberOfParameters() > 0
                || in_array($methodName, $skipMethods)
                || $method->getDeclaringClass()->getName() !== $this->record::class) {
                continue;
            }

            // Check if this key exists in the data
            if (! array_key_exists($methodName, $data)) {
                continue;
            }

            try {
                $relation = $this->record->{$methodName}();

                // Check if it's a BelongsToMany relationship
                if ($relation instanceof \Illuminate\Database\Eloquent\Relations\BelongsToMany) {
                    $relationships[$methodName] = $data[$methodName];
                    unset($data[$methodName]);
                }
            } catch (\Throwable $e) {
                // Not a relationship method, skip
                continue;
            }
        }

        return $relationships;
    }

    /**
     * Sync many-to-many relationships.
     *
     * @param  array<string, mixed>  $relationships
     */
    protected function syncRelationships(Model $record, array $relationships): void
    {
        foreach ($relationships as $relationName => $relationData) {
            if ($relationData !== null) {
                $record->{$relationName}()->sync($relationData);
            }
        }
    }

    /**
     * @return array<mixed>
     */
    public function getHeaderActions(): array
    {
        return [];
    }

    /**
     * Validate form data using schema validation rules.
     *
     * @param  array<string, mixed>  $data
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    protected function validateFormData(array $data): array
    {
        $form = $this->form(new \Laravilt\Schemas\Schema);

        $rules = $form->getValidationRules();
        $messages = $form->getValidationMessages();
        $attributes = $form->getValidationAttributes();
        $prefixes = $form->getFieldPrefixes();

        // Only validate if there are rules
        if (empty($rules)) {
            return $data;
        }

        // Prepend prefixes to field values for validation (e.g., https:// for URL fields)
        $dataForValidation = $data;
        foreach ($prefixes as $fieldName => $prefix) {
            if (isset($dataForValidation[$fieldName]) && is_string($dataForValidation[$fieldName]) && $dataForValidation[$fieldName] !== '') {
                // Only prepend if value doesn't already start with the prefix
                if (! str_starts_with($dataForValidation[$fieldName], $prefix)) {
                    $dataForValidation[$fieldName] = $prefix.$dataForValidation[$fieldName];
                }
            }
        }

        // Validate with prefixed data
        validator($dataForValidation, $rules, $messages, $attributes)->validate();

        // Return original data (without prefixes) - the storage should save the user-entered value
        return $data;
    }

    /**
     * Get the schema (form) for this page.
     */
    public function getSchema(): array
    {
        $form = $this->form(new \Laravilt\Schemas\Schema);

        $resource = static::getResource();

        // Fill with record data if available
        if (isset($this->record)) {
            $formData = $this->mutateFormDataBeforeFill($this->record->toArray());
            $form->fill($formData);
        }

        // Get the form schema
        $schema = $form->getSchema();

        // Add actions to the bottom of the form
        $actions = [
            \Laravilt\Actions\Action::make('save')
                ->label(__('laravilt-panel::panel.common.save'))
                ->color('primary')
                ->submit()
                ->preserveState(false)
                ->action(function (mixed $record, array $data) {
                    // Validate form data
                    $validated = $this->validateFormData($data);

                    $this->save($validated);
                    $redirectUrl = $this->getRedirectUrl();

                    \Laravilt\Notifications\Notification::success()
                        ->title(__('notifications::notifications.success'))
                        ->body(__('notifications::notifications.record_updated'))
                        ->send();

                    return redirect($redirectUrl);
                }),

            \Laravilt\Actions\Action::make('cancel')
                ->label(__('laravilt-panel::panel.common.cancel'))
                ->color('secondary')
                ->outlined()
                ->method('GET')
                ->url($resource::getUrl('list')),
        ];

        // Append actions to schema
        foreach ($actions as $action) {
            $schema[] = $action;
        }

        $form->schema($schema);

        return [$form];
    }

    /**
     * Get the relation managers for this record.
     *
     * @return array<array<string, mixed>>
     */
    public function getRelationManagers(): array
    {
        $resource = static::getResource();

        if (! $resource || ! isset($this->record)) {
            return [];
        }

        $relationManagers = $resource::getRelations();

        return collect($relationManagers)
            ->map(function ($relationManagerClass) {
                /** @var \Laravilt\Panel\Resources\RelationManagers\RelationManager $manager */
                $manager = $relationManagerClass::make($this->record);

                return $manager->toArray();
            })
            ->values()
            ->all();
    }

    /**
     * Get extra props for Inertia response.
     */
    protected function getInertiaProps(): array
    {
        $resource = static::getResource();

        return [
            'record' => $this->record ?? null,
            'relationManagers' => $this->getRelationManagers(),
            'resourceSlug' => $resource ? $resource::getSlug() : null,
        ];
    }
}
</file>

<file path="src/Pages/Page.php">
<?php

namespace Laravilt\Panel\Pages;

use Illuminate\Contracts\Support\Htmlable;
use Illuminate\Support\Traits\Conditionable;
use Laravilt\Actions\Concerns\InteractsWithActions;
use Laravilt\Actions\Contracts\HasActions;
use Laravilt\Forms\Concerns\InteractsWithForms;
use Laravilt\Forms\Contracts\HasForms;
use Laravilt\Panel\Concerns\HasAuth;
use Laravilt\Panel\Concerns\HasBreadcrumbs;
use Laravilt\Panel\Concerns\HasMiddleware;
use Laravilt\Panel\Concerns\HasNavigation;
use Laravilt\Panel\Concerns\HasResources;
use Laravilt\Panel\Concerns\HasWidgets;
use Laravilt\Panel\Contracts\HasPanel as HasPanelContract;
use Laravilt\Panel\Facades\Panel as PanelFacade;
use Laravilt\Panel\Panel;
use Laravilt\Support\Concerns\EvaluatesClosures;

abstract class Page implements HasActions, HasForms, HasPanelContract, Htmlable
{
    use Conditionable;
    use EvaluatesClosures;
    use HasAuth;
    use HasBreadcrumbs;
    use HasMiddleware;
    use HasNavigation;
    use HasResources;
    use HasWidgets;
    use InteractsWithActions;
    use InteractsWithForms;

    /**
     * The cluster this page belongs to.
     */
    protected static ?string $cluster = null;

    /**
     * The resource this page belongs to.
     */
    protected static ?string $resource = null;

    /**
     * The page title.
     */
    protected static ?string $title = null;

    /**
     * The page navigation label.
     */
    protected static ?string $navigationLabel = null;

    /**
     * The custom Inertia component for this page.
     */
    protected ?string $component = null;

    /**
     * The page navigation icon.
     */
    protected static ?string $navigationIcon = null;

    /**
     * The page navigation sort order.
     */
    protected static ?int $navigationSort = null;

    /**
     * The page navigation group.
     */
    protected static ?string $navigationGroup = null;

    /**
     * The page route name.
     */
    protected static ?string $slug = null;

    /**
     * The default Vue component for this page.
     */
    protected static string $view = 'laravilt/Page';

    /**
     * The panel instance.
     */
    protected ?Panel $panel = null;

    /**
     * Whether this page should be shown in navigation.
     */
    protected static bool $shouldRegisterNavigation = true;

    /**
     * Top hook content (rendered above the form).
     * Can be HTML string, Closure returning HTML, or array with 'component' and 'props'.
     */
    protected string|\Closure|array|null $topHook = null;

    /**
     * Bottom hook content (rendered below the form).
     * Can be HTML string, Closure returning HTML, or array with 'component' and 'props'.
     */
    protected string|\Closure|array|null $bottomHook = null;

    /**
     * Get the page title.
     */
    public static function getTitle(): string
    {
        return static::$title ?? static::getLabel();
    }

    /**
     * Get the page label.
     */
    public static function getLabel(): string
    {
        return static::$navigationLabel ?? (string) str(class_basename(static::class))
            ->beforeLast('Page')
            ->kebab()
            ->replace('-', ' ')
            ->title();
    }

    /**
     * Get the cluster this page belongs to.
     */
    public static function getCluster(): ?string
    {
        return static::$cluster;
    }

    /**
     * Get the resource this page belongs to.
     */
    public static function getResource(): ?string
    {
        return static::$resource;
    }

    /**
     * Get the navigation icon.
     */
    public static function getNavigationIcon(): ?string
    {
        return static::$navigationIcon;
    }

    /**
     * Get the navigation sort order.
     */
    public static function getNavigationSort(): int
    {
        return static::$navigationSort ?? 0;
    }

    /**
     * Get the navigation group.
     */
    public static function getNavigationGroup(): ?string
    {
        return static::$navigationGroup;
    }

    /**
     * Get the page slug.
     */
    public static function getSlug(): string
    {
        return static::$slug ?? (string) str(class_basename(static::class))
            ->beforeLast('Page')
            ->kebab();
    }

    /**
     * Get the page URL.
     */
    public static function getUrl(?Panel $panel = null): string
    {
        $panel = $panel ?? PanelFacade::getCurrent();

        return $panel?->url(static::getSlug()) ?? '#';
    }

    /**
     * Get the page route name.
     */
    public static function getRouteName(?Panel $panel = null): string
    {
        $panel = $panel ?? PanelFacade::getCurrent();

        return $panel?->route(static::getSlug()) ?? '';
    }

    /**
     * Create a route configuration for resource pages.
     */
    public static function route(string $path): array
    {
        return [
            'class' => static::class,
            'path' => $path,
        ];
    }

    /**
     * Check if should register navigation.
     */
    public static function shouldRegisterNavigation(): bool
    {
        return static::$shouldRegisterNavigation;
    }

    /**
     * Set the panel instance.
     */
    public function panel(Panel $panel): static
    {
        $this->panel = $panel;

        return $this;
    }

    /**
     * Get the panel instance.
     */
    public function getPanel(): Panel
    {
        return $this->panel ?? PanelFacade::getCurrent();
    }

    /**
     * Get the page heading.
     */
    public function getHeading(): string
    {
        return static::getTitle();
    }

    /**
     * Get the page subheading.
     */
    public function getSubheading(): ?string
    {
        return null;
    }

    /**
     * Get the page layout.
     */
    public function getLayout(): string
    {
        return \Laravilt\Panel\Enums\PageLayout::Panel->value;
    }

    /**
     * Get extra props for Inertia response.
     */
    protected function getInertiaProps(): array
    {
        return [];
    }

    /**
     * Get cluster navigation items for sidebar.
     */
    protected function getClusterNavigation(): ?array
    {
        $clusterClass = static::getCluster();

        if (! $clusterClass) {
            return null;
        }

        $panel = $this->getPanel();
        $clusterSlug = $clusterClass::getSlug();

        // Get all pages that belong to this cluster
        $clusterPages = collect($panel->getPages())
            ->filter(function ($pageClass) use ($clusterClass) {
                // Skip clusters themselves
                if (is_subclass_of($pageClass, \Laravilt\Panel\Cluster::class)) {
                    return false;
                }

                return $pageClass::getCluster() === $clusterClass;
            })
            ->unique()
            ->sortBy(fn ($pageClass) => $pageClass::getNavigationSort() ?? 0)
            ->map(function ($pageClass) use ($panel, $clusterSlug) {
                $pageSlug = $pageClass::getSlug();

                return [
                    'title' => $pageClass::getTitle(),
                    'href' => $panel->url("{$clusterSlug}/{$pageSlug}"),
                    'icon' => $pageClass::getNavigationIcon(),
                ];
            })
            ->values()
            ->all();

        return $clusterPages;
    }

    /**
     * Set the top hook content.
     */
    public function topHook(string|\Closure|array|null $content): static
    {
        $this->topHook = $content;

        return $this;
    }

    /**
     * Get the top hook content.
     *
     * @return string|array|null HTML string or array with component data
     */
    public function getTopHook(): string|array|null
    {
        $content = $this->evaluate($this->topHook);

        // If it's already an array (component definition), return as is
        if (is_array($content)) {
            return $content;
        }

        return $content;
    }

    /**
     * Set the bottom hook content.
     *
     * @param  string|\Closure|array|null  $content  HTML string, Closure, or ['component' => 'ComponentName', 'props' => []]
     */
    public function bottomHook(string|\Closure|array|null $content): static
    {
        $this->bottomHook = $content;

        return $this;
    }

    /**
     * Get the bottom hook content.
     *
     * @return string|array|null HTML string or array with component data
     */
    public function getBottomHook(): string|array|null
    {
        $content = $this->evaluate($this->bottomHook);

        // If it's already an array (component definition), return as is
        if (is_array($content)) {
            return $content;
        }

        return $content;
    }

    /**
     * Display the page (GET request handler).
     *
     * This method is called by Laravel routing when a page is accessed.
     * Override this method if you need custom logic before rendering.
     * Child classes can add route parameters (like Model $record) as needed.
     *
     * If the child class defines an __invoke() method, it will be called instead
     * of the default render() method, allowing for custom page rendering.
     */
    public function create(\Illuminate\Http\Request $request, ...$parameters)
    {
        // Check if child class has a custom __invoke method
        // Use ReflectionMethod to check if __invoke is defined in the child class (not inherited)
        $reflectionClass = new \ReflectionClass($this);
        if ($reflectionClass->hasMethod('__invoke')) {
            $method = $reflectionClass->getMethod('__invoke');
            // Only call __invoke if it's defined in the child class, not inherited from a parent
            if ($method->getDeclaringClass()->getName() === static::class) {
                return $this->__invoke();
            }
        }

        return $this->render();
    }

    /**
     * Get the URL for executing actions on this page.
     */
    protected function getActionUrl(): string
    {
        return '/actions/execute';
    }

    /**
     * Configure actions in schema with component context.
     * Sets the Page class on actions so they can auto-configure based on their context.
     */
    protected function configureActions(array $schema): array
    {
        foreach ($schema as $item) {
            // Check if this is a Grid or Table
            if ($item instanceof \Laravilt\Grids\Grid || $item instanceof \Laravilt\Tables\Table) {
                $this->configureGridTableActions($item);
            }
        }

        return $schema;
    }

    /**
     * Set component context on Grid/Table record actions.
     */
    protected function configureGridTableActions($gridOrTable): void
    {
        // Set the Page class as component on all record actions
        if (method_exists($gridOrTable, 'getRecordActions')) {
            $actions = $gridOrTable->getRecordActions();

            foreach ($actions as $action) {
                // Set this Page class as the component so actions know their context
                $action->component(static::class);
            }
        }
    }

    /**
     * Execute an action by name.
     *
     * This method is called via POST when an action is triggered.
     * It will execute either the action's closure or call a public method on the page.
     */
    public function executeAction(\Illuminate\Http\Request $request)
    {
        $actionName = $request->input('action');

        if (! $actionName) {
            return back()->with('error', 'Action name is required');
        }

        // Find the action in the page's actions
        $action = collect($this->getHeaderActions())->first(function ($action) use ($actionName) {
            return $action->getName() === $actionName;
        });

        if (! $action) {
            return back()->with('error', "Action '{$actionName}' not found");
        }

        // Check authorization
        if (! $action->canAuthorize()) {
            return back()->with('error', 'Unauthorized');
        }

        // Get form data if provided
        $data = $request->except(['action', '_token']);

        // If action has a closure, execute it
        if ($action->getAction() !== null) {
            $result = $action->execute(null, $data);

            // If result is a response, return it
            if ($result instanceof \Illuminate\Http\Response || $result instanceof \Illuminate\Http\RedirectResponse) {
                return $result;
            }

            return back();
        }

        // Otherwise, try to call a public method on the page with the same name
        $methodName = 'handle'.str($actionName)->studly();

        if (method_exists($this, $methodName) && (new \ReflectionMethod($this, $methodName))->isPublic()) {
            $result = $this->{$methodName}($request, $data);

            // If result is a response, return it
            if ($result instanceof \Illuminate\Http\Response || $result instanceof \Illuminate\Http\RedirectResponse) {
                return $result;
            }

            return back();
        }

        return back()->with('error', "No handler found for action '{$actionName}'");
    }

    /**
     * Render the page via Inertia.js with Vue component.
     */
    public function render(?string $component = null)
    {
        // Store custom component if provided
        if ($component !== null) {
            $this->component = $component;
        }

        $clusterClass = static::getCluster();
        $clusterNavigation = $this->getClusterNavigation();

        // Get and configure schema
        $schema = method_exists($this, 'getSchema') ? $this->getSchema() : [];
        $schema = $this->configureActions($schema);

        // Get panel ID for action context
        $panelId = $this->getPanel()?->getId();

        // Get all actions (getHeaderActions already includes getActions via trait)
        $allActions = collect($this->getHeaderActions())
            ->filter(fn ($action) => is_object($action))
            ->map(function ($action) use ($panelId) {
                // Clone action to avoid modifying the original
                $actionClone = clone $action;

                // Set component context so actions can auto-configure (including panel ID)
                $actionClone->component(static::class, null, $panelId);

                // If action works with records (Edit/View on EditRecord/ViewRecord pages), configure it
                if (isset($this->record)) {
                    $actionClone->resolveRecordContext($this->record->id);
                }

                return $actionClone->toArray();
            })->values()->all();

        $baseProps = [
            'page' => [
                'heading' => $this->getHeading(),
                'subheading' => $this->getSubheading(),
                'headerActions' => $allActions,
                'actionUrl' => $this->getActionUrl(),
            ],
            'breadcrumbs' => $this->getBreadcrumbs(),
            'pageSlug' => static::getSlug(),
            'panelId' => $this->getPanel()->getId(),
            'layout' => $this->getLayout(),
            'formController' => static::class, // For reactive fields
            'schema' => collect($schema)
                ->filter(fn ($item) => is_object($item) && (method_exists($item, 'toInertiaProps') || method_exists($item, 'toLaraviltProps')))
                ->map(function ($item) {
                    return method_exists($item, 'toInertiaProps') ? $item->toInertiaProps() : $item->toLaraviltProps();
                })
                ->values()
                ->toArray(),
            'topHook' => $this->getTopHook(),
            'bottomHook' => $this->getBottomHook(),
            'clusterNavigation' => $clusterNavigation,
            'clusterTitle' => $clusterClass ? $clusterClass::getNavigationLabel() : null,
            'clusterDescription' => null,
        ];

        $inertiaProps = $this->getInertiaProps();
        $props = array_merge($baseProps, $inertiaProps);

        // Use custom component if set, otherwise use $view property
        $componentName = $this->component ?? static::$view;

        return \Inertia\Inertia::render($componentName, $props);
    }

    /**
     * Convert to HTML.
     */
    public function toHtml()
    {
        return $this->render();
    }

    /**
     * Boot the page.
     */
    public function boot(): void
    {
        //
    }

    /**
     * Mount the page.
     */
    public function mount(): void
    {
        //
    }
}
</file>

<file path="src/Pages/ViewRecord.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Pages;

use Illuminate\Database\Eloquent\Model;
use Laravilt\Schemas\Schema;

abstract class ViewRecord extends Page
{
    protected Model $record;

    /**
     * Get the page title using the resource's label with "View" prefix.
     */
    public static function getTitle(): string
    {
        $resource = static::getResource();

        if ($resource) {
            return __('laravilt-panel::panel.pages.view_record.title', [
                'label' => $resource::getLabel(),
            ]);
        }

        return parent::getTitle();
    }

    /**
     * Get the page heading using the resource's label with "View" prefix.
     */
    public function getHeading(): string
    {
        return static::getTitle();
    }

    /**
     * Display the page (GET request handler).
     * Receives the record ID from route parameter and resolves the model.
     */
    public function create(\Illuminate\Http\Request $request, ...$parameters)
    {
        // Extract the record ID from parameters (first parameter after request)
        $recordId = $parameters[0] ?? null;

        if (! $recordId) {
            throw new \InvalidArgumentException('Record ID parameter is required for ViewRecord pages');
        }

        // Get the model class from the resource
        $resource = static::getResource();
        $modelClass = $resource::getModel();

        // Resolve the model instance from the ID
        $this->record = $modelClass::findOrFail($recordId);

        return $this->render();
    }

    public function infolist(Schema $schema): Schema
    {
        $resource = static::getResource();

        return $resource::infolist($schema);
    }

    /**
     * @return array<mixed>
     */
    public function getHeaderActions(): array
    {
        return [];
    }

    /**
     * Get the schema (infolist) for this page.
     */
    public function getSchema(): array
    {
        // Configure infolist
        $infolist = $this->infolist(new \Laravilt\Schemas\Schema);

        // Fill with record data if available
        if (isset($this->record)) {
            $infolist->fill($this->record->toArray());
        }

        return [$infolist];
    }

    /**
     * Get the relation managers for this record.
     *
     * @return array<array<string, mixed>>
     */
    public function getRelationManagers(): array
    {
        $resource = static::getResource();

        if (! $resource || ! isset($this->record)) {
            return [];
        }

        $relationManagers = $resource::getRelations();

        return collect($relationManagers)
            ->map(function ($relationManagerClass) {
                /** @var \Laravilt\Panel\Resources\RelationManagers\RelationManager $manager */
                $manager = $relationManagerClass::make($this->record);

                return $manager->toArray();
            })
            ->values()
            ->all();
    }

    /**
     * Get extra props for Inertia response.
     */
    protected function getInertiaProps(): array
    {
        $resource = static::getResource();

        return [
            'record' => $this->record ?? null,
            'relationManagers' => $this->getRelationManagers(),
            'resourceSlug' => $resource ? $resource::getSlug() : null,
        ];
    }
}
</file>

<file path="src/Resources/RelationManagers/RelationManager.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Resources\RelationManagers;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\Relation;
use Laravilt\Actions\Action;
use Laravilt\Infolists\Infolist;
use Laravilt\Schemas\Schema;
use Laravilt\Tables\Table;

abstract class RelationManager
{
    protected static string $relationship;

    protected static ?string $recordTitleAttribute = null;

    protected static ?string $label = null;

    protected static ?string $pluralLabel = null;

    protected static ?string $icon = null;

    protected Model $ownerRecord;

    public function __construct(Model $ownerRecord)
    {
        $this->ownerRecord = $ownerRecord;
    }

    public static function make(Model $ownerRecord): static
    {
        return new static($ownerRecord);
    }

    public static function getRelationship(): string
    {
        return static::$relationship;
    }

    public static function getLabel(): string
    {
        return static::$label ?? str(static::getRelationship())->title()->toString();
    }

    public static function getPluralLabel(): string
    {
        return static::$pluralLabel ?? str(static::getLabel())->plural()->toString();
    }

    public static function getIcon(): ?string
    {
        return static::$icon;
    }

    public static function getRecordTitleAttribute(): ?string
    {
        return static::$recordTitleAttribute;
    }

    public function form(Schema $schema): Schema
    {
        return $schema;
    }

    public function table(Table $table): Table
    {
        return $table;
    }

    public function infolist(Infolist $infolist): Infolist
    {
        return $infolist;
    }

    public function isReadOnly(): bool
    {
        return false;
    }

    public function canCreate(): bool
    {
        return ! $this->isReadOnly();
    }

    public function canEdit(): bool
    {
        return ! $this->isReadOnly();
    }

    public function canDelete(): bool
    {
        return ! $this->isReadOnly();
    }

    public function getRelationshipQuery(): Relation
    {
        return $this->ownerRecord->{static::getRelationship()}();
    }

    /**
     * Get the header actions for the relation manager table.
     *
     * @return array<Action>
     */
    public function getHeaderActions(): array
    {
        $actions = [];

        if ($this->canCreate() && ! $this->isReadOnly()) {
            $formSchema = $this->form(Schema::make())->getSchema();

            // Build the relation URL for creating records
            // This will be overridden by the frontend with the correct panel/resource/record context
            $createAction = Action::make('create')
                ->label(__('actions::actions.buttons.create').' '.static::getLabel())
                ->icon('Plus')
                ->color('primary')
                ->method('POST')
                ->requiresConfirmation(true)
                ->modalHeading(__('actions::actions.buttons.create').' '.static::getLabel())
                ->modalFormSchema($formSchema)
                ->modalSubmitActionLabel(__('actions::actions.buttons.create'))
                ->modalCancelActionLabel(__('actions::actions.buttons.cancel'))
                ->preserveState(false);

            $actions[] = $createAction;
        }

        return $actions;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        $table = $this->table(Table::make());

        // Add header actions to the table
        $headerActions = $this->getHeaderActions();
        foreach ($headerActions as $action) {
            $table->headerActions([$action]);
        }

        return [
            'relationship' => static::getRelationship(),
            'label' => static::getLabel(),
            'pluralLabel' => static::getPluralLabel(),
            'icon' => static::getIcon(),
            'recordTitleAttribute' => static::getRecordTitleAttribute(),
            'readOnly' => $this->isReadOnly(),
            'canCreate' => $this->canCreate(),
            'canEdit' => $this->canEdit(),
            'canDelete' => $this->canDelete(),
            'form' => $this->form(Schema::make())->toInertiaProps(),
            'infolist' => $this->infolist(Infolist::make())->toInertiaProps(),
            'table' => $table->toInertiaProps(),
            'headerActions' => collect($headerActions)->map(fn ($action) => $action->toArray())->values()->all(),
        ];
    }
}
</file>

<file path="README.md">
![Panel](./arts/screenshot.jpg)

# Laravilt Panel

[![Latest Stable Version](https://poser.pugx.org/laravilt/panel/version.svg)](https://packagist.org/packages/laravilt/panel)
[![License](https://poser.pugx.org/laravilt/panel/license.svg)](https://packagist.org/packages/laravilt/panel)
[![Downloads](https://poser.pugx.org/laravilt/panel/d/total.svg)](https://packagist.org/packages/laravilt/panel)

A powerful admin panel framework for Laravel with Vue.js (Inertia.js) frontend. Build beautiful, reactive admin panels with minimal effort.

## Features

- **Resources**: Auto-generate CRUD interfaces from database tables
- **Pages**: Custom standalone pages with full control
- **Clusters**: Group related pages under a common navigation section
- **API Generation**: RESTful API endpoints with interactive API Tester
- **Forms**: Dynamic form builder with 30+ field types
- **Tables**: Feature-rich data tables with filtering, sorting, and bulk actions
- **Infolists**: Display record details in elegant layouts
- **Actions**: Customizable actions with modal support
- **Navigation**: Auto-generated navigation with groups and badges

## Installation

```bash
composer require laravilt/panel
```

The package will automatically register its service provider.

## Configuration

Publish the config file:

```bash
php artisan vendor:publish --tag="laravilt-panel-config"
```

## Quick Start

### 1. Create a Panel

```bash
php artisan laravilt:panel admin
```

This creates a new admin panel at `app/Providers/Laravilt/AdminPanelProvider.php`.

### 2. Create a Resource

```bash
php artisan laravilt:resource admin
```

Follow the interactive prompts to:
- Select a database table
- Choose which columns to include
- Enable API endpoints (optional)
- Enable API Tester interface (optional)

### 3. Create a Page

```bash
php artisan laravilt:page admin Dashboard
```

Creates a standalone page with both PHP controller and Vue component.

### 4. Create a Cluster

```bash
php artisan laravilt:cluster admin Settings --icon=Settings
```

Creates a cluster to group related pages:

```php
// app/Laravilt/Admin/Clusters/Settings.php
class Settings extends Cluster
{
    protected static ?string $navigationIcon = 'Settings';
    protected static ?string $navigationLabel = 'Settings';
}
```

Assign pages to a cluster:

```php
class ProfilePage extends Page
{
    protected static ?string $cluster = Settings::class;
}
```

## API Generation

Resources can automatically generate RESTful API endpoints.

### Enable API on a Resource

Simply define an `api()` method on your resource - the API will be auto-detected:

```php
class ProductResource extends Resource
{
    public static function api(ApiResource $api): ApiResource
    {
        return ProductApi::configure($api);
    }
}
```

### API Configuration Class

```php
class ProductApi
{
    public static function configure(ApiResource $api): ApiResource
    {
        return $api
            ->columns([
                ApiColumn::make('id')->type('integer')->sortable(),
                ApiColumn::make('name')->searchable()->sortable(),
                ApiColumn::make('price')->type('decimal'),
                ApiColumn::make('created_at')->type('datetime'),
            ])
            ->useAPITester(); // Enable interactive API tester UI
    }
}
```

### API Tester Interface

Enable the API Tester UI to allow interactive API testing directly from the panel:

```php
$api->useAPITester(); // Enable
$api->useAPITester(false); // Disable (default)
```

### Available API Methods

```php
$api
    ->columns([...])           // Define API columns
    ->endpoint('/api/products') // Custom endpoint
    ->perPage(25)              // Items per page
    ->authenticated()          // Require authentication
    ->list(enabled: true)      // Enable/disable list operation
    ->show(enabled: true)      // Enable/disable show operation
    ->create(enabled: true)    // Enable/disable create operation
    ->update(enabled: true)    // Enable/disable update operation
    ->delete(enabled: true)    // Enable/disable delete operation
    ->useAPITester();          // Enable API Tester interface
```

## Commands

| Command | Description |
|---------|-------------|
| `laravilt:panel {name}` | Create a new panel |
| `laravilt:resource {panel}` | Create a resource with interactive prompts |
| `laravilt:page {panel} {name}` | Create a standalone page |
| `laravilt:cluster {panel} {name}` | Create a cluster for grouping pages |
| `laravilt:relation {panel} {resource} {name}` | Create a relation manager |

### Cluster Command Options

```bash
php artisan laravilt:cluster admin Settings \
    --icon=Settings \
    --sort=10 \
    --group="System"
```

## Resource Structure

```
app/Laravilt/Admin/Resources/Product/
 ProductResource.php      # Main resource class
 Form/
    ProductForm.php      # Form configuration
 Table/
    ProductTable.php     # Table configuration
 InfoList/
    ProductInfoList.php  # Infolist configuration
 Api/
    ProductApi.php       # API configuration (optional)
 Pages/
     ListProduct.php      # List page
     CreateProduct.php    # Create page
     EditProduct.php      # Edit page
     ViewProduct.php      # View page
```

## Testing

```bash
composer test
```

## Code Style

```bash
composer format
```

## Static Analysis

```bash
composer analyse
```

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
</file>

<file path=".github/workflows/fix-php-code-styling.yml">
name: Fix PHP Code Styling

on:
  push:
    branches: [ "master", "main" ]

permissions:
  contents: write

jobs:
  php-code-styling:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}

      - name: Fix PHP code style issues
        uses: aglipanci/laravel-pint-action@2.6
        with:
          preset: laravel

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: Fix styling
</file>

<file path=".github/workflows/publish.yml">
name: Publish to NPM

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js for npm
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@laravilt'

      - name: Configure npm authentication
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm install

      - name: Bump version (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          git add package.json
          git commit -m "chore: bump version to $(node -p "require('./package.json').version")"
          git push origin HEAD:${{ github.ref_name }}

      - name: Build package
        run: npm run build:npm

      - name: Publish to npm registry
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "registry=https://registry.npmjs.org/" >> .npmrc
          npm publish --access public

      - name: Publish to GitHub Packages
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc
          echo "registry=https://npm.pkg.github.com/" >> .npmrc
          echo "@laravilt:registry=https://npm.pkg.github.com/" >> .npmrc
          npm publish

      - name: Get package info
        id: package_info
        run: |
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.package_info.outputs.version }}
          name: v${{ steps.package_info.outputs.version }}
          body: |
            ## ${{ steps.package_info.outputs.name }} v${{ steps.package_info.outputs.version }}

            Published to npm: https://www.npmjs.com/package/${{ steps.package_info.outputs.name }}

            Install with:
            ```bash
            npm install ${{ steps.package_info.outputs.name }}@${{ steps.package_info.outputs.version }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push version tag (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git tag "v${{ steps.package_info.outputs.version }}"
          git push origin --tags
</file>

<file path="src/Resources/Resource.php">
<?php

declare(strict_types=1);

namespace Laravilt\Panel\Resources;

use Illuminate\Database\Eloquent\Model;
use Laravilt\AI\AIAgent;
use Laravilt\Schemas\Schema;
use Laravilt\Tables\ApiResource;
use Laravilt\Tables\Table;

abstract class Resource
{
    /** @var class-string<Model> */
    protected static string $model;

    protected static ?string $label = null;

    protected static ?string $pluralLabel = null;

    protected static ?string $icon = null;

    protected static ?string $navigationIcon = null;

    protected static ?string $navigationGroup = null;

    protected static int $navigationSort = 0;

    protected static bool $navigationVisible = true;

    protected static ?string $navigationBadge = null;

    protected static ?string $navigationBadgeColor = null;

    protected static ?string $slug = null;

    protected static bool $hasApi = false;

    protected static bool $hasFlutter = false;

    protected static bool $hasAI = false;

    /**
     * Whether to show this resource's stats on the dashboard.
     */
    protected static bool $showOnDashboard = true;

    /**
     * Check if this resource should show stats on the dashboard.
     */
    public static function shouldShowOnDashboard(): bool
    {
        return static::$showOnDashboard;
    }

    public static function makeForm(): Schema
    {
        $form = new \Laravilt\Forms\Form;
        $form->model(static::$model);

        return $form;
    }

    public static function makeTable(): Table
    {
        return new Table;
    }

    public static function makeInfoList(): Schema
    {
        return new \Laravilt\Infolists\InfoList;
    }

    public static function form(Schema $schema): Schema
    {
        return $schema;
    }

    public static function table(Table $table): Table
    {
        return $table;
    }

    public static function infolist(Schema $schema): Schema
    {
        return $schema;
    }

    /**
     * Create a new ApiResource instance for configuration.
     */
    public static function makeApiResource(): ApiResource
    {
        return ApiResource::make()
            ->endpoint('/api/'.static::getSlug());
    }

    /**
     * Configure the API resource for this resource.
     * Override this method in your resource to customize the API configuration.
     */
    public static function api(ApiResource $api): ApiResource
    {
        return $api;
    }

    /**
     * Get the configured API resource.
     */
    public static function getApiResource(): ?ApiResource
    {
        if (! static::hasApi()) {
            return null;
        }

        return static::api(static::makeApiResource());
    }

    /**
     * Create a new AIAgent instance for configuration.
     */
    public static function makeAIAgent(): AIAgent
    {
        return AIAgent::make()
            ->name(static::getSlug())
            ->model(static::$model)
            ->description('AI agent for '.static::getLabel().' resource');
    }

    /**
     * Configure the AI agent for this resource.
     * Override this method in your resource to customize the AI configuration.
     */
    public static function ai(AIAgent $agent): AIAgent
    {
        return $agent;
    }

    /**
     * Get the configured AI agent.
     */
    public static function getAIAgent(): ?AIAgent
    {
        if (! static::hasAI()) {
            return null;
        }

        return static::ai(static::makeAIAgent());
    }

    /**
     * Check if this resource has AI capabilities.
     */
    public static function hasAI(): bool
    {
        // Auto-detect: if ai() method is defined in child class (not just inherited), enable AI
        if (static::$hasAI) {
            return true;
        }

        // Check if ai() method is overridden in the child class
        try {
            $reflection = new \ReflectionMethod(static::class, 'ai');

            return $reflection->getDeclaringClass()->getName() === static::class;
        } catch (\ReflectionException $e) {
            return false;
        }
    }

    public static function flutter(\Laravilt\Flutter\Flutter $flutter): \Laravilt\Flutter\Flutter
    {
        return $flutter;
    }

    /**
     * @return array<string, array{class: string, path: string}>
     */
    public static function getPages(): array
    {
        return [];
    }

    /**
     * @return array<class-string>
     */
    public static function getRelations(): array
    {
        return [];
    }

    /**
     * @return class-string<Model>
     */
    public static function getModel(): string
    {
        return static::$model;
    }

    public static function getLabel(): string
    {
        return static::$label ?? str(class_basename(static::class))->remove('Resource')->headline()->toString();
    }

    public static function getPluralLabel(): string
    {
        return static::$pluralLabel ?? str(static::getLabel())->remove('Resource')->plural()->toString();
    }

    public static function getIcon(): ?string
    {
        return static::$icon;
    }

    public static function getNavigationIcon(): ?string
    {
        return static::$navigationIcon ?? static::$icon;
    }

    public static function getNavigationGroup(): ?string
    {
        return static::$navigationGroup;
    }

    public static function getNavigationSort(): int
    {
        return static::$navigationSort;
    }

    public static function isNavigationVisible(): bool
    {
        return static::$navigationVisible;
    }

    public static function getNavigationBadge(): ?string
    {
        return static::$navigationBadge;
    }

    public static function getNavigationBadgeColor(): ?string
    {
        return static::$navigationBadgeColor;
    }

    public static function getSlug(): string
    {
        if (static::$slug) {
            return static::$slug;
        }

        return str(class_basename(static::class))
            ->replace('Resource', '')
            ->kebab()
            ->toString();
    }

    public static function getUrl($panelOrPage = null, array $parameters = []): string
    {
        // Determine the default list page name based on available pages
        $pages = static::getPages();
        $defaultListPage = array_key_exists('list', $pages) ? 'list' : 'index';

        // Support both getUrl($panel) and getUrl('list', $parameters)
        if ($panelOrPage instanceof \Laravilt\Panel\Panel) {
            $panelId = $panelOrPage->getId();
            $page = $defaultListPage;
        } elseif ($panelOrPage === null) {
            $page = $defaultListPage;
        } else {
            // Get current panel from registry, no hardcoded fallback
            $registry = app(\Laravilt\Panel\PanelRegistry::class);
            $panel = $registry->getCurrent();
            $panelId = $panel?->getId();

            // If no current panel, try to get the default panel
            if (! $panelId) {
                $defaultPanel = $registry->getDefault();
                $panelId = $defaultPanel?->getId();
            }

            // Last resort: get the first registered panel
            if (! $panelId) {
                $allPanels = $registry->all();
                $firstPanel = reset($allPanels);
                $panelId = $firstPanel ? $firstPanel->getId() : 'admin';
            }

            $page = $panelOrPage;
        }

        return route(
            "{$panelId}.resources.".static::getSlug().".{$page}",
            $parameters
        );
    }

    public static function getRouteBaseName(): string
    {
        return 'laravilt.resources.'.static::getSlug();
    }

    public static function hasApi(): bool
    {
        // Auto-detect: if api() method is defined in child class (not just inherited), enable API
        if (static::$hasApi) {
            return true;
        }

        // Check if api() method is overridden in the child class
        try {
            $reflection = new \ReflectionMethod(static::class, 'api');

            return $reflection->getDeclaringClass()->getName() === static::class;
        } catch (\ReflectionException $e) {
            return false;
        }
    }

    public static function hasFlutter(): bool
    {
        return static::$hasFlutter;
    }

    /**
     * Check if the resource's table has a card configuration (supports grid view).
     */
    public static function hasCardConfig(): bool
    {
        if (! static::hasTable()) {
            return false;
        }

        $table = static::table(new Table);

        return $table->getCard() !== null;
    }

    /**
     * Check if the resource uses a Table for listing.
     */
    public static function hasTable(): bool
    {
        return method_exists(static::class, 'table') &&
               (new \ReflectionMethod(static::class, 'table'))->getDeclaringClass()->getName() !== self::class;
    }

    /**
     * Transform a model instance for API response.
     *
     * @return array<string, mixed>
     */
    public static function toApiResource(Model $record): array
    {
        return $record->toArray();
    }

    /**
     * Transform a model instance for Flutter consumption.
     *
     * @return array<string, mixed>
     */
    public static function toFlutterResource(Model $record): array
    {
        return $record->toArray();
    }

    /**
     * Get API routes configuration for this resource.
     *
     * @param  string|null  $panelPath  The panel path prefix (e.g., 'admin')
     * @return array<string, mixed>
     */
    public static function getApiRoutes(?string $panelPath = null): array
    {
        if (! static::hasApi()) {
            return [];
        }

        $slug = static::getSlug();
        $prefix = $panelPath ? "/{$panelPath}/api/{$slug}" : "/api/{$slug}";

        return [
            'index' => ['method' => 'GET', 'path' => $prefix],
            'show' => ['method' => 'GET', 'path' => "{$prefix}/{id}"],
            'store' => ['method' => 'POST', 'path' => $prefix],
            'update' => ['method' => 'PUT', 'path' => "{$prefix}/{id}"],
            'destroy' => ['method' => 'DELETE', 'path' => "{$prefix}/{id}"],
        ];
    }

    /**
     * @return array<string, mixed>
     */
    public static function toArray(): array
    {
        return [
            'model' => static::$model,
            'label' => static::getLabel(),
            'pluralLabel' => static::getPluralLabel(),
            'icon' => static::$icon,
            'navigationIcon' => static::getNavigationIcon(),
            'navigationGroup' => static::$navigationGroup,
            'navigationSort' => static::$navigationSort,
            'navigationVisible' => static::$navigationVisible,
            'slug' => static::getSlug(),
            'pages' => static::getPages(),
            'relations' => static::getRelations(),
            'hasApi' => static::hasApi(),
            'hasFlutter' => static::hasFlutter(),
            'hasAI' => static::hasAI(),
            'apiRoutes' => static::getApiRoutes(),
            'apiResource' => static::getApiResource()?->toInertiaProps(),
            'aiAgent' => static::getAIAgent()?->toArray(),
        ];
    }
}
</file>

<file path="src/PanelServiceProvider.php">
<?php

namespace Laravilt\Panel;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;
use Laravilt\Panel\Middleware\IdentifyPanel;

class PanelServiceProvider extends ServiceProvider
{
    /**
     * Register any panel services.
     */
    public function register(): void
    {
        $this->mergeConfigFrom(
            __DIR__.'/../config/laravilt-panel.php',
            'laravilt.panel'
        );

        $this->app->singleton(PanelRegistry::class);
    }

    /**
     * Bootstrap any panel services.
     */
    public function boot(): void
    {
        $this->loadTranslationsFrom(__DIR__.'/../lang', 'laravilt-panel');

        $this->publishes([
            __DIR__.'/../config/laravilt-panel.php' => config_path('laravilt/panel.php'),
        ], 'laravilt-panel-config');

        $this->publishes([
            __DIR__.'/../lang' => lang_path('vendor/laravilt-panel'),
        ], 'laravilt-panel-lang');

        // Register panel's custom Authenticate middleware as 'panel.auth' alias
        $router = $this->app->make(\Illuminate\Routing\Router::class);
        $router->aliasMiddleware('panel.auth', Http\Middleware\Authenticate::class);

        // Configure middleware priority to ensure IdentifyPanel runs BEFORE auth middleware
        // Laravel's middleware priority reorders middleware, so we must add IdentifyPanel
        // to the priority list before AuthenticatesRequests to ensure correct panel context
        $this->configureMiddlewarePriority($router);

        $this->registerRoutes();
        $this->registerCommands();
    }

    /**
     * Configure middleware priority to ensure IdentifyPanel runs before auth middleware.
     *
     * Laravel's middleware priority system can reorder middleware even if they're
     * specified in a certain order in routes. This ensures IdentifyPanel always
     * runs before any auth middleware so the panel context is set correctly.
     */
    protected function configureMiddlewarePriority(\Illuminate\Routing\Router $router): void
    {
        $router->middlewarePriority = [
            \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
            \Illuminate\Foundation\Http\Middleware\HandlePrecognitiveRequests::class,
            \Illuminate\Cookie\Middleware\EncryptCookies::class,
            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
            \Illuminate\Session\Middleware\StartSession::class,
            \Illuminate\View\Middleware\ShareErrorsFromSession::class,
            \Laravilt\Panel\Middleware\IdentifyPanel::class, // Must come BEFORE AuthenticatesRequests
            \Illuminate\Contracts\Auth\Middleware\AuthenticatesRequests::class,
            \Illuminate\Routing\Middleware\ThrottleRequests::class,
            \Illuminate\Routing\Middleware\ThrottleRequestsWithRedis::class,
            \Illuminate\Contracts\Session\Middleware\AuthenticatesSessions::class,
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
            \Illuminate\Auth\Middleware\Authorize::class,
        ];
    }

    /**
     * Register panel routes.
     */
    protected function registerRoutes(): void
    {
        $this->app->booted(function () {
            $registry = app(PanelRegistry::class);

            foreach ($registry->all() as $panel) {
                // Register API routes FIRST with Sanctum middleware (outside panel middleware group)
                // This allows token-based authentication to work
                foreach ($panel->getResources() as $resourceClass) {
                    if ($resourceClass::hasApi()) {
                        $this->registerResourceApiRoutes($resourceClass, $panel);
                    }
                }

                // Then register panel web routes with session auth
                // IMPORTANT: IdentifyPanel must come BEFORE auth middleware so redirectTo() knows the current panel
                $middleware = $panel->getMiddleware();
                $authMiddleware = $panel->getAuthMiddleware();

                // Replace 'auth' with 'panel.auth' to use panel's custom Authenticate middleware
                $middleware = array_map(fn ($m) => $m === 'auth' ? 'panel.auth' : $m, $middleware);
                $authMiddleware = array_map(fn ($m) => $m === 'auth' ? 'panel.auth' : $m, $authMiddleware);

                // Remove panel.auth from middleware array to ensure correct order
                $middlewareWithoutAuth = array_filter($middleware, fn ($m) => $m !== 'panel.auth');

                Route::middleware(array_merge(
                    $middlewareWithoutAuth,
                    [IdentifyPanel::class.':'.$panel->getId()],
                    $authMiddleware,
                    [Http\Middleware\HandleLocalization::class],
                    [Http\Middleware\SharePanelData::class]
                ))
                    ->prefix($panel->getPath())
                    ->name($panel->getId().'.')
                    ->group(function () use ($panel) {
                        // Register page routes
                        foreach ($panel->getPages() as $pageClass) {
                            $this->registerPageRoute($pageClass, $panel);
                        }

                        // Register resource routes (without API, those are registered above)
                        foreach ($panel->getResources() as $resourceClass) {
                            $this->registerResourceRoutes($resourceClass, $panel, false);
                        }
                    });
            }

            // Register global /login route that redirects to default panel
            $this->registerDefaultLoginRoute($registry);
        });
    }

    /**
     * Register a global /login route that redirects to the default panel's login.
     */
    protected function registerDefaultLoginRoute(PanelRegistry $registry): void
    {
        $defaultPanel = $registry->getDefault();

        if ($defaultPanel && $defaultPanel->hasLogin()) {
            Route::get('login', function () use ($defaultPanel) {
                return redirect()->route($defaultPanel->getId().'.login');
            })->name('login');
        }
    }

    /**
     * Register routes for a resource.
     */
    protected function registerResourceRoutes(string $resourceClass, Panel $panel, bool $registerApi = true): void
    {
        $slug = $resourceClass::getSlug();
        $pages = $resourceClass::getPages();
        $modelClass = $resourceClass::getModel();

        // Check if this is a simple resource (uses ManageRecords page)
        $isSimpleResource = false;
        foreach ($pages as $pageName => $pageConfig) {
            if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                $isSimpleResource = true;
                break;
            }
        }

        // Register each resource page
        foreach ($pages as $pageName => $pageConfig) {
            $pageClass = $pageConfig['class'];
            $pagePath = ltrim($pageConfig['path'], '/');

            // Build the full path for the resource page
            $fullPath = $pagePath ? $slug.'/'.$pagePath : $slug;

            // Build the route name
            $routeName = 'resources.'.$slug.'.'.$pageName;

            // Register the page route (same as registerPageRoute but for resource pages)
            $this->registerPageRoute($pageClass, $panel, $routeName, $fullPath);
        }

        // Register simple resource CRUD routes if this is a ManageRecords resource
        if ($isSimpleResource) {
            $this->registerSimpleResourceRoutes($resourceClass, $slug, $modelClass, $panel);
        }

        // Register column update route for editable columns (ToggleColumn, etc.)
        $this->registerColumnUpdateRoute($resourceClass, $slug, $modelClass, $panel);

        // Register relation manager routes
        $this->registerRelationManagerRoutes($resourceClass, $slug, $modelClass, $panel);

        // Register API routes if resource has API enabled (only if not already registered separately)
        if ($registerApi && $resourceClass::hasApi()) {
            $this->registerResourceApiRoutes($resourceClass, $panel);
        }
    }

    /**
     * Register CRUD routes for simple resources (ManageRecords).
     */
    protected function registerSimpleResourceRoutes(string $resourceClass, string $slug, string $modelClass, Panel $panel): void
    {
        // GET /{slug}/data - AJAX fetch records (handled by ManageRecords::index)
        // Using /data suffix to avoid overwriting the main page route
        Route::get($slug.'/data', function () use ($resourceClass) {
            $pages = $resourceClass::getPages();
            foreach ($pages as $pageConfig) {
                if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                    $page = app($pageConfig['class']);

                    return $page->index(request());
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.data');

        // POST /{slug} - Create record
        Route::post($slug, function () use ($resourceClass) {
            $pages = $resourceClass::getPages();
            foreach ($pages as $pageConfig) {
                if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                    $page = app($pageConfig['class']);

                    return $page->store(request());
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.store');

        // GET /{slug}/{id} - Get single record for view/edit modal
        Route::get($slug.'/{id}', function ($id) use ($resourceClass) {
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                $pages = $resourceClass::getPages();
                foreach ($pages as $pageConfig) {
                    if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                        $page = app($pageConfig['class']);

                        return $page->show(request(), $id);
                    }
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.show');

        // PUT /{slug}/{id} - Update record
        Route::put($slug.'/{id}', function ($id) use ($resourceClass) {
            $pages = $resourceClass::getPages();
            foreach ($pages as $pageConfig) {
                if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                    $page = app($pageConfig['class']);

                    return $page->update(request(), $id);
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.update');

        // DELETE /{slug}/{id} - Delete record
        Route::delete($slug.'/{id}', function ($id) use ($resourceClass) {
            $pages = $resourceClass::getPages();
            foreach ($pages as $pageConfig) {
                if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                    $page = app($pageConfig['class']);

                    return $page->destroy(request(), $id);
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.destroy');

        // POST /{slug}/bulk-delete - Bulk delete records
        Route::post($slug.'/bulk-delete', function () use ($resourceClass) {
            $pages = $resourceClass::getPages();
            foreach ($pages as $pageConfig) {
                if (is_subclass_of($pageConfig['class'], \Laravilt\Panel\Pages\ManageRecords::class)) {
                    $page = app($pageConfig['class']);

                    return $page->bulkDelete(request());
                }
            }

            return response()->json(['error' => 'Page not found'], 404);
        })->name('resources.'.$slug.'.bulk-delete');
    }

    /**
     * Register route for updating individual column values (used by ToggleColumn, etc.)
     */
    protected function registerColumnUpdateRoute(string $resourceClass, string $slug, string $modelClass, Panel $panel): void
    {
        Route::patch($slug.'/{id}/column', function ($id) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);
            $column = request()->input('column');
            $value = request()->input('value');

            // Validate input
            if (empty($column)) {
                return back()->withErrors(['column' => 'Column name is required.']);
            }

            // Get the table configuration to find the column and its callbacks
            $table = new \Laravilt\Tables\Table;
            $table = $resourceClass::table($table);
            $columns = $table->getColumns();

            // Find the column configuration
            $columnConfig = null;
            foreach ($columns as $col) {
                if ($col->getName() === $column) {
                    $columnConfig = $col;
                    break;
                }
            }

            // Check if column exists and is editable
            if (! $columnConfig) {
                return back()->withErrors([$column => 'Column not found.']);
            }

            // Execute beforeStateUpdated callback if exists
            if ($columnConfig instanceof \Laravilt\Tables\Columns\ToggleColumn) {
                $beforeCallback = $columnConfig->getBeforeStateUpdated();
                if ($beforeCallback) {
                    $beforeCallback($record, $column, $value);
                }
            }

            // Update the record
            $record->update([$column => $value]);

            // Execute afterStateUpdated callback if exists
            if ($columnConfig instanceof \Laravilt\Tables\Columns\ToggleColumn) {
                $afterCallback = $columnConfig->getAfterStateUpdated();
                if ($afterCallback) {
                    $afterCallback($record, $column, $value);
                }
            }

            return back();
        })->name('resources.'.$slug.'.column.update');
    }

    /**
     * Register relation manager routes for a resource.
     */
    protected function registerRelationManagerRoutes(string $resourceClass, string $slug, string $modelClass, Panel $panel): void
    {
        $relationManagers = $resourceClass::getRelations();

        if (empty($relationManagers)) {
            return;
        }

        // Route: GET /{slug}/{id}/relations/{relationship}
        Route::get($slug.'/{id}/relations/{relationship}', function ($id, $relationship) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                return response()->json(['error' => 'Relation manager not found'], 404);
            }

            // Get the relationship query
            $relationQuery = $record->{$relationship}();

            // Apply pagination
            $perPage = request('per_page', 10);
            $page = request('page', 1);

            // Apply sorting if provided
            $sortColumn = request('sort');
            $sortDirection = request('direction', 'asc');

            if ($sortColumn) {
                $relationQuery->orderBy($sortColumn, $sortDirection);
            }

            // Get paginated results
            $paginated = $relationQuery->paginate($perPage, ['*'], 'page', $page);

            return response()->json([
                'data' => $paginated->items(),
                'pagination' => [
                    'total' => $paginated->total(),
                    'per_page' => $paginated->perPage(),
                    'current_page' => $paginated->currentPage(),
                    'last_page' => $paginated->lastPage(),
                    'from' => $paginated->firstItem() ?? 0,
                    'to' => $paginated->lastItem() ?? 0,
                ],
            ]);
        })->name('resources.'.$slug.'.relations');

        // Route: POST /{slug}/{id}/relations/{relationship} - Create related record
        Route::post($slug.'/{id}/relations/{relationship}', function ($id, $relationship) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'Relation manager not found'], 404);
                }

                return back()->withErrors(['error' => 'Relation manager not found']);
            }

            // Get the relationship and create the new record
            $data = request()->all();
            $newRecord = $record->{$relationship}()->create($data);

            // Send success notification
            \Laravilt\Notifications\Notification::success()
                ->title(__('notifications::notifications.success'))
                ->body(__('notifications::notifications.record_created'))
                ->send();

            // Return JSON for AJAX requests, redirect for Inertia
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                return response()->json([
                    'success' => true,
                    'data' => $newRecord,
                ]);
            }

            return back();
        })->name('resources.'.$slug.'.relations.create');

        // Route: PUT /{slug}/{id}/relations/{relationship}/{relationId} - Update related record
        Route::put($slug.'/{id}/relations/{relationship}/{relationId}', function ($id, $relationship, $relationId) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'Relation manager not found'], 404);
                }

                return back()->withErrors(['error' => 'Relation manager not found']);
            }

            // Find and update the related record
            $relatedRecord = $record->{$relationship}()->findOrFail($relationId);
            $relatedRecord->update(request()->all());

            // Send success notification
            \Laravilt\Notifications\Notification::success()
                ->title(__('notifications::notifications.success'))
                ->body(__('notifications::notifications.record_updated'))
                ->send();

            // Return JSON for AJAX requests, redirect for Inertia
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                return response()->json([
                    'success' => true,
                    'data' => $relatedRecord,
                ]);
            }

            return back();
        })->name('resources.'.$slug.'.relations.update');

        // Route: DELETE /{slug}/{id}/relations/{relationship}/{relationId} - Delete related record
        Route::delete($slug.'/{id}/relations/{relationship}/{relationId}', function ($id, $relationship, $relationId) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'Relation manager not found'], 404);
                }

                return back()->withErrors(['error' => 'Relation manager not found']);
            }

            // Find and delete the related record
            $relatedRecord = $record->{$relationship}()->findOrFail($relationId);
            $relatedRecord->delete();

            // Send success notification
            \Laravilt\Notifications\Notification::success()
                ->title(__('notifications::notifications.success'))
                ->body(__('notifications::notifications.record_deleted'))
                ->send();

            // Return JSON for AJAX requests, redirect for Inertia
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                return response()->json([
                    'success' => true,
                ]);
            }

            return back();
        })->name('resources.'.$slug.'.relations.delete');

        // Route: POST /{slug}/{id}/relations/{relationship}/bulk-delete - Bulk delete related records
        Route::post($slug.'/{id}/relations/{relationship}/bulk-delete', function ($id, $relationship) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'Relation manager not found'], 404);
                }

                return back()->withErrors(['error' => 'Relation manager not found']);
            }

            // Get IDs to delete
            $ids = request()->input('ids', []);
            if (empty($ids)) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'No records selected'], 400);
                }

                return back()->withErrors(['error' => 'No records selected']);
            }

            // Delete the related records
            $deletedCount = $record->{$relationship}()->whereIn('id', $ids)->delete();

            // Send success notification
            \Laravilt\Notifications\Notification::success()
                ->title(__('notifications::notifications.success'))
                ->body(__('notifications::notifications.records_deleted', ['count' => $deletedCount]))
                ->send();

            // Return JSON for AJAX requests, redirect for Inertia
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                return response()->json([
                    'success' => true,
                    'deleted_count' => $deletedCount,
                ]);
            }

            return back();
        })->name('resources.'.$slug.'.relations.bulk-delete');

        // Route: PATCH /{slug}/{id}/relations/{relationship}/{relationId}/column - Update single column (for toggle columns)
        Route::patch($slug.'/{id}/relations/{relationship}/{relationId}/column', function ($id, $relationship, $relationId) use ($resourceClass, $modelClass) {
            $record = $modelClass::findOrFail($id);

            // Find the relation manager class
            $relationManagers = $resourceClass::getRelations();
            $relationManagerClass = null;

            foreach ($relationManagers as $rmClass) {
                if ($rmClass::getRelationship() === $relationship) {
                    $relationManagerClass = $rmClass;
                    break;
                }
            }

            if (! $relationManagerClass) {
                if (request()->wantsJson()) {
                    return response()->json(['error' => 'Relation manager not found'], 404);
                }

                return back()->withErrors(['error' => 'Relation manager not found']);
            }

            // Find and update the related record's column
            $relatedRecord = $record->{$relationship}()->findOrFail($relationId);
            $column = request()->input('column');
            $value = request()->input('value');

            if ($column) {
                $relatedRecord->update([$column => $value]);
            }

            // Return JSON for AJAX requests, redirect for Inertia
            if (request()->wantsJson() && ! request()->header('X-Inertia')) {
                return response()->json([
                    'success' => true,
                    'data' => $relatedRecord,
                ]);
            }

            return back();
        })->name('resources.'.$slug.'.relations.column');
    }

    /**
     * Register API routes for a resource.
     * These routes support both session auth (for testing in browser) and Sanctum token auth.
     */
    protected function registerResourceApiRoutes(string $resourceClass, Panel $panel): void
    {
        $slug = $resourceClass::getSlug();
        $modelClass = $resourceClass::getModel();
        $panelPath = $panel->getPath();

        // API routes are prefixed with 'api/' under the panel path
        // Full path will be: /{panel}/api/{resource}
        $apiPrefix = $panelPath.'/api/'.$slug;
        $routeNamePrefix = $panel->getId().'.api.'.$slug;

        // Get the API resource to check operation configurations
        $apiResource = $resourceClass::getApiResource();

        // Register each operation with its specific middleware
        $this->registerApiEndpoints($apiPrefix, $routeNamePrefix, $resourceClass, $modelClass, $apiResource);
    }

    /**
     * Register the actual API endpoints.
     */
    protected function registerApiEndpoints(string $apiPrefix, string $routeNamePrefix, string $resourceClass, string $modelClass, ?\Laravilt\Tables\ApiResource $apiResource = null): void
    {
        // Helper to get middleware for an operation
        $getMiddleware = function (string $operation) use ($apiResource): array {
            if ($apiResource) {
                return $apiResource->getOperationMiddleware($operation);
            }

            return ['auth:sanctum'];
        };

        // Helper to check if operation is enabled
        $isEnabled = function (string $operation) use ($apiResource): bool {
            if ($apiResource) {
                return $apiResource->isOperationEnabled($operation);
            }

            return true;
        };

        // Index - GET /api/{resource}
        if ($isEnabled('list')) {
            Route::middleware($getMiddleware('list'))->get($apiPrefix, function () use ($resourceClass, $modelClass) {
                $query = $modelClass::query();

                // Apply search if provided
                if ($search = request('search')) {
                    $apiResource = $resourceClass::getApiResource();
                    if ($apiResource) {
                        $searchableColumns = $apiResource->getSearchableColumns();
                        if (! empty($searchableColumns)) {
                            $query->where(function ($q) use ($searchableColumns, $search) {
                                foreach ($searchableColumns as $column) {
                                    $q->orWhere($column, 'like', '%'.$search.'%');
                                }
                            });
                        }
                    }
                }

                // Apply sorting if provided
                if ($sort = request('sort')) {
                    $direction = request('direction', 'asc');
                    // Validate sort direction
                    if (! in_array($direction, ['asc', 'desc'])) {
                        $direction = 'asc';
                    }
                    $query->orderBy($sort, $direction);
                }

                // Apply filters
                $apiResource = $resourceClass::getApiResource();
                if ($apiResource) {
                    $allowedFilters = $apiResource->getAllowedFilters();
                    foreach ($allowedFilters as $filter) {
                        if (request()->has($filter)) {
                            $query->where($filter, request($filter));
                        }
                    }

                    // Load relationships
                    $relationships = $apiResource->getRelationships();
                    if (! empty($relationships)) {
                        $query->with($relationships);
                    }
                }

                // Paginate
                $perPage = request('per_page', 15);
                $records = $query->paginate($perPage);

                // Transform records using API resource
                if ($apiResource) {
                    $transformedRecords = $apiResource->transformRecords($records->items());

                    return response()->json([
                        'data' => $transformedRecords,
                        'meta' => [
                            'current_page' => $records->currentPage(),
                            'last_page' => $records->lastPage(),
                            'per_page' => $records->perPage(),
                            'total' => $records->total(),
                            'from' => $records->firstItem(),
                            'to' => $records->lastItem(),
                        ],
                        'links' => [
                            'first' => $records->url(1),
                            'last' => $records->url($records->lastPage()),
                            'prev' => $records->previousPageUrl(),
                            'next' => $records->nextPageUrl(),
                        ],
                    ]);
                }

                return response()->json($records);
            })->name($routeNamePrefix.'.index');
        }

        // Show - GET /api/{resource}/{id}
        if ($isEnabled('show')) {
            Route::middleware($getMiddleware('show'))->get($apiPrefix.'/{id}', function ($id) use ($resourceClass, $modelClass) {
                $record = $modelClass::findOrFail($id);

                $apiResource = $resourceClass::getApiResource();
                if ($apiResource) {
                    // Load relationships
                    $relationships = $apiResource->getRelationships();
                    if (! empty($relationships)) {
                        $record->load($relationships);
                    }

                    return response()->json([
                        'data' => $apiResource->transformRecord($record),
                    ]);
                }

                return response()->json(['data' => $record]);
            })->name($routeNamePrefix.'.show');
        }

        // Store - POST /api/{resource}
        if ($isEnabled('create')) {
            Route::middleware($getMiddleware('create'))->post($apiPrefix, function () use ($resourceClass, $modelClass) {
                $apiResource = $resourceClass::getApiResource();
                $data = request()->all();

                // Get fillable fields from API columns
                if ($apiResource) {
                    $fillableFields = $apiResource->getFillableFields();
                    if (! empty($fillableFields)) {
                        $data = array_intersect_key($data, array_flip($fillableFields));
                    }

                    // Validate if validation rules exist
                    $rules = $apiResource->getValidationRules('create');
                    if (! empty($rules)) {
                        request()->validate($rules);
                    }
                }

                $record = $modelClass::create($data);

                if ($apiResource) {
                    return response()->json([
                        'data' => $apiResource->transformRecord($record),
                        'message' => 'Record created successfully.',
                    ], 201);
                }

                return response()->json(['data' => $record, 'message' => 'Record created successfully.'], 201);
            })->name($routeNamePrefix.'.store');
        }

        // Update - PUT/PATCH /api/{resource}/{id}
        if ($isEnabled('update')) {
            Route::middleware($getMiddleware('update'))->match(['put', 'patch'], $apiPrefix.'/{id}', function ($id) use ($resourceClass, $modelClass) {
                $record = $modelClass::findOrFail($id);
                $apiResource = $resourceClass::getApiResource();
                $data = request()->all();

                // Get fillable fields from API columns
                if ($apiResource) {
                    $fillableFields = $apiResource->getFillableFields();
                    if (! empty($fillableFields)) {
                        $data = array_intersect_key($data, array_flip($fillableFields));
                    }

                    // Validate if validation rules exist
                    $rules = $apiResource->getValidationRules('update');
                    if (! empty($rules)) {
                        request()->validate($rules);
                    }
                }

                $record->update($data);

                if ($apiResource) {
                    return response()->json([
                        'data' => $apiResource->transformRecord($record->fresh()),
                        'message' => 'Record updated successfully.',
                    ]);
                }

                return response()->json(['data' => $record->fresh(), 'message' => 'Record updated successfully.']);
            })->name($routeNamePrefix.'.update');
        }

        // Destroy - DELETE /api/{resource}/{id}
        if ($isEnabled('delete')) {
            Route::middleware($getMiddleware('delete'))->delete($apiPrefix.'/{id}', function ($id) use ($modelClass) {
                $record = $modelClass::findOrFail($id);
                $record->delete();

                return response()->json([
                    'message' => 'Record deleted successfully.',
                ]);
            })->name($routeNamePrefix.'.destroy');
        }

        // Bulk Delete - DELETE /api/{resource}
        if ($isEnabled('bulkDelete')) {
            Route::middleware($getMiddleware('bulkDelete'))->delete($apiPrefix, function () use ($modelClass) {
                $ids = request()->input('ids', []);

                if (empty($ids)) {
                    return response()->json(['message' => 'No IDs provided.'], 400);
                }

                $deleted = $modelClass::whereIn('id', $ids)->delete();

                return response()->json([
                    'message' => "{$deleted} record(s) deleted successfully.",
                    'deleted_count' => $deleted,
                ]);
            })->name($routeNamePrefix.'.bulk-destroy');
        }

        // Register custom actions (these use their own middleware from ApiAction)
        if ($apiResource) {
            $this->registerCustomActionRoutes($apiResource, $apiPrefix, $routeNamePrefix, $modelClass);
        }

        // OpenAPI spec endpoint
        Route::get($apiPrefix.'/openapi.json', function () use ($resourceClass) {
            $apiResource = $resourceClass::getApiResource();
            if (! $apiResource) {
                return response()->json(['error' => 'API not configured'], 404);
            }

            return response()->json($apiResource->toOpenApi())
                ->header('Content-Type', 'application/json');
        })->name($routeNamePrefix.'.openapi-json');

        Route::get($apiPrefix.'/openapi.yaml', function () use ($resourceClass) {
            $apiResource = $resourceClass::getApiResource();
            if (! $apiResource) {
                return response('API not configured', 404);
            }

            return response($apiResource->toOpenApiYaml())
                ->header('Content-Type', 'text/yaml')
                ->header('Content-Disposition', 'attachment; filename="openapi.yaml"');
        })->name($routeNamePrefix.'.openapi-yaml');
    }

    /**
     * Register custom action routes for a resource.
     */
    protected function registerCustomActionRoutes(
        \Laravilt\Tables\ApiResource $apiResource,
        string $apiPrefix,
        string $routeNamePrefix,
        string $modelClass
    ): void {
        foreach ($apiResource->getActions() as $action) {
            $slug = $action->getSlug();
            $method = strtolower($action->getMethod());

            if ($action->doesRequireRecord()) {
                // Single record action: /api/{resource}/{id}/actions/{action}
                Route::match([$method], $apiPrefix.'/{id}/actions/'.$slug, function ($id) use ($action, $modelClass) {
                    $record = $modelClass::findOrFail($id);

                    // Validate if rules exist
                    $rules = $action->getValidationRules();
                    if (! empty($rules)) {
                        request()->validate($rules);
                    }

                    $result = $action->execute($record, request());

                    if ($result instanceof \Illuminate\Http\Response || $result instanceof \Illuminate\Http\JsonResponse) {
                        return $result;
                    }

                    return response()->json([
                        'success' => true,
                        'message' => $action->toInertiaProps()['successMessage'] ?? 'Action executed successfully.',
                        'data' => $result,
                    ]);
                })->name($routeNamePrefix.'.actions.'.$slug);
            } elseif ($action->isBulk()) {
                // Bulk action: /api/{resource}/actions/{action}
                Route::match([$method], $apiPrefix.'/actions/'.$slug, function () use ($action, $modelClass) {
                    $ids = request()->input('ids', []);

                    if (empty($ids)) {
                        return response()->json(['error' => 'No IDs provided.'], 400);
                    }

                    $records = $modelClass::whereIn('id', $ids)->get();

                    // Validate if rules exist
                    $rules = $action->getValidationRules();
                    if (! empty($rules)) {
                        request()->validate($rules);
                    }

                    $results = [];
                    foreach ($records as $record) {
                        $results[] = $action->execute($record, request());
                    }

                    return response()->json([
                        'success' => true,
                        'message' => $action->toInertiaProps()['successMessage'] ?? 'Bulk action executed successfully.',
                        'data' => $results,
                        'processed_count' => count($results),
                    ]);
                })->name($routeNamePrefix.'.actions.'.$slug);
            } else {
                // Collection action (no record): /api/{resource}/actions/{action}
                Route::match([$method], $apiPrefix.'/actions/'.$slug, function () use ($action) {
                    // Validate if rules exist
                    $rules = $action->getValidationRules();
                    if (! empty($rules)) {
                        request()->validate($rules);
                    }

                    $result = $action->execute(null, request());

                    if ($result instanceof \Illuminate\Http\Response || $result instanceof \Illuminate\Http\JsonResponse) {
                        return $result;
                    }

                    return response()->json([
                        'success' => true,
                        'message' => $action->toInertiaProps()['successMessage'] ?? 'Action executed successfully.',
                        'data' => $result,
                    ]);
                })->name($routeNamePrefix.'.actions.'.$slug);
            }
        }
    }

    /**
     * Overload to support resource routes with custom route names and paths.
     */
    protected function registerPageRoute(string $pageClass, Panel $panel, ?string $customRouteName = null, ?string $customPath = null): void
    {
        // Skip pages that belong to a cluster - they are handled by registerClusterRoutes() in HasAuth
        // This prevents route conflicts where the cluster-based route gets overwritten
        if (method_exists($pageClass, 'getCluster') && $pageClass::getCluster() !== null) {
            return;
        }

        $slug = $customPath ?? $pageClass::getSlug();
        $routeName = $customRouteName ?? ($slug ?: 'dashboard');

        Route::get($slug, [$pageClass, 'create'])->name($routeName);

        // Register POST route for form submissions and action execution
        // All pages should support POST for action execution (forms with submit actions)
        Route::post($slug, function (...$parameters) use ($pageClass, $panel) {
            $page = app($pageClass);
            $page->panel($panel);
            $page->boot();
            $page->mount();

            // If page has store method, use it (for backwards compatibility)
            if (method_exists($page, 'store')) {
                return $page->store(request());
            }

            // Otherwise, execute action (for form submissions with ->submit() actions)
            return $page->executeAction(request());
        })->name($routeName.'.store');

        // Register DELETE route if page has destroy method
        if (method_exists($pageClass, 'destroy')) {
            Route::delete($slug.'/{id}', function ($id) use ($pageClass, $panel) {
                $page = app($pageClass);
                $page->panel($panel);
                $page->boot();
                $page->mount();

                return $page->destroy(request(), $id);
            })->name($routeName.'.destroy');
        }

        // Register DELETE route for destroyAll if page has that method
        if (method_exists($pageClass, 'destroyAll')) {
            Route::post($slug.'/revoke-all', function () use ($pageClass, $panel) {
                $page = app($pageClass);
                $page->panel($panel);
                $page->boot();
                $page->mount();

                return $page->destroyAll(request());
            })->name($routeName.'.destroy-all');
        }

        // Register DELETE route for destroyOthers if page has that method
        if (method_exists($pageClass, 'destroyOthers')) {
            Route::delete($slug.'/logout-others', function () use ($pageClass, $panel) {
                $page = app($pageClass);
                $page->panel($panel);
                $page->boot();
                $page->mount();

                return $page->destroyOthers(request());
            })->name($routeName.'.logout-others');
        }
    }

    /**
     * Register Artisan commands.
     */
    protected function registerCommands(): void
    {
        if ($this->app->runningInConsole()) {
            $this->commands([
                Commands\InstallCommand::class,
                Commands\MakePanelCommand::class,
                Commands\MakePageCommand::class,
                Commands\MakeResourceCommand::class,
                Commands\MakeRelationManagerCommand::class,
                Commands\MakeClusterCommand::class,
            ]);
        }
    }
}
</file>

<file path="composer.json">
{
    "name": "laravilt/panel",
    "description": "plugin for Laravilt",
    "version": "1.0.0",
    "type": "library",
    "license": "MIT",
    "keywords": [
        "laravel",
        "laravilt",
        "plugin"
    ],
    "authors": [
        {
            "name": "Fady Mondy",
            "email": "info@3x1.io"
        }
    ],
    "require": {
        "php": "^8.3|^8.4",
        "spatie/laravel-package-tools": "^1.14",
        "laravilt/auth": "^1.0",
        "laravilt/support": "^1.0",
        "laravilt/actions": "^1.0",
        "laravilt/forms": "^1.0"
    },
    "require-dev": {
        "larastan/larastan": "^2.9||^3.0",
        "laravel/pint": "^1.14",
        "nunomaduro/collision": "^8.1.1||^7.10.0",
        "orchestra/testbench": "^10.0",
        "pestphp/pest": "^3.0",
        "pestphp/pest-plugin-arch": "^3.0",
        "pestphp/pest-plugin-laravel": "^3.0",
        "pestphp/pest-plugin-livewire": "^3.0",
        "pestphp/pest-plugin-type-coverage": "^3.5",
        "phpstan/extension-installer": "^1.3||^2.0",
        "phpstan/phpstan-deprecation-rules": "^1.1||^2.0",
        "phpstan/phpstan-phpunit": "^1.3||^2.0"
    },
    "autoload": {
        "psr-4": {
            "Laravilt\\Panel\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Laravilt\\Panel\\Tests\\": "tests/",
            "Laravilt\\Panel\\Tests\\Database\\Factories\\": "tests/database/factories",
            "Laravilt\\Panel\\Tests\\Database\\Seeders\\": "tests/database/seeders"
        }
    },
    "scripts": {
        "testbench": "vendor/bin/testbench package:discover --ansi",
        "db": "vendor/bin/testbench package:create-sqlite-db && vendor/bin/testbench migrate",
        "analyse": "vendor/bin/phpstan analyse --memory-limit=512M",
        "test": "vendor/bin/pest",
        "test-coverage": "vendor/bin/pest --coverage",
        "format": "vendor/bin/pint"
    },
    "config": {
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "phpstan/extension-installer": true
        }
    },
    "extra": {
        "laravel": {
            "providers": [
                "Laravilt\\Panel\\PanelServiceProvider"
            ]
        }
    },
    "minimum-stability": "dev",
    "prefer-stable": true
}
</file>

</files>
